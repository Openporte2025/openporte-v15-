<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Porte v3.0 - Fase 16 BRM+Note+Export 📊</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', sans-serif;
        }
        body { 
            overscroll-behavior-y: contain;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        input, select, textarea { 
            font-size: 16px !important;
        }
        .compact-input {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .step-indicator {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s;
        }
        .step-indicator.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.1);
        }
        .step-indicator.completed {
            background: #10b981;
            color: white;
        }
        .section-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            transition: all 0.3s;
        }
        .section-card:hover {
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        .product-pill {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            border: 2px solid;
            transition: all 0.3s;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }
        .product-pill.selected {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .inline-field {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
        }
        @media (min-width: 768px) {
            .config-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        .tab-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s;
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .compact-section {
            max-height: 400px;
            overflow-y: auto;
        }
        .compact-section::-webkit-scrollbar {
            width: 6px;
        }
        .compact-section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .compact-section::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .grid-compact {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        @media (min-width: 640px) {
            .grid-compact {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (min-width: 1024px) {
            .grid-compact {
                grid-template-columns: repeat(6, 1fr);
            }
        }
        .note-checkbox {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .note-checkbox:hover {
            background: #f3f4f6;
        }
        .note-checkbox input[type="checkbox"]:checked + span {
            color: #10b981;
            font-weight: 600;
        }
        .brm-calculator {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        .brm-result {
            background: white;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-weight: bold;
            font-size: 0.875rem;
            color: #f59e0b;
            text-align: center;
            margin-top: 0.5rem;
        }
    </style>
    <!-- SheetJS Library per Export Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div id="app"></div>
    
    <script>
        // State Management
        let state = {
            screen: 'list',
            projects: [],
            currentProject: null,
            currentPosition: null,
            setupStep: 1
        };

        // Load/Save Functions
        function loadState() {
            const saved = localStorage.getItem('openPorteData');
            if (saved) {
                try {
                    state = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading state:', e);
                }
            }
        }

        function saveState() {
            localStorage.setItem('openPorteData', JSON.stringify(state));
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Notification System
        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-100 text-green-800 border-green-300',
                error: 'bg-red-100 text-red-800 border-red-300',
                info: 'bg-blue-100 text-blue-800 border-blue-300'
            };
            
            const notification = document.createElement('div');
            notification.className = `notification ${colors[type]} border-2`;
            notification.innerHTML = `<strong>${message}</strong>`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 2000);
        }

        // Project Management
        function createProject(name, client) {
            const project = {
                id: generateId(),
                name,
                client,
                clientData: {},
                prodotti: {},
                caratteristicheMuro: {},
                configInfissi: {},
                configPersiane: {},
                configCassonetti: {},
                configTapparelle: {},
                configZanzariere: {},
                // BRM Config separati per Larghezza e Altezza
                brmConfigInfissi: { 
                    misuraBaseL: '', operazioneL: '-', valoreL: '0',
                    misuraBaseH: '', operazioneH: '-', valoreH: '0',
                    note: '' 
                },
                brmConfigPersiane: { 
                    misuraBaseL: '', operazioneL: '-', valoreL: '0',
                    misuraBaseH: '', operazioneH: '-', valoreH: '0',
                    note: '' 
                },
                brmConfigTapparelle: { 
                    misuraBaseL: '', operazioneL: '-', valoreL: '0',
                    misuraBaseH: '', operazioneH: '-', valoreH: '0',
                    note: '' 
                },
                brmConfigZanzariere: { 
                    misuraBaseL: '', operazioneL: '-', valoreL: '0',
                    misuraBaseH: '', operazioneH: '-', valoreH: '0',
                    note: '' 
                },
                brmConfigCassonetti: { 
                    misuraBaseL: '', operazioneL: '-', valoreL: '0',
                    misuraBaseH: '', operazioneH: '-', valoreH: '0',
                    note: '',
                    // Campi specifici cassonetto per formula avanzata
                    SRSX: '0', // Sbraccio SX
                    SRDX: '0', // Sbraccio DX
                    ZSX: '0',  // Zoccolino SX
                    ZDX: '0'   // Zoccolino DX
                },
                positions: [],
                createdAt: new Date().toISOString()
            };
            state.projects.push(project);
            state.currentProject = project.id;
            state.setupStep = 1;
            saveState();
            return project;
        }

        function addPosition(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = {
                    id: generateId(),
                    name: `Pos. ${project.positions.length + 1}`,
                    piano: project.clientData?.piano || '',
                    ambiente: '',
                    misure: {},
                    infissi: [],
                    persiane: [],
                    cassonetti: [],
                    tapparelle: [],
                    zanzariere: [],
                    foto: [],
                    note: '',
                    noteVisibilita: [] // ['ordine', 'posa', 'entrambi']
                };
                project.positions.push(pos);
                saveState();
                state.currentPosition = pos.id;
                showNotification('Posizione aggiunta', 'success');
                render();
            }
        }

        // MAIN COMPONENTS
        function Header() {
            return `
                <header class="bg-white/95 backdrop-blur shadow-lg sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-4 py-3">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                ${state.screen !== 'list' ? `
                                    <button onclick="goBack()" class="p-2 hover:bg-gray-100 rounded-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                        </svg>
                                    </button>
                                ` : ''}
                                <h1 class="text-xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                                    Open Porte v3.0 - Fase 16 📊✨
                                </h1>
                            </div>
                            <div class="flex items-center gap-2">
                                ${state.screen === 'list' ? `
                                    <button onclick="exportData()" class="px-3 py-1.5 text-sm border rounded-lg hover:bg-gray-50">
                                        📥 Export
                                    </button>
                                    <button onclick="openExportModal()" 
                                            class="px-4 py-1.5 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-medium hover:shadow-lg transition-all flex items-center gap-2">
                                        <span>📤</span>
                                        <span>Export</span>
                                    </button>
                                    <button onclick="showNewProjectModal()" 
                                            class="px-4 py-1.5 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium hover:shadow-lg transition-all">
                                        + Nuovo Progetto
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </header>
            `;
        }

        function ProjectsList() {
            if (state.projects.length === 0) {
                return `
                    <div class="min-h-[70vh] flex items-center justify-center">
                        <div class="text-center bg-white rounded-2xl p-8 shadow-xl">
                            <div class="text-6xl mb-4">📋</div>
                            <h2 class="text-2xl font-bold mb-2">Benvenuto in Open Porte</h2>
                            <p class="text-gray-600 mb-6">Inizia creando il tuo primo progetto</p>
                            <button onclick="showNewProjectModal()" 
                                    class="px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                                + Crea Primo Progetto
                            </button>
                        
                    
                    ${extraFieldsCassonetto}
                </div>
            `;
        }

            return `
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                    ${state.projects.map(p => `
                        <div class="section-card hover:transform hover:scale-105 transition-all cursor-pointer"
                             onclick="openProject('${p.id}')">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="font-bold text-lg">${p.name}</h3>
                                    <p class="text-sm text-gray-600">${p.client}</p>
                                </div>
                                <span class="text-2xl">🗂️</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-500">${p.positions.length} posizioni</span>
                                <span class="text-purple-600 font-medium">Apri →</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function ProjectSetup() {
            const project = state.projects.find(p => p.id === state.currentProject);
            if (!project) return '';

            return `
                <div class="max-w-7xl mx-auto p-4">
                    <!-- Progress Steps -->
                    <div class="flex justify-between items-center mb-6 bg-white rounded-lg p-4 shadow overflow-x-auto">
                        ${[
                            {num: 1, label: 'Dati Cliente'},
                            {num: 2, label: 'Prodotti'},
                            {num: 3, label: 'Config. Infissi'},
                            {num: 4, label: 'Config. Persiane'},
                            {num: 5, label: 'Config. Tapparelle'},
                            {num: 6, label: 'Config. Zanzariere'},
                            {num: 7, label: 'Config. Cassonetti'},
                            {num: 8, label: 'Muro'},
                            {num: 9, label: 'Posizioni'}
                        ].map(step => `
                            <div class="flex flex-col items-center cursor-pointer flex-shrink-0" onclick="state.setupStep=${step.num}; render()">
                                <div class="step-indicator ${state.setupStep === step.num ? 'active' : state.setupStep > step.num ? 'completed' : 'bg-gray-200'}">
                                    ${state.setupStep > step.num ? '✓' : step.num}
                                </div>
                                <span class="text-xs mt-1 ${state.setupStep === step.num ? 'font-bold' : ''} whitespace-nowrap">${step.label}</span>
                            </div>
                        `).join('<div class="flex-1 border-t-2 border-gray-200 -mt-4 mx-2"></div>')}
                    </div>

                    <!-- Content Area -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        ${state.setupStep === 1 ? renderStep1ClientData(project) :
                          state.setupStep === 2 ? renderStep2Products(project) :
                          state.setupStep === 3 ? renderStep3ConfigInfissi(project) :
                          state.setupStep === 4 ? renderStep4ConfigPersiane(project) :
                          state.setupStep === 5 ? renderStep5ConfigTapparelle(project) :
                          state.setupStep === 6 ? renderStep6ConfigZanzariere(project) :
                          state.setupStep === 7 ? renderStep7ConfigCassonetti(project) :
                          state.setupStep === 8 ? renderStep8WallFeatures(project) :
                          renderStep9Positions(project)}
                        
                        <!-- Navigation -->
                        <div class="flex justify-between mt-6 pt-4 border-t">
                            <button onclick="state.setupStep = Math.max(1, state.setupStep - 1); render()" 
                                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 ${state.setupStep === 1 ? 'invisible' : ''}">
                                ← Indietro
                            </button>
                            ${state.setupStep < 9 ? `
                                <button onclick="state.setupStep = Math.min(9, state.setupStep + 1); saveState(); render()" 
                                        class="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium hover:shadow-lg">
                                    Avanti →
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStep1ClientData(project) {
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">👤</span> Dati Cliente e Progetto
                    </h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Nome Progetto</label>
                            <input type="text" value="${project.name}" 
                                   onchange="updateProject('${project.id}', 'name', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Cliente</label>
                            <input type="text" value="${project.client}" 
                                   onchange="updateProject('${project.id}', 'client', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Piano</label>
                            <input type="text" placeholder="Es: Piano Terra" 
                                   value="${project.clientData?.piano || ''}"
                                   onchange="updateClientData('${project.id}', 'piano', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Città</label>
                            <input type="text" placeholder="Milano" 
                                   value="${project.clientData?.citta || ''}"
                                   onchange="updateClientData('${project.id}', 'citta', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Via/Indirizzo</label>
                            <input type="text" placeholder="Via Roma, 1" 
                                   value="${project.clientData?.via || ''}"
                                   onchange="updateClientData('${project.id}', 'via', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Telefono</label>
                            <input type="tel" placeholder="+39 333 1234567" 
                                   value="${project.clientData?.telefono || ''}"
                                   onchange="updateClientData('${project.id}', 'telefono', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Email</label>
                            <input type="email" placeholder="cliente@email.com" 
                                   value="${project.clientData?.email || ''}"
                                   onchange="updateClientData('${project.id}', 'email', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Note</label>
                            <input type="text" placeholder="Note aggiuntive..." 
                                   value="${project.clientData?.note || ''}"
                                   onchange="updateClientData('${project.id}', 'note', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStep2Products(project) {
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">🛠️</span> Seleziona i Prodotti da Installare
                    </h2>
                    <p class="text-gray-600 mb-4">Seleziona quali prodotti verranno installati in questo progetto:</p>
                    
                    <div class="flex flex-wrap gap-4">
                        <label class="product-pill ${project.prodotti?.infissi ? 'selected bg-blue-50 border-blue-500 text-blue-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.infissi ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'infissi', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">🪟</span>
                            <div>
                                <div class="font-semibold">Infissi</div>
                                <div class="text-xs opacity-75">Finestre e porte</div>
                            </div>
                        </label>

                        <label class="product-pill ${project.prodotti?.persiane ? 'selected bg-purple-50 border-purple-500 text-purple-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.persiane ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'persiane', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">🚪</span>
                            <div>
                                <div class="font-semibold">Persiane</div>
                                <div class="text-xs opacity-75">Persiane e scuri</div>
                            </div>
                        </label>

                        <label class="product-pill ${project.prodotti?.tapparelle ? 'selected bg-amber-50 border-amber-500 text-amber-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.tapparelle ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'tapparelle', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">🎚️</span>
                            <div>
                                <div class="font-semibold">Tapparelle</div>
                                <div class="text-xs opacity-75">Avvolgibili motorizzati</div>
                            </div>
                        </label>

                        <label class="product-pill ${project.prodotti?.zanzariere ? 'selected bg-green-50 border-green-500 text-green-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.zanzariere ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'zanzariere', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">🦟</span>
                            <div>
                                <div class="font-semibold">Zanzariere</div>
                                <div class="text-xs opacity-75">Protezione insetti</div>
                            </div>
                        </label>

                        <label class="product-pill ${project.prodotti?.cassonetti ? 'selected bg-orange-50 border-orange-500 text-orange-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.cassonetti ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'cassonetti', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">📦</span>
                            <div>
                                <div class="font-semibold">Cassonetti</div>
                                <div class="text-xs opacity-75">Cassonetti avvolgibili</div>
                            </div>
                        </label>
                    </div>

                    ${Object.values(project.prodotti || {}).some(v => v) ? `
                        <div class="mt-6 p-4 bg-green-50 border border-green-300 rounded-lg">
                            <p class="text-green-700 font-medium">
                                ✅ Hai selezionato: ${Object.entries(project.prodotti || {})
                                    .filter(([k,v]) => v)
                                    .map(([k]) => k.charAt(0).toUpperCase() + k.slice(1))
                                    .join(', ')}
                            </p>
                        </div>
                    ` : `
                        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-300 rounded-lg">
                            <p class="text-yellow-700">⚠️ Seleziona almeno un prodotto per continuare</p>
                        </div>
                    `}
                </div>
            `;
        }
        
        // ═══════════════════════════════════════════════════════════
        // CALCOLO BRM CASSONETTO CON LOGICA SRSX/SRDX/ZSX/ZDX
        // ═══════════════════════════════════════════════════════════
        function calcolaBRMCassonetto(config) {
            if (!config.misuraBaseL || config.misuraBaseL !== 'LS') {
                return null; // Solo per LS
            }
            
            const SRSX = parseFloat(config.SRSX || 0);
            const SRDX = parseFloat(config.SRDX || 0);
            const ZSX = parseFloat(config.ZSX || 0);
            const ZDX = parseFloat(config.ZDX || 0);
            const valoreBase = parseFloat(config.valoreL || 0);
            const operazione = config.operazioneL || '-';
            
            // Verifica condizioni
            const condSX = ZSX > SRSX;
            const condDX = ZDX > SRDX;
            
            // Calcola percentuale valore
            let valoreFinale = 0;
            if (condSX && condDX) {
                valoreFinale = valoreBase; // 100%
            } else if (condSX || condDX) {
                valoreFinale = valoreBase / 2; // 50%
            } else {
                valoreFinale = 0; // 0%
            }
            
            // Applica operazione
            const valoreConOperazione = operazione === '+' ? valoreFinale : -valoreFinale;
            
            // Formula finale: LS + SRSX + SRDX + valore
            return {
                formula: `LS + ${SRSX} + ${SRDX} ${operazione} ${valoreFinale.toFixed(1)}`,
                componenti: {
                    SRSX: SRSX,
                    SRDX: SRDX,
                    valore: valoreConOperazione,
                    condSX: condSX,
                    condDX: condDX,
                    percentuale: condSX && condDX ? 100 : (condSX || condDX ? 50 : 0)
                }
            };
        }

// ═══════════════════════════════════════════════════════════
        // FUNZIONE RENDER BRM CONFIG L/H SEPARATI - FASE 16
        // ═══════════════════════════════════════════════════════════
        function renderBRMConfig(project, productType, productLabel, icon) {
            const configKey = `brmConfig${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
            const config = project[configKey] || { 
                misuraBaseL: '', operazioneL: '-', valoreL: '0',
                misuraBaseH: '', operazioneH: '-', valoreH: '0',
                note: '' 
            };
            
            const misureLarghezza = ['LF', 'LVT', 'LVAR', 'TMV', 'LS'];
            const misureAltezza = ['HF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'];
            
            return `
                <div class="brm-calculator mt-6 p-4 bg-amber-50 rounded-lg border-2 border-amber-400">
                    <h3 class="font-bold text-amber-800 mb-3 flex items-center gap-2">
                        <span class="text-xl">${icon}</span>
                        📏 Calcolo BRM per ${productLabel}
                    </h3>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-3">
                        <!-- BRM LARGHEZZA -->
                        <div class="bg-white p-3 rounded-lg border-2 border-amber-300">
                            <h4 class="font-semibold text-amber-800 mb-2">📐 BRM Larghezza</h4>
                            <div class="grid grid-cols-3 gap-2 mb-2">
                                <div>
                                    <label class="text-xs font-medium text-amber-800 block mb-1">Misura</label>
                                    <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseL', this.value)"
                                            class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                        <option value="">-</option>
                                        ${misureLarghezza.map(m => `
                                            <option value="${m}" ${config.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-amber-800 block mb-1">Op.</label>
                                    <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneL', this.value)"
                                            class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                        <option value="+" ${config.operazioneL === '+' ? 'selected' : ''}>+</option>
                                        <option value="-" ${config.operazioneL === '-' ? 'selected' : ''}>-</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-amber-800 block mb-1">mm</label>
                                    <input type="number" value="${config.valoreL || '0'}"
                                           onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreL', this.value)"
                                           class="w-full px-2 py-1 border border-amber-500 rounded text-sm">
                                </div>
                            </div>
                            <div class="brm-result text-sm font-semibold text-amber-900">
                                ${config.misuraBaseL ? `📐 BRM L = ${config.misuraBaseL} ${config.operazioneL} ${config.valoreL}mm` : 'Seleziona misura'}
                            </div>
                        </div>
                        
                        <!-- BRM ALTEZZA -->
                        <div class="bg-white p-3 rounded-lg border-2 border-amber-300">
                            <h4 class="font-semibold text-amber-800 mb-2">📏 BRM Altezza</h4>
                            <div class="grid grid-cols-3 gap-2 mb-2">
                                <div>
                                    <label class="text-xs font-medium text-amber-800 block mb-1">Misura</label>
                                    <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseH', this.value)"
                                            class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                        <option value="">-</option>
                                        ${misureAltezza.map(m => `
                                            <option value="${m}" ${config.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-amber-800 block mb-1">Op.</label>
                                    <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneH', this.value)"
                                            class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                        <option value="+" ${config.operazioneH === '+' ? 'selected' : ''}>+</option>
                                        <option value="-" ${config.operazioneH === '-' ? 'selected' : ''}>-</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-amber-800 block mb-1">mm</label>
                                    <input type="number" value="${config.valoreH || '0'}"
                                           onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreH', this.value)"
                                           class="w-full px-2 py-1 border border-amber-500 rounded text-sm">
                                </div>
                            </div>
                            <div class="brm-result text-sm font-semibold text-amber-900">
                                ${config.misuraBaseH ? `📏 BRM H = ${config.misuraBaseH} ${config.operazioneH} ${config.valoreH}mm` : 'Seleziona misura'}
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-medium text-amber-800 mb-1">📝 Note Formula</label>
                        <textarea onchange="updateBRMConfig('${project.id}', '${configKey}', 'note', this.value)"
                                  placeholder="Es: Tolleranza standard, considerazioni particolari..."
                                  class="w-full px-2 py-1 border border-amber-500 rounded text-sm"
                                  rows="2">${config.note || ''}</textarea>
                    </div>
                </div>
            `;
        }



        function renderStep3ConfigInfissi(project) {
            if (!project.prodotti?.infissi) {
                return `
                    <div class="text-center py-8">
                        <p class="text-gray-500">Gli infissi non sono stati selezionati. Salta questo step.</p>
                    </div>
                `;
            }

            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">🪟</span> Configurazione Infissi Default
                    </h2>
                    <p class="text-gray-600 mb-4">Imposta i valori di default per tutti gli infissi:</p>
                    
                    <div class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">1. Azienda</label>
                                ${renderEditableSelect(project.id, 'configInfissi', 'azienda', project.configInfissi?.azienda, [
                                    {value: 'finstral', label: 'FINSTRAL'},
                                    {value: 'essepi', label: 'ESSEPI'}
                                ])}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">2. Finitura Interna</label>
                                ${renderEditableSelect(project.id, 'configInfissi', 'finituraInt', project.configInfissi?.finituraInt, [
                                    {value: 'pvc', label: 'PVC'},
                                    {value: 'legno', label: 'LEGNO'},
                                    {value: 'alluminio', label: 'ALLUMINIO'},
                                    {value: 'ceramica', label: 'CERAMICA'}
                                ])}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">3. Finitura Esterna</label>
                                ${renderEditableSelect(project.id, 'configInfissi', 'finituraEst', project.configInfissi?.finituraEst, [
                                    {value: 'pvc', label: 'PVC'},
                                    {value: 'alluminio', label: 'ALLUMINIO'},
                                    {value: 'ceramica', label: 'CERAMICA'}
                                ])}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">4. Colore Interno</label>
                                <input type="text" placeholder="Es: Bianco, RAL 9010"
                                       value="${project.configInfissi?.coloreInt || ''}"
                                       onchange="updateConfigInfissi('${project.id}', 'coloreInt', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">5. Colore Esterno</label>
                                <input type="text" placeholder="Es: Marrone, RAL 8014"
                                       value="${project.configInfissi?.coloreEst || ''}"
                                       onchange="updateConfigInfissi('${project.id}', 'coloreEst', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">6. Tipo Anta</label>
                                ${renderEditableSelect(project.id, 'configInfissi', 'tipoAnta', project.configInfissi?.tipoAnta, [
                                    {value: 'step-line', label: 'STEP-LINE'},
                                    {value: 'nova-line', label: 'NOVA-LINE'},
                                    {value: 'slim-line', label: 'SLIM-LINE'},
                                    {value: 'classic-line', label: 'CLASSIC-LINE'},
                                    {value: 'step-line-door', label: 'STEP-LINE DOOR'}
                                ])}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">7. Telaio</label>
                                ${renderEditableSelect(project.id, 'configInfissi', 'telaio', project.configInfissi?.telaio, [
                                    {value: '961', label: '961'},
                                    {value: '962', label: '962'},
                                    {value: '966', label: '966'},
                                    {value: '965', label: '965'}
                                ])}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">8. Allarme</label>
                                ${renderEditableSelect(project.id, 'configInfissi', 'allarme', project.configInfissi?.allarme, [
                                    {value: 'si', label: 'Sì'},
                                    {value: 'no', label: 'No'}
                                ])}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">9. Vetro</label>
                                ${renderEditableSelect(project.id, 'configInfissi', 'vetro', project.configInfissi?.vetro, [
                                    {value: 'doppio', label: 'doppio'},
                                    {value: 'doppio-sat', label: 'doppio sat'},
                                    {value: 'triplo', label: 'triplo'},
                                    {value: 'triplo-sat', label: 'triplo sat'}
                                ])}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">10. Tagli Telaio</label>
                                ${renderEditableSelect(project.id, 'configInfissi', 'tagliTelaio', project.configInfissi?.tagliTelaio, [
                                    {value: 'sopra', label: 'sopra'},
                                    {value: 'sotto', label: 'sotto'},
                                    {value: 'sopra-sotto', label: 'sopra/sotto'},
                                    {value: 'dx', label: 'dx'},
                                    {value: 'sx', label: 'sx'},
                                    {value: 'dx-sx', label: 'dx/sx'},
                                    {value: '4-lati', label: '4 lati'},
                                    {value: 'sopra-laterali', label: 'sopra/laterali'},
                                    {value: 'sotto-laterali', label: 'sotto/laterali'}
                                ])}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">11. Tipo Tagli</label>
                                <input type="text" placeholder="Es: standard, 45°"
                                       value="${project.configInfissi?.tipoTagli || ''}"
                                       onchange="updateConfigInfissi('${project.id}', 'tipoTagli', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                    </div>
                    
                    ${renderBRMConfig(project, 'infissi', 'Infissi', '🪟')}
                </div>
            `;
        }

        function renderEditableSelect(projectId, configType, field, currentValue, options) {
            const uniqueId = `${configType}-${field}-${projectId}`;
            const isCustom = currentValue && !options.find(opt => opt.value === currentValue);
            
            return `
                <div class="flex gap-2">
                    <select id="${uniqueId}-select" 
                            onchange="handleEditableSelectChange('${projectId}', '${configType}', '${field}', this.value, '${uniqueId}')"
                            class="flex-1 px-3 py-2 border rounded-lg ${isCustom ? 'hidden' : ''}">
                        <option value="">Seleziona...</option>
                        ${options.map(opt => `
                            <option value="${opt.value}" ${currentValue === opt.value ? 'selected' : ''}>${opt.label}</option>
                        `).join('')}
                        <option value="__custom__">✏️ Altro e scrivo</option>
                    </select>
                    <input type="text" 
                           id="${uniqueId}-input"
                           value="${isCustom ? currentValue : ''}"
                           placeholder="Scrivi valore personalizzato..."
                           onchange="handleEditableInputChange('${projectId}', '${configType}', '${field}', this.value, '${uniqueId}')"
                           class="flex-1 px-3 py-2 border rounded-lg ${isCustom ? '' : 'hidden'}">
                    <button onclick="toggleEditableSelect('${uniqueId}', ${isCustom})"
                            class="px-3 py-2 border rounded-lg hover:bg-gray-50 ${isCustom ? '' : 'hidden'}"
                            id="${uniqueId}-back">
                        ← Menu
                    </button>
                </div>
            `;
        }

        window.handleEditableSelectChange = (projectId, configType, field, value, uniqueId) => {
            if (value === '__custom__') {
                document.getElementById(`${uniqueId}-select`).classList.add('hidden');
                document.getElementById(`${uniqueId}-input`).classList.remove('hidden');
                document.getElementById(`${uniqueId}-back`).classList.remove('hidden');
                document.getElementById(`${uniqueId}-input`).focus();
            } else {
                const updateFunc = `update${configType.charAt(0).toUpperCase() + configType.slice(1)}`;
                window[updateFunc](projectId, field, value);
            }
        };

        window.handleEditableInputChange = (projectId, configType, field, value, uniqueId) => {
            const updateFunc = `update${configType.charAt(0).toUpperCase() + configType.slice(1)}`;
            window[updateFunc](projectId, field, value);
        };

        window.toggleEditableSelect = (uniqueId, isCurrentlyCustom) => {
            if (isCurrentlyCustom) {
                // Extract projectId and configType from uniqueId
                const parts = uniqueId.split('-');
                const projectId = parts[parts.length - 1];
                const field = parts[parts.length - 2];
                const configType = parts.slice(0, -2).join('-');
                
                // Clear the saved value
                const updateFunc = `update${configType.charAt(0).toUpperCase() + configType.slice(1).replace(/-([a-z])/g, (g) => g[1].toUpperCase())}`;
                if (window[updateFunc]) {
                    window[updateFunc](projectId, field, '');
                }
                
                // Show select, hide input
                document.getElementById(`${uniqueId}-select`).classList.remove('hidden');
                document.getElementById(`${uniqueId}-input`).classList.add('hidden');
                document.getElementById(`${uniqueId}-back`).classList.add('hidden');
                document.getElementById(`${uniqueId}-select`).value = '';
                
                render();
            }
        };

        function renderStep4ConfigPersiane(project) {
            if (!project.prodotti?.persiane) {
                return `
                    <div class="text-center py-8">
                        <p class="text-gray-500">Le persiane non sono state selezionate. Salta questo step.</p>
                    </div>
                `;
            }

            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">🚪</span> Configurazione Persiane Default
                    </h2>
                    <p class="text-gray-600 mb-4">Imposta i valori di default per tutte le persiane:</p>
                    
                    <div class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">1. Azienda</label>
                                ${renderEditableSelect(project.id, 'configPersiane', 'azienda', project.configPersiane?.azienda, [
                                    {value: 'p-persiane', label: 'P.Persiane'}
                                ])}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">2. Modello</label>
                                ${renderEditableSelect(project.id, 'configPersiane', 'modello', project.configPersiane?.modello, [
                                    {value: 'Aurora', label: 'Aurora'},
                                    {value: 'Vanitosa', label: 'Vanitosa'},
                                    {value: 'Oscura', label: 'Oscura'},
                                    {value: 'Alto Adige', label: 'Alto Adige'}
                                ])}
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">3. Fissaggio</label>
                            <select id="fissaggio-persiane-${project.id}" onchange="updateFissaggioPersiane('${project.id}', this.value)"
                                    class="w-full md:w-1/2 px-3 py-2 border rounded-lg">
                                <option value="">Seleziona...</option>
                                <option value="A MURO" ${project.configPersiane?.fissaggio === 'A MURO' ? 'selected' : ''}>A MURO</option>
                                <option value="TELAIO" ${project.configPersiane?.fissaggio === 'TELAIO' ? 'selected' : ''}>TELAIO</option>
                            </select>
                        </div>
                        
                        <div id="tipo-telaio-persiane-container-${project.id}" style="display: ${project.configPersiane?.fissaggio === 'TELAIO' ? 'block' : 'none'}">
                            <div>
                                <label class="block text-sm font-medium mb-1">4. Tipo Telaio</label>
                                ${renderEditableSelect(project.id, 'configPersiane', 'tipoTelaio', project.configPersiane?.tipoTelaio, [
                                    {value: 'TH 62', label: 'TH 62'},
                                    {value: 'TH 40', label: 'TH 40'},
                                    {value: 'TH 82', label: 'TH 82'}
                                ])}
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">5. Colore Persiana</label>
                                <input type="text" placeholder="Es: Bianco, Verde"
                                       value="${project.configPersiane?.colorePersiana || ''}"
                                       onchange="updateConfigPersiane('${project.id}', 'colorePersiana', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            
                            <div id="colore-telaio-persiane-container-${project.id}" style="display: ${project.configPersiane?.fissaggio === 'TELAIO' ? 'block' : 'none'}">
                                <label class="block text-sm font-medium mb-1">6. Colore Telaio</label>
                                <input type="text" placeholder="Es: Bianco, Marrone"
                                       value="${project.configPersiane?.coloreTelaio || ''}"
                                       onchange="updateConfigPersiane('${project.id}', 'coloreTelaio', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">7. Battuta</label>
                            ${renderEditableSelect(project.id, 'configPersiane', 'battuta', project.configPersiane?.battuta, [
                                {value: '3 LATI', label: '3 LATI'},
                                {value: '4 LATI', label: '4 LATI'},
                                {value: '2 LATI LATERALI', label: '2 LATI LATERALI'}
                            ])}
                        </div>
                    </div>
                    
                    ${renderBRMConfig(project, 'persiane', 'Persiane', '🚪')}
                </div>
            `;
        }

        function renderStep5ConfigTapparelle(project) {
            if (!project.prodotti?.tapparelle) {
                return `
                    <div class="text-center py-8">
                        <p class="text-gray-500">Le tapparelle non sono state selezionate. Salta questo step.</p>
                    </div>
                `;
            }

            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">🎚️</span> Configurazione Tapparelle Default
                    </h2>
                    <p class="text-gray-600 mb-4">Imposta i valori di default per tutte le tapparelle:</p>
                    
                    <div class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">1. Azienda</label>
                                ${renderEditableSelect(project.id, 'configTapparelle', 'azienda', project.configTapparelle?.azienda, [
                                    {value: 'Plasticino', label: 'Plasticino'},
                                    {value: 'New solar', label: 'New solar'},
                                    {value: 'Estella', label: 'Estella'}
                                ])}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">2. Modello</label>
                                ${renderEditableSelect(project.id, 'configTapparelle', 'modello', project.configTapparelle?.modello, [
                                    {value: 'Mini', label: 'Mini'},
                                    {value: 'Alluminio', label: 'Alluminio'}
                                ])}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">3. Colore</label>
                                <input type="text" placeholder="Es: Bianco, Grigio"
                                       value="${project.configTapparelle?.colore || ''}"
                                       onchange="updateConfigTapparelle('${project.id}', 'colore', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">4. Manuale/Motorizzato</label>
                                ${renderEditableSelect(project.id, 'configTapparelle', 'tipologia', project.configTapparelle?.tipologia, [
                                    {value: 'Manuale', label: 'Manuale'},
                                    {value: 'Motorizzata', label: 'Motorizzata'}
                                ])}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">5. Sost. Esistente</label>
                                ${renderEditableSelect(project.id, 'configTapparelle', 'sostEsistente', project.configTapparelle?.sostEsistente, [
                                    {value: 'Sost. Rullo Sì', label: 'Sost. Rullo Sì'},
                                    {value: 'Sost. Rullo No', label: 'Sost. Rullo No'},
                                    {value: 'Sost. tutto', label: 'Sost. tutto'},
                                    {value: 'Non Sost. Niente', label: 'Non Sost. Niente'}
                                ])}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">6. Guida</label>
                                <input type="text" placeholder="Es: Standard, Rinforzata"
                                       value="${project.configTapparelle?.guida || ''}"
                                       onchange="updateConfigTapparelle('${project.id}', 'guida', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">7. Colore Guida</label>
                                <input type="text" placeholder="Es: Bianco, Marrone"
                                       value="${project.configTapparelle?.coloreGuida || ''}"
                                       onchange="updateConfigTapparelle('${project.id}', 'coloreGuida', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                    </div>
                    
                    ${renderBRMConfig(project, 'tapparelle', 'Tapparelle', '🎚️')}
                </div>
            `;
        }

        function renderStep6ConfigZanzariere(project) {
            if (!project.prodotti?.zanzariere) {
                return `
                    <div class="text-center py-8">
                        <p class="text-gray-500">Le zanzariere non sono state selezionate. Salta questo step.</p>
                    </div>
                `;
            }

            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">🦟</span> Configurazione Zanzariere Default
                    </h2>
                    <p class="text-gray-600 mb-4">Imposta i valori di default per tutte le zanzariere:</p>
                    
                    <div class="space-y-4">
                        <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mb-4">
                            <p class="text-sm text-blue-700 font-medium">ℹ️ Info: Il tipo F/PF verrà rilevato automaticamente dall'infisso della posizione. Se non presente, potrai selezionarlo manualmente nella singola posizione.</p>
                        </div>

                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">1. Azienda</label>
                                ${renderEditableSelect(project.id, 'configZanzariere', 'azienda', project.configZanzariere?.azienda, [
                                    {value: 'Finstral', label: 'Finstral'},
                                    {value: 'Palagina', label: 'Palagina'}
                                ])}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">2. Modello PF</label>
                                ${renderEditableSelect(project.id, 'configZanzariere', 'modelloPF', project.configZanzariere?.modelloPF, [
                                    {value: 'Extrema', label: 'Extrema'},
                                    {value: 'Sintesi', label: 'Sintesi'},
                                    {value: 'Plisse 22', label: 'Plisse 22'}
                                ])}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">3. Modello F</label>
                                ${renderEditableSelect(project.id, 'configZanzariere', 'modelloF', project.configZanzariere?.modelloF, [
                                    {value: 'Plisse 22', label: 'Plisse 22'},
                                    {value: 'Serie X', label: 'Serie X'}
                                ])}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">4. Colore</label>
                                <input type="text" placeholder="Es: Bianco, Grigio"
                                       value="${project.configZanzariere?.colore || ''}"
                                       onchange="updateConfigZanzariere('${project.id}', 'colore', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                    </div>
                    
                    ${renderBRMConfig(project, 'zanzariere', 'Zanzariere', '🦟')}
                </div>
            `;
        }

        function renderStep7ConfigCassonetti(project) {
            if (!project.prodotti?.cassonetti) {
                return `
                    <div class="text-center py-8">
                        <p class="text-gray-500">I cassonetti non sono stati selezionati. Salta questo step.</p>
                    </div>
                `;
            }

            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">📦</span> Configurazione Cassonetti Default
                    </h2>
                    <p class="text-gray-600 mb-4">Imposta i valori di default per tutti i cassonetti:</p>
                    
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">1. Tipo Cassonetto</label>
                            ${renderEditableSelect(project.id, 'configCassonetti', 'tipo', project.configCassonetti?.tipo, [
                                {value: 'Cassonetto', label: 'Cassonetto'},
                                {value: 'Monoblocco', label: 'Monoblocco'},
                                {value: 'Solo isolamento', label: 'Solo isolamento'},
                                {value: 'Cassonetto con isolamento aggiuntivo', label: 'Cassonetto con isolamento aggiuntivo'}
                            ])}
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">2. Azienda</label>
                            <input type="text" placeholder="Es: Azienda produttrice"
                                   value="${project.configCassonetti?.azienda || ''}"
                                   onchange="updateConfigCassonetti('${project.id}', 'azienda', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">3. Colore</label>
                            <input type="text" placeholder="Es: Bianco, RAL 9010"
                                   value="${project.configCassonetti?.colore || ''}"
                                   onchange="updateConfigCassonetti('${project.id}', 'colore', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg">
                        </div>
                    </div>
                    
                    ${renderBRMConfig(project, 'cassonetti', 'Cassonetti', '📦')}
                </div>
            `;
        }

        function renderStep8WallFeatures(project) {
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">🗿</span> Caratteristiche Muro (Misure in mm)
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs font-medium">Prof. Muro Int</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.profMuroInt || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'profMuroInt', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Prof. Piana Sopra</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.profPianaSopra || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'profPianaSopra', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Prof. Piana Sotto</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.profPianaSotto || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'profPianaSotto', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Telaio Prof</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.telaioProfondita || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'telaioProfondita', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Telaio Largh</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.telaioLarghezza || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'telaioLarghezza', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Delta Int</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.deltaInt || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'deltaInt', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Delta Est</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.deltaEst || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'deltaEst', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Guida Esistente?</label>
                            <select id="guida-select-${project.id}" 
                                    onchange="updateGuidaEsistente('${project.id}', this.value)"
                                    class="w-full md:w-1/2 px-3 py-2 border rounded-lg">
                                <option value="">Seleziona...</option>
                                <option value="si" ${project.caratteristicheMuro?.guidaEsistente === 'si' ? 'selected' : ''}>Sì</option>
                                <option value="no" ${project.caratteristicheMuro?.guidaEsistente === 'no' ? 'selected' : ''}>No</option>
                            </select>
                        </div>
                        
                        <div id="guida-fields-${project.id}" style="display: ${project.caratteristicheMuro?.guidaEsistente === 'si' ? 'block' : 'none'}">
                            <div class="grid grid-cols-3 gap-3 bg-green-50 p-3 rounded">
                                <div>
                                    <label class="block text-xs font-medium text-green-700 mb-1">Prof. Distanziale</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.profDistanziale || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'profDistanziale', this.value)"
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-green-700 mb-1">Prof. Guida</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.profGuida || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'profGuida', this.value)"
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-green-700 mb-1">Largh. Guida</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.larghezzaGuida || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'larghezzaGuida', this.value)"
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Prof. Muro Est.</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.profMuroEst || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'profMuroEst', this.value)"
                                   class="w-full md:w-1/2 px-3 py-2 border rounded-lg">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Falso Esistente?</label>
                            <select id="falso-select-${project.id}"
                                    onchange="updateFalsoEsistente('${project.id}', this.value)"
                                    class="w-full md:w-1/2 px-3 py-2 border rounded-lg">
                                <option value="">Seleziona...</option>
                                <option value="si" ${project.caratteristicheMuro?.falsoEsistente === 'si' ? 'selected' : ''}>Sì</option>
                                <option value="no" ${project.caratteristicheMuro?.falsoEsistente === 'no' ? 'selected' : ''}>No</option>
                            </select>
                        </div>
                        
                        <div id="falso-si-fields-${project.id}" style="display: ${project.caratteristicheMuro?.falsoEsistente === 'si' ? 'block' : 'none'}">
                            <div class="bg-orange-50 p-3 rounded space-y-3">
                                <div>
                                    <label class="block text-xs font-medium text-orange-700 mb-1">Spessore Falso</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.spessoreFalso || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'spessoreFalso', this.value)"
                                           class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-orange-700 mb-1">+ Distanza Falso/Infisso</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.distanzaFalsoInfisso || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'distanzaFalsoInfisso', this.value)"
                                           class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                </div>
                            </div>
                        </div>
                        
                        <div id="falso-no-fields-${project.id}" style="display: ${project.caratteristicheMuro?.falsoEsistente === 'no' ? 'block' : 'none'}">
                            <div class="bg-purple-50 p-3 rounded">
                                <label class="block text-xs font-medium text-purple-700 mb-1">Distanza Muro/Infisso</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.distanzaMuroInfisso || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'distanzaMuroInfisso', this.value)"
                                       class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStep9Positions(project) {
            return `
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <span class="text-2xl">📍</span> Posizioni (${project.positions.length})
                        </h2>
                        <button onclick="addPosition('${project.id}')"
                                class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                            + Aggiungi Posizione
                        </button>
                    </div>

                    ${project.positions.length === 0 ? `
                        <div class="text-center py-12 bg-gray-50 rounded-lg">
                            <p class="text-gray-600 mb-4">Nessuna posizione ancora</p>
                            <button onclick="addPosition('${project.id}')"
                                    class="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium">
                                Aggiungi Prima Posizione
                            </button>
                        </div>
                    ` : `
                        <div class="space-y-3">
                            ${project.positions.map((pos, idx) => `
                                <div class="section-card cursor-pointer hover:shadow-lg" onclick="openPosition('${pos.id}')">
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">📍</span>
                                            <div>
                                                <h3 class="font-semibold">${pos.name}</h3>
                                                <p class="text-sm text-gray-600">
                                                    ${pos.piano || 'Piano'} • ${pos.ambiente || 'Ambiente'}
                                                    ${pos.infissi?.length ? ` • 🪟 ${pos.infissi.length}` : ''}
                                                    ${pos.persiane?.length ? ` • 🚪 ${pos.persiane.length}` : ''}
                                                    ${pos.tapparelle?.length ? ` • 🎚️ ${pos.tapparelle.length}` : ''}
                                                    ${pos.zanzariere?.length ? ` • 🦟 ${pos.zanzariere.length}` : ''}
                                                    ${pos.cassonetti?.length ? ` • 📦 ${pos.cassonetti.length}` : ''}
                                                </p>
                                            </div>
                                        </div>
                                        <span class="text-purple-600">→</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function PositionDetail() {
            const project = state.projects.find(p => p.id === state.currentProject);
            const pos = project?.positions.find(p => p.id === state.currentPosition);
            if (!pos) return '';

            return `
                <div class="max-w-7xl mx-auto p-4">
                    <!-- Position Header -->
                    <div class="bg-white rounded-lg shadow p-4 mb-4">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3 flex-1">
                                <input type="text" value="${pos.name}"
                                       onchange="updatePosition('${project.id}', '${pos.id}', 'name', this.value)"
                                       class="text-xl font-bold border-b-2 border-transparent focus:border-purple-500 outline-none">
                                <select onchange="switchPosition(this.value)"
                                        class="px-3 py-1 border rounded-lg">
                                    ${project.positions.map(p => `
                                        <option value="${p.id}" ${p.id === pos.id ? 'selected' : ''}>${p.name}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="flex gap-2">
                                ${project.positions.length > 1 ? `
                                <button onclick="deletePosition('${project.id}', '${pos.id}')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm">
                                    🗑️ Elimina
                                </button>
                                ` : ''}
                                <button onclick="addPosition('${project.id}')"
                                        class="px-4 py-1.5 bg-green-600 text-white rounded-lg font-medium text-sm">
                                    + Nuova Posizione
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Info -->
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div class="section-card">
                            <label class="text-xs font-medium">Piano</label>
                            <input type="text" value="${pos.piano || ''}"
                                   onchange="updatePosition('${project.id}', '${pos.id}', 'piano', this.value)"
                                   placeholder="${project.clientData?.piano || 'Piano'}"
                                   class="w-full compact-input border rounded mt-1">
                        </div>
                        <div class="section-card">
                            <label class="text-xs font-medium">Ambiente</label>
                            <select onchange="updatePosition('${project.id}', '${pos.id}', 'ambiente', this.value)"
                                    class="w-full compact-input border rounded mt-1">
                                <option value="">Seleziona...</option>
                                ${['soggiorno', 'cucina', 'camera', 'bagno', 'corridoio'].map(amb => `
                                    <option value="${amb}" ${pos.ambiente === amb ? 'selected' : ''}>${amb}</option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="section-card">
                            <label class="text-xs font-medium">Foto</label>
                            <div class="flex items-center gap-2 mt-1">
                                <input type="file" id="foto-${pos.id}" accept="image/*" class="hidden"
                                       onchange="addFoto('${project.id}', '${pos.id}', this)">
                                <button onclick="document.getElementById('foto-${pos.id}').click()"
                                        class="px-3 py-1 bg-blue-600 text-white rounded text-sm">
                                    📷 Carica
                                </button>
                                <span class="text-sm text-gray-600">${pos.foto?.length || 0} foto</span>
                            </div>
                        </div>
                    </div>

                    <!-- Products Tabs -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="flex border-b overflow-x-auto">
                            <button onclick="setPositionTab('${pos.id}', 'misure')"
                                    class="tab-btn ${(pos.activeTab || 'misure') === 'misure' ? 'active' : ''}">
                                📏 Misure
                            </button>
                            ${project.prodotti?.infissi ? `
                                <button onclick="setPositionTab('${pos.id}', 'infissi')"
                                        class="tab-btn ${pos.activeTab === 'infissi' ? 'active' : ''}">
                                    🪟 Infissi (${pos.infissi?.length || 0})
                                </button>
                            ` : ''}
                            ${project.prodotti?.persiane ? `
                                <button onclick="setPositionTab('${pos.id}', 'persiane')"
                                        class="tab-btn ${pos.activeTab === 'persiane' ? 'active' : ''}">
                                    🚪 Persiane (${pos.persiane?.length || 0})
                                </button>
                            ` : ''}
                            ${project.prodotti?.tapparelle ? `
                                <button onclick="setPositionTab('${pos.id}', 'tapparelle')"
                                        class="tab-btn ${pos.activeTab === 'tapparelle' ? 'active' : ''}">
                                    🎚️ Tapparelle (${pos.tapparelle?.length || 0})
                                </button>
                            ` : ''}
                            ${project.prodotti?.zanzariere ? `
                                <button onclick="setPositionTab('${pos.id}', 'zanzariere')"
                                        class="tab-btn ${pos.activeTab === 'zanzariere' ? 'active' : ''}">
                                    🦟 Zanzariere (${pos.zanzariere?.length || 0})
                                </button>
                            ` : ''}
                            ${project.prodotti?.cassonetti ? `
                                <button onclick="setPositionTab('${pos.id}', 'cassonetti')"
                                        class="tab-btn ${pos.activeTab === 'cassonetti' ? 'active' : ''}">
                                    📦 Cassonetti (${pos.cassonetti?.length || 0})
                                </button>
                            ` : ''}
                            <button onclick="setPositionTab('${pos.id}', 'foto')"
                                    class="tab-btn ${pos.activeTab === 'foto' ? 'active' : ''}">
                                📸 Foto (${pos.foto?.length || 0})
                            </button>
                        </div>

                        <div class="p-4">
                            ${renderPositionTabContent(project, pos)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPositionTabContent(project, pos) {
            const tab = pos.activeTab || 'misure';

            if (tab === 'misure') {
                return renderMisureTab(project, pos);
            }
            if (tab === 'infissi') {
                return renderInfissiTab(project, pos);
            }
            if (tab === 'persiane') {
                return renderPersianeTab(project, pos);
            }
            if (tab === 'tapparelle') {
                return renderTapparelleTab(project, pos);
            }
            if (tab === 'zanzariere') {
                return renderZanzariereTab(project, pos);
            }
            if (tab === 'cassonetti') {
                return renderCassonettiTab(project, pos);
            }
            if (tab === 'foto') {
                return renderFotoTab(project, pos);
            }

            return '';
        }

        function renderMisureTab(project, pos) {
            return `
                <div class="space-y-4">
                    <!-- MISURE PRINCIPALI -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-sm font-bold text-gray-700 mb-3">Misure Principali (mm)</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            ${['LF', 'HF', 'LVT', 'HVT', 'TMV', 'HMT', 'LVAR', 'HVAR'].map(field => `
                                <div>
                                    <label class="text-xs font-semibold">${field}</label>
                                    <input type="number" placeholder="0"
                                           value="${pos.misure?.[field] || ''}"
                                           onchange="updateMisura('${project.id}', '${pos.id}', '${field}', this.value)"
                                           class="w-full compact-input border rounded mt-1 font-semibold">
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- ALTEZZE FINALI -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-sm font-bold text-gray-700 mb-3">Altezze (mm)</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs font-semibold mb-1">H Soffitto</label>
                                <input type="number" placeholder="0" value="${pos.misure?.HSoffitto || ''}"
                                       onchange="updateMisura('${project.id}', '${pos.id}', 'HSoffitto', this.value)"
                                       class="w-full px-3 py-2 border rounded font-semibold">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold mb-1">H Parapetto/Soffitto</label>
                                <input type="number" placeholder="0" value="${pos.misure?.HParapettoSoffitto || ''}"
                                       onchange="updateMisura('${project.id}', '${pos.id}', 'HParapettoSoffitto', this.value)"
                                       class="w-full px-3 py-2 border rounded font-semibold">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold mb-1">H Pavimento/Parapetto</label>
                                <input type="number" placeholder="0" value="${pos.misure?.HPavimentoParapetto || ''}"
                                       onchange="updateMisura('${project.id}', '${pos.id}', 'HPavimentoParapetto', this.value)"
                                       class="w-full px-3 py-2 border rounded font-semibold">
                            </div>
                        </div>
                    </div>
                    
                    ${pos.overrideCaratteristiche ? renderCaratteristicheMuroOverride(project, pos) : `
                        <button onclick="enableOverride('${project.id}', '${pos.id}')"
                                class="text-sm bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
                            ✏️ Personalizza caratteristiche muro per questa posizione
                        </button>
                    `}
                </div>
            `;
        }

        function renderCaratteristicheMuroOverride(project, pos) {
            const cm = pos.caratteristicheMuroOverride || {};
            const globalCm = project.caratteristicheMuro || {};
            
            return `
                <div class="bg-yellow-100 p-4 rounded border-2 border-yellow-500">
                    <div class="flex justify-between items-center mb-3">
                        <p class="text-sm font-bold text-yellow-800">⚠️ Override Caratteristiche Muro - Personalizzato</p>
                        <button onclick="disableOverride('${project.id}', '${pos.id}')"
                                class="text-xs bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-700">
                            ↩️ Ripristina globali
                        </button>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                            <div>
                                <label class="block text-xs font-medium mb-1">Prof. Muro Int. (mm)</label>
                                <input type="number" placeholder="0"
                                       value="${cm.profMuroInt !== undefined ? cm.profMuroInt : globalCm.profMuroInt || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profMuroInt', this.value)"
                                       class="w-full px-2 py-1 border rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1">Prof. Piana Sopra (mm)</label>
                                <input type="number" placeholder="0"
                                       value="${cm.profPianaSopra !== undefined ? cm.profPianaSopra : globalCm.profPianaSopra || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profPianaSopra', this.value)"
                                       class="w-full px-2 py-1 border rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1">Prof. Piana Sotto (mm)</label>
                                <input type="number" placeholder="0"
                                       value="${cm.profPianaSotto !== undefined ? cm.profPianaSotto : globalCm.profPianaSotto || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profPianaSotto', this.value)"
                                       class="w-full px-2 py-1 border rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1">Telaio Prof. (mm)</label>
                                <input type="number" placeholder="0"
                                       value="${cm.telaioProfondita !== undefined ? cm.telaioProfondita : globalCm.telaioProfondita || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'telaioProfondita', this.value)"
                                       class="w-full px-2 py-1 border rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1">Telaio Largh. (mm)</label>
                                <input type="number" placeholder="0"
                                       value="${cm.telaioLarghezza !== undefined ? cm.telaioLarghezza : globalCm.telaioLarghezza || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'telaioLarghezza', this.value)"
                                       class="w-full px-2 py-1 border rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1">Delta Int. (mm)</label>
                                <input type="number" placeholder="0"
                                       value="${cm.deltaInt !== undefined ? cm.deltaInt : globalCm.deltaInt || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'deltaInt', this.value)"
                                       class="w-full px-2 py-1 border rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1">Delta Est. (mm)</label>
                                <input type="number" placeholder="0"
                                       value="${cm.deltaEst !== undefined ? cm.deltaEst : globalCm.deltaEst || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'deltaEst', this.value)"
                                       class="w-full px-2 py-1 border rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1">Prof. Muro Est. (mm)</label>
                                <input type="number" placeholder="0"
                                       value="${cm.profMuroEst !== undefined ? cm.profMuroEst : globalCm.profMuroEst || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profMuroEst', this.value)"
                                       class="w-full px-2 py-1 border rounded text-sm">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium mb-1">Guida Esistente?</label>
                            <select onchange="updateCaratteristicheMuroOverrideWithRender('${project.id}', '${pos.id}', 'guidaEsistente', this.value);"
                                    class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                <option value="">Seleziona...</option>
                                <option value="si" ${(cm.guidaEsistente !== undefined ? cm.guidaEsistente : globalCm.guidaEsistente) === 'si' ? 'selected' : ''}>Sì</option>
                                <option value="no" ${(cm.guidaEsistente !== undefined ? cm.guidaEsistente : globalCm.guidaEsistente) === 'no' ? 'selected' : ''}>No</option>
                            </select>
                        </div>
                        
                        ${(cm.guidaEsistente !== undefined ? cm.guidaEsistente : globalCm.guidaEsistente) === 'si' ? `
                            <div class="grid grid-cols-3 gap-2 bg-green-50 p-2 rounded">
                                <div>
                                    <label class="block text-xs font-medium text-green-700 mb-1">Prof. Distanziale (mm)</label>
                                    <input type="number" placeholder="0"
                                           value="${cm.profDistanziale !== undefined ? cm.profDistanziale : globalCm.profDistanziale || ''}"
                                           onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profDistanziale', this.value)"
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-green-700 mb-1">Prof. Guida (mm)</label>
                                    <input type="number" placeholder="0"
                                           value="${cm.profGuida !== undefined ? cm.profGuida : globalCm.profGuida || ''}"
                                           onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profGuida', this.value)"
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-green-700 mb-1">Larghezza Guida (mm)</label>
                                    <input type="number" placeholder="0"
                                           value="${cm.larghezzaGuida !== undefined ? cm.larghezzaGuida : globalCm.larghezzaGuida || ''}"
                                           onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'larghezzaGuida', this.value)"
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                            </div>
                        ` : ''}
                        
                        <div>
                            <label class="block text-xs font-medium mb-1">Falso Esistente?</label>
                            <select onchange="updateCaratteristicheMuroOverrideWithRender('${project.id}', '${pos.id}', 'falsoEsistente', this.value);"
                                    class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                <option value="">Seleziona...</option>
                                <option value="si" ${(cm.falsoEsistente !== undefined ? cm.falsoEsistente : globalCm.falsoEsistente) === 'si' ? 'selected' : ''}>Sì</option>
                                <option value="no" ${(cm.falsoEsistente !== undefined ? cm.falsoEsistente : globalCm.falsoEsistente) === 'no' ? 'selected' : ''}>No</option>
                            </select>
                        </div>
                        
                        ${(cm.falsoEsistente !== undefined ? cm.falsoEsistente : globalCm.falsoEsistente) === 'si' ? `
                            <div class="bg-orange-50 p-2 rounded space-y-2">
                                <div>
                                    <label class="block text-xs font-medium text-orange-700 mb-1">Spessore Falso</label>
                                    <input type="number" placeholder="0"
                                           value="${cm.spessoreFalso !== undefined ? cm.spessoreFalso : globalCm.spessoreFalso || ''}"
                                           onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'spessoreFalso', this.value)"
                                           class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-orange-700 mb-1">+ Distanza Falso/Infisso</label>
                                    <input type="number" placeholder="0"
                                           value="${cm.distanzaFalsoInfisso !== undefined ? cm.distanzaFalsoInfisso : globalCm.distanzaFalsoInfisso || ''}"
                                           onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'distanzaFalsoInfisso', this.value)"
                                           class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                </div>
                            </div>
                        ` : `
                            <div class="bg-purple-50 p-2 rounded">
                                <label class="block text-xs font-medium text-purple-700 mb-1">Distanza Muro/Infisso</label>
                                <input type="number" placeholder="0"
                                       value="${cm.distanzaMuroInfisso !== undefined ? cm.distanzaMuroInfisso : globalCm.distanzaMuroInfisso || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'distanzaMuroInfisso', this.value)"
                                       class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderInfissiTab(project, pos) {
            const products = pos.infissi || [];
            const canAdd = products.length === 0;

            return `
                <div class="space-y-4">
                    ${canAdd ? `
                        <button onclick="addProduct('${project.id}', '${pos.id}', 'infissi')"
                                class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium">
                            + Aggiungi Infisso
                        </button>
                    ` : `
                        <div class="bg-yellow-50 border border-yellow-300 rounded p-3 text-sm mb-4">
                            ⚠️ Solo un infisso per posizione
                        </div>
                    `}

                    ${products.map((prod, idx) => renderInfissoDetail(project, pos, prod, idx)).join('')}
                </div>
            `;
        }

        function renderInfissoDetail(project, pos, inf, idx) {
            return `
                <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-blue-300">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-bold text-blue-700">🪟 Infisso</h4>
                        <button onclick="removeProduct('${project.id}', '${pos.id}', 'infissi', ${idx})"
                                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold">
                            🗑️ Elimina
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- DATI SPECIFICI -->
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h5 class="font-semibold text-sm mb-3 text-blue-700">📋 Dati Specifici</h5>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div>
                                    <label class="text-xs">Quantità</label>
                                    <select onchange="updateProduct('${project.id}', '${pos.id}', 'infissi', ${idx}, 'qta', this.value)"
                                            class="w-full compact-input border rounded">
                                        ${[1,2,3,4,5,6,7,8,9,10].map(n => `<option value="${n}" ${(inf.qta || 1) === n ? 'selected' : ''}>${n}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="text-xs">Tipo</label>
                                    ${renderProductEditableSelect(project.id, pos.id, 'infissi', idx, 'tipo', inf.tipo, [
                                        {value: 'F1', label: 'F1'},
                                        {value: 'PF1', label: 'PF1'},
                                        {value: 'F2', label: 'F2'},
                                        {value: 'PF2', label: 'PF2'},
                                        {value: 'F3', label: 'F3'},
                                        {value: 'PF3', label: 'PF3'},
                                        {value: 'HST', label: 'HST'},
                                        {value: 'SCORR.PARALL', label: 'SCORR.PARALL'},
                                        {value: 'FISSO', label: 'FISSO'}
                                    ])}
                                </div>
                                
                                <div>
                                    <label class="text-xs">Apertura</label>
                                    ${renderProductEditableSelect(project.id, pos.id, 'infissi', idx, 'apertura', inf.apertura, [
                                        {value: 'SX', label: 'SX'},
                                        {value: 'DX', label: 'DX'},
                                        {value: 'Fisso', label: 'Fisso'},
                                        {value: 'Ribalta', label: 'Ribalta'},
                                        {value: 'Sp. SX', label: 'Sp. SX'},
                                        {value: 'Sp. DX', label: 'Sp. DX'}
                                    ])}
                                </div>
                            </div>
                        </div>
                        
                        <!-- CONFIGURAZIONE -->
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <h5 class="font-semibold text-sm mb-3 text-green-700">⚙️ Configurazione</h5>
                            
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                ${Object.entries({
                                    finituraInt: 'Finitura Int',
                                    finituraEst: 'Finitura Est',
                                    coloreInt: 'Colore Int',
                                    coloreEst: 'Colore Est',
                                    tipoAnta: 'Tipo Anta',
                                    telaio: 'Telaio',
                                    allarme: 'Allarme',
                                    vetro: 'Vetro',
                                    tagliTelaio: 'Tagli Telaio',
                                    tipoTagli: 'Tipo Tagli'
                                }).map(([key, label]) => {
                                    const defaultVal = project.configInfissi?.[key] || '';
                                    return `
                                        <div>
                                            <label class="text-xs">${label}</label>
                                            <input type="text" 
                                                   value="${inf[key] || ''}"
                                                   placeholder="${defaultVal || '--'}"
                                                   onchange="updateProduct('${project.id}', '${pos.id}', 'infissi', ${idx}, '${key}', this.value)"
                                                   class="w-full compact-input border rounded ${inf[key] ? '' : 'bg-gray-50'}">
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderProductEditableSelect(projectId, posId, productType, idx, field, currentValue, options) {
            const uniqueId = `${productType}-${idx}-${field}-${posId}`;
            const isCustom = currentValue && !options.find(opt => opt.value === currentValue);
            
            return `
                <div class="flex gap-1">
                    <select id="${uniqueId}-select" 
                            onchange="handleProductEditableSelectChange('${projectId}', '${posId}', '${productType}', ${idx}, '${field}', this.value, '${uniqueId}')"
                            class="flex-1 compact-input border rounded ${isCustom ? 'hidden' : ''}">
                        <option value="">--</option>
                        ${options.map(opt => `
                            <option value="${opt.value}" ${currentValue === opt.value ? 'selected' : ''}>${opt.label}</option>
                        `).join('')}
                        <option value="__custom__">✏️ Altro</option>
                    </select>
                    <input type="text" 
                           id="${uniqueId}-input"
                           value="${isCustom ? currentValue : ''}"
                           placeholder="Scrivi..."
                           onchange="updateProduct('${projectId}', '${posId}', '${productType}', ${idx}, '${field}', this.value)"
                           class="flex-1 compact-input border rounded ${isCustom ? '' : 'hidden'}">
                    <button onclick="toggleProductEditableSelect('${uniqueId}', ${isCustom})"
                            class="px-1 py-1 border rounded hover:bg-gray-50 text-xs ${isCustom ? '' : 'hidden'}"
                            id="${uniqueId}-back">
                        ←
                    </button>
                </div>
            `;
        }

        window.handleProductEditableSelectChange = (projectId, posId, productType, idx, field, value, uniqueId) => {
            if (value === '__custom__') {
                document.getElementById(`${uniqueId}-select`).classList.add('hidden');
                document.getElementById(`${uniqueId}-input`).classList.remove('hidden');
                document.getElementById(`${uniqueId}-back`).classList.remove('hidden');
                document.getElementById(`${uniqueId}-input`).focus();
            } else {
                updateProduct(projectId, posId, productType, idx, field, value);
            }
        };

        window.toggleProductEditableSelect = (uniqueId, isCurrentlyCustom) => {
            if (isCurrentlyCustom) {
                // Extract info from uniqueId
                const parts = uniqueId.split('-');
                const posId = parts[parts.length - 1];
                const field = parts[parts.length - 2];
                const idx = parseInt(parts[parts.length - 3]);
                const productType = parts[parts.length - 4];
                
                // Find project
                const project = state.projects.find(p => p.id === state.currentProject);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos[productType] && pos[productType][idx]) {
                        // Clear the value
                        pos[productType][idx][field] = '';
                        saveState();
                    }
                }
                
                // Show select, hide input
                document.getElementById(`${uniqueId}-select`).classList.remove('hidden');
                document.getElementById(`${uniqueId}-input`).classList.add('hidden');
                document.getElementById(`${uniqueId}-back`).classList.add('hidden');
                document.getElementById(`${uniqueId}-select`).value = '';
                
                render();
            }
        };

        function renderPersianeTab(project, pos) {
            const products = pos.persiane || [];
            const canAdd = products.length === 0;

            return `
                <div class="space-y-4">
                    ${canAdd ? `
                        <button onclick="addProduct('${project.id}', '${pos.id}', 'persiane')"
                                class="px-4 py-2 bg-purple-600 text-white rounded-lg font-medium">
                            + Aggiungi Persiana
                        </button>
                    ` : `
                        <div class="bg-yellow-50 border border-yellow-300 rounded p-3 text-sm mb-4">
                            ⚠️ Solo una persiana per posizione
                        </div>
                    `}

                    ${products.map((prod, idx) => renderPersianaDetail(project, pos, prod, idx)).join('')}
                </div>
            `;
        }

        function renderPersianaDetail(project, pos, pers, idx) {
            return `
                <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-purple-300">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-bold text-purple-700">🚪 Persiana</h4>
                        <button onclick="removeProduct('${project.id}', '${pos.id}', 'persiane', ${idx})"
                                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold">
                            🗑️ Elimina
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- DATI SPECIFICI -->
                        <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                            <h5 class="font-semibold text-sm mb-3 text-purple-700">📋 Dati Specifici</h5>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div>
                                    <label class="text-xs">Quantità</label>
                                    <select onchange="updateProduct('${project.id}', '${pos.id}', 'persiane', ${idx}, 'qta', this.value)"
                                            class="w-full compact-input border rounded">
                                        ${[1,2,3,4,5,6,7,8,9,10].map(n => `<option value="${n}" ${(pers.qta || 1) === n ? 'selected' : ''}>${n}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="text-xs">Tipo</label>
                                    ${renderProductEditableSelect(project.id, pos.id, 'persiane', idx, 'tipo', pers.tipo, [
                                        {value: 'F1', label: 'F1'},
                                        {value: 'PF1', label: 'PF1'},
                                        {value: 'F2', label: 'F2'},
                                        {value: 'PF2', label: 'PF2'},
                                        {value: 'F3', label: 'F3'},
                                        {value: 'PF3', label: 'PF3'},
                                        {value: 'SCORREVOLE', label: 'SCORREVOLE'}
                                    ])}
                                </div>
                                
                                <div>
                                    <label class="text-xs">Apertura</label>
                                    ${renderProductEditableSelect(project.id, pos.id, 'persiane', idx, 'apertura', pers.apertura, [
                                        {value: 'SP SX', label: 'SP SX'},
                                        {value: 'SP DX', label: 'SP DX'},
                                        {value: 'LIB-SX', label: 'LIB-SX'},
                                        {value: 'LIB-DX', label: 'LIB-DX'},
                                        {value: 'SCORR-SX', label: 'SCORR-SX'},
                                        {value: 'SCORR-DX', label: 'SCORR-DX'}
                                    ])}
                                </div>
                            </div>
                        </div>
                        
                        <!-- CONFIGURAZIONE -->
                        <div class="bg-purple-100 p-4 rounded-lg border border-purple-200">
                            <h5 class="font-semibold text-sm mb-3 text-purple-700">⚙️ Configurazione</h5>
                            
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                ${Object.entries({
                                    modello: 'Modello',
                                    fissaggio: 'Fissaggio',
                                    tipoTelaio: 'Tipo Telaio',
                                    colorePersiana: 'Colore Persiana',
                                    coloreTelaio: 'Colore Telaio',
                                    battuta: 'Battuta'
                                }).map(([key, label]) => {
                                    const defaultVal = project.configPersiane?.[key] || '';
                                    return `
                                        <div>
                                            <label class="text-xs">${label}</label>
                                            <input type="text" 
                                                   value="${pers[key] || ''}"
                                                   placeholder="${defaultVal || '--'}"
                                                   onchange="updateProduct('${project.id}', '${pos.id}', 'persiane', ${idx}, '${key}', this.value)"
                                                   class="w-full compact-input border rounded ${pers[key] ? '' : 'bg-gray-50'}">
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- FOTO PERSIANA -->
                        <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-3">
                            <h5 class="font-semibold text-sm mb-2 text-blue-700">📸 Foto Persiana</h5>
                            
                            <div class="mb-2">
                                <input type="file" 
                                       id="foto-persiana-input-${pos.id}-${idx}" 
                                       accept="image/*" 
                                       onchange="addFotoPersiana('${project.id}', '${pos.id}', ${idx}, this)"
                                       class="hidden">
                                <button onclick="document.getElementById('foto-persiana-input-${pos.id}-${idx}').click()" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-semibold">
                                    📷 Carica Foto
                                </button>
                                <p class="text-xs text-gray-600 mt-1">1 foto per persiana</p>
                            </div>
                            
                            ${pers.foto ? `
                                <div class="relative group inline-block">
                                    <img src="${pers.foto.data}" 
                                         onclick="showFotoModal('${pers.foto.data}')"
                                         class="w-32 h-32 object-cover rounded-lg border-2 border-gray-300 cursor-pointer hover:border-blue-500 transition-all">
                                    <button onclick="removeFotoPersiana('${project.id}', '${pos.id}', ${idx})"
                                            class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                        ✕
                                    </button>
                                </div>
                            ` : '<p class="text-xs text-gray-500 italic">Nessuna foto caricata</p>'}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTapparelleTab(project, pos) {
            const products = pos.tapparelle || [];

            return `
                <div class="space-y-4">
                    <button onclick="addProduct('${project.id}', '${pos.id}', 'tapparelle')"
                            class="px-4 py-2 bg-amber-600 text-white rounded-lg font-medium">
                        + Aggiungi Tapparella
                    </button>

                    ${products.map((prod, idx) => renderTapparellaDetail(project, pos, prod, idx)).join('')}
                </div>
            `;
        }

        function renderTapparellaDetail(project, pos, tapp, idx) {
            const isMotorizzata = tapp.tipologia === 'Motorizzata' || project.configTapparelle?.tipologia === 'Motorizzata';
            
            return `
                <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-amber-300">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-bold text-amber-700">🎚️ Tapparella ${idx + 1}</h4>
                        <button onclick="removeProduct('${project.id}', '${pos.id}', 'tapparelle', ${idx})"
                                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold">
                            🗑️ Elimina
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- DATI SPECIFICI -->
                        <div class="bg-amber-50 p-4 rounded-lg border border-amber-200">
                            <h5 class="font-semibold text-sm mb-3 text-amber-700">📋 Dati Specifici</h5>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                <div>
                                    <label class="text-xs">Quantità</label>
                                    <select onchange="updateProduct('${project.id}', '${pos.id}', 'tapparelle', ${idx}, 'qta', this.value)"
                                            class="w-full compact-input border rounded">
                                        ${[1,2,3,4,5,6,7,8,9,10].map(n => `<option value="${n}" ${(tapp.qta || 1) === n ? 'selected' : ''}>${n}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- CONFIGURAZIONE -->
                        <div class="bg-amber-100 p-4 rounded-lg border border-amber-200">
                            <h5 class="font-semibold text-sm mb-3 text-amber-700">⚙️ Configurazione</h5>
                            
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                ${Object.entries({
                                    azienda: 'Azienda',
                                    modello: 'Modello',
                                    colore: 'Colore',
                                    tipologia: 'Manuale/Motorizzato',
                                    sostEsistente: 'Sost. Esistente',
                                    guida: 'Guida',
                                    coloreGuida: 'Colore Guida'
                                }).map(([key, label]) => {
                                    const defaultVal = project.configTapparelle?.[key] || '';
                                    return `
                                        <div>
                                            <label class="text-xs">${label}</label>
                                            <input type="text" 
                                                   value="${tapp[key] || ''}"
                                                   placeholder="${defaultVal || '--'}"
                                                   onchange="updateProductWithRender('${project.id}', '${pos.id}', 'tapparelle', ${idx}, '${key}', this.value)"
                                                   class="w-full compact-input border rounded ${tapp[key] ? '' : 'bg-gray-50'}">
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- MOTORI SECTION - SOLO SE MOTORIZZATA -->
                        ${isMotorizzata ? `
                            <div class="bg-indigo-50 border-2 border-indigo-300 rounded-lg p-4">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-semibold text-sm text-indigo-700">🔌 Motori</h5>
                                    <button onclick="addMotoreTapparella('${project.id}', '${pos.id}', ${idx})"
                                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded text-sm font-semibold">
                                        + Aggiungi Motore
                                    </button>
                                </div>
                                
                                ${tapp.motori && tapp.motori.length > 0 ? `
                                    <div class="space-y-2">
                                        ${tapp.motori.map((motore, mIdx) => `
                                            <div class="bg-white p-3 rounded border border-indigo-200 flex justify-between items-center">
                                                <div class="flex-1">
                                                    <label class="text-xs font-medium">Modello Motore ${mIdx + 1}</label>
                                                    <input type="text" 
                                                           value="${motore.modello || ''}"
                                                           onchange="updateMotoreTapparella('${project.id}', '${pos.id}', ${idx}, ${mIdx}, this.value)"
                                                           placeholder="Es: Somfy RTS, Nice Era..."
                                                           class="w-full px-2 py-1 border rounded text-sm mt-1">
                                                </div>
                                                <button onclick="removeMotoreTapparella('${project.id}', '${pos.id}', ${idx}, ${mIdx})"
                                                        class="ml-2 bg-red-600 text-white rounded px-2 py-1 text-xs hover:bg-red-700">
                                                    ✕
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<p class="text-xs text-gray-600 italic">Nessun motore aggiunto</p>'}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderZanzariereTab(project, pos) {
            const products = pos.zanzariere || [];

            // Detect F or PF from infissi
            let detectedType = '';
            if (pos.infissi && pos.infissi.length > 0) {
                const infissoTipo = pos.infissi[0].tipo || '';
                if (infissoTipo.startsWith('PF')) {
                    detectedType = 'PF';
                } else if (infissoTipo.startsWith('F')) {
                    detectedType = 'F';
                }
            }

            return `
                <div class="space-y-4">
                    ${detectedType ? `
                        <div class="bg-green-50 border-2 border-green-300 rounded-lg p-3">
                            <p class="text-sm text-green-700 font-medium">
                                ✅ Tipo rilevato automaticamente dall'infisso: <strong>${detectedType}</strong>
                            </p>
                        </div>
                    ` : `
                        <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-3">
                            <p class="text-sm text-blue-700 font-medium">
                                ℹ️ Nessun infisso presente. Seleziona manualmente F o PF per ogni zanzariera.
                            </p>
                        </div>
                    `}

                    <button onclick="addProduct('${project.id}', '${pos.id}', 'zanzariere')"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium">
                        + Aggiungi Zanzariera
                    </button>

                    ${products.map((prod, idx) => renderZanzarieraDetail(project, pos, prod, idx, detectedType)).join('')}
                </div>
            `;
        }

        function renderZanzarieraDetail(project, pos, zanz, idx, detectedType) {
            // Use detected type or manual selection
            const tipoFPF = zanz.tipoFPF || detectedType || '';
            const isF = tipoFPF === 'F';
            const isPF = tipoFPF === 'PF';

            return `
                <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-green-300">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-bold text-green-700">🦟 Zanzariera ${idx + 1}</h4>
                        <button onclick="removeProduct('${project.id}', '${pos.id}', 'zanzariere', ${idx})"
                                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold">
                            🗑️ Elimina
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- TIPO F/PF -->
                        <div class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-4">
                            <h5 class="font-semibold text-sm mb-3 text-yellow-800">🎯 Tipo Infisso Associato</h5>
                            ${detectedType ? `
                                <div class="flex items-center gap-3">
                                    <span class="text-lg font-bold text-green-600">${detectedType}</span>
                                    <span class="text-sm text-gray-600">(rilevato automaticamente)</span>
                                    <button onclick="manualOverrideZanzariera('${project.id}', '${pos.id}', ${idx})"
                                            class="ml-auto px-3 py-1 bg-yellow-600 text-white rounded text-sm hover:bg-yellow-700">
                                        ✏️ Modifica Manualmente
                                    </button>
                                </div>
                            ` : `
                                <div>
                                    <label class="text-sm font-medium mb-2 block">Seleziona tipo:</label>
                                    <div class="flex gap-3">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="tipo-fpf-${pos.id}-${idx}" value="F"
                                                   ${isF ? 'checked' : ''}
                                                   onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariere', ${idx}, 'tipoFPF', 'F'); render();">
                                            <span class="font-semibold">F (Finestra)</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="tipo-fpf-${pos.id}-${idx}" value="PF"
                                                   ${isPF ? 'checked' : ''}
                                                   onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariere', ${idx}, 'tipoFPF', 'PF'); render();">
                                            <span class="font-semibold">PF (Porta Finestra)</span>
                                        </label>
                                    </div>
                                </div>
                            `}
                        </div>

                        <!-- DATI SPECIFICI -->
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <h5 class="font-semibold text-sm mb-3 text-green-700">📋 Dati Specifici</h5>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                <div>
                                    <label class="text-xs">Quantità</label>
                                    <select onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariere', ${idx}, 'qta', this.value)"
                                            class="w-full compact-input border rounded">
                                        ${[1,2,3,4,5,6,7,8,9,10].map(n => `<option value="${n}" ${(zanz.qta || 1) === n ? 'selected' : ''}>${n}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- CONFIGURAZIONE -->
                        <div class="bg-green-100 p-4 rounded-lg border border-green-200">
                            <h5 class="font-semibold text-sm mb-3 text-green-700">⚙️ Configurazione</h5>
                            
                            ${!tipoFPF ? `
                                <p class="text-sm text-gray-600 italic">⚠️ Seleziona prima se F o PF</p>
                            ` : `
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs">Azienda</label>
                                        <input type="text" 
                                               value="${zanz.azienda || ''}"
                                               placeholder="${project.configZanzariere?.azienda || '--'}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariere', ${idx}, 'azienda', this.value)"
                                               class="w-full compact-input border rounded">
                                    </div>
                                    
                                    ${isPF ? `
                                        <div>
                                            <label class="text-xs">Modello PF</label>
                                            <input type="text" 
                                                   value="${zanz.modelloPF || ''}"
                                                   placeholder="${project.configZanzariere?.modelloPF || '--'}"
                                                   onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariere', ${idx}, 'modelloPF', this.value)"
                                                   class="w-full compact-input border rounded">
                                        </div>
                                    ` : ''}
                                    
                                    ${isF ? `
                                        <div>
                                            <label class="text-xs">Modello F</label>
                                            <input type="text" 
                                                   value="${zanz.modelloF || ''}"
                                                   placeholder="${project.configZanzariere?.modelloF || '--'}"
                                                   onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariere', ${idx}, 'modelloF', this.value)"
                                                   class="w-full compact-input border rounded">
                                        </div>
                                    ` : ''}
                                    
                                    <div>
                                        <label class="text-xs">Colore</label>
                                        <input type="text" 
                                               value="${zanz.colore || ''}"
                                               placeholder="${project.configZanzariere?.colore || '--'}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariere', ${idx}, 'colore', this.value)"
                                               class="w-full compact-input border rounded">
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        window.manualOverrideZanzariera = (projectId, posId, idx) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.zanzariere && pos.zanzariere[idx]) {
                    pos.zanzariere[idx].tipoFPF = '';
                    saveState();
                    render();
                }
            }
        };

        function renderCassonettiTab(project, pos) {
            const products = pos.cassonetti || [];
            const canAdd = products.length === 0;

            return `
                <div class="space-y-4">
                    ${canAdd ? `
                        <button onclick="addProduct('${project.id}', '${pos.id}', 'cassonetti')"
                                class="px-4 py-2 bg-orange-600 text-white rounded-lg font-medium">
                            + Aggiungi Cassonetto
                        </button>
                    ` : `
                        <div class="bg-yellow-50 border border-yellow-300 rounded p-3 text-sm mb-4">
                            ⚠️ Solo un cassonetto per posizione
                        </div>
                    `}

                    ${products.map((prod, idx) => renderCassonettoDetail(project, pos, prod, idx)).join('')}
                </div>
            `;
        }

        function renderCassonettoDetail(project, pos, cass, idx) {
            return `
                <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-orange-300">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-bold text-orange-700">📦 Cassonetto</h4>
                        <button onclick="removeProduct('${project.id}', '${pos.id}', 'cassonetti', ${idx})"
                                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold">
                            🗑️ Elimina
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- DATI GENERALI -->
                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                            <h5 class="font-semibold text-sm mb-3 text-orange-700">📋 Dati Generali</h5>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                <div>
                                    <label class="text-xs">Quantità</label>
                                    <select onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetti', ${idx}, 'qta', this.value)"
                                            class="w-full compact-input border rounded">
                                        ${[1,2,3,4,5,6,7,8,9,10].map(n => `<option value="${n}" ${(cass.qta || 1) === n ? 'selected' : ''}>${n}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="text-xs">Tipo</label>
                                    <input type="text" 
                                           value="${cass.tipo || ''}"
                                           placeholder="${project.configCassonetti?.tipo || '--'}"
                                           onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetti', ${idx}, 'tipo', this.value)"
                                           class="w-full compact-input border rounded">
                                </div>
                                
                                ${Object.entries({
                                    azienda: 'Azienda',
                                    colore: 'Colore',
                                    sovrappSostit: 'Sovrapp/Sostit',
                                    aSoffitto: 'A Soffitto'
                                }).map(([key, label]) => {
                                    const defaultVal = project.configCassonetti?.[key] || '';
                                    return `
                                        <div>
                                            <label class="text-xs">${label}</label>
                                            <input type="text" 
                                                   value="${cass[key] || ''}"
                                                   placeholder="${defaultVal || '--'}"
                                                   onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetti', ${idx}, '${key}', this.value)"
                                                   class="w-full compact-input border rounded ${cass[key] ? '' : 'bg-gray-50'}">
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- MISURE CASSONETTO -->
                        <div class="bg-amber-50 p-4 rounded-lg border border-amber-200">
                            <h5 class="font-semibold text-sm mb-3 text-amber-700">📏 Misure Cassonetto (mm)</h5>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                ${['LS', 'SRSX', 'ZSX', 'SRDX', 'ZDX', 'HCASS', 'B', 'C', 'BSuperiore'].map(field => `
                                    <div>
                                        <label class="text-xs font-semibold">${field}</label>
                                        <input type="number" placeholder="0" value="${cass[field] || ''}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetti', ${idx}, '${field}', this.value)"
                                               class="w-full compact-input border rounded font-semibold">
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="mt-3 p-2 bg-yellow-100 rounded border border-yellow-400">
                                <p class="text-xs font-semibold text-yellow-800">ℹ️ Note:</p>
                                <p class="text-xs text-yellow-700">
                                    Se SRSX = ZSX → Muro a SX | Se SRDX = ZDX → Muro a DX
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderFotoTab(project, pos) {
            return `
                <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-700 mb-3">📸 Foto Posizione</h4>
                    
                    <div class="mb-3">
                        <input type="file" 
                               id="foto-input-${pos.id}" 
                               accept="image/*" 
                               onchange="addFoto('${project.id}', '${pos.id}', this)"
                               class="hidden">
                        <button onclick="document.getElementById('foto-input-${pos.id}').click()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold">
                            📷 Carica Foto
                        </button>
                        <p class="text-xs text-gray-600 mt-2">Click per selezionare un'immagine dal dispositivo</p>
                    </div>
                    
                    ${pos.foto && pos.foto.length > 0 ? `
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            ${pos.foto.map((foto, idx) => `
                                <div class="relative group">
                                    <img src="${foto.data}" 
                                         onclick="showFotoModal('${foto.data}')"
                                         class="w-full h-32 object-cover rounded-lg border-2 border-gray-300 cursor-pointer hover:border-blue-500 transition-all">
                                    <button onclick="removeFoto('${project.id}', '${pos.id}', ${idx})"
                                            class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                        ✕
                                    </button>
                                    <p class="text-xs text-center mt-1 text-gray-600">Foto ${idx + 1}</p>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p class="text-sm text-gray-500 italic">Nessuna foto caricata</p>'}
                </div>
            `;
        }

        // New Project Modal
        function NewProjectModal() {
            return `
                <div id="modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
                        <h3 class="text-xl font-bold mb-4">Nuovo Progetto</h3>
                        <input type="text" id="projectName" placeholder="Nome progetto" 
                               class="w-full px-3 py-2 border rounded-lg mb-3">
                        <input type="text" id="projectClient" placeholder="Cliente" 
                               class="w-full px-3 py-2 border rounded-lg mb-4">
                        <div class="flex gap-3">
                            <button onclick="hideModal()" 
                                    class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">
                                Annulla
                            </button>
                            <button onclick="createNewProject()" 
                                    class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium">
                                Crea
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function FotoModal() {
            return `
                <div id="foto-modal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50" onclick="hideFotoModal()">
                    <div class="relative max-w-4xl max-h-screen p-4">
                        <button onclick="hideFotoModal()" class="absolute top-2 right-2 bg-white text-black rounded-full w-10 h-10 flex items-center justify-center font-bold hover:bg-gray-200">
                            ✕
                        </button>
                        <img id="foto-modal-img" src="" class="max-w-full max-h-screen object-contain rounded-lg">
                    </div>
                </div>
            `;
        }

        // Window Functions
        window.showNewProjectModal = () => document.getElementById('modal').classList.remove('hidden');
        window.hideModal = () => document.getElementById('modal').classList.add('hidden');

        window.createNewProject = () => {
            const name = document.getElementById('projectName').value.trim();
            const client = document.getElementById('projectClient').value.trim();
            if (name && client) {
                createProject(name, client);
                hideModal();
                state.screen = 'project';
                render();
            }
        };

        window.goBack = () => {
            if (state.screen === 'position') {
                state.screen = 'project';
            } else {
                state.screen = 'list';
            }
            render();
        };

        window.openProject = (id) => {
            state.currentProject = id;
            state.screen = 'project';
            render();
        };

        window.openPosition = (id) => {
            state.currentPosition = id;
            state.screen = 'position';
            render();
        };

        window.switchPosition = (id) => {
            state.currentPosition = id;
            render();
        };

        window.setPositionTab = (posId, tab) => {
            const project = state.projects.find(p => p.id === state.currentProject);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos.activeTab = tab;
                    render();
                }
            }
        };

        // Update Functions
        window.updateProject = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                project[field] = value;
                saveState();
            }
        };

        window.updateClientData = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.clientData) project.clientData = {};
                project.clientData[field] = value;
                
                if (field === 'piano') {
                    project.positions.forEach(pos => {
                        if (!pos.piano) pos.piano = value;
                    });
                }
                saveState();
            }
        };

        window.updateProdotti = (projectId, product, checked) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.prodotti) project.prodotti = {};
                project.prodotti[product] = checked;
                saveState();
                render();
            }
        };

        window.updateConfigInfissi = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configInfissi) project.configInfissi = {};
                project.configInfissi[field] = value;
                saveState();
            }
        };

        window.updateConfigPersiane = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configPersiane) project.configPersiane = {};
                project.configPersiane[field] = value;
                saveState();
            }
        };

        window.updateFissaggioPersiane = (projectId, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configPersiane) project.configPersiane = {};
                project.configPersiane.fissaggio = value;
                saveState();
                
                const tipoTelaioContainer = document.getElementById(`tipo-telaio-persiane-container-${projectId}`);
                const coloreTelaioContainer = document.getElementById(`colore-telaio-persiane-container-${projectId}`);
                
                if (tipoTelaioContainer) {
                    tipoTelaioContainer.style.display = value === 'TELAIO' ? 'block' : 'none';
                }
                if (coloreTelaioContainer) {
                    coloreTelaioContainer.style.display = value === 'TELAIO' ? 'block' : 'none';
                }
            }
        };

        window.updateConfigTapparelle = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configTapparelle) project.configTapparelle = {};
                project.configTapparelle[field] = value;
                saveState();
            }
        };

        window.updateConfigZanzariere = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configZanzariere) project.configZanzariere = {};
                project.configZanzariere[field] = value;
                saveState();
            }
        };

        window.updateConfigCassonetti = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configCassonetti) project.configCassonetti = {};
                project.configCassonetti[field] = value;
                saveState();
            }
        };


        window.updateBRMConfig = (projectId, configKey, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project[configKey]) project[configKey] = {};
                project[configKey][field] = value;
                saveState();
                render();
            }
        };

        window.updateCaratteristicheMuro = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
                project.caratteristicheMuro[field] = value;
                saveState();
            }
        };

        window.updateGuidaEsistente = (projectId, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
                project.caratteristicheMuro.guidaEsistente = value;
                saveState();
                
                const guidaFields = document.getElementById(`guida-fields-${projectId}`);
                if (guidaFields) {
                    guidaFields.style.display = value === 'si' ? 'block' : 'none';
                }
            }
        };

        window.updateFalsoEsistente = (projectId, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
                project.caratteristicheMuro.falsoEsistente = value;
                saveState();
                
                const falsoSiFields = document.getElementById(`falso-si-fields-${projectId}`);
                const falsoNoFields = document.getElementById(`falso-no-fields-${projectId}`);
                if (falsoSiFields && falsoNoFields) {
                    falsoSiFields.style.display = value === 'si' ? 'block' : 'none';
                    falsoNoFields.style.display = value === 'no' ? 'block' : 'none';
                }
            }
        };

        window.updatePosition = (projectId, posId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos[field] = value;
                    saveState();
                }
            }
        };

        window.updateMisura = (projectId, posId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    if (!pos.misure) pos.misure = {};
                    pos.misure[field] = value;
                    saveState();
                }
            }
        };

        window.enableOverride = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos.overrideCaratteristiche = true;
                    pos.caratteristicheMuroOverride = {...project.caratteristicheMuro};
                    saveState();
                    render();
                }
            }
        };

        window.disableOverride = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos.overrideCaratteristiche = false;
                    pos.caratteristicheMuroOverride = null;
                    saveState();
                    render();
                }
            }
        };


        window.updateBRMConfig = (projectId, configKey, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project[configKey]) project[configKey] = {};
                project[configKey][field] = value;
                saveState();
                render();
            }
        };

        window.updateCaratteristicheMuroOverride = (projectId, posId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.caratteristicheMuroOverride) {
                    pos.caratteristicheMuroOverride[field] = value;
                    saveState();
                }
            }
        };


        window.updateBRMConfig = (projectId, configKey, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project[configKey]) project[configKey] = {};
                project[configKey][field] = value;
                saveState();
                render();
            }
        };

        window.updateCaratteristicheMuroOverrideWithRender = (projectId, posId, field, value) => {
            updateCaratteristicheMuroOverride(projectId, posId, field, value);
            render();
        };

        // Product Functions

        window.toggleNoteVisibility = (projectId, posId, type, checked) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    if (!pos.noteVisibilita) pos.noteVisibilita = [];
                    pos.noteVisibilita = [];
                    if (checked) {
                        pos.noteVisibilita = type === 'entrambi' ? ['entrambi'] : [type];
                    }
                    saveState();
                    render();
                }
            }
        };

        window.toggleProductNoteVisibility = (projectId, posId, productType, idx, type, checked) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos[productType] && pos[productType][idx]) {
                    if (!pos[productType][idx].noteVisibilita) pos[productType][idx].noteVisibilita = [];
                    pos[productType][idx].noteVisibilita = [];
                    if (checked) {
                        pos[productType][idx].noteVisibilita = type === 'entrambi' ? ['entrambi'] : [type];
                    }
                    saveState();
                    render();
                }
            }
        };

        window.addProduct = (projectId, posId, type) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    if (!pos[type]) pos[type] = [];
                    
                    const config = type === 'infissi' ? project.configInfissi :
                                  type === 'persiane' ? project.configPersiane :
                                  type === 'tapparelle' ? project.configTapparelle :
                                  type === 'zanzariere' ? project.configZanzariere :
                                  project.configCassonetti;
                    
                    const product = {
                        qta: 1,
                        ...config
                    };
                    
                    // Add motori array if tapparella
                    if (type === 'tapparelle') {
                        product.motori = [];
                    }
                    
                    // Auto-detect F/PF for zanzariere
                    if (type === 'zanzariere') {
                        let detectedType = '';
                        if (pos.infissi && pos.infissi.length > 0) {
                            const infissoTipo = pos.infissi[0].tipo || '';
                            if (infissoTipo.startsWith('PF')) {
                                detectedType = 'PF';
                            } else if (infissoTipo.startsWith('F')) {
                                detectedType = 'F';
                            }
                        }
                        if (detectedType) {
                            product.tipoFPF = detectedType;
                        }
                    }
                    
                    pos[type].push(product);
                    saveState();
                    showNotification(`${type.slice(0, -1)} aggiunto`, 'success');
                    render();
                }
            }
        };

        window.updateProduct = (projectId, posId, type, idx, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos[type] && pos[type][idx]) {
                    pos[type][idx][field] = value;
                    saveState();
                }
            }
        };

        window.updateProductWithRender = (projectId, posId, type, idx, field, value) => {
            updateProduct(projectId, posId, type, idx, field, value);
            render();
        };

        window.removeProduct = (projectId, posId, type, idx) => {
            if (confirm('Eliminare questo prodotto?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos[type]) {
                        pos[type].splice(idx, 1);
                        saveState();
                        showNotification('Prodotto eliminato', 'info');
                        render();
                    }
                }
            }
        };

        window.deletePosition = (projectId, posId) => {
            if (confirm('Sei sicuro di voler eliminare questa posizione? Tutti i dati verranno persi.')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    project.positions = project.positions.filter(p => p.id !== posId);
                    saveState();
                    
                    if (project.positions.length > 0) {
                        state.currentPosition = project.positions[0].id;
                        state.screen = 'position';
                    } else {
                        state.screen = 'project';
                    }
                    render();
                }
            }
        };

        // Motor Functions for Tapparelle
        window.addMotoreTapparella = (projectId, posId, tappIdx) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.tapparelle && pos.tapparelle[tappIdx]) {
                    if (!pos.tapparelle[tappIdx].motori) {
                        pos.tapparelle[tappIdx].motori = [];
                    }
                    pos.tapparelle[tappIdx].motori.push({ modello: '' });
                    saveState();
                    render();
                }
            }
        };

        window.updateMotoreTapparella = (projectId, posId, tappIdx, motoreIdx, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.tapparelle && pos.tapparelle[tappIdx] && pos.tapparelle[tappIdx].motori) {
                    pos.tapparelle[tappIdx].motori[motoreIdx].modello = value;
                    saveState();
                }
            }
        };

        window.removeMotoreTapparella = (projectId, posId, tappIdx, motoreIdx) => {
            if (confirm('Eliminare questo motore?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos.tapparelle && pos.tapparelle[tappIdx] && pos.tapparelle[tappIdx].motori) {
                        pos.tapparelle[tappIdx].motori.splice(motoreIdx, 1);
                        saveState();
                        render();
                    }
                }
            }
        };

        // Foto Functions
        window.addFoto = (projectId, posId, input) => {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const project = state.projects.find(p => p.id === projectId);
                    if (project) {
                        const pos = project.positions.find(p => p.id === posId);
                        if (pos) {
                            if (!pos.foto) pos.foto = [];
                            pos.foto.push({
                                data: e.target.result,
                                timestamp: new Date().toISOString()
                            });
                            saveState();
                            showNotification('Foto aggiunta', 'success');
                            render();
                        }
                    }
                };
                reader.readAsDataURL(file);
            }
        };

        window.removeFoto = (projectId, posId, fotoIdx) => {
            if (confirm('Sei sicuro di voler eliminare questa foto?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos.foto) {
                        pos.foto.splice(fotoIdx, 1);
                        saveState();
                        render();
                    }
                }
            }
        };

        window.addFotoPersiana = (projectId, posId, persianaIdx, input) => {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const project = state.projects.find(p => p.id === projectId);
                    if (project) {
                        const pos = project.positions.find(p => p.id === posId);
                        if (pos && pos.persiane && pos.persiane[persianaIdx]) {
                            pos.persiane[persianaIdx].foto = {
                                data: e.target.result,
                                timestamp: new Date().toISOString()
                            };
                            saveState();
                            render();
                        }
                    }
                };
                reader.readAsDataURL(file);
            }
            input.value = '';
        };

        window.removeFotoPersiana = (projectId, posId, persianaIdx) => {
            if (confirm('Sei sicuro di voler eliminare questa foto?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos.persiane && pos.persiane[persianaIdx]) {
                        pos.persiane[persianaIdx].foto = null;
                        saveState();
                        render();
                    }
                }
            }
        };

        window.showFotoModal = (fotoData) => {
            const modal = document.getElementById('foto-modal');
            const img = document.getElementById('foto-modal-img');
            if (modal && img) {
                img.src = fotoData;
                modal.classList.remove('hidden');
            }
        };

        window.hideFotoModal = () => {
            const modal = document.getElementById('foto-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        };

        // Export Function
        window.exportData = () => {
            const dataStr = JSON.stringify(state, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', `open-porte-${new Date().toISOString().split('T')[0]}.json`);
            link.click();
            showNotification('Dati esportati', 'success');
        };

        // Main Render Function
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = `
                ${Header()}
                <main class="min-h-screen">
                    ${state.screen === 'list' ? ProjectsList() :
                      state.screen === 'position' ? PositionDetail() :
                      ProjectSetup()}
                </main>
                ${NewProjectModal()}
                ${FotoModal()}
            `;
        }

        // Initialize App
        loadState();
        render();
    </script>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- MODAL EXPORT PDF/EXCEL - FASE 16 -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div id="exportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-amber-800">📤 Esporta Progetto</h2>
                    <button onclick="closeExportModal()" class="text-gray-500 hover:text-gray-700">
                        <span class="text-3xl font-bold">×</span>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <!-- Tipo Export -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-3">📋 Tipo di Export</label>
                        <div class="space-y-2">
                            <label class="flex items-start p-3 border-2 border-amber-300 rounded-lg cursor-pointer hover:bg-amber-50 transition">
                                <input type="radio" name="exportType" value="ordine" checked class="mt-1 mr-3">
                                <div>
                                    <div class="font-semibold text-amber-800">📦 Export per Ordine</div>
                                    <div class="text-sm text-gray-600">Solo BRM e configurazioni prodotti per l'ordine</div>
                                </div>
                            </label>
                            <label class="flex items-start p-3 border-2 border-amber-300 rounded-lg cursor-pointer hover:bg-amber-50 transition">
                                <input type="radio" name="exportType" value="posa" class="mt-1 mr-3">
                                <div>
                                    <div class="font-semibold text-amber-800">🔧 Export per Posa</div>
                                    <div class="text-sm text-gray-600">Misure complete, foto e note per la posa</div>
                                </div>
                            </label>
                            <label class="flex items-start p-3 border-2 border-amber-300 rounded-lg cursor-pointer hover:bg-amber-50 transition">
                                <input type="radio" name="exportType" value="completo" class="mt-1 mr-3">
                                <div>
                                    <div class="font-semibold text-amber-800">📋 Export Completo</div>
                                    <div class="text-sm text-gray-600">Tutti i dati, foto e note complete</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Formato Export -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-3">💾 Formato File</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="exportProject('pdf')" 
                                    class="flex items-center justify-center gap-2 p-4 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold transition shadow-lg hover:shadow-xl">
                                <span class="text-2xl">📄</span>
                                <span>Export PDF</span>
                            </button>
                            <button onclick="exportProject('excel')" 
                                    class="flex items-center justify-center gap-2 p-4 bg-green-500 hover:bg-green-600 text-white rounded-lg font-semibold transition shadow-lg hover:shadow-xl">
                                <span class="text-2xl">📊</span>
                                <span>Export Excel</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="text-xs text-gray-500 text-center pt-4 border-t">
                        💡 Le note verranno incluse secondo la visibilità selezionata (Ordine/Posa/Entrambi)
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
