<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Porte v1.6 - Rilievo Misure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { overscroll-behavior-y: contain; }
        input, select, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>
    <script>
        let state = {
            screen: 'list',
            projects: [],
            currentProject: null
        };

        function loadState() {
            const saved = localStorage.getItem('openPorteData');
            if (saved) state = JSON.parse(saved);
        }

        function saveState() {
            localStorage.setItem('openPorteData', JSON.stringify(state));
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function addProject(name, client) {
            const project = {
                id: generateId(),
                name,
                client,
                clientData: {},
                caratteristicheMuro: {},
                positions: [],
                createdAt: new Date().toISOString()
            };
            state.projects.push(project);
            saveState();
            render();
        }

        function addPosition(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = {
                    id: generateId(),
                    name: 'Posizione #' + (project.positions.length + 1),
                    piano: '',
                    ambiente: '',
                    misure: {},
                    infissi: [],
                    persiane: [],
                    cassonetti: [],
                    note: '',
                    foto: []
                };
                project.positions.push(pos);
                saveState();
                // Apri la posizione appena creata
                state.currentPosition = pos.id;
                state.screen = 'position';
                render();
            }
        }

        function Header() {
            return `
                <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
                    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                        <div class="flex items-center">
                            ${state.screen === 'position' ? `
                                <button onclick="state.screen='project'; render()" class="mr-4 p-2 hover:bg-white/20 rounded">‚Üê Indietro</button>
                            ` : state.screen !== 'list' ? `
                                <button onclick="state.screen='list'; render()" class="mr-4 p-2 hover:bg-white/20 rounded">‚Üê Indietro</button>
                            ` : ''}
                            <h1 class="text-2xl font-bold">Open Porte v1.7</h1>
                        </div>
                        ${state.screen === 'list' ? `
                            <button onclick="showNewProjectModal()" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-semibold">+ Nuovo Progetto</button>
                        ` : ''}
                    </div>
                </header>
            `;
        }

        function ProjectsList() {
            if (state.projects.length === 0) {
                return `
                    <div class="text-center py-16">
                        <p class="text-gray-500 mb-4">Nessun progetto</p>
                        <button onclick="showNewProjectModal()" class="bg-blue-600 text-white px-6 py-3 rounded-lg">Crea Progetto</button>
                    </div>
                `;
            }

            return `
                <div class="grid gap-4">
                    ${state.projects.map(p => `
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold">${p.name}</h3>
                            <p class="text-gray-600">Cliente: ${p.client}</p>
                            <p class="text-sm text-gray-500 mt-2">${p.positions.length} posizioni</p>
                            <button onclick="openProject('${p.id}')" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">Apri</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function PositionDetail() {
            const project = state.projects.find(p => p.id === state.currentProject);
            const pos = project?.positions.find(p => p.id === state.currentPosition);
            
            if (!pos || !project) return '<p>Posizione non trovata</p>';

            const tab = pos.activeTab || 'ambiente';

            return `
                <div class="space-y-4">
                    <!-- SELETTORE POSIZIONI + AGGIUNGI -->
                    <div class="bg-white rounded-lg shadow p-4">
                        <div class="flex gap-3 items-center">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Posizione Corrente</label>
                                <select onchange="switchPosition(this.value)" 
                                        class="w-full px-3 py-2 border rounded-lg font-semibold">
                                    ${project.positions.map(p => `
                                        <option value="${p.id}" ${p.id === pos.id ? 'selected' : ''}>
                                            ${p.name} ${p.piano ? '- ' + p.piano : ''} ${p.ambiente ? '- ' + p.ambiente : ''}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            ${project.positions.length > 1 ? `
                            <button onclick="deletePosition('${project.id}', '${pos.id}')" 
                                    class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold whitespace-nowrap mt-6">
                                üóëÔ∏è Elimina
                            </button>
                            ` : ''}
                            <button onclick="addPosition('${project.id}')" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold whitespace-nowrap mt-6">
                                + Aggiungi Posizione
                            </button>
                        </div>
                    </div>

                    <!-- CARD POSIZIONE -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <!-- HEADER CON NOME POSIZIONE -->
                        <div class="mb-4">
                            <input type="text" value="${pos.name}" 
                                   onchange="updatePosition('${project.id}', '${pos.id}', {name: this.value})"
                                   class="text-2xl font-bold border-b-2 bg-transparent outline-none w-full">
                        </div>

                        <!-- TABS -->
                        <div class="border-b mb-4">
                            <div class="flex space-x-4 overflow-x-auto">
                                <button onclick="setTab('${pos.id}', 'ambiente')" 
                                        class="px-4 py-2 font-semibold whitespace-nowrap ${tab === 'ambiente' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500'}">
                                    üè† Ambiente
                                </button>
                                <button onclick="setTab('${pos.id}', 'misure')" 
                                        class="px-4 py-2 font-semibold whitespace-nowrap ${tab === 'misure' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500'}">
                                    üìè Misure
                                </button>
                                ${project.prodotti?.infissi ? `
                                    <button onclick="setTab('${pos.id}', 'infissi')" 
                                            class="px-4 py-2 font-semibold whitespace-nowrap ${tab === 'infissi' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500'}">
                                        ü™ü Infissi
                                    </button>
                                ` : ''}
                                ${project.prodotti?.persiane ? `
                                    <button onclick="setTab('${pos.id}', 'persiane')" 
                                            class="px-4 py-2 font-semibold whitespace-nowrap ${tab === 'persiane' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500'}">
                                        üö™ Persiane
                                    </button>
                                ` : ''}
                                ${project.prodotti?.cassonetti ? `
                                    <button onclick="setTab('${pos.id}', 'cassonetti')" 
                                            class="px-4 py-2 font-semibold whitespace-nowrap ${tab === 'cassonetti' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500'}">
                                        üì¶ Cassonetti
                                    </button>
                                ` : ''}
                            </div>
                        </div>

                        <!-- CONTENUTO TAB -->
                        <div class="mt-4">
                            ${getTabContent(project, pos)}
                        </div>
                    </div>
                </div>
            `;
        }

        function ProjectDetail() {
            const project = state.projects.find(p => p.id === state.currentProject);
            if (!project) return '<p>Progetto non trovato</p>';

            return `
                <div class="space-y-6">
                    <!-- HEADER PROGETTO -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold">${project.name}</h2>
                                <p class="text-gray-600">Cliente: ${project.client}</p>
                            </div>
                        </div>
                    </div>

                    <!-- ACCORDION DATI CLIENTE -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="p-4 cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors flex justify-between items-center" 
                             onclick="toggleAccordion('client-accordion-${project.id}')">
                            <h3 class="font-semibold text-lg">üìã Dati Cliente</h3>
                            <span id="arrow-client-accordion-${project.id}" class="text-xl transition-transform">‚ñº</span>
                        </div>
                        <div id="client-accordion-${project.id}" class="p-4 border-t" style="display: none;">
                            <div class="grid grid-cols-2 gap-3">
                                <input type="text" placeholder="Citt√†" value="${project.clientData?.citta || ''}" 
                                       onchange="updateClientData('${project.id}', 'citta', this.value)" 
                                       class="px-3 py-2 border rounded">
                                <input type="text" placeholder="Via" value="${project.clientData?.via || ''}" 
                                       onchange="updateClientData('${project.id}', 'via', this.value)" 
                                       class="px-3 py-2 border rounded">
                                <input type="tel" placeholder="Telefono" value="${project.clientData?.telefono || ''}" 
                                       onchange="updateClientData('${project.id}', 'telefono', this.value)" 
                                       class="px-3 py-2 border rounded">
                                <input type="email" placeholder="Email" value="${project.clientData?.email || ''}" 
                                       onchange="updateClientData('${project.id}', 'email', this.value)" 
                                       class="px-3 py-2 border rounded">
                            </div>
                        </div>
                    </div>

                    <!-- ACCORDION CARATTERISTICHE MURO -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="p-4 cursor-pointer bg-blue-50 hover:bg-blue-100 transition-colors flex justify-between items-center" 
                             onclick="toggleAccordion('muro-accordion-${project.id}')">
                            <h3 class="font-semibold text-lg">üèóÔ∏è Caratteristiche Muro (Globali) - Misure in MM</h3>
                            <span id="arrow-muro-accordion-${project.id}" class="text-xl transition-transform">‚ñº</span>
                        </div>
                        <div id="muro-accordion-${project.id}" class="p-4 border-t" style="display: none;">
                                    <!-- RIGA 1 -->
                                    <div class="grid grid-cols-3 gap-2">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Prof. Muro Int.</label>
                                            <input type="number" placeholder="0" 
                                                   value="${project.caratteristicheMuro?.profMuroInt || ''}"
                                                   onchange="updateCaratteristicheMuro('${project.id}', 'profMuroInt', this.value)"
                                                   class="w-full px-2 py-1 border rounded text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Prof. Piana Sopra</label>
                                            <input type="number" placeholder="0" 
                                                   value="${project.caratteristicheMuro?.profPianaSopra || ''}"
                                                   onchange="updateCaratteristicheMuro('${project.id}', 'profPianaSopra', this.value)"
                                                   class="w-full px-2 py-1 border rounded text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Prof. Piana Sotto</label>
                                            <input type="number" placeholder="0" 
                                                   value="${project.caratteristicheMuro?.profPianaSotto || ''}"
                                                   onchange="updateCaratteristicheMuro('${project.id}', 'profPianaSotto', this.value)"
                                                   class="w-full px-2 py-1 border rounded text-sm">
                                        </div>
                                    </div>

                                    <!-- RIGA 2 -->
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Telaio Prof.</label>
                                            <input type="number" placeholder="0" 
                                                   value="${project.caratteristicheMuro?.telaioProfondita || ''}"
                                                   onchange="updateCaratteristicheMuro('${project.id}', 'telaioProfondita', this.value)"
                                                   class="w-full px-2 py-1 border rounded text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Telaio Largh.</label>
                                            <input type="number" placeholder="0" 
                                                   value="${project.caratteristicheMuro?.telaioLarghezza || ''}"
                                                   onchange="updateCaratteristicheMuro('${project.id}', 'telaioLarghezza', this.value)"
                                                   class="w-full px-2 py-1 border rounded text-sm">
                                        </div>
                                    </div>

                                    <!-- RIGA 3 -->
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Delta Int.</label>
                                            <input type="number" placeholder="0" 
                                                   value="${project.caratteristicheMuro?.deltaInt || ''}"
                                                   onchange="updateCaratteristicheMuro('${project.id}', 'deltaInt', this.value)"
                                                   class="w-full px-2 py-1 border rounded text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Delta Est.</label>
                                            <input type="number" placeholder="0" 
                                                   value="${project.caratteristicheMuro?.deltaEst || ''}"
                                                   onchange="updateCaratteristicheMuro('${project.id}', 'deltaEst', this.value)"
                                                   class="w-full px-2 py-1 border rounded text-sm">
                                        </div>
                                    </div>

                                    <!-- Guida esistente -->
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Guida Esistente?</label>
                                        <select id="guida-select-${project.id}" 
                                                onchange="updateGuidaEsistente('${project.id}', this.value)"
                                                class="w-1/2 px-2 py-1 border rounded text-sm">
                                            <option value="">Seleziona...</option>
                                            <option value="si" ${project.caratteristicheMuro?.guidaEsistente === 'si' ? 'selected' : ''}>S√¨</option>
                                            <option value="no" ${project.caratteristicheMuro?.guidaEsistente === 'no' ? 'selected' : ''}>No</option>
                                        </select>
                                    </div>

                                    <div id="guida-fields-${project.id}" style="display: ${project.caratteristicheMuro?.guidaEsistente === 'si' ? 'block' : 'none'}">
                                        <div class="grid grid-cols-3 gap-2 bg-green-50 p-2 rounded">
                                            <div>
                                                <label class="block text-xs font-medium text-green-700 mb-1">Prof. Distanziale</label>
                                                <input type="number" placeholder="0" 
                                                       value="${project.caratteristicheMuro?.profDistanziale || ''}"
                                                       onchange="updateCaratteristicheMuro('${project.id}', 'profDistanziale', this.value)"
                                                       class="w-full px-2 py-1 border rounded text-sm">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-green-700 mb-1">Prof. Guida</label>
                                                <input type="number" placeholder="0" 
                                                       value="${project.caratteristicheMuro?.profGuida || ''}"
                                                       onchange="updateCaratteristicheMuro('${project.id}', 'profGuida', this.value)"
                                                       class="w-full px-2 py-1 border rounded text-sm">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-green-700 mb-1">Largh. Guida</label>
                                                <input type="number" placeholder="0" 
                                                       value="${project.caratteristicheMuro?.larghezzaGuida || ''}"
                                                       onchange="updateCaratteristicheMuro('${project.id}', 'larghezzaGuida', this.value)"
                                                       class="w-full px-2 py-1 border rounded text-sm">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Prof Muro Est -->
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Prof. Muro Est.</label>
                                        <input type="number" placeholder="0" 
                                               value="${project.caratteristicheMuro?.profMuroEst || ''}"
                                               onchange="updateCaratteristicheMuro('${project.id}', 'profMuroEst', this.value)"
                                               class="w-1/2 px-2 py-1 border rounded text-sm">
                                    </div>

                                    <!-- Falso esistente -->
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Falso Esistente?</label>
                                        <select id="falso-select-${project.id}"
                                                onchange="updateFalsoEsistente('${project.id}', this.value)"
                                                class="w-1/2 px-2 py-1 border rounded text-sm">
                                            <option value="">Seleziona...</option>
                                            <option value="si" ${project.caratteristicheMuro?.falsoEsistente === 'si' ? 'selected' : ''}>S√¨</option>
                                            <option value="no" ${project.caratteristicheMuro?.falsoEsistente === 'no' ? 'selected' : ''}>No</option>
                                        </select>
                                    </div>

                                    <div id="falso-si-fields-${project.id}" style="display: ${project.caratteristicheMuro?.falsoEsistente === 'si' ? 'block' : 'none'}">
                                        <div class="bg-orange-50 p-2 rounded space-y-2">
                                            <div>
                                                <label class="block text-xs font-medium text-orange-700 mb-1">Spessore Falso</label>
                                                <input type="number" placeholder="0" 
                                                       value="${project.caratteristicheMuro?.spessoreFalso || ''}"
                                                       onchange="updateCaratteristicheMuro('${project.id}', 'spessoreFalso', this.value)"
                                                       class="w-1/2 px-2 py-1 border rounded text-sm">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-orange-700 mb-1">+ Distanza Falso/Infisso</label>
                                                <input type="number" placeholder="0" 
                                                       value="${project.caratteristicheMuro?.distanzaFalsoInfisso || ''}"
                                                       onchange="updateCaratteristicheMuro('${project.id}', 'distanzaFalsoInfisso', this.value)"
                                                       class="w-1/2 px-2 py-1 border rounded text-sm">
                                            </div>
                                        </div>
                                    </div>

                                    <div id="falso-no-fields-${project.id}" style="display: ${project.caratteristicheMuro?.falsoEsistente === 'no' ? 'block' : 'none'}">
                                        <div class="bg-purple-50 p-2 rounded">
                                            <label class="block text-xs font-medium text-purple-700 mb-1">Distanza Muro/Infisso</label>
                                            <input type="number" placeholder="0" 
                                                   value="${project.caratteristicheMuro?.distanzaMuroInfisso || ''}"
                                                   onchange="updateCaratteristicheMuro('${project.id}', 'distanzaMuroInfisso', this.value)"
                                                   class="w-1/2 px-2 py-1 border rounded text-sm">
                                        </div>
                                    </div>
                            </div>
                        </div>
                    </div>

                    <!-- ACCORDION CONFIGURAZIONE INFISSI GLOBALE -->
                    ${project.prodotti?.infissi ? `
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="p-4 cursor-pointer bg-green-50 hover:bg-green-100 transition-colors flex justify-between items-center" 
                                 onclick="toggleAccordion('infissi-config-${project.id}')">
                                <h3 class="font-semibold text-lg">ü™ü Configurazione Infissi Globale</h3>
                                <span id="arrow-infissi-config-${project.id}" class="text-xl transition-transform">‚ñº</span>
                            </div>
                            <div id="infissi-config-${project.id}" class="p-4 border-t" style="display: none;">
                                <!-- Toggle sostituzione -->
                                <div class="mb-4 p-3 bg-yellow-50 rounded">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‚ö†Ô∏è Verranno sostituiti infissi?</label>
                                    <select id="sostituisci-infissi-${project.id}"
                                            onchange="toggleSostituzioneInfissi('${project.id}', this.value)"
                                            class="w-1/3 px-3 py-2 border rounded">
                                        <option value="">Seleziona...</option>
                                        <option value="si" ${project.configInfissi?.sostituisci === 'si' ? 'selected' : ''}>S√¨</option>
                                        <option value="no" ${project.configInfissi?.sostituisci === 'no' ? 'selected' : ''}>No</option>
                                    </select>
                                </div>

                                <div id="config-infissi-fields-${project.id}" style="display: ${project.configInfissi?.sostituisci === 'si' ? 'block' : 'none'}">
                                    <div class="space-y-3">
                                        <!-- 1. Azienda -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">1. Azienda</label>
                                            <select onchange="updateConfigInfissi('${project.id}', 'azienda', this.value)"
                                                    class="w-full md:w-1/2 px-3 py-2 border rounded">
                                                <option value="">Seleziona...</option>
                                                <option value="finstral" ${project.configInfissi?.azienda === 'finstral' ? 'selected' : ''}>FINSTRAL</option>
                                                <option value="essepi" disabled>ESSEPI (prossimamente)</option>
                                            </select>
                                        </div>

                                        <!-- 2. Finitura Interna -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">2. Finitura Interna</label>
                                            <select onchange="updateConfigInfissi('${project.id}', 'finituraInt', this.value)"
                                                    class="w-full md:w-1/2 px-3 py-2 border rounded">
                                                <option value="">Seleziona...</option>
                                                <option value="pvc" ${project.configInfissi?.finituraInt === 'pvc' ? 'selected' : ''}>PVC</option>
                                                <option value="legno" ${project.configInfissi?.finituraInt === 'legno' ? 'selected' : ''}>LEGNO</option>
                                                <option value="alluminio" ${project.configInfissi?.finituraInt === 'alluminio' ? 'selected' : ''}>ALLUMINIO</option>
                                                <option value="ceramica" ${project.configInfissi?.finituraInt === 'ceramica' ? 'selected' : ''}>CERAMICA</option>
                                            </select>
                                        </div>

                                        <!-- 3. Finitura Esterna -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">3. Finitura Esterna</label>
                                            <select onchange="updateConfigInfissi('${project.id}', 'finituraEst', this.value)"
                                                    class="w-full md:w-1/2 px-3 py-2 border rounded">
                                                <option value="">Seleziona...</option>
                                                <option value="pvc" ${project.configInfissi?.finituraEst === 'pvc' ? 'selected' : ''}>PVC</option>
                                                <option value="alluminio" ${project.configInfissi?.finituraEst === 'alluminio' ? 'selected' : ''}>ALLUMINIO</option>
                                                <option value="ceramica" ${project.configInfissi?.finituraEst === 'ceramica' ? 'selected' : ''}>CERAMICA</option>
                                            </select>
                                        </div>

                                        <!-- 4. Colore Interno -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">4. Colore Interno</label>
                                            <input type="text" placeholder="Es: Bianco, RAL 9010, ecc."
                                                   value="${project.configInfissi?.coloreInt || ''}"
                                                   onchange="updateConfigInfissi('${project.id}', 'coloreInt', this.value)"
                                                   class="w-full md:w-1/2 px-3 py-2 border rounded">
                                        </div>

                                        <!-- 5. Colore Esterno -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">5. Colore Esterno</label>
                                            <input type="text" placeholder="Es: Marrone, RAL 8014, ecc."
                                                   value="${project.configInfissi?.coloreEst || ''}"
                                                   onchange="updateConfigInfissi('${project.id}', 'coloreEst', this.value)"
                                                   class="w-full md:w-1/2 px-3 py-2 border rounded">
                                        </div>

                                        <!-- 6. Tipo Anta -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">6. Tipo Anta</label>
                                            <select onchange="updateConfigInfissi('${project.id}', 'tipoAnta', this.value)"
                                                    class="w-full md:w-1/2 px-3 py-2 border rounded">
                                                <option value="">Seleziona...</option>
                                                <option value="step-line" ${project.configInfissi?.tipoAnta === 'step-line' ? 'selected' : ''}>STEP-LINE</option>
                                                <option value="nova-line" ${project.configInfissi?.tipoAnta === 'nova-line' ? 'selected' : ''}>NOVA-LINE</option>
                                                <option value="slim-line" ${project.configInfissi?.tipoAnta === 'slim-line' ? 'selected' : ''}>SLIM-LINE</option>
                                                <option value="classic-line" ${project.configInfissi?.tipoAnta === 'classic-line' ? 'selected' : ''}>CLASSIC-LINE</option>
                                                <option value="step-line-door" ${project.configInfissi?.tipoAnta === 'step-line-door' ? 'selected' : ''}>STEP-LINE DOOR</option>
                                            </select>
                                        </div>

                                        <!-- 7. Telaio -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">7. Telaio</label>
                                            <select onchange="updateConfigInfissi('${project.id}', 'telaio', this.value)"
                                                    class="w-full md:w-1/2 px-3 py-2 border rounded">
                                                <option value="">Seleziona...</option>
                                                <option value="961" ${project.configInfissi?.telaio === '961' ? 'selected' : ''}>961</option>
                                                <option value="962" ${project.configInfissi?.telaio === '962' ? 'selected' : ''}>962</option>
                                                <option value="966" ${project.configInfissi?.telaio === '966' ? 'selected' : ''}>966</option>
                                                <option value="965" ${project.configInfissi?.telaio === '965' ? 'selected' : ''}>965</option>
                                            </select>
                                        </div>

                                        <!-- 8. Allarme -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">8. Allarme</label>
                                            <select onchange="updateConfigInfissi('${project.id}', 'allarme', this.value)"
                                                    class="w-full md:w-1/2 px-3 py-2 border rounded">
                                                <option value="">Seleziona...</option>
                                                <option value="si" ${project.configInfissi?.allarme === 'si' ? 'selected' : ''}>S√¨</option>
                                                <option value="no" ${project.configInfissi?.allarme === 'no' ? 'selected' : ''}>No</option>
                                            </select>
                                        </div>

                                        <!-- 9. Vetro -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">9. Vetro</label>
                                            <select onchange="updateConfigInfissi('${project.id}', 'vetro', this.value)"
                                                    class="w-full md:w-1/2 px-3 py-2 border rounded">
                                                <option value="">Seleziona...</option>
                                                <option value="doppio" ${project.configInfissi?.vetro === 'doppio' ? 'selected' : ''}>doppio</option>
                                                <option value="doppio-sat" ${project.configInfissi?.vetro === 'doppio-sat' ? 'selected' : ''}>doppio sat</option>
                                                <option value="triplo" ${project.configInfissi?.vetro === 'triplo' ? 'selected' : ''}>triplo</option>
                                                <option value="triplo-sat" ${project.configInfissi?.vetro === 'triplo-sat' ? 'selected' : ''}>triplo sat</option>
                                            </select>
                                        </div>

                                        <!-- 10. Tagli Telaio -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">10. Tagli Telaio</label>
                                            <select onchange="updateConfigInfissi('${project.id}', 'tagliTelaio', this.value)"
                                                    class="w-full md:w-1/2 px-3 py-2 border rounded">
                                                <option value="">Seleziona...</option>
                                                <option value="sopra" ${project.configInfissi?.tagliTelaio === 'sopra' ? 'selected' : ''}>sopra</option>
                                                <option value="sotto" ${project.configInfissi?.tagliTelaio === 'sotto' ? 'selected' : ''}>sotto</option>
                                                <option value="sopra-sotto" ${project.configInfissi?.tagliTelaio === 'sopra-sotto' ? 'selected' : ''}>sopra/sotto</option>
                                                <option value="dx" ${project.configInfissi?.tagliTelaio === 'dx' ? 'selected' : ''}>dx</option>
                                                <option value="sx" ${project.configInfissi?.tagliTelaio === 'sx' ? 'selected' : ''}>sx</option>
                                                <option value="dx-sx" ${project.configInfissi?.tagliTelaio === 'dx-sx' ? 'selected' : ''}>dx/sx</option>
                                                <option value="4-lati" ${project.configInfissi?.tagliTelaio === '4-lati' ? 'selected' : ''}>4 lati</option>
                                                <option value="sopra-laterali" ${project.configInfissi?.tagliTelaio === 'sopra-laterali' ? 'selected' : ''}>sopra/laterali</option>
                                                <option value="sotto-laterali" ${project.configInfissi?.tagliTelaio === 'sotto-laterali' ? 'selected' : ''}>sotto/laterali</option>
                                            </select>
                                        </div>

                                        <!-- 11. Tipo Tagli -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">11. Tipo Tagli</label>
                                            <input type="text" placeholder="Es: standard, 45¬∞, ecc."
                                                   value="${project.configInfissi?.tipoTagli || ''}"
                                                   onchange="updateConfigInfissi('${project.id}', 'tipoTagli', this.value)"
                                                   class="w-full md:w-1/2 px-3 py-2 border rounded">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- SELEZIONE PRODOTTI -->
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <h3 class="text-lg font-bold mb-3">üõ†Ô∏è Prodotti nel Progetto</h3>
                        <p class="text-sm text-gray-600 mb-3">Seleziona quali prodotti saranno presenti in questo progetto:</p>
                        <div class="flex flex-wrap gap-3">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" ${project.prodotti?.infissi ? 'checked' : ''} 
                                       onchange="updateProdotti('${project.id}', 'infissi', this.checked)"
                                       class="mr-2">
                                <span class="text-sm font-medium">ü™ü Infissi</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" ${project.prodotti?.persiane ? 'checked' : ''} 
                                       onchange="updateProdotti('${project.id}', 'persiane', this.checked)"
                                       class="mr-2">
                                <span class="text-sm font-medium">üö™ Persiane</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" ${project.prodotti?.cassonetti ? 'checked' : ''} 
                                       onchange="updateProdotti('${project.id}', 'cassonetti', this.checked)"
                                       class="mr-2">
                                <span class="text-sm font-medium">üì¶ Cassonetti</span>
                            </label>
                        </div>
                    </div>

                    <!-- POSIZIONI -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Posizioni (${project.positions.length})</h3>
                            <button onclick="addPosition('${project.id}')" class="bg-green-600 text-white px-4 py-2 rounded">+ Aggiungi</button>
                        </div>
                        ${project.positions.length === 0 ? '<p class="text-gray-500">Nessuna posizione</p>' : `
                            <div class="space-y-4">
                                ${project.positions.map(pos => PositionCard(project, pos)).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function PositionCard(project, pos) {
            return `
                <div class="border rounded-lg p-4 bg-gradient-to-r from-purple-50 to-blue-50 cursor-pointer hover:shadow-md transition-shadow"
                     onclick="openPosition('${pos.id}')">
                    <div class="flex justify-between items-center">
                        <h4 class="text-lg font-semibold">${pos.name}</h4>
                        <span class="text-gray-500">‚Üí</span>
                    </div>
                    <div class="mt-2 text-sm text-gray-600">
                        ${pos.piano ? `Piano: ${pos.piano}` : ''} 
                        ${pos.ambiente ? `‚Ä¢ Ambiente: ${pos.ambiente}` : ''}
                    </div>
                </div>
            `;
        }

        function getTabContent(project, pos) {
            const tab = pos.activeTab || 'ambiente';
            
            if (tab === 'ambiente') {
                return `
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">Piano</label>
                                <select onchange="updatePosition('${project.id}', '${pos.id}', {piano: this.value})" 
                                        class="w-full px-3 py-2 border rounded">
                                    <option value="">Seleziona...</option>
                                    <option ${pos.piano === 'interrato' ? 'selected' : ''}>interrato</option>
                                    <option ${pos.piano === 'terra' ? 'selected' : ''}>terra</option>
                                    <option ${pos.piano === 'primo' ? 'selected' : ''}>primo</option>
                                    <option ${pos.piano === 'secondo' ? 'selected' : ''}>secondo</option>
                                    <option ${pos.piano === 'terzo' ? 'selected' : ''}>terzo</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Ambiente</label>
                                <select onchange="updatePosition('${project.id}', '${pos.id}', {ambiente: this.value})" 
                                        class="w-full px-3 py-2 border rounded">
                                    <option value="">Seleziona...</option>
                                    <option ${pos.ambiente === 'soggiorno' ? 'selected' : ''}>soggiorno</option>
                                    <option ${pos.ambiente === 'cucina' ? 'selected' : ''}>cucina</option>
                                    <option ${pos.ambiente === 'camera' ? 'selected' : ''}>camera</option>
                                    <option ${pos.ambiente === 'bagno' ? 'selected' : ''}>bagno</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- SEZIONE FOTO -->
                        <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mt-4">
                            <h4 class="font-semibold text-blue-700 mb-3">üì∏ Foto Posizione</h4>
                            
                            <div class="mb-3">
                                <input type="file" 
                                       id="foto-input-${pos.id}" 
                                       accept="image/*" 
                                       onchange="addFoto('${project.id}', '${pos.id}', this)"
                                       class="hidden">
                                <button onclick="document.getElementById('foto-input-${pos.id}').click()" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold">
                                    üìÅ Carica Foto
                                </button>
                                <p class="text-xs text-gray-600 mt-2">Click per selezionare un'immagine dal dispositivo</p>
                            </div>
                            
                            ${pos.foto && pos.foto.length > 0 ? `
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    ${pos.foto.map((foto, idx) => `
                                        <div class="relative group">
                                            <img src="${foto.data}" 
                                                 onclick="showFotoModal('${foto.data}')"
                                                 class="w-full h-32 object-cover rounded-lg border-2 border-gray-300 cursor-pointer hover:border-blue-500 transition-all">
                                            <button onclick="removeFoto('${project.id}', '${pos.id}', ${idx})"
                                                    class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                ‚úï
                                            </button>
                                            <p class="text-xs text-center mt-1 text-gray-600">Foto ${idx + 1}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p class="text-sm text-gray-500 italic">Nessuna foto caricata</p>'}
                        </div>
                    </div>
                `;
            }

            if (tab === 'misure') {
                return `
                    <div class="space-y-3">
                        <!-- COPPIA 1: LF + HF (BLU) -->
                        <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-3">
                            <p class="text-xs font-bold text-blue-700 mb-2">üîµ COPPIA 1: Foro</p>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" placeholder="LF" value="${pos.misure?.LF || ''}" 
                                       onchange="updateMisure('${project.id}', '${pos.id}', 'LF', this.value)"
                                       class="px-3 py-2 border rounded font-semibold">
                                <input type="number" placeholder="HF" value="${pos.misure?.HF || ''}" 
                                       onchange="updateMisure('${project.id}', '${pos.id}', 'HF', this.value)"
                                       class="px-3 py-2 border rounded font-semibold">
                            </div>
                        </div>

                        <!-- COPPIA 2: LVT + HVT (VERDE) -->
                        <div class="bg-green-50 border-2 border-green-300 rounded-lg p-3">
                            <p class="text-xs font-bold text-green-700 mb-2">üü¢ COPPIA 2: Vecchio Telaio</p>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" placeholder="LVT" value="${pos.misure?.LVT || ''}" 
                                       onchange="updateMisure('${project.id}', '${pos.id}', 'LVT', this.value)"
                                       class="px-3 py-2 border rounded font-semibold">
                                <input type="number" placeholder="HVT" value="${pos.misure?.HVT || ''}" 
                                       onchange="updateMisure('${project.id}', '${pos.id}', 'HVT', this.value)"
                                       class="px-3 py-2 border rounded font-semibold">
                            </div>
                        </div>

                        <!-- COPPIA 3: TMV + HMT (VIOLA) -->
                        <div class="bg-purple-50 border-2 border-purple-300 rounded-lg p-3">
                            <p class="text-xs font-bold text-purple-700 mb-2">üü£ COPPIA 3: Misure Massime</p>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" placeholder="TMV" value="${pos.misure?.TMV || ''}" 
                                       onchange="updateMisure('${project.id}', '${pos.id}', 'TMV', this.value)"
                                       class="px-3 py-2 border rounded font-semibold">
                                <input type="number" placeholder="HMT" value="${pos.misure?.HMT || ''}" 
                                       onchange="updateMisure('${project.id}', '${pos.id}', 'HMT', this.value)"
                                       class="px-3 py-2 border rounded font-semibold">
                            </div>
                        </div>

                        <!-- COPPIA 4: LVAR + HVAR (ARANCIONE) -->
                        <div class="bg-orange-50 border-2 border-orange-300 rounded-lg p-3">
                            <p class="text-xs font-bold text-orange-700 mb-2">üü† COPPIA 4: Variabili</p>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" placeholder="LVAR" value="${pos.misure?.LVAR || ''}" 
                                       onchange="updateMisure('${project.id}', '${pos.id}', 'LVAR', this.value)"
                                       class="px-3 py-2 border rounded font-semibold">
                                <input type="number" placeholder="HVAR" value="${pos.misure?.HVAR || ''}" 
                                       onchange="updateMisure('${project.id}', '${pos.id}', 'HVAR', this.value)"
                                       class="px-3 py-2 border rounded font-semibold">
                            </div>
                        </div>
                        
                        ${pos.overrideCaratteristiche ? `
                            <div class="bg-yellow-100 p-4 rounded border-2 border-yellow-500 mt-3">
                                <div class="flex justify-between items-center mb-3">
                                    <p class="text-sm font-bold text-yellow-800">‚ö†Ô∏è Override Caratteristiche Muro - Personalizzato</p>
                                    <button onclick="disableOverride('${project.id}', '${pos.id}')" 
                                            class="text-xs bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-700">
                                        ‚Ü©Ô∏è Ripristina globali
                                    </button>
                                </div>
                                
                                <div class="space-y-3">
                                    <!-- RIGA 1 -->
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                        <div>
                                            <label class="block text-xs font-medium mb-1">Prof. Muro Int. (mm)</label>
                                            <input type="number" placeholder="0" 
                                                   value="${pos.caratteristicheMuroOverride?.profMuroInt !== undefined ? pos.caratteristicheMuroOverride.profMuroInt : (project.caratteristicheMuro?.profMuroInt || '')}"
                                                   onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profMuroInt', this.value)"
                                                   class="w-full px-2 py-1 border rounded text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium mb-1">Prof. Piana Sopra (mm)</label>
                                            <input type="number" placeholder="0" 
                                                   value="${pos.caratteristicheMuroOverride?.profPianaSopra !== undefined ? pos.caratteristicheMuroOverride.profPianaSopra : (project.caratteristicheMuro?.profPianaSopra || '')}"
                                                   onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profPianaSopra', this.value)"
                                                   class="w-full px-2 py-1 border rounded text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium mb-1">Prof. Piana Sotto (mm)</label>
                                            <input type="number" placeholder="0" 
                                                   value="${pos.caratteristicheMuroOverride?.profPianaSotto !== undefined ? pos.caratteristicheMuroOverride.profPianaSotto : (project.caratteristicheMuro?.profPianaSotto || '')}"
                                                   onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profPianaSotto', this.value)"
                                                   class="w-full px-2 py-1 border rounded text-sm">
                                        </div>
                                    </div>

                                    <!-- RIGA 2 -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-xs font-medium mb-1">Telaio Profondit√† (mm)</label>
                                            <input type="number" placeholder="0" 
                                                   value="${pos.caratteristicheMuroOverride?.telaioProfondita !== undefined ? pos.caratteristicheMuroOverride.telaioProfondita : (project.caratteristicheMuro?.telaioProfondita || '')}"
                                                   onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'telaioProfondita', this.value)"
                                                   class="w-full px-2 py-1 border rounded text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium mb-1">Telaio Larghezza (mm)</label>
                                            <input type="number" placeholder="0" 
                                                   value="${pos.caratteristicheMuroOverride?.telaioLarghezza !== undefined ? pos.caratteristicheMuroOverride.telaioLarghezza : (project.caratteristicheMuro?.telaioLarghezza || '')}"
                                                   onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'telaioLarghezza', this.value)"
                                                   class="w-full px-2 py-1 border rounded text-sm">
                                        </div>
                                    </div>

                                    <!-- RIGA 3 -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-xs font-medium mb-1">Delta Interno (mm)</label>
                                            <input type="number" placeholder="0" 
                                                   value="${pos.caratteristicheMuroOverride?.deltaInt !== undefined ? pos.caratteristicheMuroOverride.deltaInt : (project.caratteristicheMuro?.deltaInt || '')}"
                                                   onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'deltaInt', this.value)"
                                                   class="w-full px-2 py-1 border rounded text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium mb-1">Delta Esterno (mm)</label>
                                            <input type="number" placeholder="0" 
                                                   value="${pos.caratteristicheMuroOverride?.deltaEst !== undefined ? pos.caratteristicheMuroOverride.deltaEst : (project.caratteristicheMuro?.deltaEst || '')}"
                                                   onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'deltaEst', this.value)"
                                                   class="w-full px-2 py-1 border rounded text-sm">
                                        </div>
                                    </div>

                                    <!-- Guida esistente -->
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Guida Esistente?</label>
                                        <select onchange="updateCaratteristicheMuroOverrideWithRender('${project.id}', '${pos.id}', 'guidaEsistente', this.value);"
                                                class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                            <option value="">Seleziona...</option>
                                            <option value="si" ${((pos.caratteristicheMuroOverride?.guidaEsistente !== undefined ? pos.caratteristicheMuroOverride.guidaEsistente : project.caratteristicheMuro?.guidaEsistente) === 'si') ? 'selected' : ''}>S√¨</option>
                                            <option value="no" ${((pos.caratteristicheMuroOverride?.guidaEsistente !== undefined ? pos.caratteristicheMuroOverride.guidaEsistente : project.caratteristicheMuro?.guidaEsistente) === 'no') ? 'selected' : ''}>No</option>
                                        </select>
                                    </div>

                                    ${((pos.caratteristicheMuroOverride?.guidaEsistente !== undefined ? pos.caratteristicheMuroOverride.guidaEsistente : project.caratteristicheMuro?.guidaEsistente) === 'si') ? `
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 bg-green-50 p-2 rounded">
                                            <div>
                                                <label class="block text-xs font-medium text-green-700 mb-1">Prof. Distanziale (mm)</label>
                                                <input type="number" placeholder="0" 
                                                       value="${pos.caratteristicheMuroOverride?.profDistanziale !== undefined ? pos.caratteristicheMuroOverride.profDistanziale : (project.caratteristicheMuro?.profDistanziale || '')}"
                                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profDistanziale', this.value)"
                                                       class="w-full px-2 py-1 border rounded text-sm">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-green-700 mb-1">Prof. Guida (mm)</label>
                                                <input type="number" placeholder="0" 
                                                       value="${pos.caratteristicheMuroOverride?.profGuida !== undefined ? pos.caratteristicheMuroOverride.profGuida : (project.caratteristicheMuro?.profGuida || '')}"
                                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profGuida', this.value)"
                                                       class="w-full px-2 py-1 border rounded text-sm">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-green-700 mb-1">Larghezza Guida (mm)</label>
                                                <input type="number" placeholder="0" 
                                                       value="${pos.caratteristicheMuroOverride?.larghezzaGuida !== undefined ? pos.caratteristicheMuroOverride.larghezzaGuida : (project.caratteristicheMuro?.larghezzaGuida || '')}"
                                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'larghezzaGuida', this.value)"
                                                       class="w-full px-2 py-1 border rounded text-sm">
                                            </div>
                                        </div>
                                    ` : ''}

                                    <!-- Prof Muro Est -->
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Prof. Muro Esterno (mm)</label>
                                        <input type="number" placeholder="0" 
                                               value="${pos.caratteristicheMuroOverride?.profMuroEst !== undefined ? pos.caratteristicheMuroOverride.profMuroEst : (project.caratteristicheMuro?.profMuroEst || '')}"
                                               onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profMuroEst', this.value)"
                                               class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                    </div>

                                    <!-- Falso esistente -->
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Falso Esistente?</label>
                                        <select onchange="updateCaratteristicheMuroOverrideWithRender('${project.id}', '${pos.id}', 'falsoEsistente', this.value);"
                                                class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                            <option value="">Seleziona...</option>
                                            <option value="si" ${((pos.caratteristicheMuroOverride?.falsoEsistente !== undefined ? pos.caratteristicheMuroOverride.falsoEsistente : project.caratteristicheMuro?.falsoEsistente) === 'si') ? 'selected' : ''}>S√¨</option>
                                            <option value="no" ${((pos.caratteristicheMuroOverride?.falsoEsistente !== undefined ? pos.caratteristicheMuroOverride.falsoEsistente : project.caratteristicheMuro?.falsoEsistente) === 'no') ? 'selected' : ''}>No</option>
                                        </select>
                                    </div>

                                    ${((pos.caratteristicheMuroOverride?.falsoEsistente !== undefined ? pos.caratteristicheMuroOverride.falsoEsistente : project.caratteristicheMuro?.falsoEsistente) === 'si') ? `
                                        <div class="bg-orange-50 p-2 rounded space-y-2">
                                            <div>
                                                <label class="block text-xs font-medium text-orange-700 mb-1">Spessore Falso</label>
                                                <input type="number" placeholder="0" 
                                                       value="${pos.caratteristicheMuroOverride?.spessoreFalso !== undefined ? pos.caratteristicheMuroOverride.spessoreFalso : (project.caratteristicheMuro?.spessoreFalso || '')}"
                                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'spessoreFalso', this.value)"
                                                       class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-orange-700 mb-1">+ Distanza Falso/Infisso</label>
                                                <input type="number" placeholder="0" 
                                                       value="${pos.caratteristicheMuroOverride?.distanzaFalsoInfisso !== undefined ? pos.caratteristicheMuroOverride.distanzaFalsoInfisso : (project.caratteristicheMuro?.distanzaFalsoInfisso || '')}"
                                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'distanzaFalsoInfisso', this.value)"
                                                       class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                            </div>
                                        </div>
                                    ` : `
                                        <div class="bg-purple-50 p-2 rounded">
                                            <label class="block text-xs font-medium text-purple-700 mb-1">Distanza Muro/Infisso</label>
                                            <input type="number" placeholder="0" 
                                                   value="${pos.caratteristicheMuroOverride?.distanzaMuroInfisso !== undefined ? pos.caratteristicheMuroOverride.distanzaMuroInfisso : (project.caratteristicheMuro?.distanzaMuroInfisso || '')}"
                                                   onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'distanzaMuroInfisso', this.value)"
                                                   class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                        </div>
                                    `}
                                </div>
                            </div>
                        ` : `
                            <button onclick="enableOverride('${project.id}', '${pos.id}')" 
                                    class="text-xs bg-yellow-600 text-white px-3 py-1 rounded mt-3 hover:bg-yellow-700">
                                ‚úèÔ∏è Personalizza caratteristiche muro per questa posizione
                            </button>
                        `}
                    </div>
                `;
            }

            if (tab === 'infissi') {
                return `
                    <div class="space-y-4">
                        <button onclick="addInfisso('${project.id}', '${pos.id}')" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold">
                            ‚ûï Aggiungi Infisso
                        </button>
                        
                        <div id="infissi-list-${pos.id}">
                            ${pos.infissi?.map((inf, idx) => InfissoCard(project, pos, inf, idx)).join('') || '<p class="text-gray-500 text-sm">Nessun infisso aggiunto</p>'}
                        </div>
                    </div>
                `;
            }

            return `<p class="text-gray-500 text-center py-8">Tab ${tab} - Da implementare</p>`;
        }

        function InfissoCard(project, pos, inf, idx) {
            const isExpanded = inf.expanded || false;
            
            return `
                <div class="bg-gray-50 border-2 border-gray-200 rounded-lg overflow-hidden">
                    <!-- HEADER INFISSO -->
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-3 cursor-pointer flex justify-between items-center"
                         onclick="toggleInfisso('${project.id}', '${pos.id}', ${idx})">
                        <h4 class="font-bold">ü™ü INFISSO #${idx + 1}</h4>
                        <div class="flex items-center gap-2">
                            <span id="infisso-arrow-${pos.id}-${idx}">${isExpanded ? '‚ñ≤' : '‚ñº'}</span>
                            <button onclick="event.stopPropagation(); removeInfisso('${project.id}', '${pos.id}', ${idx})"
                                    class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                    
                    <!-- CONTENUTO INFISSO -->
                    <div id="infisso-content-${pos.id}-${idx}" 
                         class="p-4 space-y-4" 
                         style="display: ${isExpanded ? 'block' : 'none'}">
                        
                        <!-- CAMPI SPECIFICI POSIZIONE -->
                        <div class="bg-white p-3 rounded border-2 border-blue-300">
                            <h5 class="font-semibold text-sm mb-3 text-blue-700">üìã Dati Specifici</h5>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <!-- Quantit√† -->
                                <div>
                                    <label class="block text-xs font-medium mb-1">Quantit√†</label>
                                    <select onchange="updateInfisso('${project.id}', '${pos.id}', ${idx}, 'qta', this.value)"
                                            class="w-full px-2 py-1 border rounded text-sm">
                                        ${[1,2,3,4,5,6,7,8].map(n => `<option value="${n}" ${(inf.qta || 1) === n ? 'selected' : ''}>${n}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <!-- Tipo -->
                                <div>
                                    <label class="block text-xs font-medium mb-1">Tipo</label>
                                    <select onchange="updateInfissoWithRender('${project.id}', '${pos.id}', ${idx}, 'tipo', this.value)"
                                            class="w-full px-2 py-1 border rounded text-sm">
                                        <option value="">Seleziona...</option>
                                        <option value="F1" ${inf.tipo === 'F1' ? 'selected' : ''}>F1</option>
                                        <option value="PF1" ${inf.tipo === 'PF1' ? 'selected' : ''}>PF1</option>
                                        <option value="F2" ${inf.tipo === 'F2' ? 'selected' : ''}>F2</option>
                                        <option value="PF2" ${inf.tipo === 'PF2' ? 'selected' : ''}>PF2</option>
                                        <option value="F3" ${inf.tipo === 'F3' ? 'selected' : ''}>F3</option>
                                        <option value="PF3" ${inf.tipo === 'PF3' ? 'selected' : ''}>PF3</option>
                                        <option value="HST" ${inf.tipo === 'HST' ? 'selected' : ''}>HST</option>
                                        <option value="SCORR.PARALL" ${inf.tipo === 'SCORR.PARALL' ? 'selected' : ''}>SCORR.PARALL</option>
                                        <option value="FISSO" ${inf.tipo === 'FISSO' ? 'selected' : ''}>FISSO</option>
                                        <option value="altro" ${inf.tipo === 'altro' ? 'selected' : ''}>Altro</option>
                                    </select>
                                </div>
                                
                                ${inf.tipo === 'altro' ? `
                                <div>
                                    <label class="block text-xs font-medium mb-1">Specifica Tipo</label>
                                    <input type="text" value="${inf.tipoAltro || ''}"
                                           onchange="updateInfisso('${project.id}', '${pos.id}', ${idx}, 'tipoAltro', this.value)"
                                           placeholder="Inserisci tipo..."
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                ` : ''}
                                
                                <!-- Apertura -->
                                <div>
                                    <label class="block text-xs font-medium mb-1">Apertura</label>
                                    <select onchange="updateInfissoWithRender('${project.id}', '${pos.id}', ${idx}, 'apertura', this.value)"
                                            class="w-full px-2 py-1 border rounded text-sm">
                                        <option value="">Seleziona...</option>
                                        <option value="SX" ${inf.apertura === 'SX' ? 'selected' : ''}>SX</option>
                                        <option value="DX" ${inf.apertura === 'DX' ? 'selected' : ''}>DX</option>
                                        <option value="Fisso" ${inf.apertura === 'Fisso' ? 'selected' : ''}>Fisso</option>
                                        <option value="Ribalta" ${inf.apertura === 'Ribalta' ? 'selected' : ''}>Ribalta</option>
                                        <option value="Sp. SX" ${inf.apertura === 'Sp. SX' ? 'selected' : ''}>Sp. SX</option>
                                        <option value="Sp. DX" ${inf.apertura === 'Sp. DX' ? 'selected' : ''}>Sp. DX</option>
                                        <option value="altro" ${inf.apertura === 'altro' ? 'selected' : ''}>Altro</option>
                                    </select>
                                </div>
                                
                                ${inf.apertura === 'altro' ? `
                                <div>
                                    <label class="block text-xs font-medium mb-1">Specifica Apertura</label>
                                    <input type="text" value="${inf.aperturaAltro || ''}"
                                           onchange="updateInfisso('${project.id}', '${pos.id}', ${idx}, 'aperturaAltro', this.value)"
                                           placeholder="Inserisci apertura..."
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- CONFIGURAZIONE (PRECOMPILATA DA GLOBALE) -->
                        <div class="bg-green-50 p-3 rounded border-2 border-green-300">
                            <h5 class="font-semibold text-sm mb-2 text-green-700">‚öôÔ∏è Configurazione <span class="text-xs font-normal text-gray-600">(da config globale - modificabile)</span></h5>
                            
                            <div class="space-y-3">
                                <!-- RIGA 1 -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Finitura Interna</label>
                                        <select onchange="updateInfisso('${project.id}', '${pos.id}', ${idx}, 'finituraInt', this.value)"
                                                class="w-full px-2 py-1 border rounded text-sm">
                                            <option value="">Seleziona...</option>
                                            <option value="pvc" ${inf.finituraInt === 'pvc' ? 'selected' : ''}>PVC</option>
                                            <option value="legno" ${inf.finituraInt === 'legno' ? 'selected' : ''}>LEGNO</option>
                                            <option value="alluminio" ${inf.finituraInt === 'alluminio' ? 'selected' : ''}>ALLUMINIO</option>
                                            <option value="ceramica" ${inf.finituraInt === 'ceramica' ? 'selected' : ''}>CERAMICA</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Finitura Esterna</label>
                                        <select onchange="updateInfisso('${project.id}', '${pos.id}', ${idx}, 'finituraEst', this.value)"
                                                class="w-full px-2 py-1 border rounded text-sm">
                                            <option value="">Seleziona...</option>
                                            <option value="pvc" ${inf.finituraEst === 'pvc' ? 'selected' : ''}>PVC</option>
                                            <option value="alluminio" ${inf.finituraEst === 'alluminio' ? 'selected' : ''}>ALLUMINIO</option>
                                            <option value="ceramica" ${inf.finituraEst === 'ceramica' ? 'selected' : ''}>CERAMICA</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- RIGA 2 -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Colore Interno</label>
                                        <input type="text" value="${inf.coloreInt || ''}"
                                               onchange="updateInfisso('${project.id}', '${pos.id}', ${idx}, 'coloreInt', this.value)"
                                               placeholder="Es: Bianco, RAL 9010"
                                               class="w-full px-2 py-1 border rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Colore Esterno</label>
                                        <input type="text" value="${inf.coloreEst || ''}"
                                               onchange="updateInfisso('${project.id}', '${pos.id}', ${idx}, 'coloreEst', this.value)"
                                               placeholder="Es: Marrone, RAL 8014"
                                               class="w-full px-2 py-1 border rounded text-sm">
                                    </div>
                                </div>
                                
                                <!-- RIGA 3 -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Tipo Anta</label>
                                        <select onchange="updateInfisso('${project.id}', '${pos.id}', ${idx}, 'tipoAnta', this.value)"
                                                class="w-full px-2 py-1 border rounded text-sm">
                                            <option value="">Seleziona...</option>
                                            <option value="step-line" ${inf.tipoAnta === 'step-line' ? 'selected' : ''}>STEP-LINE</option>
                                            <option value="nova-line" ${inf.tipoAnta === 'nova-line' ? 'selected' : ''}>NOVA-LINE</option>
                                            <option value="slim-line" ${inf.tipoAnta === 'slim-line' ? 'selected' : ''}>SLIM-LINE</option>
                                            <option value="classic-line" ${inf.tipoAnta === 'classic-line' ? 'selected' : ''}>CLASSIC-LINE</option>
                                            <option value="step-line-door" ${inf.tipoAnta === 'step-line-door' ? 'selected' : ''}>STEP-LINE DOOR</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Telaio</label>
                                        <select onchange="updateInfisso('${project.id}', '${pos.id}', ${idx}, 'telaio', this.value)"
                                                class="w-full px-2 py-1 border rounded text-sm">
                                            <option value="">Seleziona...</option>
                                            <option value="961" ${inf.telaio === '961' ? 'selected' : ''}>961</option>
                                            <option value="962" ${inf.telaio === '962' ? 'selected' : ''}>962</option>
                                            <option value="966" ${inf.telaio === '966' ? 'selected' : ''}>966</option>
                                            <option value="965" ${inf.telaio === '965' ? 'selected' : ''}>965</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Allarme</label>
                                        <select onchange="updateInfisso('${project.id}', '${pos.id}', ${idx}, 'allarme', this.value)"
                                                class="w-full px-2 py-1 border rounded text-sm">
                                            <option value="">Seleziona...</option>
                                            <option value="si" ${inf.allarme === 'si' ? 'selected' : ''}>S√¨</option>
                                            <option value="no" ${inf.allarme === 'no' ? 'selected' : ''}>No</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- RIGA 4 -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Vetro</label>
                                        <select onchange="updateInfisso('${project.id}', '${pos.id}', ${idx}, 'vetro', this.value)"
                                                class="w-full px-2 py-1 border rounded text-sm">
                                            <option value="">Seleziona...</option>
                                            <option value="doppio" ${inf.vetro === 'doppio' ? 'selected' : ''}>doppio</option>
                                            <option value="doppio-sat" ${inf.vetro === 'doppio-sat' ? 'selected' : ''}>doppio sat</option>
                                            <option value="triplo" ${inf.vetro === 'triplo' ? 'selected' : ''}>triplo</option>
                                            <option value="triplo-sat" ${inf.vetro === 'triplo-sat' ? 'selected' : ''}>triplo sat</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Tagli Telaio</label>
                                        <select onchange="updateInfisso('${project.id}', '${pos.id}', ${idx}, 'tagliTelaio', this.value)"
                                                class="w-full px-2 py-1 border rounded text-sm">
                                            <option value="">Seleziona...</option>
                                            <option value="sopra" ${inf.tagliTelaio === 'sopra' ? 'selected' : ''}>sopra</option>
                                            <option value="sotto" ${inf.tagliTelaio === 'sotto' ? 'selected' : ''}>sotto</option>
                                            <option value="sopra-sotto" ${inf.tagliTelaio === 'sopra-sotto' ? 'selected' : ''}>sopra/sotto</option>
                                            <option value="dx" ${inf.tagliTelaio === 'dx' ? 'selected' : ''}>dx</option>
                                            <option value="sx" ${inf.tagliTelaio === 'sx' ? 'selected' : ''}>sx</option>
                                            <option value="dx-sx" ${inf.tagliTelaio === 'dx-sx' ? 'selected' : ''}>dx/sx</option>
                                            <option value="4-lati" ${inf.tagliTelaio === '4-lati' ? 'selected' : ''}>4 lati</option>
                                            <option value="sopra-laterali" ${inf.tagliTelaio === 'sopra-laterali' ? 'selected' : ''}>sopra/laterali</option>
                                            <option value="sotto-laterali" ${inf.tagliTelaio === 'sotto-laterali' ? 'selected' : ''}>sotto/laterali</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Tipo Tagli</label>
                                        <input type="text" value="${inf.tipoTagli || ''}"
                                               onchange="updateInfisso('${project.id}', '${pos.id}', ${idx}, 'tipoTagli', this.value)"
                                               placeholder="Es: standard, 45¬∞"
                                               class="w-full px-2 py-1 border rounded text-sm">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function NewProjectModal() {
            return `
                <div id="modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <h3 class="text-xl font-bold mb-4">Nuovo Progetto</h3>
                        <input type="text" id="projectName" placeholder="Nome progetto" class="w-full px-3 py-2 border rounded mb-3">
                        <input type="text" id="projectClient" placeholder="Cliente" class="w-full px-3 py-2 border rounded mb-4">
                        <div class="flex gap-2">
                            <button onclick="hideModal()" class="flex-1 px-4 py-2 border rounded">Annulla</button>
                            <button onclick="createProject()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded">Crea</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function FotoModal() {
            return `
                <div id="foto-modal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50" onclick="hideFotoModal()">
                    <div class="relative max-w-4xl max-h-screen p-4">
                        <button onclick="hideFotoModal()" class="absolute top-2 right-2 bg-white text-black rounded-full w-10 h-10 flex items-center justify-center font-bold hover:bg-gray-200">
                            ‚úï
                        </button>
                        <img id="foto-modal-img" src="" class="max-w-full max-h-screen object-contain rounded-lg">
                    </div>
                </div>
            `;
        }





        window.updateCaratteristicheMuroModal = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
                project.caratteristicheMuro[field] = value;
                saveState();
                
                // Aggiorna visibilit√† campi senza chiudere modal
                if (field === 'guidaEsistente') {
                    const guidaFields = document.getElementById(`guida-fields-${projectId}`);
                    if (guidaFields) {
                        guidaFields.style.display = value === 'si' ? 'block' : 'none';
                    }
                } else if (field === 'falsoEsistente') {
                    const falsoFields = document.getElementById(`falso-fields-${projectId}`);
                    const noFalsoFields = document.getElementById(`no-falso-fields-${projectId}`);
                    if (falsoFields && noFalsoFields) {
                        falsoFields.style.display = value === 'si' ? 'block' : 'none';
                        noFalsoFields.style.display = value === 'no' ? 'block' : 'none';
                    }
                }
            }
        };

        window.toggleAccordion = (accordionId) => {
            const accordion = document.getElementById(accordionId);
            const arrow = document.getElementById(`arrow-${accordionId}`);
            if (accordion && arrow) {
                if (accordion.style.display === 'none') {
                    accordion.style.display = 'block';
                    arrow.style.transform = 'rotate(180deg)';
                } else {
                    accordion.style.display = 'none';
                    arrow.style.transform = 'rotate(0deg)';
                }
            }
        };

        window.showNewProjectModal = () => document.getElementById('modal').classList.remove('hidden');
        window.hideModal = () => document.getElementById('modal').classList.add('hidden');
        
        window.toggleProjectInfo = (projectId) => {
            const info = document.getElementById(`project-info-${projectId}`);
            const arrow = document.getElementById(`arrow-${projectId}`);
            if (info.style.display === 'none') {
                info.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                info.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        };

        window.toggleSection = (sectionId) => {
            const section = document.getElementById(sectionId);
            const arrow = document.getElementById(`arrow-${sectionId}`);
            if (section.style.display === 'none') {
                section.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                section.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        };

        window.updateProdotti = (projectId, prodotto, checked) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.prodotti) project.prodotti = {};
                project.prodotti[prodotto] = checked;
                saveState();
                render();
            }
        };

        window.createProject = () => {
            const name = document.getElementById('projectName').value;
            const client = document.getElementById('projectClient').value;
            if (name && client) {
                addProject(name, client);
                hideModal();
                // Auto-apri l'ultimo progetto creato
                const lastProject = state.projects[state.projects.length - 1];
                state.currentProject = lastProject.id;
                state.screen = 'project';
                render();
            }
        };

        window.openProject = (id) => {
            state.currentProject = id;
            state.screen = 'project';
            render();
        };

        window.openPosition = (id) => {
            state.currentPosition = id;
            state.screen = 'position';
            render();
        };

        window.switchPosition = (positionId) => {
            state.currentPosition = positionId;
            render();
        };

        window.updateClientData = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.clientData) project.clientData = {};
                project.clientData[field] = value;
                saveState();
            }
        };

        window.toggleSostituzioneInfissi = (projectId, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configInfissi) project.configInfissi = {};
                project.configInfissi.sostituisci = value;
                saveState();
                
                // Mostra/nascondi campi configurazione
                const configFields = document.getElementById(`config-infissi-fields-${projectId}`);
                if (configFields) {
                    configFields.style.display = value === 'si' ? 'block' : 'none';
                }
            }
        };

        window.updateConfigInfissi = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configInfissi) project.configInfissi = {};
                project.configInfissi[field] = value;
                saveState();
            }
        };

        window.updateGuidaEsistente = (projectId, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
                project.caratteristicheMuro.guidaEsistente = value;
                saveState();
                
                // Aggiorna visibilit√† senza render
                const guidaFields = document.getElementById(`guida-fields-${projectId}`);
                if (guidaFields) {
                    guidaFields.style.display = value === 'si' ? 'block' : 'none';
                }
            }
        };

        window.updateFalsoEsistente = (projectId, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
                project.caratteristicheMuro.falsoEsistente = value;
                saveState();
                
                // Aggiorna visibilit√† senza render
                const falsoSiFields = document.getElementById(`falso-si-fields-${projectId}`);
                const falsoNoFields = document.getElementById(`falso-no-fields-${projectId}`);
                if (falsoSiFields && falsoNoFields) {
                    falsoSiFields.style.display = value === 'si' ? 'block' : 'none';
                    falsoNoFields.style.display = value === 'no' ? 'block' : 'none';
                }
            }
        };

        window.updateCaratteristicheMuro = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
                project.caratteristicheMuro[field] = value;
                saveState();
            }
        };


        window.updatePosition = (projectId, posId, updates) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) Object.assign(pos, updates);
                saveState();
                render();
            }
        };

        window.updateMisure = (projectId, posId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    if (!pos.misure) pos.misure = {};
                    pos.misure[field] = value;
                    saveState();
                }
            }
        };

        window.setTab = (posId, tab) => {
            const project = state.projects.find(p => p.id === state.currentProject);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos.activeTab = tab;
                    render();
                }
            }
        };

        window.enableOverride = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos.overrideCaratteristiche = true;
                    // Inizializza con i valori globali
                    pos.caratteristicheMuroOverride = {...project.caratteristicheMuro};
                    saveState();
                    render();
                }
            }
        };

        window.disableOverride = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos.overrideCaratteristiche = false;
                    pos.caratteristicheMuroOverride = null;
                    saveState();
                    render();
                }
            }
        };

        window.updateCaratteristicheMuroOverride = (projectId, posId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.caratteristicheMuroOverride) {
                    pos.caratteristicheMuroOverride[field] = value;
                    saveState();
                }
            }
        };

        window.updateCaratteristicheMuroOverrideWithRender = (projectId, posId, field, value) => {
            updateCaratteristicheMuroOverride(projectId, posId, field, value);
            render();
        };

        // ============================================
        // FUNZIONI GESTIONE INFISSI
        // ============================================
        
        window.addInfisso = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    if (!pos.infissi) pos.infissi = [];
                    
                    // Crea nuovo infisso con valori precompilati dalla config globale
                    const nuovoInfisso = {
                        qta: 1,
                        tipo: '',
                        tipoAltro: '',
                        apertura: '',
                        aperturaAltro: '',
                        // Precompilazione da config globale
                        finituraInt: project.configInfissi?.finituraInt || '',
                        finituraEst: project.configInfissi?.finituraEst || '',
                        coloreInt: project.configInfissi?.coloreInt || '',
                        coloreEst: project.configInfissi?.coloreEst || '',
                        tipoAnta: project.configInfissi?.tipoAnta || '',
                        telaio: project.configInfissi?.telaio || '',
                        allarme: project.configInfissi?.allarme || '',
                        vetro: project.configInfissi?.vetro || '',
                        tagliTelaio: project.configInfissi?.tagliTelaio || '',
                        tipoTagli: project.configInfissi?.tipoTagli || '',
                        expanded: true // Espandi automaticamente il nuovo infisso
                    };
                    
                    pos.infissi.push(nuovoInfisso);
                    saveState();
                    render();
                }
            }
        };
        
        window.toggleInfisso = (projectId, posId, infissoIdx) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.infissi && pos.infissi[infissoIdx]) {
                    pos.infissi[infissoIdx].expanded = !pos.infissi[infissoIdx].expanded;
                    saveState();
                    render();
                }
            }
        };
        
        window.updateInfisso = (projectId, posId, infissoIdx, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.infissi && pos.infissi[infissoIdx]) {
                    pos.infissi[infissoIdx][field] = value;
                    saveState();
                }
            }
        };
        
        window.updateInfissoWithRender = (projectId, posId, infissoIdx, field, value) => {
            updateInfisso(projectId, posId, infissoIdx, field, value);
            render();
        };
        
        window.removeInfisso = (projectId, posId, infissoIdx) => {
            if (confirm('Sei sicuro di voler eliminare questo infisso?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos.infissi) {
                        pos.infissi.splice(infissoIdx, 1);
                        saveState();
                        render();
                    }
                }
            }
        };

        // ============================================
        // FUNZIONI GESTIONE FOTO
        // ============================================
        
        window.addFoto = (projectId, posId, input) => {
            const file = input.files[0];
            if (file) {
                // Verifica che sia un'immagine
                if (!file.type.startsWith('image/')) {
                    alert('Per favore seleziona un file immagine valido');
                    return;
                }
                
                // Verifica dimensione (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('L\'immagine √® troppo grande. Dimensione massima: 5MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const project = state.projects.find(p => p.id === projectId);
                    if (project) {
                        const pos = project.positions.find(p => p.id === posId);
                        if (pos) {
                            if (!pos.foto) pos.foto = [];
                            pos.foto.push({
                                data: e.target.result,
                                nome: file.name,
                                timestamp: new Date().toISOString()
                            });
                            saveState();
                            render();
                        }
                    }
                };
                reader.readAsDataURL(file);
            }
            // Reset input per permettere di caricare la stessa foto di nuovo
            input.value = '';
        };
        
        window.removeFoto = (projectId, posId, fotoIdx) => {
            if (confirm('Sei sicuro di voler eliminare questa foto?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos.foto) {
                        pos.foto.splice(fotoIdx, 1);
                        saveState();
                        render();
                    }
                }
            }
        };
        
        window.showFotoModal = (fotoData) => {
            const modal = document.getElementById('foto-modal');
            const img = document.getElementById('foto-modal-img');
            if (modal && img) {
                img.src = fotoData;
                modal.classList.remove('hidden');
            }
        };
        
        window.hideFotoModal = () => {
            const modal = document.getElementById('foto-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        };

        // ============================================
        // FUNZIONE ELIMINA POSIZIONE
        // ============================================
        
        window.deletePosition = (projectId, posId) => {
            if (confirm('Sei sicuro di voler eliminare questa posizione? Tutti i dati verranno persi.')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    project.positions = project.positions.filter(p => p.id !== posId);
                    saveState();
                    
                    // Se c'√® almeno una posizione, vai alla prima, altrimenti torna al progetto
                    if (project.positions.length > 0) {
                        state.currentPosition = project.positions[0].id;
                        state.screen = 'position';
                    } else {
                        state.screen = 'project';
                    }
                    render();
                }
            }
        };


        function render() {
            const app = document.getElementById('app');
            app.innerHTML = `
                ${Header()}
                <main class="max-w-7xl mx-auto px-4 py-8">
                    ${state.screen === 'list' ? ProjectsList() : state.screen === 'position' ? PositionDetail() : ProjectDetail()}
                </main>
                ${NewProjectModal()}
                ${FotoModal()}
            `;
        }

        loadState();
        render();
    </script>
</body>
</html>
