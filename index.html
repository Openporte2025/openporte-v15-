<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Porte v3.0 - Professional Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', sans-serif;
        }
        body { 
            overscroll-behavior-y: contain;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        input, select, textarea { 
            font-size: 16px !important;
            transition: all 0.3s ease;
        }
        input:focus, select:focus, textarea:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .smooth-shadow {
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn-primary:hover::before {
            width: 300px;
            height: 300px;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            transition: all 0.3s ease;
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(239, 68, 68, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.4);
        }
        .input-modern {
            border: 2px solid #e5e7eb;
            background: white;
            transition: all 0.3s ease;
        }
        .input-modern:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-slide-in {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.85rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .tab-active {
            border-bottom: 3px solid;
            border-image: linear-gradient(90deg, #667eea, #764ba2) 1;
        }
        .icon-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .icon-button:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.1);
        }
        .section-header {
            position: relative;
            padding-left: 20px;
        }
        .section-header::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }
        .stats-card {
            position: relative;
            overflow: hidden;
        }
        .stats-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 50%;
            transform: translate(30%, -30%);
        }
        .product-icon {
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            text-align: center;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        .accordion-content.open {
            max-height: 2000px;
        }
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }
        .photo-thumb {
            position: relative;
            padding-bottom: 100%;
            overflow: hidden;
            border-radius: 0.5rem;
            background: #f3f4f6;
        }
        .photo-thumb img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .delete-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 24px;
            height: 24px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
            cursor: pointer;
        }
        .photo-thumb:hover .delete-btn {
            opacity: 1;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <script>
        // Icons SVG
        const icons = {
            home: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>`,
            plus: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>`,
            folder: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>`,
            window: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM4 10h16"></path></svg>`,
            door: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="5" y="3" width="14" height="18" rx="2" stroke-width="2"/><circle cx="15" cy="12" r="1" fill="currentColor"/></svg>`,
            box: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>`,
            measure: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>`,
            camera: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>`,
            trash: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`,
            chevronLeft: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>`,
            chevronDown: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`,
            chevronRight: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`,
            settings: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>`,
            user: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>`,
            location: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>`,
            edit: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>`,
            check: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`,
            x: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`,
            upload: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>`,
            download: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>`,
            eye: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>`,
            clock: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
        };

        // Main App State
        let state = {
            screen: 'list',
            projects: [],
            currentProject: null,
            currentPosition: null,
            theme: 'light',
            searchQuery: '',
            sortBy: 'date'
        };

        // Utility Functions
        function loadState() {
            const saved = localStorage.getItem('openPorteData');
            if (saved) {
                try {
                    state = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading state:', e);
                }
            }
        }

        function saveState() {
            try {
                localStorage.setItem('openPorteData', JSON.stringify(state));
            } catch (e) {
                console.error('Error saving state:', e);
            }
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric' 
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Project Management Functions
        function addProject(name, client, description = '') {
            const project = {
                id: generateId(),
                name,
                client,
                description,
                clientData: {
                    piano: '',
                    citta: '',
                    via: '',
                    telefono: '',
                    email: ''
                },
                caratteristicheMuro: {},
                configInfissi: {},
                configPersiane: {},
                configCassonetti: {},
                prodotti: {
                    infissi: false,
                    persiane: false,
                    cassonetti: false
                },
                positions: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            state.projects.push(project);
            saveState();
            showNotification('Progetto creato con successo', 'success');
            return project;
        }

        function deleteProject(projectId) {
            if (confirm('Sei sicuro di voler eliminare questo progetto? Questa azione non può essere annullata.')) {
                state.projects = state.projects.filter(p => p.id !== projectId);
                saveState();
                showNotification('Progetto eliminato', 'info');
                render();
            }
        }

        function duplicateProject(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const newProject = JSON.parse(JSON.stringify(project));
                newProject.id = generateId();
                newProject.name = project.name + ' (Copia)';
                newProject.createdAt = new Date().toISOString();
                newProject.updatedAt = new Date().toISOString();
                state.projects.push(newProject);
                saveState();
                showNotification('Progetto duplicato con successo', 'success');
                render();
            }
        }

        // Position Management Functions
        function addPosition(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = {
                    id: generateId(),
                    name: `Posizione #${project.positions.length + 1}`,
                    piano: project.clientData?.piano || '',
                    ambiente: '',
                    misure: {},
                    infissi: [],
                    persiane: [],
                    cassonetti: [],
                    note: '',
                    foto: [],
                    activeTab: 'ambiente',
                    overrideCaratteristiche: false,
                    caratteristicheMuroOverride: null
                };
                project.positions.push(pos);
                project.updatedAt = new Date().toISOString();
                saveState();
                state.currentPosition = pos.id;
                state.screen = 'position';
                showNotification('Posizione aggiunta', 'success');
                render();
            }
        }

        function deletePosition(projectId, posId) {
            if (confirm('Eliminare questa posizione?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    project.positions = project.positions.filter(p => p.id !== posId);
                    project.updatedAt = new Date().toISOString();
                    saveState();
                    showNotification('Posizione eliminata', 'info');
                    
                    if (project.positions.length > 0) {
                        state.currentPosition = project.positions[0].id;
                    } else {
                        state.screen = 'project';
                    }
                    render();
                }
            }
        }

        // Notification System
        function showNotification(message, type = 'info') {
            const notificationDiv = document.createElement('div');
            notificationDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-in flex items-center space-x-2`;
            
            const colors = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                warning: 'bg-yellow-500 text-white',
                info: 'bg-blue-500 text-white'
            };
            
            notificationDiv.className += ' ' + colors[type];
            
            const iconMap = {
                success: icons.check,
                error: icons.x,
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            notificationDiv.innerHTML = `
                ${typeof iconMap[type] === 'string' && iconMap[type].includes('<svg') ? iconMap[type] : `<span>${iconMap[type]}</span>`}
                <span class="font-medium">${message}</span>
            `;
            
            document.body.appendChild(notificationDiv);
            
            setTimeout(() => {
                notificationDiv.classList.add('animate-fade-out');
                setTimeout(() => {
                    document.body.removeChild(notificationDiv);
                }, 300);
            }, 3000);
        }

        // Header Component
        function Header() {
            const breadcrumbs = [];
            if (state.screen === 'list') {
                breadcrumbs.push('Progetti');
            } else if (state.screen === 'project') {
                const project = state.projects.find(p => p.id === state.currentProject);
                breadcrumbs.push(
                    `<a href="#" onclick="state.screen='list'; render()" class="text-gray-500 hover:text-gray-700">Progetti</a>`,
                    project?.name || 'Progetto'
                );
            } else if (state.screen === 'position') {
                const project = state.projects.find(p => p.id === state.currentProject);
                const position = project?.positions.find(p => p.id === state.currentPosition);
                breadcrumbs.push(
                    `<a href="#" onclick="state.screen='list'; render()" class="text-gray-500 hover:text-gray-700">Progetti</a>`,
                    `<a href="#" onclick="state.screen='project'; render()" class="text-gray-500 hover:text-gray-700">${project?.name || 'Progetto'}</a>`,
                    position?.name || 'Posizione'
                );
            }

            return `
                <header class="glass-effect sticky top-0 z-40 shadow-lg">
                    <div class="max-w-7xl mx-auto px-4 py-4">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                ${state.screen !== 'list' ? `
                                    <button onclick="goBack()" 
                                            class="icon-button text-gray-600 hover:text-purple-600">
                                        ${icons.chevronLeft}
                                    </button>
                                ` : ''}
                                <div>
                                    <h1 class="text-2xl font-bold gradient-text">Open Porte v3.0</h1>
                                    <nav class="text-sm text-gray-600 mt-1">
                                        ${breadcrumbs.join(' <span class="mx-2">/</span> ')}
                                    </nav>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                ${state.screen === 'list' ? `
                                    <button onclick="exportData()" 
                                            class="text-gray-600 hover:text-purple-600 p-2">
                                        ${icons.download}
                                    </button>
                                    <button onclick="showNewProjectModal()" 
                                            class="btn-primary text-white px-6 py-2.5 rounded-xl font-semibold flex items-center space-x-2 shadow-lg">
                                        ${icons.plus}
                                        <span class="hidden sm:inline">Nuovo Progetto</span>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </header>
            `;
        }

        // Projects List View
        function ProjectsList() {
            const filteredProjects = state.projects.filter(p => 
                p.name.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
                p.client.toLowerCase().includes(state.searchQuery.toLowerCase())
            );

            const sortedProjects = [...filteredProjects].sort((a, b) => {
                if (state.sortBy === 'name') return a.name.localeCompare(b.name);
                if (state.sortBy === 'client') return a.client.localeCompare(b.client);
                return new Date(b.createdAt) - new Date(a.createdAt);
            });

            if (state.projects.length === 0) {
                return `
                    <div class="min-h-[60vh] flex items-center justify-center">
                        <div class="empty-state animate-slide-in">
                            <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-purple-100 to-blue-100 rounded-full mb-6">
                                ${icons.folder}
                            </div>
                            <h2 class="text-2xl font-semibold text-gray-700 mb-2">Benvenuto in Open Porte</h2>
                            <p class="text-gray-500 mb-6">Crea il tuo primo progetto per iniziare</p>
                            <button onclick="showNewProjectModal()" 
                                    class="btn-primary text-white px-8 py-3 rounded-xl font-semibold shadow-lg">
                                ${icons.plus} Crea Primo Progetto
                            </button>
                        </div>
                    </div>
                `;
            }

            const stats = {
                total: state.projects.length,
                positions: state.projects.reduce((sum, p) => sum + p.positions.length, 0),
                recent: state.projects.filter(p => {
                    const daysDiff = (new Date() - new Date(p.createdAt)) / (1000 * 60 * 60 * 24);
                    return daysDiff <= 7;
                }).length
            };

            return `
                <div class="space-y-6 animate-slide-in">
                    <!-- Statistics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="stats-card bg-white rounded-xl p-6 smooth-shadow">
                            <div class="relative z-10">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="p-2 bg-purple-100 rounded-lg">
                                        ${icons.folder}
                                    </div>
                                    <span class="text-2xl">📊</span>
                                </div>
                                <p class="text-3xl font-bold gradient-text">${stats.total}</p>
                                <p class="text-sm text-gray-500">Progetti Totali</p>
                            </div>
                        </div>
                        <div class="stats-card bg-white rounded-xl p-6 smooth-shadow">
                            <div class="relative z-10">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="p-2 bg-blue-100 rounded-lg">
                                        ${icons.location}
                                    </div>
                                    <span class="text-2xl">📍</span>
                                </div>
                                <p class="text-3xl font-bold gradient-text">${stats.positions}</p>
                                <p class="text-sm text-gray-500">Posizioni Totali</p>
                            </div>
                        </div>
                        <div class="stats-card bg-white rounded-xl p-6 smooth-shadow">
                            <div class="relative z-10">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="p-2 bg-green-100 rounded-lg">
                                        ${icons.clock}
                                    </div>
                                    <span class="text-2xl">🆕</span>
                                </div>
                                <p class="text-3xl font-bold gradient-text">${stats.recent}</p>
                                <p class="text-sm text-gray-500">Progetti Recenti</p>
                            </div>
                        </div>
                    </div>

                    <!-- Search and Filters -->
                    <div class="bg-white rounded-xl p-4 smooth-shadow">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1 relative">
                                <input type="text" 
                                       placeholder="Cerca progetti..." 
                                       value="${state.searchQuery}"
                                       oninput="state.searchQuery = this.value; render()"
                                       class="w-full input-modern px-4 py-2.5 pl-10 rounded-lg">
                                <div class="absolute left-3 top-3 text-gray-400">
                                    🔍
                                </div>
                            </div>
                            <select onchange="state.sortBy = this.value; render()"
                                    class="input-modern px-4 py-2.5 rounded-lg">
                                <option value="date" ${state.sortBy === 'date' ? 'selected' : ''}>Data (più recenti)</option>
                                <option value="name" ${state.sortBy === 'name' ? 'selected' : ''}>Nome (A-Z)</option>
                                <option value="client" ${state.sortBy === 'client' ? 'selected' : ''}>Cliente (A-Z)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Projects Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${sortedProjects.map(p => ProjectCard(p)).join('')}
                    </div>
                </div>
            `;
        }

        function ProjectCard(project) {
            const productCount = [
                project.prodotti?.infissi,
                project.prodotti?.persiane, 
                project.prodotti?.cassonetti
            ].filter(Boolean).length;

            return `
                <div class="card-hover bg-white rounded-xl smooth-shadow overflow-hidden group">
                    <div class="h-1 bg-gradient-to-r from-purple-500 to-blue-500"></div>
                    <div class="p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center justify-center w-12 h-12 bg-gradient-to-br from-purple-100 to-blue-100 rounded-lg">
                                ${icons.folder}
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="event.stopPropagation(); duplicateProject('${project.id}')" 
                                        class="opacity-0 group-hover:opacity-100 transition-opacity p-2 hover:bg-gray-100 rounded-lg"
                                        title="Duplica progetto">
                                    📋
                                </button>
                                <button onclick="event.stopPropagation(); deleteProject('${project.id}')" 
                                        class="opacity-0 group-hover:opacity-100 transition-opacity p-2 hover:bg-red-50 text-red-500 rounded-lg"
                                        title="Elimina progetto">
                                    ${icons.trash}
                                </button>
                            </div>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800 mb-1">${project.name}</h3>
                        <p class="text-sm text-gray-500 mb-3 flex items-center space-x-1">
                            ${icons.user}
                            <span>${project.client}</span>
                        </p>
                        ${project.description ? `
                            <p class="text-xs text-gray-400 mb-3 line-clamp-2">${project.description}</p>
                        ` : ''}
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex space-x-2">
                                <span class="badge bg-purple-100 text-purple-700">
                                    ${project.positions.length} pos.
                                </span>
                                ${productCount > 0 ? `
                                    <span class="badge bg-blue-100 text-blue-700">
                                        ${productCount} prod.
                                    </span>
                                ` : ''}
                            </div>
                            <p class="text-xs text-gray-400">
                                ${formatDate(project.createdAt)}
                            </p>
                        </div>
                        <button onclick="openProject('${project.id}')" 
                                class="w-full btn-primary text-white py-2.5 rounded-lg font-semibold flex items-center justify-center space-x-2">
                            <span>Apri Progetto</span>
                            ${icons.chevronRight}
                        </button>
                    </div>
                </div>
            `;
        }

        // Project Detail View
        function ProjectDetail() {
            const project = state.projects.find(p => p.id === state.currentProject);
            if (!project) {
                return `
                    <div class="empty-state">
                        <p class="text-gray-500">Progetto non trovato</p>
                        <button onclick="state.screen='list'; render()" class="text-purple-600 hover:text-purple-700 font-semibold mt-4">
                            Torna ai progetti
                        </button>
                    </div>
                `;
            }

            return `
                <div class="space-y-6 animate-slide-in">
                    <!-- Project Header -->
                    <div class="bg-white rounded-xl smooth-shadow p-8">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-3">
                                    <input type="text" 
                                           value="${project.name}" 
                                           onchange="updateProject('${project.id}', 'name', this.value)"
                                           class="text-3xl font-bold text-gray-800 bg-transparent border-0 outline-none focus:border-b-2 focus:border-purple-500">
                                    <button onclick="editProjectDetails('${project.id}')" 
                                            class="p-2 hover:bg-gray-100 rounded-lg">
                                        ${icons.edit}
                                    </button>
                                </div>
                                <div class="flex items-center space-x-4 text-sm text-gray-600">
                                    <div class="flex items-center space-x-1">
                                        ${icons.user}
                                        <span>${project.client}</span>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        ${icons.clock}
                                        <span>${formatDate(project.updatedAt || project.createdAt)}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-2">
                                <div class="flex space-x-2">
                                    <span class="badge bg-gradient-to-r from-purple-100 to-blue-100 text-purple-700">
                                        ${project.positions.length} posizioni
                                    </span>
                                    ${project.prodotti?.infissi ? '<span class="badge bg-blue-100 text-blue-700">Infissi</span>' : ''}
                                    ${project.prodotti?.persiane ? '<span class="badge bg-purple-100 text-purple-700">Persiane</span>' : ''}
                                    ${project.prodotti?.cassonetti ? '<span class="badge bg-orange-100 text-orange-700">Cassonetti</span>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <button onclick="addPosition('${project.id}')"
                                class="btn-success text-white p-4 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all flex items-center justify-center space-x-2">
                            ${icons.plus}
                            <span>Nuova Posizione</span>
                        </button>
                        <button onclick="toggleSection('client-data')"
                                class="bg-white hover:shadow-lg p-4 rounded-xl font-semibold transition-all flex items-center justify-center space-x-2 smooth-shadow">
                            ${icons.user}
                            <span>Dati Cliente</span>
                        </button>
                        <button onclick="toggleSection('products')"
                                class="bg-white hover:shadow-lg p-4 rounded-xl font-semibold transition-all flex items-center justify-center space-x-2 smooth-shadow">
                            ${icons.settings}
                            <span>Prodotti</span>
                        </button>
                        <button onclick="toggleSection('wall-config')"
                                class="bg-white hover:shadow-lg p-4 rounded-xl font-semibold transition-all flex items-center justify-center space-x-2 smooth-shadow">
                            🏗️
                            <span>Muro</span>
                        </button>
                    </div>

                    <!-- Collapsible Sections -->
                    ${renderClientDataSection(project)}
                    ${renderProductsSection(project)}
                    ${renderWallConfigSection(project)}
                    ${renderProductConfigSections(project)}

                    <!-- Positions List -->
                    <div class="bg-white rounded-xl smooth-shadow p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="section-header text-xl font-bold text-gray-700">
                                Posizioni del Progetto
                            </h3>
                            <button onclick="addPosition('${project.id}')" 
                                    class="btn-primary text-white px-4 py-2 rounded-lg font-semibold flex items-center space-x-2">
                                ${icons.plus}
                                <span>Aggiungi</span>
                            </button>
                        </div>
                        ${project.positions.length === 0 ? `
                            <div class="empty-state py-8">
                                <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full mb-4">
                                    ${icons.location}
                                </div>
                                <p class="text-gray-500 mb-4">Nessuna posizione nel progetto</p>
                                <button onclick="addPosition('${project.id}')" 
                                        class="text-purple-600 hover:text-purple-700 font-semibold">
                                    Aggiungi la prima posizione →
                                </button>
                            </div>
                        ` : `
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${project.positions.map(pos => PositionCard(project, pos)).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderClientDataSection(project) {
            return `
                <div class="bg-white rounded-xl smooth-shadow overflow-hidden">
                    <div class="p-6 cursor-pointer hover:bg-gray-50 transition-colors flex justify-between items-center"
                         onclick="toggleSection('client-data')">
                        <h3 class="section-header font-semibold text-lg text-gray-700">Dati Cliente</h3>
                        <span id="arrow-client-data" class="transition-transform">
                            ${icons.chevronDown}
                        </span>
                    </div>
                    <div id="section-client-data" class="hidden p-6 pt-0 border-t">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${[
                                { field: 'piano', label: 'Piano', type: 'text', placeholder: 'Es: Piano Terra' },
                                { field: 'citta', label: 'Città', type: 'text', placeholder: 'Milano' },
                                { field: 'via', label: 'Via/Indirizzo', type: 'text', placeholder: 'Via Roma, 1' },
                                { field: 'telefono', label: 'Telefono', type: 'tel', placeholder: '+39 333 1234567' },
                                { field: 'email', label: 'Email', type: 'email', placeholder: 'cliente@email.com' }
                            ].map(field => `
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-2">${field.label}</label>
                                    <input type="${field.type}" 
                                           placeholder="${field.placeholder}" 
                                           value="${project.clientData?.[field.field] || ''}" 
                                           onchange="updateClientData('${project.id}', '${field.field}', this.value)" 
                                           class="w-full input-modern px-4 py-2.5 rounded-lg">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderProductsSection(project) {
            return `
                <div class="bg-white rounded-xl smooth-shadow overflow-hidden">
                    <div class="p-6 cursor-pointer hover:bg-gray-50 transition-colors flex justify-between items-center"
                         onclick="toggleSection('products')">
                        <h3 class="section-header font-semibold text-lg text-gray-700">Prodotti nel Progetto</h3>
                        <span id="arrow-products" class="transition-transform">
                            ${icons.chevronDown}
                        </span>
                    </div>
                    <div id="section-products" class="hidden p-6 pt-0 border-t">
                        <p class="text-sm text-gray-600 mb-4">Seleziona i prodotti che verranno gestiti in questo progetto:</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${[
                                { id: 'infissi', label: 'Infissi', desc: 'Finestre e porte', icon: icons.window, color: 'blue' },
                                { id: 'persiane', label: 'Persiane', desc: 'Persiane e scuri', icon: icons.door, color: 'purple' },
                                { id: 'cassonetti', label: 'Cassonetti', desc: 'Cassonetti avvolgibili', icon: icons.box, color: 'orange' }
                            ].map(prod => `
                                <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-${prod.color}-500 transition-all ${project.prodotti?.[prod.id] ? `border-${prod.color}-500 bg-${prod.color}-50` : ''}">
                                    <input type="checkbox" 
                                           ${project.prodotti?.[prod.id] ? 'checked' : ''} 
                                           onchange="updateProdotti('${project.id}', '${prod.id}', this.checked)"
                                           class="mr-3 w-5 h-5 text-${prod.color}-600 rounded focus:ring-${prod.color}-500">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-700 flex items-center space-x-2">
                                            ${prod.icon}
                                            <span>${prod.label}</span>
                                        </div>
                                        <div class="text-xs text-gray-500">${prod.desc}</div>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderWallConfigSection(project) {
            return `
                <div class="bg-white rounded-xl smooth-shadow overflow-hidden">
                    <div class="p-6 cursor-pointer hover:bg-gray-50 transition-colors flex justify-between items-center"
                         onclick="toggleSection('wall-config')">
                        <h3 class="section-header font-semibold text-lg text-gray-700">🏗️ Caratteristiche Muro (Globali)</h3>
                        <span id="arrow-wall-config" class="transition-transform">
                            ${icons.chevronDown}
                        </span>
                    </div>
                    <div id="section-wall-config" class="hidden p-6 pt-0 border-t">
                        <p class="text-sm text-gray-600 mb-4">Misure in millimetri (mm)</p>
                        <div class="space-y-4">
                            <!-- Basic measurements -->
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                ${[
                                    'profMuroInt', 'profPianaSopra', 'profPianaSotto',
                                    'telaioProfondita', 'telaioLarghezza', 'deltaInt',
                                    'deltaEst', 'profMuroEst'
                                ].map(field => `
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">${field}</label>
                                        <input type="number" 
                                               placeholder="0" 
                                               value="${project.caratteristicheMuro?.[field] || ''}"
                                               onchange="updateCaratteristicheMuro('${project.id}', '${field}', this.value)"
                                               class="w-full input-modern px-3 py-2 rounded-lg">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderProductConfigSections(project) {
            let sections = '';
            
            if (project.prodotti?.infissi) {
                sections += `
                    <div class="bg-white rounded-xl smooth-shadow overflow-hidden">
                        <div class="p-6 cursor-pointer hover:bg-gray-50 transition-colors flex justify-between items-center"
                             onclick="toggleSection('infissi-config')">
                            <h3 class="section-header font-semibold text-lg text-gray-700">${icons.window} Configurazione Infissi Globale</h3>
                            <span id="arrow-infissi-config" class="transition-transform">
                                ${icons.chevronDown}
                            </span>
                        </div>
                        <div id="section-infissi-config" class="hidden p-6 pt-0 border-t">
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">1. Azienda</label>
                                        <select onchange="updateConfigInfissi('${project.id}', 'azienda', this.value)"
                                                class="w-full input-modern px-4 py-2.5 rounded-lg">
                                            <option value="">Seleziona...</option>
                                            <option value="finstral" ${project.configInfissi?.azienda === 'finstral' ? 'selected' : ''}>FINSTRAL</option>
                                            <option value="essepi" ${project.configInfissi?.azienda === 'essepi' ? 'selected' : ''}>ESSEPI</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">2. Tipo Anta</label>
                                        <select onchange="updateConfigInfissi('${project.id}', 'tipoAnta', this.value)"
                                                class="w-full input-modern px-4 py-2.5 rounded-lg">
                                            <option value="">Seleziona...</option>
                                            <option value="step-line" ${project.configInfissi?.tipoAnta === 'step-line' ? 'selected' : ''}>STEP-LINE</option>
                                            <option value="nova-line" ${project.configInfissi?.tipoAnta === 'nova-line' ? 'selected' : ''}>NOVA-LINE</option>
                                            <option value="slim-line" ${project.configInfissi?.tipoAnta === 'slim-line' ? 'selected' : ''}>SLIM-LINE</option>
                                            <option value="classic-line" ${project.configInfissi?.tipoAnta === 'classic-line' ? 'selected' : ''}>CLASSIC-LINE</option>
                                            <option value="step-line-door" ${project.configInfissi?.tipoAnta === 'step-line-door' ? 'selected' : ''}>STEP-LINE DOOR</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">3. Finitura Interna</label>
                                        <select onchange="updateConfigInfissi('${project.id}', 'finituraInt', this.value)"
                                                class="w-full input-modern px-4 py-2.5 rounded-lg">
                                            <option value="">Seleziona...</option>
                                            <option value="pvc" ${project.configInfissi?.finituraInt === 'pvc' ? 'selected' : ''}>PVC</option>
                                            <option value="legno" ${project.configInfissi?.finituraInt === 'legno' ? 'selected' : ''}>LEGNO</option>
                                            <option value="alluminio" ${project.configInfissi?.finituraInt === 'alluminio' ? 'selected' : ''}>ALLUMINIO</option>
                                            <option value="ceramica" ${project.configInfissi?.finituraInt === 'ceramica' ? 'selected' : ''}>CERAMICA</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">4. Finitura Esterna</label>
                                        <select onchange="updateConfigInfissi('${project.id}', 'finituraEst', this.value)"
                                                class="w-full input-modern px-4 py-2.5 rounded-lg">
                                            <option value="">Seleziona...</option>
                                            <option value="pvc" ${project.configInfissi?.finituraEst === 'pvc' ? 'selected' : ''}>PVC</option>
                                            <option value="alluminio" ${project.configInfissi?.finituraEst === 'alluminio' ? 'selected' : ''}>ALLUMINIO</option>
                                            <option value="ceramica" ${project.configInfissi?.finituraEst === 'ceramica' ? 'selected' : ''}>CERAMICA</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">5. Colore Interno</label>
                                        <input type="text" placeholder="Es: Bianco, RAL 9010, ecc."
                                               value="${project.configInfissi?.coloreInt || ''}"
                                               onchange="updateConfigInfissi('${project.id}', 'coloreInt', this.value)"
                                               class="w-full input-modern px-4 py-2.5 rounded-lg">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">6. Colore Esterno</label>
                                        <input type="text" placeholder="Es: Marrone, RAL 8014, ecc."
                                               value="${project.configInfissi?.coloreEst || ''}"
                                               onchange="updateConfigInfissi('${project.id}', 'coloreEst', this.value)"
                                               class="w-full input-modern px-4 py-2.5 rounded-lg">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">7. Telaio</label>
                                        <select onchange="updateConfigInfissi('${project.id}', 'telaio', this.value)"
                                                class="w-full input-modern px-4 py-2.5 rounded-lg">
                                            <option value="">Seleziona...</option>
                                            <option value="961" ${project.configInfissi?.telaio === '961' ? 'selected' : ''}>961</option>
                                            <option value="962" ${project.configInfissi?.telaio === '962' ? 'selected' : ''}>962</option>
                                            <option value="966" ${project.configInfissi?.telaio === '966' ? 'selected' : ''}>966</option>
                                            <option value="965" ${project.configInfissi?.telaio === '965' ? 'selected' : ''}>965</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">8. Allarme</label>
                                        <select onchange="updateConfigInfissi('${project.id}', 'allarme', this.value)"
                                                class="w-full input-modern px-4 py-2.5 rounded-lg">
                                            <option value="">Seleziona...</option>
                                            <option value="si" ${project.configInfissi?.allarme === 'si' ? 'selected' : ''}>Sì</option>
                                            <option value="no" ${project.configInfissi?.allarme === 'no' ? 'selected' : ''}>No</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">9. Vetro</label>
                                        <select onchange="updateConfigInfissi('${project.id}', 'vetro', this.value)"
                                                class="w-full input-modern px-4 py-2.5 rounded-lg">
                                            <option value="">Seleziona...</option>
                                            <option value="doppio" ${project.configInfissi?.vetro === 'doppio' ? 'selected' : ''}>Doppio</option>
                                            <option value="doppio-sat" ${project.configInfissi?.vetro === 'doppio-sat' ? 'selected' : ''}>Doppio SAT</option>
                                            <option value="triplo" ${project.configInfissi?.vetro === 'triplo' ? 'selected' : ''}>Triplo</option>
                                            <option value="triplo-sat" ${project.configInfissi?.vetro === 'triplo-sat' ? 'selected' : ''}>Triplo SAT</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">10. Tagli Telaio</label>
                                        <select onchange="updateConfigInfissi('${project.id}', 'tagliTelaio', this.value)"
                                                class="w-full input-modern px-4 py-2.5 rounded-lg">
                                            <option value="">Seleziona...</option>
                                            <option value="sopra" ${project.configInfissi?.tagliTelaio === 'sopra' ? 'selected' : ''}>Sopra</option>
                                            <option value="sotto" ${project.configInfissi?.tagliTelaio === 'sotto' ? 'selected' : ''}>Sotto</option>
                                            <option value="sopra-sotto" ${project.configInfissi?.tagliTelaio === 'sopra-sotto' ? 'selected' : ''}>Sopra/Sotto</option>
                                            <option value="dx" ${project.configInfissi?.tagliTelaio === 'dx' ? 'selected' : ''}>DX</option>
                                            <option value="sx" ${project.configInfissi?.tagliTelaio === 'sx' ? 'selected' : ''}>SX</option>
                                            <option value="dx-sx" ${project.configInfissi?.tagliTelaio === 'dx-sx' ? 'selected' : ''}>DX/SX</option>
                                            <option value="4-lati" ${project.configInfissi?.tagliTelaio === '4-lati' ? 'selected' : ''}>4 Lati</option>
                                            <option value="sopra-laterali" ${project.configInfissi?.tagliTelaio === 'sopra-laterali' ? 'selected' : ''}>Sopra/Laterali</option>
                                            <option value="sotto-laterali" ${project.configInfissi?.tagliTelaio === 'sotto-laterali' ? 'selected' : ''}>Sotto/Laterali</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">11. Tipo Tagli</label>
                                        <input type="text" placeholder="Es: standard, 45°, ecc."
                                               value="${project.configInfissi?.tipoTagli || ''}"
                                               onchange="updateConfigInfissi('${project.id}', 'tipoTagli', this.value)"
                                               class="w-full input-modern px-4 py-2.5 rounded-lg">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (project.prodotti?.persiane) {
                sections += `
                    <div class="bg-white rounded-xl smooth-shadow overflow-hidden">
                        <div class="p-6 cursor-pointer hover:bg-gray-50 transition-colors flex justify-between items-center"
                             onclick="toggleSection('persiane-config')">
                            <h3 class="section-header font-semibold text-lg text-gray-700">${icons.door} Configurazione Persiane Globale</h3>
                            <span id="arrow-persiane-config" class="transition-transform">
                                ${icons.chevronDown}
                            </span>
                        </div>
                        <div id="section-persiane-config" class="hidden p-6 pt-0 border-t">
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">1. Azienda</label>
                                        <select onchange="updateConfigPersiane('${project.id}', 'azienda', this.value)"
                                                class="w-full input-modern px-4 py-2.5 rounded-lg">
                                            <option value="">Seleziona...</option>
                                            <option value="p-persiane" ${project.configPersiane?.azienda === 'p-persiane' ? 'selected' : ''}>P.Persiane</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">2. Modello</label>
                                        <select id="modello-persiane-${project.id}" 
                                                onchange="updateConfigPersianeConditional('${project.id}', 'modello', this.value)"
                                                class="w-full input-modern px-4 py-2.5 rounded-lg">
                                            <option value="">Seleziona...</option>
                                            <option value="Aurora" ${project.configPersiane?.modello === 'Aurora' ? 'selected' : ''}>Aurora</option>
                                            <option value="Vanitosa" ${project.configPersiane?.modello === 'Vanitosa' ? 'selected' : ''}>Vanitosa</option>
                                            <option value="Oscura" ${project.configPersiane?.modello === 'Oscura' ? 'selected' : ''}>Oscura</option>
                                            <option value="Alto Adige" ${project.configPersiane?.modello === 'Alto Adige' ? 'selected' : ''}>Alto Adige</option>
                                            <option value="altro" ${project.configPersiane?.modello === 'altro' ? 'selected' : ''}>Altro (specifica)</option>
                                        </select>
                                    </div>

                                    ${project.configPersiane?.modello === 'altro' ? `
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">Specifica Modello</label>
                                        <input type="text" value="${project.configPersiane?.modelloAltro || ''}"
                                               onchange="updateConfigPersiane('${project.id}', 'modelloAltro', this.value)"
                                               placeholder="Inserisci modello..."
                                               class="w-full input-modern px-4 py-2.5 rounded-lg">
                                    </div>
                                    ` : ''}

                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">3. Fissaggio</label>
                                        <select id="fissaggio-persiane-${project.id}" 
                                                onchange="updateFissaggioPersiane('${project.id}', this.value)"
                                                class="w-full input-modern px-4 py-2.5 rounded-lg">
                                            <option value="">Seleziona...</option>
                                            <option value="A MURO" ${project.configPersiane?.fissaggio === 'A MURO' ? 'selected' : ''}>A MURO</option>
                                            <option value="TELAIO" ${project.configPersiane?.fissaggio === 'TELAIO' ? 'selected' : ''}>TELAIO</option>
                                        </select>
                                    </div>

                                    ${project.configPersiane?.fissaggio === 'TELAIO' ? `
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">4. Tipo Telaio</label>
                                        <select id="tipo-telaio-persiane-${project.id}" 
                                                onchange="updateConfigPersianeConditional('${project.id}', 'tipoTelaio', this.value)"
                                                class="w-full input-modern px-4 py-2.5 rounded-lg">
                                            <option value="">Seleziona...</option>
                                            <option value="TH 62" ${project.configPersiane?.tipoTelaio === 'TH 62' ? 'selected' : ''}>TH 62</option>
                                            <option value="TH 40" ${project.configPersiane?.tipoTelaio === 'TH 40' ? 'selected' : ''}>TH 40</option>
                                            <option value="TH 82" ${project.configPersiane?.tipoTelaio === 'TH 82' ? 'selected' : ''}>TH 82</option>
                                            <option value="altro" ${project.configPersiane?.tipoTelaio === 'altro' ? 'selected' : ''}>Altro (specifica)</option>
                                        </select>
                                    </div>

                                    ${project.configPersiane?.tipoTelaio === 'altro' ? `
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">Specifica Tipo Telaio</label>
                                        <input type="text" value="${project.configPersiane?.tipoTelaioAltro || ''}"
                                               onchange="updateConfigPersiane('${project.id}', 'tipoTelaioAltro', this.value)"
                                               placeholder="Inserisci tipo telaio..."
                                               class="w-full input-modern px-4 py-2.5 rounded-lg">
                                    </div>
                                    ` : ''}
                                    ` : ''}

                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">5. Colore Persiana</label>
                                        <input type="text" placeholder="Es: Bianco, Verde, ecc."
                                               value="${project.configPersiane?.colorePersiana || ''}"
                                               onchange="updateConfigPersiane('${project.id}', 'colorePersiana', this.value)"
                                               class="w-full input-modern px-4 py-2.5 rounded-lg">
                                    </div>

                                    ${project.configPersiane?.fissaggio === 'TELAIO' ? `
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">6. Colore Telaio</label>
                                        <input type="text" placeholder="Es: Bianco, Marrone, ecc."
                                               value="${project.configPersiane?.coloreTelaio || ''}"
                                               onchange="updateConfigPersiane('${project.id}', 'coloreTelaio', this.value)"
                                               class="w-full input-modern px-4 py-2.5 rounded-lg">
                                    </div>
                                    ` : ''}

                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">7. Battuta</label>
                                        <select onchange="updateConfigPersiane('${project.id}', 'battuta', this.value)"
                                                class="w-full input-modern px-4 py-2.5 rounded-lg">
                                            <option value="">Seleziona...</option>
                                            <option value="3 LATI" ${project.configPersiane?.battuta === '3 LATI' ? 'selected' : ''}>3 LATI</option>
                                            <option value="4 LATI" ${project.configPersiane?.battuta === '4 LATI' ? 'selected' : ''}>4 LATI</option>
                                            <option value="2 LATI LATERALI" ${project.configPersiane?.battuta === '2 LATI LATERALI' ? 'selected' : ''}>2 LATI LATERALI</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (project.prodotti?.cassonetti) {
                sections += `
                    <div class="bg-white rounded-xl smooth-shadow overflow-hidden">
                        <div class="p-6 cursor-pointer hover:bg-gray-50 transition-colors flex justify-between items-center"
                             onclick="toggleSection('cassonetti-config')">
                            <h3 class="section-header font-semibold text-lg text-gray-700">${icons.box} Configurazione Cassonetti Globale</h3>
                            <span id="arrow-cassonetti-config" class="transition-transform">
                                ${icons.chevronDown}
                            </span>
                        </div>
                        <div id="section-cassonetti-config" class="hidden p-6 pt-0 border-t">
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">1. Tipo Cassonetto</label>
                                        <select onchange="updateConfigCassonetti('${project.id}', 'tipo', this.value)"
                                                class="w-full input-modern px-4 py-2.5 rounded-lg">
                                            <option value="">Seleziona...</option>
                                            <option value="monoblocco" ${project.configCassonetti?.tipo === 'monoblocco' ? 'selected' : ''}>MONOBLOCCO</option>
                                            <option value="isole" ${project.configCassonetti?.tipo === 'isole' ? 'selected' : ''}>SOLO ISOLE CASSONETTO</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">2. Azienda</label>
                                        <input type="text" placeholder="Es: Azienda produttrice"
                                               value="${project.configCassonetti?.azienda || ''}"
                                               onchange="updateConfigCassonetti('${project.id}', 'azienda', this.value)"
                                               class="w-full input-modern px-4 py-2.5 rounded-lg">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">3. Colore</label>
                                        <input type="text" placeholder="Es: Bianco, RAL 9010, ecc."
                                               value="${project.configCassonetti?.colore || ''}"
                                               onchange="updateConfigCassonetti('${project.id}', 'colore', this.value)"
                                               class="w-full input-modern px-4 py-2.5 rounded-lg">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return sections;
        }

        function PositionCard(project, pos) {
            const productCount = (pos.infissi?.length || 0) + 
                               (pos.persiane?.length || 0) + 
                               (pos.cassonetti?.length || 0);
            
            return `
                <div class="border-2 border-gray-100 rounded-xl p-5 hover:border-purple-300 hover:shadow-lg transition-all cursor-pointer group"
                     onclick="openPosition('${pos.id}')">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="text-lg font-semibold text-gray-800">${pos.name}</h4>
                        <button onclick="event.stopPropagation(); deletePosition('${project.id}', '${pos.id}')" 
                                class="opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-red-50 text-red-500 rounded">
                            ${icons.trash}
                        </button>
                    </div>
                    <div class="space-y-2 mb-4">
                        ${pos.piano ? `
                            <p class="text-sm text-gray-600 flex items-center space-x-1">
                                ${icons.home}
                                <span>${pos.piano}</span>
                            </p>
                        ` : ''}
                        ${pos.ambiente ? `
                            <p class="text-sm text-gray-600 flex items-center space-x-1">
                                ${icons.location}
                                <span>${pos.ambiente}</span>
                            </p>
                        ` : ''}
                        ${pos.foto?.length > 0 ? `
                            <p class="text-sm text-gray-600 flex items-center space-x-1">
                                ${icons.camera}
                                <span>${pos.foto.length} foto</span>
                            </p>
                        ` : ''}
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-1">
                            ${productCount > 0 ? `
                                <span class="badge bg-purple-100 text-purple-700">
                                    ${productCount} prod.
                                </span>
                            ` : '<span class="text-xs text-gray-400">Nessun prodotto</span>'}
                        </div>
                        <button class="text-purple-600 hover:text-purple-700 font-semibold text-sm flex items-center space-x-1">
                            <span>Apri</span>
                            ${icons.chevronRight}
                        </button>
                    </div>
                </div>
            `;
        }

        // Position Detail View
        function PositionDetail() {
            const project = state.projects.find(p => p.id === state.currentProject);
            const pos = project?.positions.find(p => p.id === state.currentPosition);
            
            if (!pos || !project) {
                return `
                    <div class="empty-state">
                        <p class="text-gray-500">Posizione non trovata</p>
                        <button onclick="state.screen='project'; render()" class="text-purple-600 hover:text-purple-700 font-semibold mt-4">
                            Torna al progetto
                        </button>
                    </div>
                `;
            }

            const tab = pos.activeTab || 'ambiente';

            return `
                <div class="space-y-6 animate-slide-in">
                    <!-- Position Selector -->
                    <div class="bg-white rounded-xl smooth-shadow p-6">
                        <div class="flex flex-col md:flex-row gap-4 items-start md:items-center">
                            <div class="flex-1">
                                <label class="block text-xs font-semibold text-gray-500 mb-2">POSIZIONE CORRENTE</label>
                                <select onchange="switchPosition(this.value)" 
                                        class="w-full input-modern px-4 py-2.5 rounded-lg font-semibold text-gray-700">
                                    ${project.positions.map(p => `
                                        <option value="${p.id}" ${p.id === pos.id ? 'selected' : ''}>
                                            ${p.name} ${p.piano ? '• ' + p.piano : ''} ${p.ambiente ? '• ' + p.ambiente : ''}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="flex gap-3">
                                ${project.positions.length > 1 ? `
                                <button onclick="deletePosition('${project.id}', '${pos.id}')" 
                                        class="btn-danger text-white px-4 py-2.5 rounded-lg font-semibold flex items-center space-x-2">
                                    ${icons.trash}
                                    <span>Elimina</span>
                                </button>
                                ` : ''}
                                <button onclick="addPosition('${project.id}')" 
                                        class="btn-success text-white px-4 py-2.5 rounded-lg font-semibold flex items-center space-x-2">
                                    ${icons.plus}
                                    <span>Nuova Posizione</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content Card -->
                    <div class="bg-white rounded-xl smooth-shadow overflow-hidden">
                        <!-- Position Header -->
                        <div class="p-6 border-b border-gray-100">
                            <input type="text" value="${pos.name}" 
                                   onchange="updatePosition('${project.id}', '${pos.id}', {name: this.value})"
                                   class="text-2xl font-bold text-gray-800 bg-transparent border-0 outline-none w-full focus:border-b-2 focus:border-purple-500"
                                   placeholder="Nome posizione">
                        </div>

                        <!-- Tabs -->
                        <div class="border-b border-gray-100 bg-gray-50">
                            <div class="flex overflow-x-auto px-6">
                                ${renderPositionTabs(project, pos, tab)}
                            </div>
                        </div>

                        <!-- Tab Content -->
                        <div class="p-6">
                            ${getTabContent(project, pos)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPositionTabs(project, pos, activeTab) {
            const tabs = [
                { id: 'ambiente', label: 'Ambiente', icon: icons.home, always: true },
                { id: 'misure', label: 'Misure', icon: icons.measure, always: true },
                { id: 'infissi', label: 'Infissi', icon: icons.window, condition: project.prodotti?.infissi },
                { id: 'persiane', label: 'Persiane', icon: icons.door, condition: project.prodotti?.persiane },
                { id: 'cassonetti', label: 'Cassonetti', icon: icons.box, condition: project.prodotti?.cassonetti }
            ];

            return tabs.filter(tab => tab.always || tab.condition).map(tab => `
                <button onclick="setTab('${pos.id}', '${tab.id}')" 
                        class="px-6 py-3 font-semibold whitespace-nowrap transition-colors flex items-center space-x-2
                               ${activeTab === tab.id ? 'text-purple-600 tab-active' : 'text-gray-500 hover:text-gray-700'}">
                    ${tab.icon}
                    <span>${tab.label}</span>
                </button>
            `).join('');
        }

        function getTabContent(project, pos) {
            const tab = pos.activeTab || 'ambiente';
            
            switch(tab) {
                case 'ambiente':
                    return renderAmbienteTab(project, pos);
                case 'misure':
                    return renderMisureTab(project, pos);
                case 'infissi':
                    return renderProductTab(project, pos, 'infissi');
                case 'persiane':
                    return renderProductTab(project, pos, 'persiane');
                case 'cassonetti':
                    return renderProductTab(project, pos, 'cassonetti');
                default:
                    return '<p class="text-center text-gray-500 py-8">Tab non disponibile</p>';
            }
        }

        function renderAmbienteTab(project, pos) {
            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">Piano</label>
                            <input type="text" value="${pos.piano || ''}" 
                                   onchange="updatePosition('${project.id}', '${pos.id}', {piano: this.value})"
                                   placeholder="Es: Piano Terra"
                                   class="w-full input-modern px-4 py-2.5 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">Ambiente</label>
                            <select onchange="updatePosition('${project.id}', '${pos.id}', {ambiente: this.value})" 
                                    class="w-full input-modern px-4 py-2.5 rounded-lg">
                                <option value="">Seleziona...</option>
                                ${['soggiorno', 'cucina', 'camera', 'bagno', 'corridoio', 'balcone', 'altro'].map(amb => `
                                    <option value="${amb}" ${pos.ambiente === amb ? 'selected' : ''}>${amb}</option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Note</label>
                        <textarea value="${pos.note || ''}" 
                                  onchange="updatePosition('${project.id}', '${pos.id}', {note: this.value})"
                                  placeholder="Aggiungi note per questa posizione..."
                                  rows="3"
                                  class="w-full input-modern px-4 py-2.5 rounded-lg resize-none"></textarea>
                    </div>
                    
                    <!-- Photo Section -->
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-6">
                        <h4 class="font-semibold text-gray-700 mb-4 flex items-center space-x-2">
                            ${icons.camera}
                            <span>Foto Posizione</span>
                        </h4>
                        
                        <div class="mb-4">
                            <input type="file" 
                                   id="foto-input-${pos.id}" 
                                   accept="image/*"
                                   multiple
                                   onchange="addFoto('${project.id}', '${pos.id}', this)"
                                   class="hidden">
                            <button onclick="document.getElementById('foto-input-${pos.id}').click()" 
                                    class="btn-primary text-white px-4 py-2.5 rounded-lg font-semibold flex items-center space-x-2">
                                ${icons.upload}
                                <span>Carica Foto</span>
                            </button>
                        </div>
                        
                        ${pos.foto && pos.foto.length > 0 ? `
                            <div class="photo-grid">
                                ${pos.foto.map((foto, idx) => `
                                    <div class="photo-thumb group">
                                        <img src="${foto.data}" 
                                             onclick="showFotoModal('${foto.data}')"
                                             class="cursor-pointer hover:opacity-90 transition-opacity"
                                             alt="Foto ${idx + 1}">
                                        <button onclick="removeFoto('${project.id}', '${pos.id}', ${idx})"
                                                class="delete-btn">
                                            ×
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p class="text-sm text-gray-500 italic">Nessuna foto caricata</p>'}
                    </div>
                </div>
            `;
        }

        function renderMisureTab(project, pos) {
            const measureGroups = [
                {
                    title: 'Misure Principali',
                    fields: ['LF', 'HF', 'LVT', 'HVT', 'TMV', 'HMT', 'LVAR', 'HVAR'],
                    color: 'gray'
                },
                {
                    title: 'Altezze',
                    fields: ['HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'],
                    color: 'blue'
                }
            ];

            return `
                <div class="space-y-6">
                    ${measureGroups.map(group => `
                        <div class="bg-gradient-to-r from-${group.color}-50 to-${group.color}-100 rounded-xl p-6">
                            <h5 class="font-semibold text-gray-700 mb-4">${group.title} (mm)</h5>
                            <div class="grid grid-cols-2 md:grid-cols-${group.fields.length > 3 ? '4' : '3'} gap-4">
                                ${group.fields.map(field => `
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-600 mb-1">${field}</label>
                                        <input type="number" 
                                               placeholder="0" 
                                               value="${pos.misure?.[field] || ''}" 
                                               onchange="updateMisure('${project.id}', '${pos.id}', '${field}', this.value)"
                                               class="w-full input-modern px-3 py-2 rounded-lg font-mono font-semibold">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                    
                    ${pos.overrideCaratteristiche ? `
                        <div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h5 class="font-semibold text-yellow-800">⚠️ Override Caratteristiche Muro</h5>
                                <button onclick="disableOverride('${project.id}', '${pos.id}')" 
                                        class="text-sm bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-700">
                                    Ripristina globali
                                </button>
                            </div>
                            <!-- Override fields here -->
                        </div>
                    ` : `
                        <button onclick="enableOverride('${project.id}', '${pos.id}')" 
                                class="text-sm bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
                            Personalizza caratteristiche muro per questa posizione
                        </button>
                    `}
                </div>
            `;
        }

        function renderProductTab(project, pos, productType) {
            const products = pos[productType] || [];
            
            const productConfig = {
                infissi: { label: 'Infisso', icon: icons.window, color: 'blue' },
                persiane: { label: 'Persiana', icon: icons.door, color: 'purple' },
                cassonetti: { label: 'Cassonetto', icon: icons.box, color: 'orange' }
            };
            
            const config = productConfig[productType];
            const canAdd = !products || products.length === 0;
            
            return `
                <div class="space-y-4">
                    ${canAdd ? `
                        <button onclick="add${productType.charAt(0).toUpperCase() + productType.slice(1, -1)}('${project.id}', '${pos.id}')" 
                                class="btn-success text-white px-4 py-2.5 rounded-lg font-semibold flex items-center space-x-2">
                            ${icons.plus}
                            <span>Aggiungi ${config.label}</span>
                        </button>
                    ` : `
                        <div class="bg-yellow-100 border border-yellow-400 rounded p-3 text-sm text-yellow-800">
                            ⚠️ Non puoi aggiungere più di un ${config.label.toLowerCase()} per posizione.
                        </div>
                    `}
                    
                    ${products.length > 0 ? 
                        (productType === 'infissi' ? InfissoDetail(project, pos, products[0]) :
                         productType === 'persiane' ? PersianaDetail(project, pos, products[0]) :
                         CassonettoDetail(project, pos, products[0]))
                    : `
                        <div class="empty-state py-8">
                            <p class="text-gray-500">Nessun ${config.label.toLowerCase()} aggiunto</p>
                        </div>
                    `}
                </div>
            `;
        }

        function InfissoDetail(project, pos, inf) {
            return `
                <div class="product-card infissi">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-bold text-blue-700">🪟 Infisso</h4>
                        <button onclick="removeInfisso('${project.id}', '${pos.id}', 0)"
                                class="btn-danger text-white px-4 py-2 rounded-lg font-semibold">
                            🗑️ Elimina Infisso
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- DATI SPECIFICI -->
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h5 class="font-semibold text-sm mb-3 text-blue-700">📋 Dati Specifici</h5>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <!-- Quantità -->
                                <div>
                                    <label class="block text-xs font-medium mb-1">Quantità</label>
                                    <select onchange="updateInfisso('${project.id}', '${pos.id}', 0, 'qta', this.value)"
                                            class="w-full input-modern px-2 py-1 rounded text-sm">
                                        ${[1,2,3,4,5,6,7,8,9,10].map(n => 
                                            `<option value="${n}" ${(inf.qta || 1) == n ? 'selected' : ''}>${n}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                
                                <!-- Tipo -->
                                <div>
                                    <label class="block text-xs font-medium mb-1">Tipo</label>
                                    <select id="tipo-infisso-${pos.id}" 
                                            onchange="updateInfissoConditional('${project.id}', '${pos.id}', 0, 'tipo', this.value)"
                                            class="w-full input-modern px-2 py-1 rounded text-sm">
                                        <option value="">Seleziona...</option>
                                        <option value="F1" ${inf.tipo === 'F1' ? 'selected' : ''}>F1</option>
                                        <option value="PF1" ${inf.tipo === 'PF1' ? 'selected' : ''}>PF1</option>
                                        <option value="F2" ${inf.tipo === 'F2' ? 'selected' : ''}>F2</option>
                                        <option value="PF2" ${inf.tipo === 'PF2' ? 'selected' : ''}>PF2</option>
                                        <option value="F3" ${inf.tipo === 'F3' ? 'selected' : ''}>F3</option>
                                        <option value="PF3" ${inf.tipo === 'PF3' ? 'selected' : ''}>PF3</option>
                                        <option value="HST" ${inf.tipo === 'HST' ? 'selected' : ''}>HST</option>
                                        <option value="SCORR.PARALL" ${inf.tipo === 'SCORR.PARALL' ? 'selected' : ''}>SCORR.PARALL</option>
                                        <option value="FISSO" ${inf.tipo === 'FISSO' ? 'selected' : ''}>FISSO</option>
                                        <option value="altro" ${inf.tipo === 'altro' ? 'selected' : ''}>Altro e scrivo</option>
                                    </select>
                                </div>
                                
                                <!-- Tipo Altro (condizionale) -->
                                ${inf.tipo === 'altro' ? `
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Specifica Tipo</label>
                                        <input type="text" value="${inf.tipoAltro || ''}"
                                               onchange="updateInfisso('${project.id}', '${pos.id}', 0, 'tipoAltro', this.value)"
                                               placeholder="Inserisci tipo..."
                                               class="w-full input-modern px-2 py-1 rounded text-sm">
                                    </div>
                                ` : ''}
                                
                                <!-- Apertura -->
                                <div>
                                    <label class="block text-xs font-medium mb-1">Apertura</label>
                                    <select id="apertura-infisso-${pos.id}"
                                            onchange="updateInfissoConditional('${project.id}', '${pos.id}', 0, 'apertura', this.value)"
                                            class="w-full input-modern px-2 py-1 rounded text-sm">
                                        <option value="">Seleziona...</option>
                                        <option value="SX" ${inf.apertura === 'SX' ? 'selected' : ''}>SX</option>
                                        <option value="DX" ${inf.apertura === 'DX' ? 'selected' : ''}>DX</option>
                                        <option value="Fisso" ${inf.apertura === 'Fisso' ? 'selected' : ''}>Fisso</option>
                                        <option value="Ribalta" ${inf.apertura === 'Ribalta' ? 'selected' : ''}>Ribalta</option>
                                        <option value="Sp. SX" ${inf.apertura === 'Sp. SX' ? 'selected' : ''}>Sp. SX</option>
                                        <option value="Sp. DX" ${inf.apertura === 'Sp. DX' ? 'selected' : ''}>Sp. DX</option>
                                        <option value="altro" ${inf.apertura === 'altro' ? 'selected' : ''}>Altro e scrivo</option>
                                    </select>
                                </div>
                                
                                <!-- Apertura Altro (condizionale) -->
                                ${inf.apertura === 'altro' ? `
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Specifica Apertura</label>
                                        <input type="text" value="${inf.aperturaAltro || ''}"
                                               onchange="updateInfisso('${project.id}', '${pos.id}', 0, 'aperturaAltro', this.value)"
                                               placeholder="Inserisci apertura..."
                                               class="w-full input-modern px-2 py-1 rounded text-sm">
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- CONFIGURAZIONE (eredita da globale) -->
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <h5 class="font-semibold text-sm mb-3 text-green-700">⚙️ Configurazione (eredita da globale se vuoto)</h5>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                <div>
                                    <label class="block text-xs font-medium mb-1">Finitura Int</label>
                                    <select onchange="updateInfisso('${project.id}', '${pos.id}', 0, 'finituraInt', this.value)"
                                            class="w-full input-modern px-2 py-1 rounded text-sm ${inf.finituraInt ? '' : 'opacity-60'}">
                                        <option value="">-- ${project.configInfissi?.finituraInt || 'Globale'} --</option>
                                        <option value="pvc" ${inf.finituraInt === 'pvc' ? 'selected' : ''}>PVC</option>
                                        <option value="legno" ${inf.finituraInt === 'legno' ? 'selected' : ''}>LEGNO</option>
                                        <option value="alluminio" ${inf.finituraInt === 'alluminio' ? 'selected' : ''}>ALLUMINIO</option>
                                        <option value="ceramica" ${inf.finituraInt === 'ceramica' ? 'selected' : ''}>CERAMICA</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium mb-1">Finitura Est</label>
                                    <select onchange="updateInfisso('${project.id}', '${pos.id}', 0, 'finituraEst', this.value)"
                                            class="w-full input-modern px-2 py-1 rounded text-sm ${inf.finituraEst ? '' : 'opacity-60'}">
                                        <option value="">-- ${project.configInfissi?.finituraEst || 'Globale'} --</option>
                                        <option value="pvc" ${inf.finituraEst === 'pvc' ? 'selected' : ''}>PVC</option>
                                        <option value="alluminio" ${inf.finituraEst === 'alluminio' ? 'selected' : ''}>ALLUMINIO</option>
                                        <option value="ceramica" ${inf.finituraEst === 'ceramica' ? 'selected' : ''}>CERAMICA</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium mb-1">Colore Int</label>
                                    <input type="text" 
                                           value="${inf.coloreInt || ''}"
                                           placeholder="${project.configInfissi?.coloreInt || 'Globale'}"
                                           onchange="updateInfisso('${project.id}', '${pos.id}', 0, 'coloreInt', this.value)"
                                           class="w-full input-modern px-2 py-1 rounded text-sm ${inf.coloreInt ? '' : 'opacity-60'}">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium mb-1">Colore Est</label>
                                    <input type="text" 
                                           value="${inf.coloreEst || ''}"
                                           placeholder="${project.configInfissi?.coloreEst || 'Globale'}"
                                           onchange="updateInfisso('${project.id}', '${pos.id}', 0, 'coloreEst', this.value)"
                                           class="w-full input-modern px-2 py-1 rounded text-sm ${inf.coloreEst ? '' : 'opacity-60'}">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium mb-1">Tipo Anta</label>
                                    <select onchange="updateInfisso('${project.id}', '${pos.id}', 0, 'tipoAnta', this.value)"
                                            class="w-full input-modern px-2 py-1 rounded text-sm ${inf.tipoAnta ? '' : 'opacity-60'}">
                                        <option value="">-- ${project.configInfissi?.tipoAnta || 'Globale'} --</option>
                                        <option value="step-line" ${inf.tipoAnta === 'step-line' ? 'selected' : ''}>STEP-LINE</option>
                                        <option value="nova-line" ${inf.tipoAnta === 'nova-line' ? 'selected' : ''}>NOVA-LINE</option>
                                        <option value="slim-line" ${inf.tipoAnta === 'slim-line' ? 'selected' : ''}>SLIM-LINE</option>
                                        <option value="classic-line" ${inf.tipoAnta === 'classic-line' ? 'selected' : ''}>CLASSIC-LINE</option>
                                        <option value="step-line-door" ${inf.tipoAnta === 'step-line-door' ? 'selected' : ''}>STEP-LINE DOOR</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium mb-1">Telaio</label>
                                    <select onchange="updateInfisso('${project.id}', '${pos.id}', 0, 'telaio', this.value)"
                                            class="w-full input-modern px-2 py-1 rounded text-sm ${inf.telaio ? '' : 'opacity-60'}">
                                        <option value="">-- ${project.configInfissi?.telaio || 'Globale'} --</option>
                                        <option value="961" ${inf.telaio === '961' ? 'selected' : ''}>961</option>
                                        <option value="962" ${inf.telaio === '962' ? 'selected' : ''}>962</option>
                                        <option value="966" ${inf.telaio === '966' ? 'selected' : ''}>966</option>
                                        <option value="965" ${inf.telaio === '965' ? 'selected' : ''}>965</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium mb-1">Allarme</label>
                                    <select onchange="updateInfisso('${project.id}', '${pos.id}', 0, 'allarme', this.value)"
                                            class="w-full input-modern px-2 py-1 rounded text-sm ${inf.allarme ? '' : 'opacity-60'}">
                                        <option value="">-- ${project.configInfissi?.allarme || 'Globale'} --</option>
                                        <option value="si" ${inf.allarme === 'si' ? 'selected' : ''}>Sì</option>
                                        <option value="no" ${inf.allarme === 'no' ? 'selected' : ''}>No</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium mb-1">Vetro</label>
                                    <select onchange="updateInfisso('${project.id}', '${pos.id}', 0, 'vetro', this.value)"
                                            class="w-full input-modern px-2 py-1 rounded text-sm ${inf.vetro ? '' : 'opacity-60'}">
                                        <option value="">-- ${project.configInfissi?.vetro || 'Globale'} --</option>
                                        <option value="doppio" ${inf.vetro === 'doppio' ? 'selected' : ''}>Doppio</option>
                                        <option value="doppio-sat" ${inf.vetro === 'doppio-sat' ? 'selected' : ''}>Doppio SAT</option>
                                        <option value="triplo" ${inf.vetro === 'triplo' ? 'selected' : ''}>Triplo</option>
                                        <option value="triplo-sat" ${inf.vetro === 'triplo-sat' ? 'selected' : ''}>Triplo SAT</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium mb-1">Tagli Telaio</label>
                                    <select onchange="updateInfisso('${project.id}', '${pos.id}', 0, 'tagliTelaio', this.value)"
                                            class="w-full input-modern px-2 py-1 rounded text-sm ${inf.tagliTelaio ? '' : 'opacity-60'}">
                                        <option value="">-- ${project.configInfissi?.tagliTelaio || 'Globale'} --</option>
                                        <option value="sopra" ${inf.tagliTelaio === 'sopra' ? 'selected' : ''}>Sopra</option>
                                        <option value="sotto" ${inf.tagliTelaio === 'sotto' ? 'selected' : ''}>Sotto</option>
                                        <option value="sopra-sotto" ${inf.tagliTelaio === 'sopra-sotto' ? 'selected' : ''}>Sopra/Sotto</option>
                                        <option value="dx" ${inf.tagliTelaio === 'dx' ? 'selected' : ''}>DX</option>
                                        <option value="sx" ${inf.tagliTelaio === 'sx' ? 'selected' : ''}>SX</option>
                                        <option value="dx-sx" ${inf.tagliTelaio === 'dx-sx' ? 'selected' : ''}>DX/SX</option>
                                        <option value="4-lati" ${inf.tagliTelaio === '4-lati' ? 'selected' : ''}>4 Lati</option>
                                        <option value="sopra-laterali" ${inf.tagliTelaio === 'sopra-laterali' ? 'selected' : ''}>Sopra/Laterali</option>
                                        <option value="sotto-laterali" ${inf.tagliTelaio === 'sotto-laterali' ? 'selected' : ''}>Sotto/Laterali</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium mb-1">Tipo Tagli</label>
                                    <input type="text" 
                                           value="${inf.tipoTagli || ''}"
                                           placeholder="${project.configInfissi?.tipoTagli || 'Globale'}"
                                           onchange="updateInfisso('${project.id}', '${pos.id}', 0, 'tipoTagli', this.value)"
                                           class="w-full input-modern px-2 py-1 rounded text-sm ${inf.tipoTagli ? '' : 'opacity-60'}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function PersianaDetail(project, pos, pers) {
            return `
                <div class="product-card persiane">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-bold text-purple-700">🚪 Persiana</h4>
                        <button onclick="removePersiana('${project.id}', '${pos.id}', 0)"
                                class="btn-danger text-white px-4 py-2 rounded-lg font-semibold">
                            🗑️ Elimina Persiana
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- DATI SPECIFICI PERSIANA -->
                        <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                            <h5 class="font-semibold text-sm mb-3 text-purple-700">📋 Dati Specifici</h5>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-xs font-medium mb-1">Quantità</label>
                                    <select onchange="updatePersiana('${project.id}', '${pos.id}', 0, 'qta', this.value)"
                                            class="w-full input-modern px-2 py-1 rounded text-sm">
                                        ${[1,2,3,4,5].map(n => 
                                            `<option value="${n}" ${(pers.qta || 1) == n ? 'selected' : ''}>${n}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium mb-1">Tipo</label>
                                    <select onchange="updatePersianaConditional('${project.id}', '${pos.id}', 0, 'tipo', this.value)"
                                            class="w-full input-modern px-2 py-1 rounded text-sm">
                                        <option value="">Seleziona...</option>
                                        <option value="SP2" ${pers.tipo === 'SP2' ? 'selected' : ''}>SP2</option>
                                        <option value="SP3" ${pers.tipo === 'SP3' ? 'selected' : ''}>SP3</option>
                                        <option value="PS2" ${pers.tipo === 'PS2' ? 'selected' : ''}>PS2</option>
                                        <option value="PS3" ${pers.tipo === 'PS3' ? 'selected' : ''}>PS3</option>
                                        <option value="altro" ${pers.tipo === 'altro' ? 'selected' : ''}>Altro</option>
                                    </select>
                                </div>
                                
                                ${pers.tipo === 'altro' ? `
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Specifica Tipo</label>
                                        <input type="text" value="${pers.tipoAltro || ''}"
                                               onchange="updatePersiana('${project.id}', '${pos.id}', 0, 'tipoAltro', this.value)"
                                               placeholder="Inserisci tipo..."
                                               class="w-full input-modern px-2 py-1 rounded text-sm">
                                    </div>
                                ` : ''}
                                
                                <div>
                                    <label class="block text-xs font-medium mb-1">Apertura</label>
                                    <select onchange="updatePersianaConditional('${project.id}', '${pos.id}', 0, 'apertura', this.value)"
                                            class="w-full input-modern px-2 py-1 rounded text-sm">
                                        <option value="">Seleziona...</option>
                                        <option value="SX" ${pers.apertura === 'SX' ? 'selected' : ''}>SX</option>
                                        <option value="DX" ${pers.apertura === 'DX' ? 'selected' : ''}>DX</option>
                                        <option value="Libro DX" ${pers.apertura === 'Libro DX' ? 'selected' : ''}>Libro DX</option>
                                        <option value="Libro SX" ${pers.apertura === 'Libro SX' ? 'selected' : ''}>Libro SX</option>
                                        <option value="Libro Bilaterale" ${pers.apertura === 'Libro Bilaterale' ? 'selected' : ''}>Libro Bilaterale</option>
                                        <option value="altro" ${pers.apertura === 'altro' ? 'selected' : ''}>Altro</option>
                                    </select>
                                </div>
                                
                                ${pers.apertura === 'altro' ? `
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Specifica Apertura</label>
                                        <input type="text" value="${pers.aperturaAltro || ''}"
                                               onchange="updatePersiana('${project.id}', '${pos.id}', 0, 'aperturaAltro', this.value)"
                                               placeholder="Inserisci apertura..."
                                               class="w-full input-modern px-2 py-1 rounded text-sm">
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- CONFIGURAZIONE PERSIANA -->
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <h5 class="font-semibold text-sm mb-3 text-green-700">⚙️ Configurazione</h5>
                            <div class="space-y-2">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Modello</label>
                                        <input type="text" 
                                               value="${pers.modello || ''}"
                                               placeholder="${project.configPersiane?.modello || 'Globale'}"
                                               onchange="updatePersiana('${project.id}', '${pos.id}', 0, 'modello', this.value)"
                                               class="w-full input-modern px-2 py-1 rounded text-sm">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Fissaggio</label>
                                        <select onchange="updatePersianaFissaggio('${project.id}', '${pos.id}', 0, this.value)"
                                                class="w-full input-modern px-2 py-1 rounded text-sm">
                                            <option value="">-- ${project.configPersiane?.fissaggio || 'Globale'} --</option>
                                            <option value="A MURO" ${pers.fissaggio === 'A MURO' ? 'selected' : ''}>A MURO</option>
                                            <option value="TELAIO" ${pers.fissaggio === 'TELAIO' ? 'selected' : ''}>TELAIO</option>
                                        </select>
                                    </div>
                                </div>
                                
                                ${(pers.fissaggio === 'TELAIO' || (!pers.fissaggio && project.configPersiane?.fissaggio === 'TELAIO')) ? `
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium mb-1">Tipo Telaio</label>
                                            <input type="text" 
                                                   value="${pers.tipoTelaio || ''}"
                                                   placeholder="${project.configPersiane?.tipoTelaio || 'Globale'}"
                                                   onchange="updatePersiana('${project.id}', '${pos.id}', 0, 'tipoTelaio', this.value)"
                                                   class="w-full input-modern px-2 py-1 rounded text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium mb-1">Colore Telaio</label>
                                            <input type="text" 
                                                   value="${pers.coloreTelaio || ''}"
                                                   placeholder="${project.configPersiane?.coloreTelaio || 'Globale'}"
                                                   onchange="updatePersiana('${project.id}', '${pos.id}', 0, 'coloreTelaio', this.value)"
                                                   class="w-full input-modern px-2 py-1 rounded text-sm">
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Colore Persiana</label>
                                        <input type="text" 
                                               value="${pers.colorePersiana || ''}"
                                               placeholder="${project.configPersiane?.colorePersiana || 'Globale'}"
                                               onchange="updatePersiana('${project.id}', '${pos.id}', 0, 'colorePersiana', this.value)"
                                               class="w-full input-modern px-2 py-1 rounded text-sm">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Battuta</label>
                                        <select onchange="updatePersiana('${project.id}', '${pos.id}', 0, 'battuta', this.value)"
                                                class="w-full input-modern px-2 py-1 rounded text-sm">
                                            <option value="">-- ${project.configPersiane?.battuta || 'Globale'} --</option>
                                            <option value="3 LATI" ${pers.battuta === '3 LATI' ? 'selected' : ''}>3 LATI</option>
                                            <option value="4 LATI" ${pers.battuta === '4 LATI' ? 'selected' : ''}>4 LATI</option>
                                            <option value="2 LATI LATERALI" ${pers.battuta === '2 LATI LATERALI' ? 'selected' : ''}>2 LATI LATERALI</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function CassonettoDetail(project, pos, cass) {
            return `
                <div class="product-card cassonetti">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-bold text-orange-700">📦 Cassonetto</h4>
                        <button onclick="removeCassonetto('${project.id}', '${pos.id}', 0)"
                                class="btn-danger text-white px-4 py-2 rounded-lg font-semibold">
                            🗑️ Elimina Cassonetto
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- DATI SPECIFICI CASSONETTO -->
                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                            <h5 class="font-semibold text-sm mb-3 text-orange-700">📋 Dati Specifici</h5>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-xs font-medium mb-1">Quantità</label>
                                    <select onchange="updateCassonetto('${project.id}', '${pos.id}', 0, 'qta', this.value)"
                                            class="w-full input-modern px-2 py-1 rounded text-sm">
                                        ${[1,2,3,4,5].map(n => 
                                            `<option value="${n}" ${(cass.qta || 1) == n ? 'selected' : ''}>${n}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium mb-1">Misura L</label>
                                    <input type="number" value="${cass.misuraL || ''}"
                                           onchange="updateCassonetto('${project.id}', '${pos.id}', 0, 'misuraL', this.value)"
                                           placeholder="mm"
                                           class="w-full input-modern px-2 py-1 rounded text-sm">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium mb-1">Misura H</label>
                                    <input type="number" value="${cass.misuraH || ''}"
                                           onchange="updateCassonetto('${project.id}', '${pos.id}', 0, 'misuraH', this.value)"
                                           placeholder="mm"
                                           class="w-full input-modern px-2 py-1 rounded text-sm">
                                </div>
                            </div>
                        </div>
                        
                        <!-- CONFIGURAZIONE CASSONETTO -->
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <h5 class="font-semibold text-sm mb-3 text-green-700">⚙️ Configurazione</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium mb-1">Tipo</label>
                                    <select onchange="updateCassonetto('${project.id}', '${pos.id}', 0, 'tipo', this.value)"
                                            class="w-full input-modern px-2 py-1 rounded text-sm">
                                        <option value="">-- ${project.configCassonetti?.tipo || 'Globale'} --</option>
                                        <option value="monoblocco" ${cass.tipo === 'monoblocco' ? 'selected' : ''}>MONOBLOCCO</option>
                                        <option value="isole" ${cass.tipo === 'isole' ? 'selected' : ''}>SOLO ISOLE CASSONETTO</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium mb-1">Azienda</label>
                                    <input type="text" 
                                           value="${cass.azienda || ''}"
                                           placeholder="${project.configCassonetti?.azienda || 'Globale'}"
                                           onchange="updateCassonetto('${project.id}', '${pos.id}', 0, 'azienda', this.value)"
                                           class="w-full input-modern px-2 py-1 rounded text-sm">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium mb-1">Colore</label>
                                    <input type="text" 
                                           value="${cass.colore || ''}"
                                           placeholder="${project.configCassonetti?.colore || 'Globale'}"
                                           onchange="updateCassonetto('${project.id}', '${pos.id}', 0, 'colore', this.value)"
                                           class="w-full input-modern px-2 py-1 rounded text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Modal Components
        function NewProjectModal() {
            return `
                <div id="modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
                    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl animate-slide-in">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">Nuovo Progetto</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">Nome Progetto *</label>
                                <input type="text" id="projectName" placeholder="Es: Villa Rossi" 
                                       class="w-full input-modern px-4 py-3 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">Cliente *</label>
                                <input type="text" id="projectClient" placeholder="Es: Mario Rossi" 
                                       class="w-full input-modern px-4 py-3 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">Descrizione</label>
                                <textarea id="projectDescription" placeholder="Descrizione opzionale..." 
                                          rows="3"
                                          class="w-full input-modern px-4 py-3 rounded-lg resize-none"></textarea>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-8">
                            <button onclick="hideModal()" 
                                    class="flex-1 px-4 py-3 border-2 border-gray-200 text-gray-600 rounded-lg font-semibold hover:bg-gray-50 transition-colors">
                                Annulla
                            </button>
                            <button onclick="createProject()" 
                                    class="flex-1 btn-primary text-white px-4 py-3 rounded-lg font-semibold">
                                Crea Progetto
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function FotoModal() {
            return `
                <div id="foto-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50" 
                     onclick="hideFotoModal()">
                    <div class="relative max-w-5xl max-h-screen p-4">
                        <button onclick="hideFotoModal()" 
                                class="absolute top-4 right-4 bg-white/20 backdrop-blur text-white rounded-full w-12 h-12 flex items-center justify-center hover:bg-white/30 transition-colors">
                            ${icons.x}
                        </button>
                        <img id="foto-modal-img" src="" class="max-w-full max-h-screen object-contain rounded-lg">
                    </div>
                </div>
            `;
        }

        // Window Functions
        window.goBack = () => {
            if (state.screen === 'position') {
                state.screen = 'project';
            } else if (state.screen === 'project') {
                state.screen = 'list';
            }
            render();
        };

        window.toggleSection = (sectionId) => {
            const section = document.getElementById(`section-${sectionId}`);
            const arrow = document.getElementById(`arrow-${sectionId}`);
            if (section && arrow) {
                section.classList.toggle('hidden');
                arrow.style.transform = section.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
            }
        };

        window.showNewProjectModal = () => document.getElementById('modal').classList.remove('hidden');
        window.hideModal = () => document.getElementById('modal').classList.add('hidden');

        window.createProject = () => {
            const name = document.getElementById('projectName').value.trim();
            const client = document.getElementById('projectClient').value.trim();
            const description = document.getElementById('projectDescription').value.trim();
            
            if (name && client) {
                const project = addProject(name, client, description);
                hideModal();
                state.currentProject = project.id;
                state.screen = 'project';
                render();
            } else {
                showNotification('Compila tutti i campi obbligatori', 'error');
            }
        };

        window.openProject = (id) => {
            state.currentProject = id;
            state.screen = 'project';
            render();
        };

        window.openPosition = (id) => {
            state.currentPosition = id;
            state.screen = 'position';
            render();
        };

        window.switchPosition = (positionId) => {
            state.currentPosition = positionId;
            render();
        };

        window.updateProject = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                project[field] = value;
                project.updatedAt = new Date().toISOString();
                saveState();
            }
        };

        window.updateClientData = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.clientData) project.clientData = {};
                project.clientData[field] = value;
                project.updatedAt = new Date().toISOString();
                saveState();
            }
        };

        window.updateProdotti = (projectId, prodotto, checked) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.prodotti) project.prodotti = {};
                project.prodotti[prodotto] = checked;
                project.updatedAt = new Date().toISOString();
                saveState();
                render();
            }
        };

        window.updateConfigInfissi = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configInfissi) project.configInfissi = {};
                project.configInfissi[field] = value;
                project.updatedAt = new Date().toISOString();
                saveState();
            }
        };

        window.updateConfigPersiane = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configPersiane) project.configPersiane = {};
                project.configPersiane[field] = value;
                project.updatedAt = new Date().toISOString();
                saveState();
            }
        };

        window.updateConfigPersianeConditional = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configPersiane) project.configPersiane = {};
                project.configPersiane[field] = value;
                project.updatedAt = new Date().toISOString();
                saveState();
                render(); // Re-render to show/hide conditional fields
            }
        };

        window.updateFissaggioPersiane = (projectId, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configPersiane) project.configPersiane = {};
                project.configPersiane.fissaggio = value;
                project.updatedAt = new Date().toISOString();
                saveState();
                render(); // Re-render to show/hide telaio fields
            }
        };

        window.updateConfigCassonetti = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configCassonetti) project.configCassonetti = {};
                project.configCassonetti[field] = value;
                project.updatedAt = new Date().toISOString();
                saveState();
            }
        };

        window.updatePosition = (projectId, posId, updates) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    Object.assign(pos, updates);
                    project.updatedAt = new Date().toISOString();
                    saveState();
                    if (updates.name) render();
                }
            }
        };

        window.updateMisure = (projectId, posId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    if (!pos.misure) pos.misure = {};
                    pos.misure[field] = value;
                    project.updatedAt = new Date().toISOString();
                    saveState();
                }
            }
        };

        window.setTab = (posId, tab) => {
            const project = state.projects.find(p => p.id === state.currentProject);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos.activeTab = tab;
                    render();
                }
            }
        };

        window.enableOverride = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos.overrideCaratteristiche = true;
                    pos.caratteristicheMuroOverride = {...project.caratteristicheMuro};
                    saveState();
                    render();
                }
            }
        };

        window.disableOverride = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos.overrideCaratteristiche = false;
                    pos.caratteristicheMuroOverride = null;
                    saveState();
                    render();
                }
            }
        };

        window.addProduct = (projectId, posId, productType) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    if (!pos[productType]) pos[productType] = [];
                    pos[productType].push({
                        id: generateId(),
                        qta: 1,
                        // Add default fields based on productType
                    });
                    project.updatedAt = new Date().toISOString();
                    saveState();
                    render();
                }
            }
        };

        window.removeProduct = (projectId, posId, productType, idx) => {
            if (confirm('Eliminare questo prodotto?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos[productType]) {
                        pos[productType].splice(idx, 1);
                        project.updatedAt = new Date().toISOString();
                        saveState();
                        render();
                    }
                }
            }
        };

        window.addFoto = (projectId, posId, input) => {
            const files = input.files;
            if (files.length === 0) return;
            
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const pos = project.positions.find(p => p.id === posId);
            if (!pos) return;
            
            if (!pos.foto) pos.foto = [];
            
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) {
                    showNotification('Seleziona solo file immagine', 'error');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('Immagine troppo grande (max 5MB)', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    pos.foto.push({
                        data: e.target.result,
                        nome: file.name,
                        timestamp: new Date().toISOString()
                    });
                    project.updatedAt = new Date().toISOString();
                    saveState();
                    render();
                };
                reader.readAsDataURL(file);
            });
            
            input.value = '';
        };

        window.removeFoto = (projectId, posId, fotoIdx) => {
            if (confirm('Eliminare questa foto?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos.foto) {
                        pos.foto.splice(fotoIdx, 1);
                        project.updatedAt = new Date().toISOString();
                        saveState();
                        render();
                    }
                }
            }
        };

        window.showFotoModal = (fotoData) => {
            const modal = document.getElementById('foto-modal');
            const img = document.getElementById('foto-modal-img');
            if (modal && img) {
                img.src = fotoData;
                modal.classList.remove('hidden');
            }
        };

        window.hideFotoModal = () => {
            const modal = document.getElementById('foto-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        };

        window.addInfisso = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    if (!pos.infissi) pos.infissi = [];
                    if (pos.infissi.length === 0) {
                        const nuovoInfisso = {
                            qta: 1,
                            tipo: '',
                            tipoAltro: '',
                            apertura: '',
                            aperturaAltro: '',
                            // Copia configurazioni dal globale se esistono
                            finituraInt: '',
                            finituraEst: '',
                            coloreInt: '',
                            coloreEst: '',
                            tipoAnta: '',
                            telaio: '',
                            allarme: '',
                            vetro: '',
                            tagliTelaio: '',
                            tipoTagli: ''
                        };
                        pos.infissi.push(nuovoInfisso);
                        project.updatedAt = new Date().toISOString();
                        saveState();
                        showNotification('Infisso aggiunto', 'success');
                        render();
                    }
                }
            }
        };

        window.updateInfisso = (projectId, posId, idx, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.infissi && pos.infissi[idx]) {
                    pos.infissi[idx][field] = value;
                    project.updatedAt = new Date().toISOString();
                    saveState();
                }
            }
        };

        window.updateInfissoConditional = (projectId, posId, idx, field, value) => {
            updateInfisso(projectId, posId, idx, field, value);
            render(); // Re-render to show/hide conditional fields
        };

        window.removeInfisso = (projectId, posId, idx) => {
            if (confirm('Eliminare questo infisso?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos.infissi) {
                        pos.infissi.splice(idx, 1);
                        project.updatedAt = new Date().toISOString();
                        saveState();
                        showNotification('Infisso eliminato', 'info');
                        render();
                    }
                }
            }
        };

        window.addPersiana = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    if (!pos.persiane) pos.persiane = [];
                    if (pos.persiane.length === 0) {
                        const nuovaPersiana = {
                            qta: 1,
                            tipo: '',
                            tipoAltro: '',
                            apertura: '',
                            aperturaAltro: '',
                            modello: '',
                            fissaggio: '',
                            tipoTelaio: '',
                            colorePersiana: '',
                            coloreTelaio: '',
                            battuta: ''
                        };
                        pos.persiane.push(nuovaPersiana);
                        project.updatedAt = new Date().toISOString();
                        saveState();
                        showNotification('Persiana aggiunta', 'success');
                        render();
                    }
                }
            }
        };

        window.updatePersiana = (projectId, posId, idx, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.persiane && pos.persiane[idx]) {
                    pos.persiane[idx][field] = value;
                    project.updatedAt = new Date().toISOString();
                    saveState();
                }
            }
        };

        window.updatePersianaConditional = (projectId, posId, idx, field, value) => {
            updatePersiana(projectId, posId, idx, field, value);
            render();
        };

        window.updatePersianaFissaggio = (projectId, posId, idx, value) => {
            updatePersiana(projectId, posId, idx, 'fissaggio', value);
            render(); // Re-render to show/hide telaio fields
        };

        window.removePersiana = (projectId, posId, idx) => {
            if (confirm('Eliminare questa persiana?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos.persiane) {
                        pos.persiane.splice(idx, 1);
                        project.updatedAt = new Date().toISOString();
                        saveState();
                        showNotification('Persiana eliminata', 'info');
                        render();
                    }
                }
            }
        };

        window.addCassonetto = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    if (!pos.cassonetti) pos.cassonetti = [];
                    if (pos.cassonetti.length === 0) {
                        const nuovoCassonetto = {
                            qta: 1,
                            misuraL: '',
                            misuraH: '',
                            tipo: '',
                            azienda: '',
                            colore: ''
                        };
                        pos.cassonetti.push(nuovoCassonetto);
                        project.updatedAt = new Date().toISOString();
                        saveState();
                        showNotification('Cassonetto aggiunto', 'success');
                        render();
                    }
                }
            }
        };

        window.updateCassonetto = (projectId, posId, idx, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.cassonetti && pos.cassonetti[idx]) {
                    pos.cassonetti[idx][field] = value;
                    project.updatedAt = new Date().toISOString();
                    saveState();
                }
            }
        };

        window.removeCassonetto = (projectId, posId, idx) => {
            if (confirm('Eliminare questo cassonetto?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos.cassonetti) {
                        pos.cassonetti.splice(idx, 1);
                        project.updatedAt = new Date().toISOString();
                        saveState();
                        showNotification('Cassonetto eliminato', 'info');
                        render();
                    }
                }
            }
        };

        // Main Render Function
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = `
                ${Header()}
                <main class="max-w-7xl mx-auto px-4 py-8">
                    ${state.screen === 'list' ? ProjectsList() : 
                      state.screen === 'position' ? PositionDetail() : 
                      ProjectDetail()}
                </main>
                ${NewProjectModal()}
                ${FotoModal()}
            `;
        }

        // Initialize App
        loadState();
        render();
    </script>
</body>
</html>
