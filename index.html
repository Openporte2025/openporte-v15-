<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Porte v3.0 - Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', sans-serif;
        }
        body { 
            overscroll-behavior-y: contain;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        input, select, textarea { 
            font-size: 16px !important;
        }
        .compact-input {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .step-indicator {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s;
        }
        .step-indicator.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.1);
        }
        .step-indicator.completed {
            background: #10b981;
            color: white;
        }
        .section-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            transition: all 0.3s;
        }
        .section-card:hover {
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        .product-pill {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            border: 2px solid;
            transition: all 0.3s;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }
        .product-pill.selected {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .inline-field {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
        }
        @media (min-width: 768px) {
            .config-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        .tab-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s;
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .compact-section {
            max-height: 400px;
            overflow-y: auto;
        }
        .compact-section::-webkit-scrollbar {
            width: 6px;
        }
        .compact-section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .compact-section::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .flow-container {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 1rem;
        }
        .flow-step {
            min-width: 300px;
            flex: 1;
        }
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .grid-compact {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        @media (min-width: 640px) {
            .grid-compact {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (min-width: 1024px) {
            .grid-compact {
                grid-template-columns: repeat(6, 1fr);
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <script>
        // State Management
        let state = {
            screen: 'list',
            projects: [],
            currentProject: null,
            currentPosition: null,
            setupStep: 1 // For project setup flow
        };

        // Load/Save Functions
        function loadState() {
            const saved = localStorage.getItem('openPorteData');
            if (saved) {
                try {
                    state = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading state:', e);
                }
            }
        }

        function saveState() {
            localStorage.setItem('openPorteData', JSON.stringify(state));
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Notification System
        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-100 text-green-800 border-green-300',
                error: 'bg-red-100 text-red-800 border-red-300',
                info: 'bg-blue-100 text-blue-800 border-blue-300'
            };
            
            const notification = document.createElement('div');
            notification.className = `notification ${colors[type]} border-2`;
            notification.innerHTML = `<strong>${message}</strong>`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 2000);
        }

        // Project Management
        function createProject(name, client) {
            const project = {
                id: generateId(),
                name,
                client,
                clientData: {},
                prodotti: {},
                caratteristicheMuro: {},
                configInfissi: {},
                configPersiane: {},
                configCassonetti: {},
                positions: [],
                createdAt: new Date().toISOString()
            };
            state.projects.push(project);
            state.currentProject = project.id;
            state.setupStep = 1;
            saveState();
            return project;
        }

        function addPosition(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = {
                    id: generateId(),
                    name: `Pos. ${project.positions.length + 1}`,
                    piano: project.clientData?.piano || '',
                    ambiente: '',
                    misure: {},
                    infissi: [],
                    persiane: [],
                    cassonetti: [],
                    foto: [],
                    note: ''
                };
                project.positions.push(pos);
                saveState();
                state.currentPosition = pos.id;
                showNotification('Posizione aggiunta', 'success');
                render();
            }
        }

        // MAIN COMPONENTS
        function Header() {
            return `
                <header class="bg-white/95 backdrop-blur shadow-lg sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-4 py-3">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                ${state.screen !== 'list' ? `
                                    <button onclick="goBack()" class="p-2 hover:bg-gray-100 rounded-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                        </svg>
                                    </button>
                                ` : ''}
                                <h1 class="text-xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                                    Open Porte v3.0
                                </h1>
                            </div>
                            <div class="flex items-center gap-2">
                                ${state.screen === 'list' ? `
                                    <button onclick="exportData()" class="px-3 py-1.5 text-sm border rounded-lg hover:bg-gray-50">
                                        📥 Export
                                    </button>
                                    <button onclick="showNewProjectModal()" 
                                            class="px-4 py-1.5 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium hover:shadow-lg transition-all">
                                        + Nuovo Progetto
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </header>
            `;
        }

        function ProjectsList() {
            if (state.projects.length === 0) {
                return `
                    <div class="min-h-[70vh] flex items-center justify-center">
                        <div class="text-center bg-white rounded-2xl p-8 shadow-xl">
                            <div class="text-6xl mb-4">📁</div>
                            <h2 class="text-2xl font-bold mb-2">Benvenuto in Open Porte</h2>
                            <p class="text-gray-600 mb-6">Inizia creando il tuo primo progetto</p>
                            <button onclick="showNewProjectModal()" 
                                    class="px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                                + Crea Primo Progetto
                            </button>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                    ${state.projects.map(p => `
                        <div class="section-card hover:transform hover:scale-105 transition-all cursor-pointer"
                             onclick="openProject('${p.id}')">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="font-bold text-lg">${p.name}</h3>
                                    <p class="text-sm text-gray-600">${p.client}</p>
                                </div>
                                <span class="text-2xl">🏗️</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-500">${p.positions.length} posizioni</span>
                                <span class="text-purple-600 font-medium">Apri →</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function ProjectSetup() {
            const project = state.projects.find(p => p.id === state.currentProject);
            if (!project) return '';

            return `
                <div class="max-w-7xl mx-auto p-4">
                    <!-- Progress Steps -->
                    <div class="flex justify-between items-center mb-6 bg-white rounded-lg p-4 shadow">
                        ${[
                            {num: 1, label: 'Dati Cliente'},
                            {num: 2, label: 'Prodotti'},
                            {num: 3, label: 'Configurazioni'},
                            {num: 4, label: 'Caratteristiche Muro'},
                            {num: 5, label: 'Posizioni'}
                        ].map(step => `
                            <div class="flex flex-col items-center cursor-pointer" onclick="state.setupStep=${step.num}; render()">
                                <div class="step-indicator ${state.setupStep === step.num ? 'active' : state.setupStep > step.num ? 'completed' : 'bg-gray-200'}">
                                    ${state.setupStep > step.num ? '✓' : step.num}
                                </div>
                                <span class="text-xs mt-1 ${state.setupStep === step.num ? 'font-bold' : ''}">${step.label}</span>
                            </div>
                        `).join('<div class="flex-1 border-t-2 border-gray-200 -mt-4"></div>')}
                    </div>

                    <!-- Content Area -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        ${state.setupStep === 1 ? renderStep1ClientData(project) :
                          state.setupStep === 2 ? renderStep2Products(project) :
                          state.setupStep === 3 ? renderStep3Configurations(project) :
                          state.setupStep === 4 ? renderStep4WallFeatures(project) :
                          renderStep5Positions(project)}
                        
                        <!-- Navigation -->
                        <div class="flex justify-between mt-6 pt-4 border-t">
                            <button onclick="state.setupStep = Math.max(1, state.setupStep - 1); render()" 
                                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 ${state.setupStep === 1 ? 'invisible' : ''}">
                                ← Indietro
                            </button>
                            ${state.setupStep < 5 ? `
                                <button onclick="state.setupStep = Math.min(5, state.setupStep + 1); saveState(); render()" 
                                        class="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium hover:shadow-lg">
                                    Avanti →
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStep1ClientData(project) {
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">👤</span> Dati Cliente e Progetto
                    </h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Nome Progetto</label>
                            <input type="text" value="${project.name}" 
                                   onchange="updateProject('${project.id}', 'name', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Cliente</label>
                            <input type="text" value="${project.client}" 
                                   onchange="updateProject('${project.id}', 'client', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Piano</label>
                            <input type="text" placeholder="Es: Piano Terra" 
                                   value="${project.clientData?.piano || ''}"
                                   onchange="updateClientData('${project.id}', 'piano', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Città</label>
                            <input type="text" placeholder="Milano" 
                                   value="${project.clientData?.citta || ''}"
                                   onchange="updateClientData('${project.id}', 'citta', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Via/Indirizzo</label>
                            <input type="text" placeholder="Via Roma, 1" 
                                   value="${project.clientData?.via || ''}"
                                   onchange="updateClientData('${project.id}', 'via', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Telefono</label>
                            <input type="tel" placeholder="+39 333 1234567" 
                                   value="${project.clientData?.telefono || ''}"
                                   onchange="updateClientData('${project.id}', 'telefono', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Email</label>
                            <input type="email" placeholder="cliente@email.com" 
                                   value="${project.clientData?.email || ''}"
                                   onchange="updateClientData('${project.id}', 'email', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Note</label>
                            <input type="text" placeholder="Note aggiuntive..." 
                                   value="${project.clientData?.note || ''}"
                                   onchange="updateClientData('${project.id}', 'note', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStep2Products(project) {
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">🛠️</span> Seleziona i Prodotti da Installare
                    </h2>
                    <p class="text-gray-600 mb-4">Seleziona quali prodotti verranno installati in questo progetto:</p>
                    
                    <div class="flex flex-wrap gap-4">
                        <label class="product-pill ${project.prodotti?.infissi ? 'selected bg-blue-50 border-blue-500 text-blue-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.infissi ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'infissi', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">🪟</span>
                            <div>
                                <div class="font-semibold">Infissi</div>
                                <div class="text-xs opacity-75">Finestre e porte</div>
                            </div>
                        </label>

                        <label class="product-pill ${project.prodotti?.persiane ? 'selected bg-purple-50 border-purple-500 text-purple-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.persiane ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'persiane', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">🚪</span>
                            <div>
                                <div class="font-semibold">Persiane</div>
                                <div class="text-xs opacity-75">Persiane e scuri</div>
                            </div>
                        </label>

                        <label class="product-pill ${project.prodotti?.cassonetti ? 'selected bg-orange-50 border-orange-500 text-orange-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.cassonetti ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'cassonetti', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">📦</span>
                            <div>
                                <div class="font-semibold">Cassonetti</div>
                                <div class="text-xs opacity-75">Cassonetti avvolgibili</div>
                            </div>
                        </label>
                    </div>

                    ${Object.values(project.prodotti || {}).some(v => v) ? `
                        <div class="mt-6 p-4 bg-green-50 border border-green-300 rounded-lg">
                            <p class="text-green-700 font-medium">
                                ✅ Hai selezionato: ${Object.entries(project.prodotti || {})
                                    .filter(([k,v]) => v)
                                    .map(([k]) => k.charAt(0).toUpperCase() + k.slice(1))
                                    .join(', ')}
                            </p>
                        </div>
                    ` : `
                        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-300 rounded-lg">
                            <p class="text-yellow-700">⚠️ Seleziona almeno un prodotto per continuare</p>
                        </div>
                    `}
                </div>
            `;
        }

        function renderStep3Configurations(project) {
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">⚙️</span> Configurazioni Prodotti (Valori di Default)
                    </h2>
                    <p class="text-gray-600 mb-4">Imposta i valori di default che verranno applicati a tutti i prodotti:</p>

                    ${project.prodotti?.infissi ? `
                        <div class="section-card mb-4">
                            <h3 class="font-semibold text-blue-700 mb-3 flex items-center gap-2">
                                🪟 Configurazione Infissi Default
                            </h3>
                            <div class="config-grid">
                                <div>
                                    <label class="text-xs font-medium">Azienda</label>
                                    <select onchange="updateConfigInfissi('${project.id}', 'azienda', this.value)"
                                            class="w-full compact-input border rounded">
                                        <option value="">Seleziona...</option>
                                        <option value="finstral" ${project.configInfissi?.azienda === 'finstral' ? 'selected' : ''}>FINSTRAL</option>
                                        <option value="essepi" ${project.configInfissi?.azienda === 'essepi' ? 'selected' : ''}>ESSEPI</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Finitura Int</label>
                                    <select onchange="updateConfigInfissi('${project.id}', 'finituraInt', this.value)"
                                            class="w-full compact-input border rounded">
                                        <option value="">--</option>
                                        <option value="pvc" ${project.configInfissi?.finituraInt === 'pvc' ? 'selected' : ''}>PVC</option>
                                        <option value="legno" ${project.configInfissi?.finituraInt === 'legno' ? 'selected' : ''}>Legno</option>
                                        <option value="alluminio" ${project.configInfissi?.finituraInt === 'alluminio' ? 'selected' : ''}>Alluminio</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Finitura Est</label>
                                    <select onchange="updateConfigInfissi('${project.id}', 'finituraEst', this.value)"
                                            class="w-full compact-input border rounded">
                                        <option value="">--</option>
                                        <option value="pvc" ${project.configInfissi?.finituraEst === 'pvc' ? 'selected' : ''}>PVC</option>
                                        <option value="alluminio" ${project.configInfissi?.finituraEst === 'alluminio' ? 'selected' : ''}>Alluminio</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Colore Int</label>
                                    <input type="text" placeholder="Bianco"
                                           value="${project.configInfissi?.coloreInt || ''}"
                                           onchange="updateConfigInfissi('${project.id}', 'coloreInt', this.value)"
                                           class="w-full compact-input border rounded">
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Colore Est</label>
                                    <input type="text" placeholder="Marrone"
                                           value="${project.configInfissi?.coloreEst || ''}"
                                           onchange="updateConfigInfissi('${project.id}', 'coloreEst', this.value)"
                                           class="w-full compact-input border rounded">
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Tipo Anta</label>
                                    <select onchange="updateConfigInfissi('${project.id}', 'tipoAnta', this.value)"
                                            class="w-full compact-input border rounded">
                                        <option value="">--</option>
                                        <option value="step-line" ${project.configInfissi?.tipoAnta === 'step-line' ? 'selected' : ''}>Step-Line</option>
                                        <option value="nova-line" ${project.configInfissi?.tipoAnta === 'nova-line' ? 'selected' : ''}>Nova-Line</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Vetro</label>
                                    <select onchange="updateConfigInfissi('${project.id}', 'vetro', this.value)"
                                            class="w-full compact-input border rounded">
                                        <option value="">--</option>
                                        <option value="doppio" ${project.configInfissi?.vetro === 'doppio' ? 'selected' : ''}>Doppio</option>
                                        <option value="triplo" ${project.configInfissi?.vetro === 'triplo' ? 'selected' : ''}>Triplo</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Allarme</label>
                                    <select onchange="updateConfigInfissi('${project.id}', 'allarme', this.value)"
                                            class="w-full compact-input border rounded">
                                        <option value="">--</option>
                                        <option value="si" ${project.configInfissi?.allarme === 'si' ? 'selected' : ''}>Sì</option>
                                        <option value="no" ${project.configInfissi?.allarme === 'no' ? 'selected' : ''}>No</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    ${project.prodotti?.persiane ? `
                        <div class="section-card mb-4">
                            <h3 class="font-semibold text-purple-700 mb-3 flex items-center gap-2">
                                🚪 Configurazione Persiane Default
                            </h3>
                            <div class="config-grid">
                                <div>
                                    <label class="text-xs font-medium">Modello</label>
                                    <input type="text" placeholder="Aurora"
                                           value="${project.configPersiane?.modello || ''}"
                                           onchange="updateConfigPersiane('${project.id}', 'modello', this.value)"
                                           class="w-full compact-input border rounded">
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Fissaggio</label>
                                    <select onchange="updateConfigPersiane('${project.id}', 'fissaggio', this.value)"
                                            class="w-full compact-input border rounded">
                                        <option value="">--</option>
                                        <option value="A MURO" ${project.configPersiane?.fissaggio === 'A MURO' ? 'selected' : ''}>A Muro</option>
                                        <option value="TELAIO" ${project.configPersiane?.fissaggio === 'TELAIO' ? 'selected' : ''}>Telaio</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Colore</label>
                                    <input type="text" placeholder="Verde"
                                           value="${project.configPersiane?.colorePersiana || ''}"
                                           onchange="updateConfigPersiane('${project.id}', 'colorePersiana', this.value)"
                                           class="w-full compact-input border rounded">
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Battuta</label>
                                    <select onchange="updateConfigPersiane('${project.id}', 'battuta', this.value)"
                                            class="w-full compact-input border rounded">
                                        <option value="">--</option>
                                        <option value="3 LATI" ${project.configPersiane?.battuta === '3 LATI' ? 'selected' : ''}>3 Lati</option>
                                        <option value="4 LATI" ${project.configPersiane?.battuta === '4 LATI' ? 'selected' : ''}>4 Lati</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    ${project.prodotti?.cassonetti ? `
                        <div class="section-card">
                            <h3 class="font-semibold text-orange-700 mb-3 flex items-center gap-2">
                                📦 Configurazione Cassonetti Default
                            </h3>
                            <div class="config-grid">
                                <div>
                                    <label class="text-xs font-medium">Tipo</label>
                                    <select onchange="updateConfigCassonetti('${project.id}', 'tipo', this.value)"
                                            class="w-full compact-input border rounded">
                                        <option value="">--</option>
                                        <option value="monoblocco" ${project.configCassonetti?.tipo === 'monoblocco' ? 'selected' : ''}>Monoblocco</option>
                                        <option value="isole" ${project.configCassonetti?.tipo === 'isole' ? 'selected' : ''}>Solo Isole</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Azienda</label>
                                    <input type="text" placeholder="Nome azienda"
                                           value="${project.configCassonetti?.azienda || ''}"
                                           onchange="updateConfigCassonetti('${project.id}', 'azienda', this.value)"
                                           class="w-full compact-input border rounded">
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Colore</label>
                                    <input type="text" placeholder="Bianco"
                                           value="${project.configCassonetti?.colore || ''}"
                                           onchange="updateConfigCassonetti('${project.id}', 'colore', this.value)"
                                           class="w-full compact-input border rounded">
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderStep4WallFeatures(project) {
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">🏗️</span> Caratteristiche Muro (Misure in mm)
                    </h2>
                    
                    <div class="grid-compact">
                        <div>
                            <label class="text-xs font-medium">Prof. Muro Int</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.profMuroInt || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'profMuroInt', this.value)"
                                   class="w-full compact-input border rounded">
                        </div>
                        <div>
                            <label class="text-xs font-medium">Prof. Piana Sopra</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.profPianaSopra || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'profPianaSopra', this.value)"
                                   class="w-full compact-input border rounded">
                        </div>
                        <div>
                            <label class="text-xs font-medium">Prof. Piana Sotto</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.profPianaSotto || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'profPianaSotto', this.value)"
                                   class="w-full compact-input border rounded">
                        </div>
                        <div>
                            <label class="text-xs font-medium">Telaio Prof</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.telaioProfondita || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'telaioProfondita', this.value)"
                                   class="w-full compact-input border rounded">
                        </div>
                        <div>
                            <label class="text-xs font-medium">Telaio Largh</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.telaioLarghezza || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'telaioLarghezza', this.value)"
                                   class="w-full compact-input border rounded">
                        </div>
                        <div>
                            <label class="text-xs font-medium">Delta Int</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.deltaInt || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'deltaInt', this.value)"
                                   class="w-full compact-input border rounded">
                        </div>
                        <div>
                            <label class="text-xs font-medium">Delta Est</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.deltaEst || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'deltaEst', this.value)"
                                   class="w-full compact-input border rounded">
                        </div>
                        <div>
                            <label class="text-xs font-medium">Prof. Muro Est</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.profMuroEst || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'profMuroEst', this.value)"
                                   class="w-full compact-input border rounded">
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStep5Positions(project) {
            return `
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <span class="text-2xl">📍</span> Posizioni (${project.positions.length})
                        </h2>
                        <button onclick="addPosition('${project.id}')"
                                class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                            + Aggiungi Posizione
                        </button>
                    </div>

                    ${project.positions.length === 0 ? `
                        <div class="text-center py-12 bg-gray-50 rounded-lg">
                            <p class="text-gray-600 mb-4">Nessuna posizione ancora</p>
                            <button onclick="addPosition('${project.id}')"
                                    class="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium">
                                Aggiungi Prima Posizione
                            </button>
                        </div>
                    ` : `
                        <div class="space-y-3">
                            ${project.positions.map((pos, idx) => `
                                <div class="section-card cursor-pointer hover:shadow-lg" onclick="openPosition('${pos.id}')">
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">📐</span>
                                            <div>
                                                <h3 class="font-semibold">${pos.name}</h3>
                                                <p class="text-sm text-gray-600">
                                                    ${pos.piano || 'Piano'} • ${pos.ambiente || 'Ambiente'}
                                                    ${pos.infissi?.length ? ` • 🪟 ${pos.infissi.length}` : ''}
                                                    ${pos.persiane?.length ? ` • 🚪 ${pos.persiane.length}` : ''}
                                                    ${pos.cassonetti?.length ? ` • 📦 ${pos.cassonetti.length}` : ''}
                                                </p>
                                            </div>
                                        </div>
                                        <span class="text-purple-600">→</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function PositionDetail() {
            const project = state.projects.find(p => p.id === state.currentProject);
            const pos = project?.positions.find(p => p.id === state.currentPosition);
            if (!pos) return '';

            return `
                <div class="max-w-7xl mx-auto p-4">
                    <!-- Position Header -->
                    <div class="bg-white rounded-lg shadow p-4 mb-4">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <input type="text" value="${pos.name}"
                                       onchange="updatePosition('${project.id}', '${pos.id}', 'name', this.value)"
                                       class="text-xl font-bold border-b-2 border-transparent focus:border-purple-500 outline-none">
                                <select onchange="switchPosition(this.value)"
                                        class="px-3 py-1 border rounded-lg">
                                    ${project.positions.map(p => `
                                        <option value="${p.id}" ${p.id === pos.id ? 'selected' : ''}>${p.name}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <button onclick="addPosition('${project.id}')"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium">
                                + Nuova Posizione
                            </button>
                        </div>
                    </div>

                    <!-- Quick Info -->
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div class="section-card">
                            <label class="text-xs font-medium">Piano</label>
                            <input type="text" value="${pos.piano || ''}"
                                   onchange="updatePosition('${project.id}', '${pos.id}', 'piano', this.value)"
                                   placeholder="${project.clientData?.piano || 'Piano'}"
                                   class="w-full compact-input border rounded mt-1">
                        </div>
                        <div class="section-card">
                            <label class="text-xs font-medium">Ambiente</label>
                            <select onchange="updatePosition('${project.id}', '${pos.id}', 'ambiente', this.value)"
                                    class="w-full compact-input border rounded mt-1">
                                <option value="">Seleziona...</option>
                                ${['soggiorno', 'cucina', 'camera', 'bagno', 'corridoio'].map(amb => `
                                    <option value="${amb}" ${pos.ambiente === amb ? 'selected' : ''}>${amb}</option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="section-card">
                            <label class="text-xs font-medium">Foto</label>
                            <div class="flex items-center gap-2 mt-1">
                                <input type="file" id="foto-${pos.id}" accept="image/*" class="hidden"
                                       onchange="addFoto('${project.id}', '${pos.id}', this)">
                                <button onclick="document.getElementById('foto-${pos.id}').click()"
                                        class="px-3 py-1 bg-blue-600 text-white rounded text-sm">
                                    📷 Carica
                                </button>
                                <span class="text-sm text-gray-600">${pos.foto?.length || 0} foto</span>
                            </div>
                        </div>
                    </div>

                    <!-- Products Tabs -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="flex border-b">
                            <button onclick="setPositionTab('${pos.id}', 'misure')"
                                    class="tab-btn ${pos.activeTab === 'misure' ? 'active' : ''}">
                                📏 Misure
                            </button>
                            ${project.prodotti?.infissi ? `
                                <button onclick="setPositionTab('${pos.id}', 'infissi')"
                                        class="tab-btn ${pos.activeTab === 'infissi' ? 'active' : ''}">
                                    🪟 Infissi (${pos.infissi?.length || 0})
                                </button>
                            ` : ''}
                            ${project.prodotti?.persiane ? `
                                <button onclick="setPositionTab('${pos.id}', 'persiane')"
                                        class="tab-btn ${pos.activeTab === 'persiane' ? 'active' : ''}">
                                    🚪 Persiane (${pos.persiane?.length || 0})
                                </button>
                            ` : ''}
                            ${project.prodotti?.cassonetti ? `
                                <button onclick="setPositionTab('${pos.id}', 'cassonetti')"
                                        class="tab-btn ${pos.activeTab === 'cassonetti' ? 'active' : ''}">
                                    📦 Cassonetti (${pos.cassonetti?.length || 0})
                                </button>
                            ` : ''}
                        </div>

                        <div class="p-4">
                            ${renderPositionTabContent(project, pos)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPositionTabContent(project, pos) {
            const tab = pos.activeTab || 'misure';

            if (tab === 'misure') {
                return `
                    <div class="grid-compact">
                        ${['LF', 'HF', 'LVT', 'HVT', 'TMV', 'HMT', 'LVAR', 'HVAR'].map(field => `
                            <div>
                                <label class="text-xs font-medium">${field} (mm)</label>
                                <input type="number" placeholder="0"
                                       value="${pos.misure?.[field] || ''}"
                                       onchange="updateMisura('${project.id}', '${pos.id}', '${field}', this.value)"
                                       class="w-full compact-input border rounded mt-1">
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Product tabs
            const products = pos[tab] || [];
            const canAdd = products.length === 0;

            return `
                ${canAdd ? `
                    <button onclick="addProduct('${project.id}', '${pos.id}', '${tab}')"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium">
                        + Aggiungi ${tab.charAt(0).toUpperCase() + tab.slice(1, -1)}
                    </button>
                ` : `
                    <div class="bg-yellow-50 border border-yellow-300 rounded p-3 text-sm mb-4">
                        ⚠️ Solo un prodotto per posizione
                    </div>
                `}

                ${products.map((prod, idx) => renderProductCompact(project, pos, tab, prod, idx)).join('')}
            `;
        }

        function renderProductCompact(project, pos, type, prod, idx) {
            const config = type === 'infissi' ? project.configInfissi :
                          type === 'persiane' ? project.configPersiane :
                          project.configCassonetti;

            return `
                <div class="border rounded-lg p-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-semibold">${type.charAt(0).toUpperCase() + type.slice(1, -1)}</h4>
                        <button onclick="removeProduct('${project.id}', '${pos.id}', '${type}', ${idx})"
                                class="text-red-600 hover:bg-red-50 p-1 rounded">🗑️</button>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <div>
                            <label class="text-xs">Quantità</label>
                            <select onchange="updateProduct('${project.id}', '${pos.id}', '${type}', ${idx}, 'qta', this.value)"
                                    class="w-full compact-input border rounded">
                                ${[1,2,3,4,5].map(n => `<option value="${n}" ${prod.qta == n ? 'selected' : ''}>${n}</option>`).join('')}
                            </select>
                        </div>

                        ${type === 'infissi' ? `
                            <div>
                                <label class="text-xs">Tipo</label>
                                <select onchange="updateProduct('${project.id}', '${pos.id}', '${type}', ${idx}, 'tipo', this.value)"
                                        class="w-full compact-input border rounded">
                                    <option value="">--</option>
                                    ${['F1','PF1','F2','PF2','F3','PF3'].map(t => 
                                        `<option value="${t}" ${prod.tipo === t ? 'selected' : ''}>${t}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="text-xs">Apertura</label>
                                <select onchange="updateProduct('${project.id}', '${pos.id}', '${type}', ${idx}, 'apertura', this.value)"
                                        class="w-full compact-input border rounded">
                                    <option value="">--</option>
                                    ${['SX','DX','Fisso','Ribalta'].map(a => 
                                        `<option value="${a}" ${prod.apertura === a ? 'selected' : ''}>${a}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        ` : ''}

                        <!-- Inherit from config with visual indication -->
                        ${Object.entries(config || {}).slice(0, 4).map(([key, defaultVal]) => `
                            <div>
                                <label class="text-xs">${key}</label>
                                <input type="text" 
                                       value="${prod[key] || ''}"
                                       placeholder="${defaultVal || '--'}"
                                       onchange="updateProduct('${project.id}', '${pos.id}', '${type}', ${idx}, '${key}', this.value)"
                                       class="w-full compact-input border rounded ${prod[key] ? '' : 'bg-gray-50'}">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // New Project Modal
        function NewProjectModal() {
            return `
                <div id="modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
                        <h3 class="text-xl font-bold mb-4">Nuovo Progetto</h3>
                        <input type="text" id="projectName" placeholder="Nome progetto" 
                               class="w-full px-3 py-2 border rounded-lg mb-3">
                        <input type="text" id="projectClient" placeholder="Cliente" 
                               class="w-full px-3 py-2 border rounded-lg mb-4">
                        <div class="flex gap-3">
                            <button onclick="hideModal()" 
                                    class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">
                                Annulla
                            </button>
                            <button onclick="createNewProject()" 
                                    class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium">
                                Crea
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Window Functions
        window.showNewProjectModal = () => document.getElementById('modal').classList.remove('hidden');
        window.hideModal = () => document.getElementById('modal').classList.add('hidden');

        window.createNewProject = () => {
            const name = document.getElementById('projectName').value.trim();
            const client = document.getElementById('projectClient').value.trim();
            if (name && client) {
                createProject(name, client);
                hideModal();
                state.screen = 'project';
                render();
            }
        };

        window.goBack = () => {
            if (state.screen === 'position') {
                state.screen = 'project';
            } else {
                state.screen = 'list';
            }
            render();
        };

        window.openProject = (id) => {
            state.currentProject = id;
            state.screen = 'project';
            render();
        };

        window.openPosition = (id) => {
            state.currentPosition = id;
            state.screen = 'position';
            render();
        };

        window.switchPosition = (id) => {
            state.currentPosition = id;
            render();
        };

        window.setPositionTab = (posId, tab) => {
            const project = state.projects.find(p => p.id === state.currentProject);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos.activeTab = tab;
                    render();
                }
            }
        };

        // Update Functions
        window.updateProject = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                project[field] = value;
                saveState();
            }
        };

        window.updateClientData = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.clientData) project.clientData = {};
                project.clientData[field] = value;
                
                // Propagate piano to positions
                if (field === 'piano') {
                    project.positions.forEach(pos => {
                        if (!pos.piano) pos.piano = value;
                    });
                }
                saveState();
            }
        };

        window.updateProdotti = (projectId, product, checked) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.prodotti) project.prodotti = {};
                project.prodotti[product] = checked;
                saveState();
                // Don't re-render to avoid closing the modal
            }
        };

        window.updateConfigInfissi = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configInfissi) project.configInfissi = {};
                project.configInfissi[field] = value;
                
                // Apply to all existing infissi without override
                project.positions.forEach(pos => {
                    if (pos.infissi) {
                        pos.infissi.forEach(inf => {
                            if (!inf[field]) {
                                inf[field] = value;
                            }
                        });
                    }
                });
                saveState();
            }
        };

        window.updateConfigPersiane = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configPersiane) project.configPersiane = {};
                project.configPersiane[field] = value;
                saveState();
            }
        };

        window.updateConfigCassonetti = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configCassonetti) project.configCassonetti = {};
                project.configCassonetti[field] = value;
                saveState();
            }
        };

        window.updateCaratteristicheMuro = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
                project.caratteristicheMuro[field] = value;
                saveState();
            }
        };

        window.updatePosition = (projectId, posId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos[field] = value;
                    saveState();
                }
            }
        };

        window.updateMisura = (projectId, posId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    if (!pos.misure) pos.misure = {};
                    pos.misure[field] = value;
                    saveState();
                }
            }
        };

        // Product Functions
        window.addProduct = (projectId, posId, type) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    if (!pos[type]) pos[type] = [];
                    
                    const config = type === 'infissi' ? project.configInfissi :
                                  type === 'persiane' ? project.configPersiane :
                                  project.configCassonetti;
                    
                    // Create product with default config
                    const product = {
                        qta: 1,
                        ...config // Copy all default configurations
                    };
                    
                    pos[type].push(product);
                    saveState();
                    showNotification(`${type.slice(0, -1)} aggiunto`, 'success');
                    render();
                }
            }
        };

        window.updateProduct = (projectId, posId, type, idx, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos[type] && pos[type][idx]) {
                    pos[type][idx][field] = value;
                    saveState();
                }
            }
        };

        window.removeProduct = (projectId, posId, type, idx) => {
            if (confirm('Eliminare questo prodotto?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos[type]) {
                        pos[type].splice(idx, 1);
                        saveState();
                        showNotification('Prodotto eliminato', 'info');
                        render();
                    }
                }
            }
        };

        // Foto Functions
        window.addFoto = (projectId, posId, input) => {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const project = state.projects.find(p => p.id === projectId);
                    if (project) {
                        const pos = project.positions.find(p => p.id === posId);
                        if (pos) {
                            if (!pos.foto) pos.foto = [];
                            pos.foto.push({
                                data: e.target.result,
                                timestamp: new Date().toISOString()
                            });
                            saveState();
                            showNotification('Foto aggiunta', 'success');
                            render();
                        }
                    }
                };
                reader.readAsDataURL(file);
            }
        };

        // Export Function
        window.exportData = () => {
            const dataStr = JSON.stringify(state, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', `open-porte-${new Date().toISOString().split('T')[0]}.json`);
            link.click();
            showNotification('Dati esportati', 'success');
        };

        // Main Render Function
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = `
                ${Header()}
                <main class="min-h-screen">
                    ${state.screen === 'list' ? ProjectsList() :
                      state.screen === 'position' ? PositionDetail() :
                      ProjectSetup()}
                </main>
                ${NewProjectModal()}
            `;
        }

        // Initialize App
        loadState();
        render();
    </script>
</body>
</html>
