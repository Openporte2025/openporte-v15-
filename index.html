<!DOCTYPE html>
<!--
    Open Porte v3.2 - FASE 15: MISURE IN PRIMA VISTA NEL RILIEVO INFISSI 📏✨
    
    ✨ MODIFICHE FASE 15:
    ✅ RILIEVO PREESISTENTE INFISSI - MISURE VISIBILI SUBITO:
       - Misure Principali (LVT, HVT, LF, HF, TMV, HMT, LVAR, HVAR) in griglia 4 colonne
       - Delta (Delta INT, Delta EST) in griglia compatta
       - Altezze (H Soffitto, H Parapetto/Soffitto, H Pavimento/Parapetto)
       - Posizionate PRIMA di Materiale e Note
       - Visibili SOLO per Infissi
       - Funzione updateMisureGlobaliInfissi(projectId, field, value)
       - Salvataggio in project.misureGlobaliInfissi
    
    ✨ MODIFICHE FASE 13a (PRECEDENTI):
    ✅ CAMPO "COSA C'È" - ELIMINATO:
       - Rimosso completamente il campo "🏠 Cosa c'è?" dal rilievo preesistente
       - Layout adattato da 3 a 2 colonne (Materiale + Note)
    
    ✅ CAMPO "MATERIALE" - SELECT/INPUT INTERCAMBIABILE:
       - Aggiunto bottone toggle "✏️ Scrivi" / "📋 Tendina"
       - Modalità SELECT (default): Dropdown con opzioni predefinite (Legno, PVC, Alluminio, Ferro)
       - Modalità INPUT: Campo testo libero per materiali personalizzati
       - Sincronizzazione automatica del valore tra le due modalità
       - Funzione toggleMaterialeMode(productType, projectId) per gestire il cambio modalità
    
    ✨ MODIFICHE FASE 13 (PRECEDENTI):
    ✅ RILIEVO PREESISTENTE GLOBALE:
       - Aggiunta sezione "RILIEVO PREESISTENTE" negli STEP di configurazione (3,4,5,7)
       - Ogni prodotto (Infissi, Persiane, Tapparelle, Cassonetti) ha il suo rilievo globale
       - Campi globali per ogni prodotto:
         * 🔧 Materiale (SELECT/INPUT intercambiabile)
         * 📝 Note
         * 🔨 Da togliere? (checkbox)
         * 🗑️ Da smaltire? (checkbox)
       - SOLO per INFISSI anche:
         * 📏 Coprifili INT? (checkbox)
         * 📐 Coprifili EST? (checkbox)
       
    ✅ SALVATAGGIO DATI:
       - I dati globali vengono salvati in: project.rilievoInfissi, project.rilievoPersiane, etc.
       - Ogni posizione può modificare localmente questi dati (pos.rilievo)
       - Indicatore progresso: 0-100% completezza campi
       - Validazione visiva con colori (rosso = incompleto, verde = completo)
    
    ✅ FUNZIONI NUOVE:
       - updateRilievoGlobale(projectId, productType, field, value)
       - getRilievoGlobale(project, productType)
       - calculateRilievoGlobaleCompleteness(project, productType)
       - renderRilievoGlobale(project, productType, productLabel, icon)
       - toggleMaterialeMode(productType, projectId) - FASE 13a
    
    ✨ MODIFICHE FASE 11_1A (PRECEDENTE):
    ✅ BRM CASSONETTI - Nuove Misure Larghezza:
       - Opzioni specifiche per cassonetti: LARGH_CASS, LS, LVT, TMV, LF, MIS_FIN_INF_L, LS+SRDX+SRSX
       - Le altre tipologie di prodotto mantengono le misure standard
       - FORMULE COMPOSITE: Supporto per formule tipo "LS+SRDX+SRSX" (somma automatica di più misure)
       - Le misure del cassonetto sono salvate nel cassonetto stesso (non in pos.misure)
       - Ricalcolo automatico BRM quando cambiano le misure (LS, SRSX, SRDX, etc.)
       - Bottone "Ricalcola BRM" visibile SOLO con "Usa Globale" attivo
       - Con formula personalizzata, il BRM si aggiorna automaticamente modificando i dropdown
    
    ✅ TAGLI INFISSO - COD.TAGLI Automatico:
       - ELIMINATO campo "Tipo Tagli" (campo testo libero)
       - AGGIUNTO campo "COD.TAGLI" (sola lettura, automatico)
       - Codice generato automaticamente in base alla selezione di "Tagli Telaio":
         * Sopra → SOPRA
         * Sotto → SOTTO
         * Sopra/Sotto → SOPRA SOTTO
         * DX → DX
         * SX → SX
         * DX/SX → DX SX
         * 4 Lati → SOPRA SOTTO SX DX
         * Sopra/Laterali → SOPRA SX DX
         * Sotto/Laterali → SOTTO SX DX
    
    🔧 FIX TECNICI:
       - calculateBRM() ora gestisce formule composite con "+" e rimuove spazi
       - addCassonetto() inizializza tutte le misure a 0
       - updateProduct() ricalcola BRM per tutte le misure del cassonetto
       - toggleUsaGlobale() copia correttamente l'operazione dalla config globale
       - updateBRMPersonalizzato() usa le misure corrette per cassonetti
       - Bottone "Ricalcola BRM" nascosto quando si usa formula personalizzata (non serve)
    
    ✨ MODIFICHE FASE 11a (PRECEDENTE):
    ✅ CASSONETTI - Nuovo Campo "Tipo Cassonetto":
       - Datalist selezionabile: LARGH_CASS, LS, LVT, TMV, LP, MIS_FIN_INF_L, LS+SRDX+SRSX
       - Permette sia selezione da dropdown che scrittura libera
    
    ✅ MOTORI TAPPARELLE - Sistema Completo:
       - 🏭 MARCA: Somfy, Nice, Cherubini (datalist)
       - 📡 MODELLO/Trasmettitore: Dinamico basato su marca
       - ⚡ ALIMENTAZIONE: Radio Filare/Telecomando
       - 📻 TRASMETTITORE: Solo se Telecomando
    
    ✅ SOSTITUZIONE TAPPARELLE:
       - Radio: Solo Motore/Solo Tapparella/Entrambi
       - Campi intelligenti in base alla selezione
    
    ✅ BREADCRUMB NAVIGATION:
       - Sostituita freccia con breadcrumb
       - Mostra: Progetti › Progetto › Posizione
    
    ✨ MODIFICHE FASE 10a (PRECEDENTE):
    ✅ TUTTI I PRODOTTI - Campi Configurazione con Datalist:
       - INPUT + DATALIST: Permette sia selezione da dropdown che scrittura libera
       - INFISSO: Finitura Int/Est, Colore Int/Est, Tipo Anta, Telaio, Allarme, Vetro, Tagli Telaio
       - PERSIANA: Modello, Fissaggio, Tipo Telaio, Colore Persiana, Colore Telaio, Battuta
       - TAPPARELLA: Azienda, Modello, Colore, Manuale/Motorizzato, Sost. Esistente, Guida, Colore Guida
       - ZANZARIERA: Colore Telaio, Tipo Rete, Colore Rete
       - CASSONETTO: Tipo, Azienda, Colore, Sovrappi/Sostit, A Soffitto
    
    💡 FUNZIONAMENTO DATALIST:
    - Click sulla freccia dropdown → Mostra opzioni predefinite dalla tabella globale
    - Scrittura diretta → Accetta qualsiasi valore personalizzato
    - Suggerimenti mentre si digita → Filtra le opzioni disponibili
    
    ✨ MODIFICHE FASE 9a-UPDATE (PRECEDENTE):
    ✅ INFISSO - Tipo e Apertura aggiornati:
       - TIPO: F1, PF1, F2, PF2, F3, PF3, HST, FISSO + ✏️ ALTRO - SCRIVO
       - APERTURA: SX, DX, Fisso, Ribalta, Sp. SX, Sp. DX, SCORR.PARALL + ✏️ ALTRO - SCRIVO
       - Possibilità di scrivere custom e tornare a selezionare dal dropdown
    
    ✅ PERSIANA - Tipo e Apertura aggiornati:
       - TIPO: FA, PFA, F2, PF2, F3, PF3, SCORREVOLE + ✏️ ALTRO - SCRIVO
       - APERTURA: SP SX, SP DX, LIB SX, LIB DX, SCORR SX, SCORR DX + ✏️ Altro SCRIVO
       - Campo input che appare quando si seleziona ALTRO - SCRIVO
       - Possibilità di tornare a selezionare dal dropdown
    
    ✨ MODIFICHE FASE 9a (RIORGANIZZAZIONE COMPLETA):
    ✅ INFISSO: Riorganizzato con sezioni separate
       - 📋 Dati Specifici: Quantità, Tipo, Apertura
       - ⚙️ Configurazione: Finitura Int/Est, Colore Int/Est, Tipo Anta, Telaio, Allarme, Vetro, Tagli Telaio, Tipo Tagli
    
    ✅ PERSIANA: Riorganizzata con sezioni separate + foto
       - 📋 Dati Specifici: Quantità, Tipo, Apertura
       - ⚙️ Configurazione: Modello, Fissaggio, Tipo Telaio, Colore Persiana, Colore Telaio, Battuta
       - 📷 Foto Persiana: Upload e gestione foto
       - RISOLTO: Rimossa doppia selezione QTÀ
    
    ✅ TAPPARELLA: Riorganizzata con sezioni separate + motori dinamici
       - 📋 Dati Specifici: Quantità
       - ⚙️ Configurazione: Azienda, Modello, Colore, Manuale/Motorizzato, Sost. Esistente, Guida, Colore Guida
       - 🔌 Motori: Sezione dinamica con "+ Aggiungi Motore"
    
    ✅ ZANZARIERA: Riorganizzata con tipo infisso associato
       - 🔧 Tipo Infisso Associato: Radio button F (Finestra) / PF (Porta Finestra)
       - ⚠️ Avviso: "Seleziona prima se F o PF"
       - 📋 Dati Specifici: Quantità, Tipo, Apertura
       - ⚙️ Configurazione: Colore Telaio, Tipo Rete, Colore Rete
    
    ✅ CASSONETTO: Riorganizzato con misure dettagliate
       - 📋 Dati Generali: Quantità, Tipo, Azienda, Colore, Sovrappi/Sostit, A Soffitto
       - 📏 Misure Cassonetto (mm): LS, SRSX, ZSX, SRDX, ZDX, HCASS, B, C, BSuperiore
       - 📝 Nota: "Se SRSX = ZSX → Muro a SX | Se SRDX = ZDX → Muro a DX"
    
    ✨ MODIFICHE FASE 31 (INTEGRAZIONE):
    ✅ FOTO PERSIANE: Aggiunte funzioni per gestire foto specifiche delle persiane
       - addFotoPersiana: Aggiunge foto a una persiana specifica
       - removeFotoPersiana: Rimuove foto da una persiana specifica
    
    ✅ MOTORI TAPPARELLE: Aggiunte funzioni per gestire motori delle tapparelle
       - addMotoreTapparella: Aggiunge un motore a una tapparella
       - updateMotoreTapparella: Aggiorna il modello di un motore
       - removeMotoreTapparella: Rimuove un motore da una tapparella
    
    ✨ MODIFICHE FASE 28:
    ✅ INFISSI: Aggiunto campo QTÀ selezionabile (1-10) come per le Persiane
       - Select dropdown per selezionare quantità
       - Default: 1
       - Visibile nella griglia dettagli infisso
    
    ✅ PERSIANE TIPO: Aggiunte opzioni F1 e PF1
       - Lista completa: FA, PFA, F1, PF1, F2, PF2, F3, PF3, SCORREVOLE
       - Opzione "✏️ ALTRO - SCRIVO" per tipi personalizzati
    
    ✅ LAYOUT OTTIMIZZATO:
       - Grid infissi: 4 colonne (QTÀ + 6 campi)
       - Prima riga: QTÀ, Azienda, Finitura Int, Finitura Est
       - Seconda riga: Colore Int, Colore Est, Tipo Anta
    
    MODIFICHE FASE 21 (PRECEDENTE):
    ✅ CAMPO PIANO: Dropdown selezionabile con opzioni predefinite
       - Piano Seminterrato, Piano Terra, Piano Rialzato
       - Primo-Quinto Piano, Attico, Mansarda
    
    ✅ CONFIG INFISSI: Rimossa sezione Motori (i motori vanno su tapparelle)
       - Mantiene tutti gli altri 10 campi
       - Formula BRM personalizzabile
    
    ✅ CONFIG PERSIANE: Campi completi con dropdown
       - Tipo (Battente, Scorrevole, A libro, Orientabile)
       - Materiale (Alluminio, Legno, PVC, Alluminio-Legno)
       - Colore/Finitura (input libero)
       - Apertura (Interna, Esterna)
       - Formula BRM personalizzabile
    
    ✅ CONFIG TAPPARELLE: Campi completi con MOTORI
       - Tipo (Standard, Blindata, Coibentata, Orientabile)
       - Materiale (PVC, Alluminio, Alluminio Coibentato, Acciaio)
       - Colore (input libero)
       - Comando (Manuale, Motorizzata)
       - Motori: Azienda (Somfy, Nice, Cherubini, Faac) + Modello
       - Formula BRM personalizzabile
    
    ✅ CONFIG ZANZARIERE: Campi completi
       - Tipo (Avvolgibile, Plissé, Battente, Scorrevole, Fissa)
       - Colore Telaio (input libero)
       - Tipo Rete (Standard, Anti-polline, Pet-resistant, Micro-forata)
       - Colore Rete (Nero, Grigio, Bianco)
       - Formula BRM personalizzabile
    
    ✅ CONFIG CASSONETTI: Campi completi
       - Tipo (Esterno, Incasso, Sopra-finestra, Semi-incasso)
       - Materiale (PVC, Alluminio, Alluminio Coibentato, Legno)
       - Finitura/Colore (input libero)
       - Coibentazione (Standard, Rinforzata, Acustica)
       - Formula BRM personalizzabile
    
    ✅ QUANTITÀ NELLE POSIZIONI: Campo numerico
       - Default: 1
       - Modificabile per ogni posizione
       - Visibile nella griglia dettagli posizione
    
    ✅ INIZIALIZZAZIONE AUTOMATICA: I prodotti ereditano i valori dalle config default
       - Quando aggiungi un prodotto, i campi sono pre-compilati
       - Puoi personalizzare ogni singolo prodotto
    
    ✅ FUNZIONI UPDATE: Aggiunte per tutti i config
       - updateConfigPersiane
       - updateConfigTapparelle
       - updateConfigZanzariere
       - updateConfigCassonetti
    
    MODIFICHE FASE 20:
    ✅ DROPDOWN PER FORMULA PERSONALIZZATA quando usaGlobale è false
    ✅ CALCOLO AUTOMATICO BRM con formula personalizzata
    ✅ FIX ERRORI VARIABILI nei render delle tab prodotti
    
    MODIFICHE FASE 18B:
    ✅ UN SOLO prodotto per tipo per posizione (no più array)
    ✅ Pulsante "Usa Globale" per BRM
    ✅ Migrazione automatica dati
    ✅ UI migliorata
-->
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Porte v3.0 - FASE 13: Rilievo Preesistente Globale 📋✨🎯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', sans-serif;
        }
        body { 
            overscroll-behavior-y: contain;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        input, select, textarea { 
            font-size: 16px !important;
        }
        .compact-input {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .step-indicator {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s;
        }
        .step-indicator.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.1);
        }
        .step-indicator.completed {
            background: #10b981;
            color: white;
        }
        .section-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            transition: all 0.3s;
        }
        .section-card:hover {
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        .product-pill {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            border: 2px solid;
            transition: all 0.3s;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }
        .product-pill.selected {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .brm-calculator {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        .brm-result {
            background: white;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-weight: bold;
            font-size: 0.875rem;
            color: #f59e0b;
            text-align: center;
            margin-top: 0.5rem;
        }
        
        /* 🎯 FASE 18A - STILI VALIDAZIONE */
        .input-valid {
            border: 2px solid #10b981 !important;
            background: #f0fdf4 !important;
        }
        .input-warning {
            border: 2px solid #f59e0b !important;
            background: #fffbeb !important;
        }
        .input-error {
            border: 2px solid #ef4444 !important;
            background: #fef2f2 !important;
        }
        .validation-message {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .validation-message.error {
            color: #ef4444;
        }
        .validation-message.warning {
            color: #f59e0b;
        }
        .validation-message.success {
            color: #10b981;
        }
        .validation-summary {
            position: sticky;
            top: 0;
            z-index: 10;
            margin-bottom: 1rem;
        }
        .pulse-error {
            animation: pulseRed 2s infinite;
        }
        @keyframes pulseRed {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }
        .product-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s;
        }
        .product-card:hover {
            border-color: #8b5cf6;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
        }
        .tab-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s;
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div id="app"></div>
    
    <script>
        // State Management
        let state = {
            screen: 'list',
            projects: [],
            currentProject: null,
            currentPosition: null,
            setupStep: 1,
            showRiepilogoRilievi: false  // Per mostrare il riepilogo rilievi
        };

        // Load/Save Functions
        function loadState() {
            const saved = localStorage.getItem('openPorteData');
            if (saved) {
                try {
                    state = JSON.parse(saved);
                    migrateOldData(); // Migra dati vecchi formato array -> singolo oggetto
                } catch (e) {
                    console.error('Error loading state:', e);
                }
            }
        }

        // Migrazione dati da vecchio formato (array) a nuovo formato (oggetto singolo)
        function migrateOldData() {
            if (!state.projects) return;
            
            state.projects.forEach(project => {
                if (!project.positions) return;
                
                project.positions.forEach(pos => {
                    // Migra infissi
                    if (pos.infissi && Array.isArray(pos.infissi) && pos.infissi.length > 0) {
                        pos.infisso = pos.infissi[0]; // Prendi il primo
                        if (!pos.infisso.usaGlobale) pos.infisso.usaGlobale = true;
                        delete pos.infissi;
                    }
                    
                    // Migra persiane
                    if (pos.persiane && Array.isArray(pos.persiane) && pos.persiane.length > 0) {
                        pos.persiana = pos.persiane[0];
                        if (!pos.persiana.usaGlobale) pos.persiana.usaGlobale = true;
                        delete pos.persiane;
                    }
                    
                    // Migra tapparelle
                    if (pos.tapparelle && Array.isArray(pos.tapparelle) && pos.tapparelle.length > 0) {
                        pos.tapparella = pos.tapparelle[0];
                        if (!pos.tapparella.usaGlobale) pos.tapparella.usaGlobale = true;
                        delete pos.tapparelle;
                    }
                    
                    // Migra zanzariere
                    if (pos.zanzariere && Array.isArray(pos.zanzariere) && pos.zanzariere.length > 0) {
                        pos.zanzariera = pos.zanzariere[0];
                        if (!pos.zanzariera.usaGlobale) pos.zanzariera.usaGlobale = true;
                        delete pos.zanzariere;
                    }
                    
                    // Migra cassonetti
                    if (pos.cassonetti && Array.isArray(pos.cassonetti) && pos.cassonetti.length > 0) {
                        pos.cassonetto = pos.cassonetti[0];
                        if (!pos.cassonetto.usaGlobale) pos.cassonetto.usaGlobale = true;
                        delete pos.cassonetti;
                    }
                });
            });
            
            saveState(); // Salva i dati migrati
        }

        function saveState() {
            localStorage.setItem('openPorteData', JSON.stringify(state));
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // 🎯 FASE 25: Gestione Select con "Altro e scrivo"
        function handleSelectWithCustom(projectId, field, selectId, inputId, value, options) {
            const select = document.getElementById(selectId);
            const input = document.getElementById(inputId);
            
            if (!select || !input) return;
            
            if (value === '__ALTRO__') {
                // Mostra input personalizzato
                input.style.display = 'block';
                input.focus();
                // Non salvare ancora
            } else if (value) {
                // Opzione standard selezionata
                input.style.display = 'none';
                input.value = '';
                updateClientData(projectId, field, value);
            }
        }

        function handleConfigSelectWithCustom(projectId, configType, field, selectId, inputId, value) {
            const select = document.getElementById(selectId);
            const input = document.getElementById(inputId);
            
            if (!select || !input) return;
            
            if (value === '__ALTRO__') {
                // Mostra input personalizzato
                input.style.display = 'block';
                input.focus();
            } else if (value) {
                // Opzione standard selezionata
                input.style.display = 'none';
                input.value = '';
                // Chiama la funzione di update appropriata
                const updateFnMap = {
                    'persiane': updateConfigPersiane,
                    'tapparelle': updateConfigTapparelle,
                    'zanzariere': updateConfigZanzariere,
                    'cassonetti': updateConfigCassonetti
                };
                const updateFn = updateFnMap[configType];
                if (updateFn) {
                    updateFn(projectId, field, value);
                }
            }
        }

        function handleProductSelectWithCustom(projectId, posId, productType, field, selectId, inputId, value) {
            const select = document.getElementById(selectId);
            const input = document.getElementById(inputId);
            
            if (!select || !input) return;
            
            if (value === '__ALTRO__') {
                // Mostra input personalizzato
                input.style.display = 'block';
                input.focus();
            } else if (value) {
                // Opzione standard selezionata
                input.style.display = 'none';
                input.value = '';
                updateProduct(projectId, posId, productType, field, value);
            }
        }

        // Notification System
        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-100 text-green-800 border-green-300',
                error: 'bg-red-100 text-red-800 border-red-300',
                info: 'bg-blue-100 text-blue-800 border-blue-300'
            };
            
            const notification = document.createElement('div');
            notification.className = `notification ${colors[type]} border-2`;
            notification.innerHTML = `<strong>${message}</strong>`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 2000);
        }

        // 🎯 FASE 18A - SISTEMA VALIDAZIONE MISURE
        function validateMisure(project, pos) {
            const errors = [];
            const warnings = [];
            
            const misure = pos.misure || {};
            
            // Prendi caratteristiche muro (override o globali)
            const cm = pos.overrideCaratteristiche && pos.caratteristicheMuroOverride 
                ? pos.caratteristicheMuroOverride 
                : project.caratteristicheMuro || {};
            
            const LF = parseFloat(misure.LF) || 0;
            const HF = parseFloat(misure.HF) || 0;
            const LVT = parseFloat(misure.LVT) || 0;
            const HVT = parseFloat(misure.HVT) || 0;
            const TMV = parseFloat(misure.TMV) || 0;
            const HMT = parseFloat(misure.HMT) || 0;
            
            const LT = parseFloat(cm.telaioLarghezza) || 0;
            
            // Calcola ARIA
            let ARIA = 0;
            if (cm.falsoEsistente === 'si') {
                ARIA = parseFloat(cm.distanzaFalsoInfisso) || 0;
            } else if (cm.falsoEsistente === 'no') {
                ARIA = parseFloat(cm.distanzaMuroInfisso) || 0;
            }
            
            // Calcola SPESSORE_FALSO
            const SPESSORE_FALSO = cm.falsoEsistente === 'si' ? (parseFloat(cm.spessoreFalso) || 0) : 0;
            
            // 1. LF <= LVT
            if (LF > 0 && LVT > 0) {
                if (LF > LVT) {
                    errors.push({
                        field: 'LF',
                        message: `LF (${LF}) deve essere ≤ LVT (${LVT})`
                    });
                }
            }
            
            // 2. HF <= HVT
            if (HF > 0 && HVT > 0) {
                if (HF > HVT) {
                    errors.push({
                        field: 'HF',
                        message: `HF (${HF}) deve essere ≤ HVT (${HVT})`
                    });
                }
            }
            
            // 3. HVT + LT <= HMT
            if (HVT > 0 && LT > 0 && HMT > 0) {
                if (HVT + LT > HMT) {
                    errors.push({
                        field: 'HMT',
                        message: `HVT (${HVT}) + LT (${LT}) = ${HVT + LT} deve essere ≤ HMT (${HMT})`
                    });
                }
            }
            
            // 4. LF <= TMV
            if (LF > 0 && TMV > 0) {
                if (LF > TMV) {
                    errors.push({
                        field: 'TMV',
                        message: `LF (${LF}) deve essere ≤ TMV (${TMV})`
                    });
                }
            }
            
            // 5. HF <= HMT
            if (HF > 0 && HMT > 0) {
                if (HF > HMT) {
                    errors.push({
                        field: 'HMT',
                        message: `HF (${HF}) deve essere ≤ HMT (${HMT})`
                    });
                }
            }
            
            // 6. LVT + ((LT + ARIA + SPESSORE_FALSO)*2) <= TMV
            if (LVT > 0 && LT > 0 && TMV > 0) {
                const calcolato = LVT + ((LT + ARIA + SPESSORE_FALSO) * 2);
                if (calcolato > TMV) {
                    errors.push({
                        field: 'TMV',
                        message: `LVT (${LVT}) + [(LT (${LT}) + ARIA (${ARIA}) + FALSO (${SPESSORE_FALSO})) × 2] = ${calcolato.toFixed(1)} deve essere ≤ TMV (${TMV})`
                    });
                } else if (calcolato > TMV * 0.95) {
                    warnings.push({
                        field: 'TMV',
                        message: `TMV vicino al limite: calcolato ${calcolato.toFixed(1)} / max ${TMV}`
                    });
                }
            }
            
            // Warnings per valori sospetti
            if (LF > 0 && LF < 300) {
                warnings.push({
                    field: 'LF',
                    message: 'LF molto piccolo (< 300mm)'
                });
            }
            if (LF > 3000) {
                warnings.push({
                    field: 'LF',
                    message: 'LF molto grande (> 3000mm)'
                });
            }
            if (HF > 0 && HF < 300) {
                warnings.push({
                    field: 'HF',
                    message: 'HF molto piccolo (< 300mm)'
                });
            }
            if (HF > 3000) {
                warnings.push({
                    field: 'HF',
                    message: 'HF molto grande (> 3000mm)'
                });
            }
            
            return { errors, warnings, isValid: errors.length === 0 };
        }

        function getFieldValidationClass(project, pos, fieldName) {
            const validation = validateMisure(project, pos);
            
            const hasError = validation.errors.some(e => e.field === fieldName);
            const hasWarning = validation.warnings.some(w => w.field === fieldName);
            
            const misure = pos.misure || {};
            const value = parseFloat(misure[fieldName]) || 0;
            
            if (hasError) return 'input-error';
            if (hasWarning) return 'input-warning';
            if (value > 0) return 'input-valid';
            
            return '';
        }

        function getFieldValidationMessage(project, pos, fieldName) {
            const validation = validateMisure(project, pos);
            
            const error = validation.errors.find(e => e.field === fieldName);
            if (error) {
                return `<div class="validation-message error">🔴 ${error.message}</div>`;
            }
            
            const warning = validation.warnings.find(w => w.field === fieldName);
            if (warning) {
                return `<div class="validation-message warning">🟡 ${warning.message}</div>`;
            }
            
            const misure = pos.misure || {};
            const value = parseFloat(misure[fieldName]) || 0;
            if (value > 0) {
                return `<div class="validation-message success">✅ OK</div>`;
            }
            
            return '';
        }

        // 📋 RILIEVO PREESISTENTE - Gestione e Validazione
        function updateRilievo(projectId, posId, field, value) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    if (!pos.rilievo) {
                        pos.rilievo = {
                            togliere: false,
                            smaltimento: false,
                            materiale: '',
                            coprifiliInt: false,
                            coprifiliEst: false,
                            note: ''
                        };
                    }
                    
                    // Gestione checkbox (boolean)
                    if (field === 'togliere' || field === 'smaltimento' || field === 'coprifiliInt' || field === 'coprifiliEst') {
                        pos.rilievo[field] = value === true || value === 'true';
                    } else {
                        pos.rilievo[field] = value;
                    }
                    
                    saveState();
                    render();
                }
            }
        }

        function calculateRilievoCompleteness(pos) {
            if (!pos.rilievo) return { percentage: 0, completed: 0, total: 5 };
            
            const rilievo = pos.rilievo;
            let completed = 0;
            const total = 5; // materiale, togliere, smaltimento, coprifiliInt, coprifiliEst (campo "preesistente" ELIMINATO in FASE 13a)
            
            // Conta i campi compilati (campo "preesistente" ELIMINATO in FASE 13a)
            if (rilievo.togliere !== undefined && rilievo.togliere !== null) completed++;
            if (rilievo.smaltimento !== undefined && rilievo.smaltimento !== null) completed++;
            if (rilievo.materiale && rilievo.materiale.trim() !== '') completed++;
            if (rilievo.coprifiliInt !== undefined && rilievo.coprifiliInt !== null) completed++;
            if (rilievo.coprifiliEst !== undefined && rilievo.coprifiliEst !== null) completed++;
            
            const percentage = Math.round((completed / total) * 100);
            
            return { percentage, completed, total };
        }

        function getRilievoStatus(pos) {
            const completeness = calculateRilievoCompleteness(pos);
            
            if (completeness.percentage === 0) {
                return { icon: '⚪', color: 'gray', text: 'NON INIZIATO', badge: 'bg-gray-500' };
            } else if (completeness.percentage < 50) {
                return { icon: '🔴', color: 'red', text: 'INCOMPLETO', badge: 'bg-red-500' };
            } else if (completeness.percentage < 100) {
                return { icon: '🟡', color: 'amber', text: 'PARZIALE', badge: 'bg-amber-500' };
            } else {
                return { icon: '🟢', color: 'green', text: 'COMPLETO', badge: 'bg-green-500' };
            }
        }

        // 🆕 FASE 13 - Gestione Rilievo Globale per Prodotti
        function updateRilievoGlobale(projectId, productType, field, value) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const rilievoKey = `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
                
                if (!project[rilievoKey]) {
                    project[rilievoKey] = {
                        materiale: '',
                        note: '',
                        togliere: false,
                        smaltimento: false
                    };
                    
                    // Aggiungi coprifili solo per infissi
                    if (productType === 'infissi') {
                        project[rilievoKey].coprifiliInt = false;
                        project[rilievoKey].coprifiliEst = false;
                    }
                }
                
                // Gestione checkbox (boolean)
                if (field === 'togliere' || field === 'smaltimento' || field === 'coprifiliInt' || field === 'coprifiliEst') {
                    project[rilievoKey][field] = value === true || value === 'true';
                } else {
                    project[rilievoKey][field] = value;
                }
                
                saveState();
                render();
            }
        }

        function toggleMaterialeMode(productType, projectId) {
            const selectEl = document.getElementById(`materiale-select-${productType}-${projectId}`);
            const inputEl = document.getElementById(`materiale-input-${productType}-${projectId}`);
            const toggleBtn = document.getElementById(`materiale-toggle-${productType}-${projectId}`);
            
            if (selectEl && inputEl && toggleBtn) {
                if (selectEl.style.display === 'none') {
                    // Passa a SELECT
                    selectEl.style.display = 'block';
                    inputEl.style.display = 'none';
                    toggleBtn.innerHTML = '✏️ Scrivi';
                    // Sincronizza valore
                    const currentValue = inputEl.value;
                    // Se il valore esiste nelle opzioni, selezionalo
                    const optionExists = Array.from(selectEl.options).some(opt => opt.value === currentValue);
                    if (optionExists) {
                        selectEl.value = currentValue;
                    } else {
                        selectEl.value = '';
                    }
                } else {
                    // Passa a INPUT
                    selectEl.style.display = 'none';
                    inputEl.style.display = 'block';
                    toggleBtn.innerHTML = '📋 Tendina';
                    // Sincronizza valore
                    inputEl.value = selectEl.value;
                }
            }
        }

        function toggleMaterialePosMode(posId) {
            const selectEl = document.getElementById(`materiale-pos-select-${posId}`);
            const inputEl = document.getElementById(`materiale-pos-input-${posId}`);
            const toggleBtn = document.getElementById(`materiale-pos-toggle-${posId}`);
            
            if (selectEl && inputEl && toggleBtn) {
                if (selectEl.style.display === 'none') {
                    // Passa a SELECT
                    selectEl.style.display = 'block';
                    inputEl.style.display = 'none';
                    toggleBtn.innerHTML = '✏️ Scrivi';
                    // Sincronizza valore
                    const currentValue = inputEl.value;
                    const optionExists = Array.from(selectEl.options).some(opt => opt.value === currentValue);
                    if (optionExists) {
                        selectEl.value = currentValue;
                    } else {
                        selectEl.value = '';
                    }
                } else {
                    // Passa a INPUT
                    selectEl.style.display = 'none';
                    inputEl.style.display = 'block';
                    toggleBtn.innerHTML = '📋 Tendina';
                    inputEl.value = selectEl.value;
                }
            }
        }

        function copiaRilievoDaGlobale(projectId, posId) {
            const project = state.projects.find(p => p.id === projectId);
            const pos = project?.positions.find(p => p.id === posId);
            
            if (project && pos) {
                // Copia dal rilievo globale infissi (default)
                const rilievoGlobale = getRilievoGlobale(project, 'infissi');
                
                // Inizializza pos.rilievo se non esiste
                if (!pos.rilievo) {
                    pos.rilievo = {
                        togliere: false,
                        smaltimento: false,
                        materiale: '',
                        coprifiliInt: false,
                        coprifiliEst: false,
                        note: ''
                    };
                }
                
                // Copia i valori
                pos.rilievo.materiale = rilievoGlobale.materiale || '';
                pos.rilievo.note = rilievoGlobale.note || '';
                pos.rilievo.togliere = rilievoGlobale.togliere || false;
                pos.rilievo.smaltimento = rilievoGlobale.smaltimento || false;
                pos.rilievo.coprifiliInt = rilievoGlobale.coprifiliInt || false;
                pos.rilievo.coprifiliEst = rilievoGlobale.coprifiliEst || false;
                
                saveState();
                render();
                
                alert('✅ Dati copiati dal rilievo globale!');
            }
        }

        function updateRilievoProdotto(projectId, posId, productType, field, value) {
            const project = state.projects.find(p => p.id === projectId);
            const pos = project?.positions.find(p => p.id === posId);
            
            if (project && pos) {
                const rilievoKey = `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
                
                // Inizializza rilievo se non esiste
                if (!pos[rilievoKey]) {
                    pos[rilievoKey] = {
                        materiale: '',
                        note: '',
                        togliere: false,
                        smaltimento: false
                    };
                    
                    // Aggiungi coprifili solo per infissi
                    if (productType === 'infissi') {
                        pos[rilievoKey].coprifiliInt = false;
                        pos[rilievoKey].coprifiliEst = false;
                    }
                }
                
                // Gestione checkbox (boolean)
                if (field === 'togliere' || field === 'smaltimento' || field === 'coprifiliInt' || field === 'coprifiliEst') {
                    pos[rilievoKey][field] = value === true || value === 'true';
                } else {
                    pos[rilievoKey][field] = value;
                }
                
                saveState();
                render();
            }
        }

        function copiaRilievoDaGlobaleProdotto(projectId, posId, productType) {
            const project = state.projects.find(p => p.id === projectId);
            const pos = project?.positions.find(p => p.id === posId);
            
            if (project && pos) {
                const rilievoGlobale = getRilievoGlobale(project, productType);
                const rilievoKey = `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
                
                // Inizializza pos.rilievo se non esiste
                if (!pos[rilievoKey]) {
                    pos[rilievoKey] = {
                        materiale: '',
                        note: '',
                        togliere: false,
                        smaltimento: false
                    };
                    
                    if (productType === 'infissi') {
                        pos[rilievoKey].coprifiliInt = false;
                        pos[rilievoKey].coprifiliEst = false;
                    }
                }
                
                // Copia i valori
                pos[rilievoKey].materiale = rilievoGlobale.materiale || '';
                pos[rilievoKey].note = rilievoGlobale.note || '';
                pos[rilievoKey].togliere = rilievoGlobale.togliere || false;
                pos[rilievoKey].smaltimento = rilievoGlobale.smaltimento || false;
                
                if (productType === 'infissi') {
                    pos[rilievoKey].coprifiliInt = rilievoGlobale.coprifiliInt || false;
                    pos[rilievoKey].coprifiliEst = rilievoGlobale.coprifiliEst || false;
                }
                
                saveState();
                render();
                
                alert('✅ Dati copiati dal rilievo globale!');
            }
        }

        function toggleMaterialeProdottoMode(uniqueId) {
            const selectEl = document.getElementById(`materiale-select-${uniqueId}`);
            const inputEl = document.getElementById(`materiale-input-${uniqueId}`);
            const toggleBtn = document.getElementById(`materiale-toggle-${uniqueId}`);
            
            if (selectEl && inputEl && toggleBtn) {
                if (selectEl.style.display === 'none') {
                    // Passa a SELECT
                    selectEl.style.display = 'block';
                    inputEl.style.display = 'none';
                    toggleBtn.innerHTML = '✏️ Scrivi';
                    const currentValue = inputEl.value;
                    const optionExists = Array.from(selectEl.options).some(opt => opt.value === currentValue);
                    if (optionExists) {
                        selectEl.value = currentValue;
                    } else {
                        selectEl.value = '';
                    }
                } else {
                    // Passa a INPUT
                    selectEl.style.display = 'none';
                    inputEl.style.display = 'block';
                    toggleBtn.innerHTML = '📋 Tendina';
                    inputEl.value = selectEl.value;
                }
            }
        }

        function getRilievoGlobale(project, productType) {
            const rilievoKey = `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
            return project[rilievoKey] || {};
        }

        function calculateRilievoGlobaleCompleteness(project, productType) {
            const rilievo = getRilievoGlobale(project, productType);
            let completed = 0;
            let total = 3; // materiale, togliere, smaltimento (campo "preesistente" ELIMINATO in FASE 13a)
            
            // Per infissi ci sono anche i coprifili
            if (productType === 'infissi') {
                total = 5; // + coprifiliInt, coprifiliEst
            }
            
            // Conta i campi compilati (campo "preesistente" ELIMINATO in FASE 13a)
            if (rilievo.materiale && rilievo.materiale.trim() !== '') completed++;
            if (rilievo.togliere !== undefined && rilievo.togliere !== null) completed++;
            if (rilievo.smaltimento !== undefined && rilievo.smaltimento !== null) completed++;
            
            if (productType === 'infissi') {
                if (rilievo.coprifiliInt !== undefined && rilievo.coprifiliInt !== null) completed++;
                if (rilievo.coprifiliEst !== undefined && rilievo.coprifiliEst !== null) completed++;
            }
            
            const percentage = Math.round((completed / total) * 100);
            return { percentage, completed, total };
        }

        // BRM Calculator
        function calculateBRM(project, pos, misure, brmConfig) {
            if (!brmConfig) {
                return { L: null, H: null };
            }
            
            // Funzione helper per calcolare formule composite
            const calcolaMisura = (formula, misure) => {
                if (!formula) return null;
                
                // Rimuovi tutti gli spazi dalla formula
                formula = formula.replace(/\s+/g, '');
                
                // Se la formula contiene "+" significa che è una somma di più misure
                if (formula.includes('+')) {
                    const parti = formula.split('+').map(p => p.trim());
                    let totale = 0;
                    for (const parte of parti) {
                        const valore = parseFloat(misure[parte]);
                        if (!isNaN(valore)) {
                            totale += valore;
                        }
                    }
                    return totale;
                }
                // Altrimenti è una singola misura
                const valore = parseFloat(misure[formula]);
                return isNaN(valore) ? null : valore;
            };
            
            // Calcola L separatamente
            let L = null;
            if (brmConfig.misuraBaseL) {
                const baseL = calcolaMisura(brmConfig.misuraBaseL, misure);
                if (baseL !== null) {
                    const valoreL = parseFloat(brmConfig.valoreL) || 0;
                    if (brmConfig.operazioneL === '+') {
                        L = baseL + valoreL;
                    } else {
                        L = baseL - valoreL;
                    }
                }
            }
            
            // Calcola H separatamente
            let H = null;
            if (brmConfig.misuraBaseH) {
                const baseH = calcolaMisura(brmConfig.misuraBaseH, misure);
                if (baseH !== null) {
                    const valoreH = parseFloat(brmConfig.valoreH) || 0;
                    if (brmConfig.operazioneH === '+') {
                        H = baseH + valoreH;
                    } else {
                        H = baseH - valoreH;
                    }
                }
            }
            
            return { L, H };
        }

        // Project Management
        function createProject(name, client) {
            const project = {
                id: generateId(),
                name,
                client,
                clientData: {},
                prodotti: {},
                caratteristicheMuro: {},
                configInfissi: {},
                configPersiane: {},
                configCassonetti: {
                    tipo: '',
                    azienda: '',
                    colore: ''
                },
                configTapparelle: {},
                configZanzariere: {
                    azienda: '',
                    modelloPF: '',
                    modelloF: '',
                    colore: ''
                },
                brmConfigInfissi: { 
                    misuraBaseL: '', operazioneL: '-', valoreL: '0',
                    misuraBaseH: '', operazioneH: '-', valoreH: '0',
                    note: '' 
                },
                brmConfigPersiane: { 
                    misuraBaseL: '', operazioneL: '-', valoreL: '0',
                    misuraBaseH: '', operazioneH: '-', valoreH: '0',
                    note: '' 
                },
                brmConfigTapparelle: { 
                    misuraBaseL: '', operazioneL: '-', valoreL: '0',
                    misuraBaseH: '', operazioneH: '-', valoreH: '0',
                    note: '' 
                },
                brmConfigZanzariere: { 
                    misuraBaseL: '', operazioneL: '-', valoreL: '0',
                    misuraBaseH: '', operazioneH: '-', valoreH: '0',
                    note: '' 
                },
                brmConfigCassonetti: { 
                    misuraBaseL: '', operazioneL: '-', valoreL: '0',
                    misuraBaseH: '', operazioneH: '-', valoreH: '0',
                    note: '',
                    SRSX: '0',
                    SRDX: '0',
                    ZSX: '0',
                    ZDX: '0'
                },
                positions: [],
                createdAt: new Date().toISOString()
            };
            state.projects.push(project);
            state.currentProject = project.id;
            state.setupStep = 1;
            saveState();
            return project;
        }

        function addPosition(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = {
                    id: generateId(),
                    name: `Pos. ${project.positions.length + 1}`,
                    piano: project.clientData?.piano || '',
                    ambiente: '',
                    quantita: '1',
                    misure: {},
                    // 📋 NUOVO: Dati rilievo preesistente
                    rilievo: {
                        togliere: false,            // Da togliere? SI/NO
                        smaltimento: false,         // Da smaltire? SI/NO
                        materiale: '',              // Tipo materiale (legno, pvc, alluminio)
                        coprifiliInt: false,        // Coprifili interni necessari?
                        coprifiliEst: false,        // Coprifili esterni necessari?
                        note: ''                    // Note aggiuntive
                    },
                    infissi: [],
                    persiane: [],
                    cassonetti: [],
                    tapparelle: [],
                    zanzariere: [],
                    foto: [],
                    note: '',
                    noteVisibilita: []
                };
                project.positions.push(pos);
                saveState();
                state.currentPosition = pos.id;
                showNotification('Posizione aggiunta', 'success');
                render();
            }
        }

        // Product Management Functions
        function addInfisso(projectId, posId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    const brm = calculateBRM(project, pos, pos.misure, project.brmConfigInfissi);
                    // UN SOLO INFISSO per posizione
                    pos.infisso = {
                        id: generateId(),
                        qta: '1',
                        azienda: project.configInfissi?.azienda || '',
                        finituraInt: project.configInfissi?.finituraInt || '',
                        finituraEst: project.configInfissi?.finituraEst || '',
                        coloreInt: project.configInfissi?.coloreInt || '',
                        coloreEst: project.configInfissi?.coloreEst || '',
                        tipoAnta: project.configInfissi?.tipoAnta || '',
                        telaio: project.configInfissi?.telaio || '',
                        allarme: project.configInfissi?.allarme || '',
                        vetro: project.configInfissi?.vetro || '',
                        tagliTelaio: project.configInfissi?.tagliTelaio || '',
                        motoreAzienda: project.configInfissi?.motoreAzienda || '',
                        motoreModello: project.configInfissi?.motoreModello || '',
                        BRM_L: brm.L,
                        BRM_H: brm.H,
                        usaGlobale: true, // di default usa la config globale
                        note: '',
                        foto: []
                    };
                    saveState();
                    render();
                }
            }
        }

        function addPersiana(projectId, posId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    const brm = calculateBRM(project, pos, pos.misure, project.brmConfigPersiane);
                    // UNA SOLA PERSIANA per posizione
                    pos.persiana = {
                        id: generateId(),
                        qta: '1',
                        tipo: project.configPersiane?.tipo || '',
                        materiale: project.configPersiane?.materiale || '',
                        colore: project.configPersiane?.colore || '',
                        apertura: project.configPersiane?.apertura || '',
                        BRM_L: brm.L,
                        BRM_H: brm.H,
                        usaGlobale: true,
                        note: '',
                        foto: []
                    };
                    saveState();
                    render();
                }
            }
        }

        function addTapparella(projectId, posId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    const brm = calculateBRM(project, pos, pos.misure, project.brmConfigTapparelle);
                    // UNA SOLA TAPPARELLA per posizione
                    pos.tapparella = {
                        id: generateId(),
                        tipo: project.configTapparelle?.tipo || '',
                        materiale: project.configTapparelle?.materiale || '',
                        colore: project.configTapparelle?.colore || '',
                        comando: project.configTapparelle?.comando || '',
                        motoreAzienda: project.configTapparelle?.motoreAzienda || '',
                        motoreModello: project.configTapparelle?.motoreModello || '',
                        BRM_L: brm.L,
                        BRM_H: brm.H,
                        usaGlobale: true,
                        note: '',
                        foto: []
                    };
                    saveState();
                    render();
                }
            }
        }

        function addZanzariera(projectId, posId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    const brm = calculateBRM(project, pos, pos.misure, project.brmConfigZanzariere);
                    // UNA SOLA ZANZARIERA per posizione
                    pos.zanzariera = {
                        id: generateId(),
                        tipo: project.configZanzariere?.tipo || '',
                        coloreTelaio: project.configZanzariere?.coloreTelaio || '',
                        tipoRete: project.configZanzariere?.tipoRete || '',
                        coloreRete: project.configZanzariere?.coloreRete || '',
                        BRM_L: brm.L,
                        BRM_H: brm.H,
                        usaGlobale: true,
                        note: '',
                        foto: []
                    };
                    saveState();
                    render();
                }
            }
        }

        function addCassonetto(projectId, posId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    // UN SOLO CASSONETTO per posizione
                    pos.cassonetto = {
                        id: generateId(),
                        tipo: project.configCassonetti?.tipo || '',
                        materiale: project.configCassonetti?.materiale || '',
                        finitura: project.configCassonetti?.finitura || '',
                        coibentazione: project.configCassonetti?.coibentazione || '',
                        // Inizializza le misure a 0
                        LS: '0',
                        SRSX: '0',
                        ZSX: '0',
                        SRDX: '0',
                        ZDX: '0',
                        HCASS: '0',
                        B: '0',
                        C: '0',
                        BSuperiore: '0',
                        BRM_L: null,
                        BRM_H: null,
                        usaGlobale: true,
                        note: '',
                        foto: []
                    };
                    
                    // Calcola BRM iniziale (sarà 0 perché le misure sono 0)
                    const brm = calculateBRM(project, pos, pos.cassonetto, project.brmConfigCassonetti);
                    pos.cassonetto.BRM_L = brm.L;
                    pos.cassonetto.BRM_H = brm.H;
                    
                    saveState();
                    render();
                }
            }
        }

        function deleteProduct(projectId, posId, productType) {
            if (confirm('Sei sicuro di voler eliminare questo elemento?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos[productType]) {
                        // Elimina il singolo prodotto
                        delete pos[productType];
                        saveState();
                        render();
                    }
                }
            }
        }

        function updateProduct(projectId, posId, productType, field, value) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos[productType]) {
                    pos[productType][field] = value;
                    
                    // CASSONETTI: Se cambiano le misure, ricalcola il BRM
                    const misureCassonetto = ['LS', 'SRSX', 'ZSX', 'SRDX', 'ZDX', 'HCASS', 'B', 'C', 'BSuperiore'];
                    if (productType === 'cassonetto' && misureCassonetto.includes(field)) {
                        const cas = pos.cassonetto;
                        if (cas.usaGlobale) {
                            // Usa formula globale
                            const brm = calculateBRM(project, pos, cas, project.brmConfigCassonetti);
                            cas.BRM_L = brm.L;
                            cas.BRM_H = brm.H;
                        } else {
                            // Usa formula personalizzata
                            const brm = calculateBRM(project, pos, cas, cas.brmPersonalizzato);
                            cas.BRM_L = brm.L;
                            cas.BRM_H = brm.H;
                        }
                    }
                    
                    saveState();
                    
                    // FASE 11a: Re-render se cambiano campi che influenzano la UI
                    if (productType === 'tapparella' && (field === 'tipoSostituzione' || field === 'manualeMot')) {
                        render();
                    }
                    // Re-render anche se cambiano le misure del cassonetto per aggiornare BRM
                    if (productType === 'cassonetto' && misureCassonetto.includes(field)) {
                        render();
                    }
                }
            }
        }

        // Toggle usaGlobale e ricalcola BRM
        function toggleUsaGlobale(projectId, posId, productType) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos[productType]) {
                    const product = pos[productType];
                    product.usaGlobale = !product.usaGlobale;
                    
                    const configMap = {
                        'infisso': 'brmConfigInfissi',
                        'persiana': 'brmConfigPersiane',
                        'tapparella': 'brmConfigTapparelle',
                        'zanzariera': 'brmConfigZanzariere',
                        'cassonetto': 'brmConfigCassonetti'
                    };
                    const configKey = configMap[productType];
                    
                    // Per i cassonetti, le misure sono nel cassonetto stesso (LS, SRSX, etc)
                    // Per gli altri prodotti, le misure sono in pos.misure
                    const misure = (productType === 'cassonetto') ? product : pos.misure;
                    
                    if (product.usaGlobale) {
                        // Attivo usaGlobale: ricalcola il BRM con la config globale
                        if (configKey) {
                            const brm = calculateBRM(project, pos, misure, project[configKey]);
                            product.BRM_L = brm.L;
                            product.BRM_H = brm.H;
                        }
                    } else {
                        // Disattivo usaGlobale: inizializza formula personalizzata
                        // Copia la formula dalla config globale come punto di partenza
                        if (configKey && project[configKey]) {
                            const globalConfig = project[configKey];
                            product.brmPersonalizzato = {
                                misuraBaseL: globalConfig.misuraBaseL || '',
                                operazioneL: globalConfig.operazioneL || '-',
                                valoreL: globalConfig.valoreL || '0',
                                misuraBaseH: globalConfig.misuraBaseH || '',
                                operazioneH: globalConfig.operazioneH || '-',
                                valoreH: globalConfig.valoreH || '0'
                            };
                            
                            // Ricalcola BRM con la formula personalizzata
                            const brm = calculateBRM(project, pos, misure, product.brmPersonalizzato);
                            product.BRM_L = brm.L;
                            product.BRM_H = brm.H;
                        }
                    }
                    saveState();
                    render();
                }
            }
        }

        // Forza ricalcolo BRM per cassonetto (solo quando Usa Globale è attivo)
        window.ricalcolaBRMCassonetto = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.cassonetto) {
                    const cas = pos.cassonetto;
                    
                    // Assicurati che tutte le misure esistano
                    if (!cas.LS) cas.LS = '0';
                    if (!cas.SRSX) cas.SRSX = '0';
                    if (!cas.ZSX) cas.ZSX = '0';
                    if (!cas.SRDX) cas.SRDX = '0';
                    if (!cas.ZDX) cas.ZDX = '0';
                    if (!cas.HCASS) cas.HCASS = '0';
                    if (!cas.B) cas.B = '0';
                    if (!cas.C) cas.C = '0';
                    if (!cas.BSuperiore) cas.BSuperiore = '0';
                    
                    // Ricalcola BRM (solo con formula globale)
                    if (cas.usaGlobale) {
                        const brm = calculateBRM(project, pos, cas, project.brmConfigCassonetti);
                        cas.BRM_L = brm.L;
                        cas.BRM_H = brm.H;
                        
                        saveState();
                        render();
                        showNotification('BRM ricalcolato! L=' + (cas.BRM_L || 'null') + 'mm, H=' + (cas.BRM_H || 'null') + 'mm', 'success');
                    }
                }
            }
        };

        // Aggiorna formula BRM personalizzata per un prodotto
        function updateBRMPersonalizzato(projectId, posId, productType, field, value) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos[productType]) {
                    const product = pos[productType];
                    if (!product.brmPersonalizzato) {
                        product.brmPersonalizzato = {
                            misuraBaseL: '', operazioneL: '+', valoreL: '0',
                            misuraBaseH: '', operazioneH: '+', valoreH: '0'
                        };
                    }
                    
                    // Salva il valore
                    product.brmPersonalizzato[field] = value;
                    
                    // Per i cassonetti, le misure sono nel cassonetto stesso
                    const misure = (productType === 'cassonetto') ? product : pos.misure;
                    
                    // Ricalcola BRM con la nuova formula
                    const brm = calculateBRM(project, pos, misure, product.brmPersonalizzato);
                    product.BRM_L = brm.L;
                    product.BRM_H = brm.H;
                    
                    // Salva nello state
                    saveState();
                    
                    // Aggiorna manualmente solo i campi BRM visualizzati (senza fare render completo)
                    // Questo mantiene il valore del dropdown selezionato
                    const brmDisplay = document.querySelector('#app');
                    if (brmDisplay) {
                        // Trova e aggiorna il testo del BRM Larghezza
                        const brmLElements = brmDisplay.querySelectorAll('input[readonly]');
                        brmLElements.forEach(el => {
                            if (el.previousElementSibling && el.previousElementSibling.textContent.includes('BRM Larghezza')) {
                                el.value = brm.L || '';
                            }
                            if (el.previousElementSibling && el.previousElementSibling.textContent.includes('BRM Altezza')) {
                                el.value = brm.H || '';
                            }
                        });
                    }
                    
                    // Mostra una notifica con il nuovo valore BRM
                    showNotification(`BRM aggiornato! L=${brm.L || '?'}mm, H=${brm.H || '?'}mm`, 'success');
                    
                    // NON fare render() per mantenere il valore del dropdown
                }
            }
        }

        // MAIN COMPONENTS
        function Header() {
            return `
                <header class="bg-white/95 backdrop-blur shadow-lg sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-4 py-3">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                ${state.screen !== 'list' ? `
                                    <button onclick="goBack()" class="p-2 hover:bg-gray-100 rounded-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                        </svg>
                                    </button>
                                ` : ''}
                                <h1 class="text-xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                                    Open Porte v3.0 - Fase 21: UI Completa 🎯✨📋
                                </h1>
                            </div>
                            <div class="flex items-center gap-2">
                                ${state.screen === 'list' ? `
                                    <button onclick="importProjects()" 
                                            class="px-4 py-1.5 bg-gradient-to-r from-blue-500 to-cyan-600 text-white rounded-lg font-medium hover:shadow-lg transition-all flex items-center gap-2">
                                        <span>📥</span>
                                        <span>Importa</span>
                                    </button>
                                    <button onclick="exportAllProjects()" 
                                            class="px-4 py-1.5 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-medium hover:shadow-lg transition-all flex items-center gap-2">
                                        <span>💾</span>
                                        <span>Esporta</span>
                                    </button>
                                    <button onclick="showNewProjectModal()" 
                                            class="px-4 py-1.5 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium hover:shadow-lg transition-all">
                                        + Nuovo Progetto
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </header>
            `;
        }

        function ProjectsList() {
            if (state.projects.length === 0) {
                return `
                    <div class="min-h-[70vh] flex items-center justify-center">
                        <div class="text-center bg-white rounded-2xl p-8 shadow-xl">
                            <div class="text-6xl mb-4">📋</div>
                            <h2 class="text-2xl font-bold mb-2">Benvenuto in Open Porte</h2>
                            <p class="text-gray-600 mb-6">Inizia creando il tuo primo progetto</p>
                            <button onclick="showNewProjectModal()" 
                                    class="px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                                + Crea Primo Progetto
                            </button>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                    ${state.projects.map(p => `
                        <div class="section-card hover:transform hover:scale-105 transition-all cursor-pointer"
                             onclick="openProject('${p.id}')">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="font-bold text-lg">${p.name}</h3>
                                    <p class="text-sm text-gray-600">${p.client}</p>
                                </div>
                                <span class="text-2xl">🗂️</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-500">${p.positions.length} posizioni</span>
                                <span class="text-purple-600 font-medium">Apri →</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function ProjectSetup() {
            const project = state.projects.find(p => p.id === state.currentProject);
            if (!project) return '';

            return `
                <div class="max-w-7xl mx-auto p-4">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="state.currentProject = null; state.screen = 'list'; render()" 
                                class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium transition-all flex items-center gap-2">
                            <span>←</span>
                            <span>Torna ai Progetti</span>
                        </button>
                    </div>
                    
                    <div class="flex justify-between items-center mb-6 bg-white rounded-lg p-4 shadow overflow-x-auto">
                        ${[
                            {num: 1, label: 'Dati Cliente'},
                            {num: 2, label: 'Prodotti'},
                            {num: 3, label: 'Config. Infissi'},
                            {num: 4, label: 'Config. Persiane'},
                            {num: 5, label: 'Config. Tapparelle'},
                            {num: 6, label: 'Config. Zanzariere'},
                            {num: 7, label: 'Config. Cassonetti'},
                            {num: 8, label: 'Muro'},
                            {num: 9, label: 'Posizioni'}
                        ].map(step => `
                            <div class="flex flex-col items-center cursor-pointer flex-shrink-0" onclick="state.setupStep=${step.num}; render()">
                                <div class="step-indicator ${state.setupStep === step.num ? 'active' : state.setupStep > step.num ? 'completed' : 'bg-gray-200'}">
                                    ${state.setupStep > step.num ? '✓' : step.num}
                                </div>
                                <span class="text-xs mt-1 ${state.setupStep === step.num ? 'font-bold' : ''} whitespace-nowrap">${step.label}</span>
                            </div>
                        `).join('<div class="flex-1 border-t-2 border-gray-200 -mt-4 mx-2"></div>')}
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        ${state.setupStep === 1 ? renderStep1ClientData(project) :
                          state.setupStep === 2 ? renderStep2Products(project) :
                          state.setupStep === 3 ? renderStep3ConfigInfissi(project) :
                          state.setupStep === 4 ? renderStep4ConfigPersiane(project) :
                          state.setupStep === 5 ? renderStep5ConfigTapparelle(project) :
                          state.setupStep === 6 ? renderStep6ConfigZanzariere(project) :
                          state.setupStep === 7 ? renderStep7ConfigCassonetti(project) :
                          state.setupStep === 8 ? renderStep8WallFeatures(project) :
                          renderStep9Positions(project)}
                        
                        <div class="flex justify-between mt-6 pt-4 border-t">
                            <button onclick="state.setupStep = Math.max(1, state.setupStep - 1); render()" 
                                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 ${state.setupStep === 1 ? 'invisible' : ''}">
                                ← Indietro
                            </button>
                            ${state.setupStep < 9 ? `
                                <button onclick="state.setupStep = Math.min(9, state.setupStep + 1); saveState(); render()" 
                                        class="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium hover:shadow-lg">
                                    Avanti →
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStep1ClientData(project) {
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">👤</span> Dati Cliente e Progetto
                    </h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Nome Progetto</label>
                            <input type="text" value="${project.name}" 
                                   onchange="updateProject('${project.id}', 'name', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Cliente</label>
                            <input type="text" value="${project.client}" 
                                   onchange="updateProject('${project.id}', 'client', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Piano</label>
                            ${(() => {
                                const pianoOptions = ['Piano Seminterrato', 'Piano Terra', 'Piano Rialzato', 'Primo Piano', 'Secondo Piano', 'Terzo Piano', 'Quarto Piano', 'Quinto Piano', 'Attico', 'Mansarda'];
                                const currentPiano = project.clientData?.piano || '';
                                const isCustom = currentPiano && !pianoOptions.includes(currentPiano);
                                const selectId = `piano-select-${project.id}`;
                                const inputId = `piano-input-${project.id}`;
                                
                                return `
                                    <select id="${selectId}" 
                                            onchange="handleSelectWithCustom('${project.id}', 'piano', '${selectId}', '${inputId}', this.value, ${JSON.stringify(pianoOptions)})"
                                            class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <option value="">Seleziona piano...</option>
                                        ${pianoOptions.map(opt => `
                                            <option value="${opt}" ${currentPiano === opt ? 'selected' : ''}>${opt}</option>
                                        `).join('')}
                                        <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>✏️ Altro e scrivo...</option>
                                    </select>
                                    <input type="text" 
                                           id="${inputId}"
                                           value="${isCustom ? currentPiano : ''}"
                                           onchange="updateClientData('${project.id}', 'piano', this.value)"
                                           placeholder="Inserisci piano personalizzato..."
                                           style="display: ${isCustom ? 'block' : 'none'};"
                                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 mt-2">
                                `;
                            })()}
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Città</label>
                            <input type="text" placeholder="Milano" 
                                   value="${project.clientData?.citta || ''}"
                                   onchange="updateClientData('${project.id}', 'citta', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Via/Indirizzo</label>
                            <input type="text" placeholder="Via Roma, 1" 
                                   value="${project.clientData?.via || ''}"
                                   onchange="updateClientData('${project.id}', 'via', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Telefono</label>
                            <input type="tel" placeholder="+39 333 1234567" 
                                   value="${project.clientData?.telefono || ''}"
                                   onchange="updateClientData('${project.id}', 'telefono', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Email</label>
                            <input type="email" placeholder="cliente@email.com" 
                                   value="${project.clientData?.email || ''}"
                                   onchange="updateClientData('${project.id}', 'email', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Note</label>
                            <input type="text" placeholder="Note aggiuntive..." 
                                   value="${project.clientData?.note || ''}"
                                   onchange="updateClientData('${project.id}', 'note', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStep2Products(project) {
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">🛠️</span> Seleziona i Prodotti da Installare
                    </h2>
                    <p class="text-gray-600 mb-4">Seleziona quali prodotti verranno installati in questo progetto:</p>
                    
                    <div class="flex flex-wrap gap-4">
                        <label class="product-pill ${project.prodotti?.infissi ? 'selected bg-blue-50 border-blue-500 text-blue-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.infissi ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'infissi', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">🪟</span>
                            <div>
                                <div class="font-semibold">Infissi</div>
                                <div class="text-xs opacity-75">Finestre e porte</div>
                            </div>
                        </label>

                        <label class="product-pill ${project.prodotti?.persiane ? 'selected bg-purple-50 border-purple-500 text-purple-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.persiane ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'persiane', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">🚪</span>
                            <div>
                                <div class="font-semibold">Persiane</div>
                                <div class="text-xs opacity-75">Persiane e scuri</div>
                            </div>
                        </label>

                        <label class="product-pill ${project.prodotti?.tapparelle ? 'selected bg-amber-50 border-amber-500 text-amber-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.tapparelle ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'tapparelle', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">🎚️</span>
                            <div>
                                <div class="font-semibold">Tapparelle</div>
                                <div class="text-xs opacity-75">Avvolgibili</div>
                            </div>
                        </label>

                        <label class="product-pill ${project.prodotti?.zanzariere ? 'selected bg-green-50 border-green-500 text-green-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.zanzariere ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'zanzariere', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">🦟</span>
                            <div>
                                <div class="font-semibold">Zanzariere</div>
                                <div class="text-xs opacity-75">Protezione insetti</div>
                            </div>
                        </label>

                        <label class="product-pill ${project.prodotti?.cassonetti ? 'selected bg-orange-50 border-orange-500 text-orange-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.cassonetti ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'cassonetti', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">📦</span>
                            <div>
                                <div class="font-semibold">Cassonetti</div>
                                <div class="text-xs opacity-75">Cassonetti avvolgibili</div>
                            </div>
                        </label>
                    </div>

                    ${Object.values(project.prodotti || {}).some(v => v) ? `
                        <div class="mt-6 p-4 bg-green-50 border border-green-300 rounded-lg">
                            <p class="text-green-700 font-medium">
                                ✅ Hai selezionato: ${Object.entries(project.prodotti || {})
                                    .filter(([k,v]) => v)
                                    .map(([k]) => k.charAt(0).toUpperCase() + k.slice(1))
                                    .join(', ')}
                            </p>
                        </div>
                    ` : `
                        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-300 rounded-lg">
                            <p class="text-yellow-700">⚠️ Seleziona almeno un prodotto per continuare</p>
                        </div>
                    `}
                </div>
            `;
        }

        // 🆕 FASE 13 - Render Rilievo Globale per Prodotto
        function renderRilievoGlobale(project, productType, productLabel, icon) {
            const rilievo = getRilievoGlobale(project, productType);
            const completeness = calculateRilievoGlobaleCompleteness(project, productType);
            const hasInfissi = productType === 'infissi';
            
            return `
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-300 rounded-lg p-4 shadow-md mt-4">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                ${icon} 📋 RILIEVO PREESISTENTE - ${productLabel}
                            </h3>
                            <p class="text-xs text-gray-600 mt-1">Compila tutte le informazioni per evitare dimenticanze</p>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center gap-2">
                                <div class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="bg-purple-500 h-full transition-all duration-500" 
                                         style="width: ${completeness.percentage}%"></div>
                                </div>
                                <span class="text-sm font-bold">${completeness.percentage}%</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">${completeness.completed}/${completeness.total} campi</p>
                        </div>
                    </div>
                    
                    <!-- 📏 MISURE PRINCIPALI - SEMPRE VISIBILI PER TEST -->
                    <div class="bg-yellow-100 border-4 border-red-500 rounded-lg p-4 mb-4">
                        <p class="text-lg font-bold text-red-900 mb-3">📏📏📏 MISURE PRINCIPALI (mm) 📏📏📏</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            ${['LVT', 'HVT', 'LF', 'HF', 'TMV', 'HMT', 'LVAR', 'HVAR'].map(field => `
                                <div>
                                    <label class="text-sm font-bold text-red-700">${field}</label>
                                    <input type="number" placeholder="0"
                                           value="${(project.misureGlobaliInfissi && project.misureGlobaliInfissi[field]) || ''}"
                                           onchange="updateMisureGlobaliInfissi('${project.id}', '${field}', this.value)"
                                           class="w-full px-3 py-2 border-4 border-red-400 rounded mt-1 font-bold text-lg bg-yellow-50">
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-3 mt-4">
                            <!-- DELTA -->
                            <div class="bg-blue-100 border-4 border-blue-600 rounded-lg p-3">
                                <p class="text-sm font-bold text-blue-900 mb-2">📐 Delta (mm)</p>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-sm font-bold">Delta INT</label>
                                        <input type="number" placeholder="0" 
                                               value="${(project.misureGlobaliInfissi && project.misureGlobaliInfissi.DeltaINT) || ''}"
                                               onchange="updateMisureGlobaliInfissi('${project.id}', 'DeltaINT', this.value)"
                                               class="w-full px-3 py-2 border-2 border-blue-400 rounded font-bold text-lg">
                                    </div>
                                    <div>
                                        <label class="text-sm font-bold">Delta EST</label>
                                        <input type="number" placeholder="0" 
                                               value="${(project.misureGlobaliInfissi && project.misureGlobaliInfissi.DeltaEST) || ''}"
                                               onchange="updateMisureGlobaliInfissi('${project.id}', 'DeltaEST', this.value)"
                                               class="w-full px-3 py-2 border-2 border-blue-400 rounded font-bold text-lg">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ALTEZZE -->
                            <div class="bg-green-100 border-4 border-green-600 rounded-lg p-3">
                                <p class="text-sm font-bold text-green-900 mb-2">📊 Altezze (mm)</p>
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label class="text-xs font-bold">H Soffitto</label>
                                        <input type="number" placeholder="0" 
                                               value="${(project.misureGlobaliInfissi && project.misureGlobaliInfissi.HSoffitto) || ''}"
                                               onchange="updateMisureGlobaliInfissi('${project.id}', 'HSoffitto', this.value)"
                                               class="w-full px-2 py-1.5 border-2 border-green-400 rounded font-bold">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold">H Par/Soff</label>
                                        <input type="number" placeholder="0" 
                                               value="${(project.misureGlobaliInfissi && project.misureGlobaliInfissi.HParapettoSoffitto) || ''}"
                                               onchange="updateMisureGlobaliInfissi('${project.id}', 'HParapettoSoffitto', this.value)"
                                               class="w-full px-2 py-1.5 border-2 border-green-400 rounded font-bold">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold">H Pav/Parap</label>
                                        <input type="number" placeholder="0" 
                                               value="${(project.misureGlobaliInfissi && project.misureGlobaliInfissi.HPavimentoParapetto) || ''}"
                                               onchange="updateMisureGlobaliInfissi('${project.id}', 'HPavimentoParapetto', this.value)"
                                               class="w-full px-2 py-1.5 border-2 border-green-400 rounded font-bold">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4">
                        <!-- 1. MATERIALE -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-semibold flex items-center gap-2">
                                    🔧 Materiale
                                    ${!rilievo.materiale || rilievo.materiale.trim() === '' ? '<span class="text-red-600">●</span>' : '<span class="text-green-600">✓</span>'}
                                </label>
                                <button onclick="toggleMaterialeMode('${productType}', '${project.id}')" 
                                        id="materiale-toggle-${productType}-${project.id}"
                                        class="text-xs bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full font-medium transition">
                                    ✏️ Scrivi
                                </button>
                            </div>
                            
                            <!-- SELECT MODE (default) -->
                            <select id="materiale-select-${productType}-${project.id}"
                                    onchange="updateRilievoGlobale('${project.id}', '${productType}', 'materiale', this.value)"
                                    class="w-full px-3 py-2 border-2 ${!rilievo.materiale || rilievo.materiale.trim() === '' ? 'border-red-300 bg-red-50' : 'border-green-300 bg-white'} rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">Seleziona...</option>
                                <option value="Legno" ${rilievo.materiale === 'Legno' ? 'selected' : ''}>Legno</option>
                                <option value="PVC" ${rilievo.materiale === 'PVC' ? 'selected' : ''}>PVC</option>
                                <option value="Alluminio" ${rilievo.materiale === 'Alluminio' ? 'selected' : ''}>Alluminio</option>
                                <option value="Ferro" ${rilievo.materiale === 'Ferro' ? 'selected' : ''}>Ferro</option>
                            </select>
                            
                            <!-- INPUT MODE (hidden by default) -->
                            <input type="text" 
                                   id="materiale-input-${productType}-${project.id}"
                                   value="${rilievo.materiale || ''}"
                                   onchange="updateRilievoGlobale('${project.id}', '${productType}', 'materiale', this.value)"
                                   placeholder="Inserisci materiale..."
                                   style="display: none;"
                                   class="w-full px-3 py-2 border-2 ${!rilievo.materiale || rilievo.materiale.trim() === '' ? 'border-red-300 bg-red-50' : 'border-green-300 bg-white'} rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        
                        <!-- 2. NOTE AGGIUNTIVE -->
                        <div>
                            <label class="block text-sm font-semibold mb-2 flex items-center gap-2">
                                📝 Note
                            </label>
                            <input type="text" 
                                   value="${rilievo.note || ''}"
                                   onchange="updateRilievoGlobale('${project.id}', '${productType}', 'note', this.value)"
                                   placeholder="Note aggiuntive..."
                                   class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                    
                    <div class="grid ${hasInfissi ? 'md:grid-cols-4' : 'md:grid-cols-2'} gap-4 mt-4 pt-4 border-t-2 border-gray-200">
                        <!-- CHECKBOX: TOGLIERE -->
                        <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${rilievo.togliere ? 'border-orange-300' : 'border-gray-200'}">
                            <input type="checkbox" 
                                   id="togliere-${productType}-${project.id}"
                                   ${rilievo.togliere ? 'checked' : ''}
                                   onchange="updateRilievoGlobale('${project.id}', '${productType}', 'togliere', this.checked)"
                                   class="w-5 h-5 text-orange-600 rounded focus:ring-2 focus:ring-orange-500">
                            <label for="togliere-${productType}-${project.id}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                🔨 Da togliere?
                                ${rilievo.togliere ? '<span class="text-green-600">✓</span>' : '<span class="text-gray-400">○</span>'}
                            </label>
                        </div>
                        
                        <!-- CHECKBOX: SMALTIMENTO -->
                        <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${rilievo.smaltimento ? 'border-red-300' : 'border-gray-200'}">
                            <input type="checkbox" 
                                   id="smaltimento-${productType}-${project.id}"
                                   ${rilievo.smaltimento ? 'checked' : ''}
                                   onchange="updateRilievoGlobale('${project.id}', '${productType}', 'smaltimento', this.checked)"
                                   class="w-5 h-5 text-red-600 rounded focus:ring-2 focus:ring-red-500">
                            <label for="smaltimento-${productType}-${project.id}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                🗑️ Da smaltire?
                                ${rilievo.smaltimento ? '<span class="text-green-600">✓</span>' : '<span class="text-gray-400">○</span>'}
                            </label>
                        </div>
                        
                        ${hasInfissi ? `
                            <!-- CHECKBOX: COPRIFILI INT (solo per Infissi) -->
                            <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${rilievo.coprifiliInt ? 'border-blue-300' : 'border-gray-200'}">
                                <input type="checkbox" 
                                       id="coprifiliInt-${productType}-${project.id}"
                                       ${rilievo.coprifiliInt ? 'checked' : ''}
                                       onchange="updateRilievoGlobale('${project.id}', '${productType}', 'coprifiliInt', this.checked)"
                                       class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                                <label for="coprifiliInt-${productType}-${project.id}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                    📏 Coprifili INT?
                                    ${rilievo.coprifiliInt ? '<span class="text-green-600">✓</span>' : '<span class="text-gray-400">○</span>'}
                                </label>
                            </div>
                            
                            <!-- CHECKBOX: COPRIFILI EST (solo per Infissi) -->
                            <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${rilievo.coprifiliEst ? 'border-purple-300' : 'border-gray-200'}">
                                <input type="checkbox" 
                                       id="coprifiliEst-${productType}-${project.id}"
                                       ${rilievo.coprifiliEst ? 'checked' : ''}
                                       onchange="updateRilievoGlobale('${project.id}', '${productType}', 'coprifiliEst', this.checked)"
                                       class="w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500">
                                <label for="coprifiliEst-${productType}-${project.id}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                    📐 Coprifili EST?
                                    ${rilievo.coprifiliEst ? '<span class="text-green-600">✓</span>' : '<span class="text-gray-400">○</span>'}
                                </label>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${completeness.percentage < 100 ? `
                        <div class="mt-3 p-2 bg-amber-100 border border-amber-300 rounded text-sm text-amber-800">
                            ⚠️ <strong>Attenzione:</strong> Compila tutti i campi per evitare dimenticanze!
                        </div>
                    ` : `
                        <div class="mt-3 p-2 bg-green-100 border border-green-300 rounded text-sm text-green-800">
                            ✅ <strong>Perfetto!</strong> Tutte le informazioni del rilievo sono complete.
                        </div>
                    `}
                </div>
            `;
        }

        function renderBRMConfig(project, productType, productLabel, icon) {
            const configKey = `brmConfig${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
            const config = project[configKey] || { 
                misuraBaseL: '', operazioneL: '-', valoreL: '0',
                misuraBaseH: '', operazioneH: '-', valoreH: '0',
                note: '' 
            };
            
            // Misure di larghezza specifiche per cassonetti o generiche
            let misureLarghezza = ['LF', 'LVT', 'LVAR', 'TMV', 'LS'];
            if (productType === 'cassonetti') {
                misureLarghezza = ['LARGH_CASS', 'LS', 'LVT', 'TMV', 'LF', 'MIS_FIN_INF_L', 'LS+SRDX+SRSX'];
            }
            const misureAltezza = ['HF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'];
            
            return `
                <div class="brm-calculator mt-6 p-4">
                    <h3 class="font-bold text-amber-800 mb-3 flex items-center gap-2">
                        <span class="text-xl">${icon}</span>
                        📏 Calcolo BRM per ${productLabel}
                        ${productType === 'cassonetti' ? '<span class="ml-2 text-xs bg-green-500 text-white px-2 py-1 rounded">✅ Misure Specifiche Cassonetti</span>' : ''}
                    </h3>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-3">
                        <div class="bg-white p-3 rounded-lg border-2 border-amber-300">
                            <h4 class="font-semibold text-amber-800 mb-2">📐 BRM Larghezza</h4>
                            <div class="grid grid-cols-3 gap-2 mb-2">
                                <div>
                                    <label class="text-xs font-medium text-amber-800 block mb-1">Misura</label>
                                    <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseL', this.value)"
                                            class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                        <option value="">-</option>
                                        ${misureLarghezza.map(m => `
                                            <option value="${m}" ${config.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-amber-800 block mb-1">Op.</label>
                                    <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneL', this.value)"
                                            class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                        <option value="+" ${config.operazioneL === '+' ? 'selected' : ''}>+</option>
                                        <option value="-" ${config.operazioneL === '-' ? 'selected' : ''}>-</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-amber-800 block mb-1">mm</label>
                                    <input type="number" value="${config.valoreL || '0'}"
                                           onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreL', this.value)"
                                           class="w-full px-2 py-1 border border-amber-500 rounded text-sm">
                                </div>
                            </div>
                            <div class="brm-result">
                                ${config.misuraBaseL ? `📏 BRM L = ${config.misuraBaseL} ${config.operazioneL} ${config.valoreL}mm` : 'Seleziona misura'}
                            </div>
                        </div>
                        
                        <div class="bg-white p-3 rounded-lg border-2 border-amber-300">
                            <h4 class="font-semibold text-amber-800 mb-2">📐 BRM Altezza</h4>
                            <div class="grid grid-cols-3 gap-2 mb-2">
                                <div>
                                    <label class="text-xs font-medium text-amber-800 block mb-1">Misura</label>
                                    <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseH', this.value)"
                                            class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                        <option value="">-</option>
                                        ${misureAltezza.map(m => `
                                            <option value="${m}" ${config.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-amber-800 block mb-1">Op.</label>
                                    <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneH', this.value)"
                                            class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                        <option value="+" ${config.operazioneH === '+' ? 'selected' : ''}>+</option>
                                        <option value="-" ${config.operazioneH === '-' ? 'selected' : ''}>-</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-amber-800 block mb-1">mm</label>
                                    <input type="number" value="${config.valoreH || '0'}"
                                           onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreH', this.value)"
                                           class="w-full px-2 py-1 border border-amber-500 rounded text-sm">
                                </div>
                            </div>
                            <div class="brm-result">
                                ${config.misuraBaseH ? `📏 BRM H = ${config.misuraBaseH} ${config.operazioneH} ${config.valoreH}mm` : 'Seleziona misura'}
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-medium text-amber-800 mb-1">📝 Note Formula</label>
                        <textarea onchange="updateBRMConfig('${project.id}', '${configKey}', 'note', this.value)"
                                  placeholder="Es: Tolleranza standard, considerazioni particolari..."
                                  class="w-full px-2 py-1 border border-amber-500 rounded text-sm"
                                  rows="2">${config.note || ''}</textarea>
                    </div>
                </div>
            `;
        }

        function renderStep3ConfigInfissi(project) {
            if (!project.prodotti?.infissi) {
                return `
                    <div class="text-center py-8">
                        <p class="text-gray-500">Gli infissi non sono stati selezionati. Salta questo step.</p>
                    </div>
                `;
            }

            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">🪟</span> Configurazione Infissi Default
                    </h2>
                    <p class="text-gray-600 mb-4">Imposta i valori di default per tutti gli infissi:</p>
                    
                    ${renderRilievoGlobale(project, 'infissi', 'Infissi', '🪟')}
                    
                    <div class="space-y-4 mt-6">
                        <div class="grid md:grid-cols-2 gap-4">
                            <!-- 1. AZIENDA -->
                            <div>
                                <label class="block text-sm font-medium mb-1">1. Azienda</label>
                                <select onchange="updateConfigInfissi('${project.id}', 'azienda', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="">Seleziona...</option>
                                    <option value="finstral" ${project.configInfissi?.azienda === 'finstral' ? 'selected' : ''}>FINSTRAL</option>
                                    <option value="essepi" ${project.configInfissi?.azienda === 'essepi' ? 'selected' : ''}>ESSEPI</option>
                                    <option value="schuco" ${project.configInfissi?.azienda === 'schuco' ? 'selected' : ''}>SCHÜCO</option>
                                    <option value="oknoplast" ${project.configInfissi?.azienda === 'oknoplast' ? 'selected' : ''}>OKNOPLAST</option>
                                    <option value="internorm" ${project.configInfissi?.azienda === 'internorm' ? 'selected' : ''}>INTERNORM</option>
                                </select>
                            </div>

                            <!-- 2. TIPO ANTA -->
                            <div>
                                <label class="block text-sm font-medium mb-1">2. Tipo Anta</label>
                                <select onchange="updateConfigInfissi('${project.id}', 'tipoAnta', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="">Seleziona...</option>
                                    <option value="step-line" ${project.configInfissi?.tipoAnta === 'step-line' ? 'selected' : ''}>STEP-LINE</option>
                                    <option value="nova-line" ${project.configInfissi?.tipoAnta === 'nova-line' ? 'selected' : ''}>NOVA-LINE</option>
                                    <option value="slim-line" ${project.configInfissi?.tipoAnta === 'slim-line' ? 'selected' : ''}>SLIM-LINE</option>
                                    <option value="classic-line" ${project.configInfissi?.tipoAnta === 'classic-line' ? 'selected' : ''}>CLASSIC-LINE</option>
                                    <option value="step-line-door" ${project.configInfissi?.tipoAnta === 'step-line-door' ? 'selected' : ''}>STEP-LINE DOOR</option>
                                </select>
                            </div>

                            <!-- 3. FINITURA INTERNA -->
                            <div>
                                <label class="block text-sm font-medium mb-1">3. Finitura Interna</label>
                                <select onchange="updateConfigInfissi('${project.id}', 'finituraInt', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="">Seleziona...</option>
                                    <option value="pvc" ${project.configInfissi?.finituraInt === 'pvc' ? 'selected' : ''}>PVC</option>
                                    <option value="legno" ${project.configInfissi?.finituraInt === 'legno' ? 'selected' : ''}>LEGNO</option>
                                    <option value="alluminio" ${project.configInfissi?.finituraInt === 'alluminio' ? 'selected' : ''}>ALLUMINIO</option>
                                    <option value="ceramica" ${project.configInfissi?.finituraInt === 'ceramica' ? 'selected' : ''}>CERAMICA</option>
                                </select>
                            </div>

                            <!-- 4. FINITURA ESTERNA -->
                            <div>
                                <label class="block text-sm font-medium mb-1">4. Finitura Esterna</label>
                                <select onchange="updateConfigInfissi('${project.id}', 'finituraEst', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="">Seleziona...</option>
                                    <option value="pvc" ${project.configInfissi?.finituraEst === 'pvc' ? 'selected' : ''}>PVC</option>
                                    <option value="alluminio" ${project.configInfissi?.finituraEst === 'alluminio' ? 'selected' : ''}>ALLUMINIO</option>
                                    <option value="ceramica" ${project.configInfissi?.finituraEst === 'ceramica' ? 'selected' : ''}>CERAMICA</option>
                                </select>
                            </div>

                            <!-- 5. COLORE INTERNO -->
                            <div>
                                <label class="block text-sm font-medium mb-1">5. Colore Interno</label>
                                <input type="text" 
                                       placeholder="Es: Bianco, RAL 9010, ecc."
                                       value="${project.configInfissi?.coloreInt || ''}"
                                       onchange="updateConfigInfissi('${project.id}', 'coloreInt', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                            </div>

                            <!-- 6. COLORE ESTERNO -->
                            <div>
                                <label class="block text-sm font-medium mb-1">6. Colore Esterno</label>
                                <input type="text" 
                                       placeholder="Es: Marrone, RAL 8014, ecc."
                                       value="${project.configInfissi?.coloreEst || ''}"
                                       onchange="updateConfigInfissi('${project.id}', 'coloreEst', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                            </div>

                            <!-- 7. TELAIO -->
                            <div>
                                <label class="block text-sm font-medium mb-1">7. Telaio</label>
                                <select onchange="updateConfigInfissi('${project.id}', 'telaio', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="">Seleziona...</option>
                                    <option value="961" ${project.configInfissi?.telaio === '961' ? 'selected' : ''}>961</option>
                                    <option value="962" ${project.configInfissi?.telaio === '962' ? 'selected' : ''}>962</option>
                                    <option value="966" ${project.configInfissi?.telaio === '966' ? 'selected' : ''}>966</option>
                                    <option value="965" ${project.configInfissi?.telaio === '965' ? 'selected' : ''}>965</option>
                                </select>
                            </div>

                            <!-- 8. ALLARME -->
                            <div>
                                <label class="block text-sm font-medium mb-1">8. Allarme</label>
                                <select onchange="updateConfigInfissi('${project.id}', 'allarme', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="">Seleziona...</option>
                                    <option value="si" ${project.configInfissi?.allarme === 'si' ? 'selected' : ''}>Sì</option>
                                    <option value="no" ${project.configInfissi?.allarme === 'no' ? 'selected' : ''}>No</option>
                                </select>
                            </div>

                            <!-- 9. VETRO -->
                            <div>
                                <label class="block text-sm font-medium mb-1">9. Vetro</label>
                                <select onchange="updateConfigInfissi('${project.id}', 'vetro', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="">Seleziona...</option>
                                    <option value="doppio" ${project.configInfissi?.vetro === 'doppio' ? 'selected' : ''}>Doppio</option>
                                    <option value="doppio-sat" ${project.configInfissi?.vetro === 'doppio-sat' ? 'selected' : ''}>Doppio SAT</option>
                                    <option value="triplo" ${project.configInfissi?.vetro === 'triplo' ? 'selected' : ''}>Triplo</option>
                                    <option value="triplo-sat" ${project.configInfissi?.vetro === 'triplo-sat' ? 'selected' : ''}>Triplo SAT</option>
                                </select>
                            </div>

                            <!-- 10. TAGLI TELAIO -->
                            <div>
                                <label class="block text-sm font-medium mb-1">10. Tagli Telaio</label>
                                <select onchange="updateConfigInfissi('${project.id}', 'tagliTelaio', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="">Seleziona...</option>
                                    <option value="sopra" ${project.configInfissi?.tagliTelaio === 'sopra' ? 'selected' : ''}>Sopra</option>
                                    <option value="sotto" ${project.configInfissi?.tagliTelaio === 'sotto' ? 'selected' : ''}>Sotto</option>
                                    <option value="sopra-sotto" ${project.configInfissi?.tagliTelaio === 'sopra-sotto' ? 'selected' : ''}>Sopra/Sotto</option>
                                    <option value="dx" ${project.configInfissi?.tagliTelaio === 'dx' ? 'selected' : ''}>DX</option>
                                    <option value="sx" ${project.configInfissi?.tagliTelaio === 'sx' ? 'selected' : ''}>SX</option>
                                    <option value="dx-sx" ${project.configInfissi?.tagliTelaio === 'dx-sx' ? 'selected' : ''}>DX/SX</option>
                                    <option value="4-lati" ${project.configInfissi?.tagliTelaio === '4-lati' ? 'selected' : ''}>4 Lati</option>
                                    <option value="sopra-laterali" ${project.configInfissi?.tagliTelaio === 'sopra-laterali' ? 'selected' : ''}>Sopra/Laterali</option>
                                    <option value="sotto-laterali" ${project.configInfissi?.tagliTelaio === 'sotto-laterali' ? 'selected' : ''}>Sotto/Laterali</option>
                                </select>
                            </div>

                            <!-- 11. COD.TAGLI (Automatico basato su selezione Tagli Telaio) -->
                            <div>
                                <label class="block text-sm font-medium mb-1">11. COD.TAGLI</label>
                                <input type="text" 
                                       value="${(() => {
                                           const tagliTelaio = project.configInfissi?.tagliTelaio || '';
                                           const codiciTagli = {
                                               'sopra': 'SOPRA',
                                               'sotto': 'SOTTO',
                                               'sopra-sotto': 'SOPRA SOTTO',
                                               'dx': 'DX',
                                               'sx': 'SX',
                                               'dx-sx': 'DX SX',
                                               '4-lati': 'SOPRA SOTTO SX DX',
                                               'sopra-laterali': 'SOPRA SX DX',
                                               'sotto-laterali': 'SOTTO SX DX'
                                           };
                                           return codiciTagli[tagliTelaio] || '';
                                       })()}"
                                       readonly
                                       placeholder="Seleziona Tagli Telaio per vedere il codice"
                                       class="w-full px-3 py-2 border rounded-lg bg-gray-100 text-gray-700 font-mono">
                            </div>
                        </div>
                    </div>
                    
                    ${renderBRMConfig(project, 'infissi', 'Infissi', '🪟')}
                </div>
            `;
        }

        function renderStep4ConfigPersiane(project) {
            if (!project.prodotti?.persiane) {
                return `<div class="text-center py-8"><p class="text-gray-500">Le persiane non sono state selezionate. Salta questo step.</p></div>`;
            }
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">🚪</span> Configurazione Persiane Default
                    </h2>
                    <p class="text-gray-600 mb-4">Imposta i valori di default per tutte le persiane:</p>
                    
                    ${renderRilievoGlobale(project, 'persiane', 'Persiane', '🚪')}
                    
                    <div class="space-y-4 mt-6">
                        <div class="grid md:grid-cols-2 gap-4">
                            <!-- 1. AZIENDA -->
                            <div>
                                <label class="block text-sm font-medium mb-1">1. Azienda</label>
                                <select onchange="updateConfigPersiane('${project.id}', 'azienda', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona...</option>
                                    <option value="p-persiane" ${project.configPersiane?.azienda === 'p-persiane' ? 'selected' : ''}>P.Persiane</option>
                                </select>
                            </div>
                            
                            <!-- 2. MODELLO con "Altro e scrivo" -->
                            <div>
                                <label class="block text-sm font-medium mb-1">2. Modello</label>
                                <select id="modello-persiane-${project.id}" 
                                        onchange="updateConfigPersianeConditional('${project.id}', 'modello', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona...</option>
                                    <option value="Aurora" ${project.configPersiane?.modello === 'Aurora' ? 'selected' : ''}>Aurora</option>
                                    <option value="Vanitosa" ${project.configPersiane?.modello === 'Vanitosa' ? 'selected' : ''}>Vanitosa</option>
                                    <option value="Oscura" ${project.configPersiane?.modello === 'Oscura' ? 'selected' : ''}>Oscura</option>
                                    <option value="Alto Adige" ${project.configPersiane?.modello === 'Alto Adige' ? 'selected' : ''}>Alto Adige</option>
                                    <option value="altro" ${project.configPersiane?.modello === 'altro' ? 'selected' : ''}>✏️ Altro e scrivo</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- MODELLO ALTRO (condizionale) -->
                        <div id="modello-altro-${project.id}" style="display: ${project.configPersiane?.modello === 'altro' ? 'block' : 'none'}">
                            <label class="block text-sm font-medium mb-1">Specifica Modello</label>
                            <input type="text" 
                                   value="${project.configPersiane?.modelloAltro || ''}"
                                   onchange="updateConfigPersiane('${project.id}', 'modelloAltro', this.value)"
                                   placeholder="Inserisci modello..."
                                   class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        
                        <!-- 3. FISSAGGIO -->
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">3. Fissaggio</label>
                                <select id="fissaggio-persiane-${project.id}" 
                                        onchange="updateFissaggioPersiane('${project.id}', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona...</option>
                                    <option value="A MURO" ${project.configPersiane?.fissaggio === 'A MURO' ? 'selected' : ''}>A MURO</option>
                                    <option value="TELAIO" ${project.configPersiane?.fissaggio === 'TELAIO' ? 'selected' : ''}>TELAIO</option>
                                </select>
                            </div>
                            
                            <!-- 4. TIPO TELAIO (condizionale se FISSAGGIO = TELAIO) -->
                            <div id="tipo-telaio-persiane-container-${project.id}" 
                                 style="display: ${project.configPersiane?.fissaggio === 'TELAIO' ? 'block' : 'none'}">
                                <label class="block text-sm font-medium mb-1">4. Tipo Telaio</label>
                                <select id="tipo-telaio-persiane-select-${project.id}" 
                                        onchange="updateConfigPersianeConditional('${project.id}', 'tipoTelaio', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona...</option>
                                    <option value="TH 62" ${project.configPersiane?.tipoTelaio === 'TH 62' ? 'selected' : ''}>TH 62</option>
                                    <option value="TH 40" ${project.configPersiane?.tipoTelaio === 'TH 40' ? 'selected' : ''}>TH 40</option>
                                    <option value="TH 82" ${project.configPersiane?.tipoTelaio === 'TH 82' ? 'selected' : ''}>TH 82</option>
                                    <option value="altro" ${project.configPersiane?.tipoTelaio === 'altro' ? 'selected' : ''}>✏️ Altro e scrivo</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- TIPO TELAIO ALTRO (condizionale) -->
                        <div id="tipo-telaio-altro-${project.id}" 
                             style="display: ${project.configPersiane?.tipoTelaio === 'altro' ? 'block' : 'none'}">
                            <label class="block text-sm font-medium mb-1">Specifica Tipo Telaio</label>
                            <input type="text" 
                                   value="${project.configPersiane?.tipoTelaioAltro || ''}"
                                   onchange="updateConfigPersiane('${project.id}', 'tipoTelaioAltro', this.value)"
                                   placeholder="Inserisci tipo telaio..."
                                   class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        
                        <!-- 5. COLORE PERSIANA e 6. COLORE TELAIO -->
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">5. Colore Persiana</label>
                                <input type="text" 
                                       placeholder="Es: Bianco, Verde"
                                       value="${project.configPersiane?.colorePersiana || ''}"
                                       onchange="updateConfigPersiane('${project.id}', 'colorePersiana', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            
                            <!-- COLORE TELAIO (condizionale se FISSAGGIO = TELAIO) -->
                            <div id="colore-telaio-persiane-container-${project.id}" 
                                 style="display: ${project.configPersiane?.fissaggio === 'TELAIO' ? 'block' : 'none'}">
                                <label class="block text-sm font-medium mb-1">6. Colore Telaio</label>
                                <input type="text" 
                                       placeholder="Es: Bianco, Marrone"
                                       value="${project.configPersiane?.coloreTelaio || ''}"
                                       onchange="updateConfigPersiane('${project.id}', 'coloreTelaio', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                        
                        <!-- 7. BATTUTA -->
                        <div>
                            <label class="block text-sm font-medium mb-1">7. Battuta</label>
                            <select onchange="updateConfigPersiane('${project.id}', 'battuta', this.value)"
                                    class="w-full px-3 py-2 border rounded-lg md:w-1/2">
                                <option value="">Seleziona...</option>
                                <option value="3 LATI" ${project.configPersiane?.battuta === '3 LATI' ? 'selected' : ''}>3 LATI</option>
                                <option value="4 LATI" ${project.configPersiane?.battuta === '4 LATI' ? 'selected' : ''}>4 LATI</option>
                                <option value="2 LATI LATERALI" ${project.configPersiane?.battuta === '2 LATI LATERALI' ? 'selected' : ''}>2 LATI LATERALI</option>
                            </select>
                        </div>
                    </div>
                    
                    ${renderBRMConfig(project, 'persiane', 'Persiane', '🚪')}
                </div>
            `;
        }

        function renderStep5ConfigTapparelle(project) {
            if (!project.prodotti?.tapparelle) {
                return `<div class="text-center py-8"><p class="text-gray-500">Le tapparelle non sono state selezionate. Salta questo step.</p></div>`;
            }
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">🎚️</span> Configurazione Tapparelle Default
                    </h2>
                    <p class="text-gray-600 mb-4">Imposta i valori di default per tutte le tapparelle:</p>
                    
                    ${renderRilievoGlobale(project, 'tapparelle', 'Tapparelle', '🎚️')}
                    
                    <div class="space-y-4 mt-6">
                        <div class="grid md:grid-cols-2 gap-4">
                            <!-- 1. AZIENDA -->
                            <div>
                                <label class="block text-sm font-medium mb-1">1. Azienda</label>
                                <select onchange="updateConfigTapparelle('${project.id}', 'azienda', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona...</option>
                                    <option value="Plasticino" ${project.configTapparelle?.azienda === 'Plasticino' ? 'selected' : ''}>Plasticino</option>
                                    <option value="New solar" ${project.configTapparelle?.azienda === 'New solar' ? 'selected' : ''}>New solar</option>
                                    <option value="Estella" ${project.configTapparelle?.azienda === 'Estella' ? 'selected' : ''}>Estella</option>
                                </select>
                            </div>
                            
                            <!-- 2. MODELLO -->
                            <div>
                                <label class="block text-sm font-medium mb-1">2. Modello</label>
                                <select onchange="updateConfigTapparelle('${project.id}', 'modello', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona...</option>
                                    <option value="Mini" ${project.configTapparelle?.modello === 'Mini' ? 'selected' : ''}>Mini</option>
                                    <option value="Alluminio" ${project.configTapparelle?.modello === 'Alluminio' ? 'selected' : ''}>Alluminio</option>
                                </select>
                            </div>
                            
                            <!-- 3. COLORE -->
                            <div>
                                <label class="block text-sm font-medium mb-1">3. Colore</label>
                                <input type="text" placeholder="Es: Bianco, Grigio"
                                       value="${project.configTapparelle?.colore || ''}"
                                       onchange="updateConfigTapparelle('${project.id}', 'colore', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            
                            <!-- 4. MANUALE/MOTORIZZATO -->
                            <div>
                                <label class="block text-sm font-medium mb-1">4. Manuale/Motorizzato</label>
                                <select onchange="updateConfigTapparelle('${project.id}', 'tipologia', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona...</option>
                                    <option value="Manuale" ${project.configTapparelle?.tipologia === 'Manuale' ? 'selected' : ''}>Manuale</option>
                                    <option value="Motorizzata" ${project.configTapparelle?.tipologia === 'Motorizzata' ? 'selected' : ''}>Motorizzata</option>
                                </select>
                            </div>
                            
                            <!-- 5. SOST. ESISTENTE -->
                            <div>
                                <label class="block text-sm font-medium mb-1">5. Sost. Esistente</label>
                                <select onchange="updateConfigTapparelle('${project.id}', 'sostEsistente', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona...</option>
                                    <option value="Sost. Rullo Sì" ${project.configTapparelle?.sostEsistente === 'Sost. Rullo Sì' ? 'selected' : ''}>Sost. Rullo Sì</option>
                                    <option value="Sost. Rullo No" ${project.configTapparelle?.sostEsistente === 'Sost. Rullo No' ? 'selected' : ''}>Sost. Rullo No</option>
                                    <option value="Sost. tutto" ${project.configTapparelle?.sostEsistente === 'Sost. tutto' ? 'selected' : ''}>Sost. tutto</option>
                                    <option value="Non Sost. Niente" ${project.configTapparelle?.sostEsistente === 'Non Sost. Niente' ? 'selected' : ''}>Non Sost. Niente</option>
                                </select>
                            </div>
                            
                            <!-- 6. GUIDA -->
                            <div>
                                <label class="block text-sm font-medium mb-1">6. Guida</label>
                                <input type="text" placeholder="Es: Standard, Rinforzata"
                                       value="${project.configTapparelle?.guida || ''}"
                                       onchange="updateConfigTapparelle('${project.id}', 'guida', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            
                            <!-- 7. COLORE GUIDA -->
                            <div>
                                <label class="block text-sm font-medium mb-1">7. Colore Guida</label>
                                <input type="text" placeholder="Es: Bianco, Marrone"
                                       value="${project.configTapparelle?.coloreGuida || ''}"
                                       onchange="updateConfigTapparelle('${project.id}', 'coloreGuida', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                    </div>
                    
                    ${renderBRMConfig(project, 'tapparelle', 'Tapparelle', '🎚️')}
                </div>
            `;
        }

        function renderStep6ConfigZanzariere(project) {
            if (!project.prodotti?.zanzariere) {
                return `<div class="text-center py-8"><p class="text-gray-500">Le zanzariere non sono state selezionate. Salta questo step.</p></div>`;
            }
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">🦟</span> Configurazione Zanzariere Default
                    </h2>
                    <p class="text-gray-600 mb-4">Imposta i valori di default per tutte le zanzariere:</p>
                    
                    <div class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">1. Tipo Zanzariera</label>
                                ${(() => {
                                    const options = ['Avvolgibile', 'Plissé', 'Battente', 'Scorrevole', 'Fissa'];
                                    const current = project.configZanzariere?.tipo || '';
                                    const isCustom = current && !options.includes(current);
                                    const selectId = `zanz-tipo-${project.id}`;
                                    const inputId = `zanz-tipo-input-${project.id}`;
                                    
                                    return `
                                        <select id="${selectId}" 
                                                onchange="handleConfigSelectWithCustom('${project.id}', 'zanzariere', 'tipo', '${selectId}', '${inputId}', this.value)"
                                                class="w-full px-3 py-2 border rounded-lg">
                                            <option value="">Seleziona tipo...</option>
                                            ${options.map(opt => `
                                                <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                            `).join('')}
                                            <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>✏️ Altro e scrivo...</option>
                                        </select>
                                        <input type="text" 
                                               id="${inputId}"
                                               value="${isCustom ? current : ''}"
                                               onchange="updateConfigZanzariere('${project.id}', 'tipo', this.value)"
                                               placeholder="Inserisci tipo personalizzato..."
                                               style="display: ${isCustom ? 'block' : 'none'};"
                                               class="w-full px-3 py-2 border rounded-lg mt-2">
                                    `;
                                })()}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">2. Colore Telaio</label>
                                <input type="text" value="${project.configZanzariere?.coloreTelaio || ''}"
                                       onchange="updateConfigZanzariere('${project.id}', 'coloreTelaio', this.value)"
                                       placeholder="Es: Bianco, Marrone, RAL 9010"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">3. Tipo Rete</label>
                                ${(() => {
                                    const options = ['Standard', 'Anti-polline', 'Pet-resistant', 'Micro-forata'];
                                    const current = project.configZanzariere?.tipoRete || '';
                                    const isCustom = current && !options.includes(current);
                                    const selectId = `zanz-rete-${project.id}`;
                                    const inputId = `zanz-rete-input-${project.id}`;
                                    
                                    return `
                                        <select id="${selectId}" 
                                                onchange="handleConfigSelectWithCustom('${project.id}', 'zanzariere', 'tipoRete', '${selectId}', '${inputId}', this.value)"
                                                class="w-full px-3 py-2 border rounded-lg">
                                            <option value="">Seleziona...</option>
                                            ${options.map(opt => `
                                                <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                            `).join('')}
                                            <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>✏️ Altro e scrivo...</option>
                                        </select>
                                        <input type="text" 
                                               id="${inputId}"
                                               value="${isCustom ? current : ''}"
                                               onchange="updateConfigZanzariere('${project.id}', 'tipoRete', this.value)"
                                               placeholder="Inserisci tipo rete personalizzato..."
                                               style="display: ${isCustom ? 'block' : 'none'};"
                                               class="w-full px-3 py-2 border rounded-lg mt-2">
                                    `;
                                })()}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">4. Colore Rete</label>
                                ${(() => {
                                    const options = ['Nero', 'Grigio', 'Bianco'];
                                    const current = project.configZanzariere?.coloreRete || '';
                                    const isCustom = current && !options.includes(current);
                                    const selectId = `zanz-colore-${project.id}`;
                                    const inputId = `zanz-colore-input-${project.id}`;
                                    
                                    return `
                                        <select id="${selectId}" 
                                                onchange="handleConfigSelectWithCustom('${project.id}', 'zanzariere', 'coloreRete', '${selectId}', '${inputId}', this.value)"
                                                class="w-full px-3 py-2 border rounded-lg">
                                            <option value="">Seleziona...</option>
                                            ${options.map(opt => `
                                                <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                            `).join('')}
                                            <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>✏️ Altro e scrivo...</option>
                                        </select>
                                        <input type="text" 
                                               id="${inputId}"
                                               value="${isCustom ? current : ''}"
                                               onchange="updateConfigZanzariere('${project.id}', 'coloreRete', this.value)"
                                               placeholder="Inserisci colore personalizzato..."
                                               style="display: ${isCustom ? 'block' : 'none'};"
                                               class="w-full px-3 py-2 border rounded-lg mt-2">
                                    `;
                                })()}
                            </div>
                        </div>
                    </div>
                    
                    ${renderBRMConfig(project, 'zanzariere', 'Zanzariere', '🦟')}
                </div>
            `;
        }

        function renderStep7ConfigCassonetti(project) {
            if (!project.prodotti?.cassonetti) {
                return `<div class="text-center py-8"><p class="text-gray-500">I cassonetti non sono stati selezionati. Salta questo step.</p></div>`;
            }
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">📦</span> Configurazione Cassonetti Default
                    </h2>
                    <p class="text-gray-600 mb-4">Imposta i valori di default per tutti i cassonetti:</p>
                    
                    ${renderRilievoGlobale(project, 'cassonetti', 'Cassonetti', '📦')}
                    
                    <div class="space-y-4 mt-6">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">1. Tipo Cassonetto</label>
                                ${(() => {
                                    const options = ['Esterno', 'Incasso', 'Sopra-finestra', 'Semi-incasso'];
                                    const current = project.configCassonetti?.tipo || '';
                                    const isCustom = current && !options.includes(current);
                                    const selectId = `cass-tipo-${project.id}`;
                                    const inputId = `cass-tipo-input-${project.id}`;
                                    
                                    return `
                                        <select id="${selectId}" 
                                                onchange="handleConfigSelectWithCustom('${project.id}', 'cassonetti', 'tipo', '${selectId}', '${inputId}', this.value)"
                                                class="w-full px-3 py-2 border rounded-lg">
                                            <option value="">Seleziona tipo...</option>
                                            ${options.map(opt => `
                                                <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                            `).join('')}
                                            <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>✏️ Altro e scrivo...</option>
                                        </select>
                                        <input type="text" 
                                               id="${inputId}"
                                               value="${isCustom ? current : ''}"
                                               onchange="updateConfigCassonetti('${project.id}', 'tipo', this.value)"
                                               placeholder="Inserisci tipo personalizzato..."
                                               style="display: ${isCustom ? 'block' : 'none'};"
                                               class="w-full px-3 py-2 border rounded-lg mt-2">
                                    `;
                                })()}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">2. Materiale</label>
                                ${(() => {
                                    const options = ['PVC', 'Alluminio', 'Alluminio Coibentato', 'Legno'];
                                    const current = project.configCassonetti?.materiale || '';
                                    const isCustom = current && !options.includes(current);
                                    const selectId = `cass-materiale-${project.id}`;
                                    const inputId = `cass-materiale-input-${project.id}`;
                                    
                                    return `
                                        <select id="${selectId}" 
                                                onchange="handleConfigSelectWithCustom('${project.id}', 'cassonetti', 'materiale', '${selectId}', '${inputId}', this.value)"
                                                class="w-full px-3 py-2 border rounded-lg">
                                            <option value="">Seleziona materiale...</option>
                                            ${options.map(opt => `
                                                <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                            `).join('')}
                                            <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>✏️ Altro e scrivo...</option>
                                        </select>
                                        <input type="text" 
                                               id="${inputId}"
                                               value="${isCustom ? current : ''}"
                                               onchange="updateConfigCassonetti('${project.id}', 'materiale', this.value)"
                                               placeholder="Inserisci materiale personalizzato..."
                                               style="display: ${isCustom ? 'block' : 'none'};"
                                               class="w-full px-3 py-2 border rounded-lg mt-2">
                                    `;
                                })()}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">3. Finitura/Colore</label>
                                <input type="text" value="${project.configCassonetti?.finitura || ''}"
                                       onchange="updateConfigCassonetti('${project.id}', 'finitura', this.value)"
                                       placeholder="Es: Bianco, RAL 9010, Legno"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">4. Coibentazione</label>
                                ${(() => {
                                    const options = ['Standard', 'Rinforzata', 'Acustica'];
                                    const current = project.configCassonetti?.coibentazione || '';
                                    const isCustom = current && !options.includes(current);
                                    const selectId = `cass-coib-${project.id}`;
                                    const inputId = `cass-coib-input-${project.id}`;
                                    
                                    return `
                                        <select id="${selectId}" 
                                                onchange="handleConfigSelectWithCustom('${project.id}', 'cassonetti', 'coibentazione', '${selectId}', '${inputId}', this.value)"
                                                class="w-full px-3 py-2 border rounded-lg">
                                            <option value="">Seleziona...</option>
                                            ${options.map(opt => `
                                                <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                            `).join('')}
                                            <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>✏️ Altro e scrivo...</option>
                                        </select>
                                        <input type="text" 
                                               id="${inputId}"
                                               value="${isCustom ? current : ''}"
                                               onchange="updateConfigCassonetti('${project.id}', 'coibentazione', this.value)"
                                               placeholder="Inserisci coibentazione personalizzata..."
                                               style="display: ${isCustom ? 'block' : 'none'};"
                                               class="w-full px-3 py-2 border rounded-lg mt-2">
                                    `;
                                })()}
                            </div>
                        </div>
                    </div>
                    
                    ${renderBRMConfig(project, 'cassonetti', 'Cassonetti', '📦')}
                </div>
            `;
        }

        function renderStep8WallFeatures(project) {
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">🗿</span> Caratteristiche Muro (Misure in mm)
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs font-medium">Prof. Muro Int</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.profMuroInt || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'profMuroInt', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Prof. Piana Sopra</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.profPianaSopra || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'profPianaSopra', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Prof. Piana Sotto</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.profPianaSotto || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'profPianaSotto', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Telaio Prof</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.telaioProfondita || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'telaioProfondita', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Telaio Largh</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.telaioLarghezza || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'telaioLarghezza', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Guida Esistente?</label>
                            <select id="guida-select-${project.id}" 
                                    onchange="updateGuidaEsistente('${project.id}', this.value)"
                                    class="w-full md:w-1/2 px-3 py-2 border rounded-lg">
                                <option value="">Seleziona...</option>
                                <option value="si" ${project.caratteristicheMuro?.guidaEsistente === 'si' ? 'selected' : ''}>Sì</option>
                                <option value="no" ${project.caratteristicheMuro?.guidaEsistente === 'no' ? 'selected' : ''}>No</option>
                            </select>
                        </div>
                        
                        <div id="guida-fields-${project.id}" style="display: ${project.caratteristicheMuro?.guidaEsistente === 'si' ? 'block' : 'none'}">
                            <div class="grid grid-cols-3 gap-3 bg-green-50 p-3 rounded">
                                <div>
                                    <label class="block text-xs font-medium text-green-700 mb-1">Prof. Distanziale</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.profDistanziale || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'profDistanziale', this.value)"
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-green-700 mb-1">Prof. Guida</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.profGuida || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'profGuida', this.value)"
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-green-700 mb-1">Largh. Guida</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.larghezzaGuida || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'larghezzaGuida', this.value)"
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Prof. Muro Est.</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.profMuroEst || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'profMuroEst', this.value)"
                                   class="w-full md:w-1/2 px-3 py-2 border rounded-lg">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Falso Esistente?</label>
                            <select id="falso-select-${project.id}"
                                    onchange="updateFalsoEsistente('${project.id}', this.value)"
                                    class="w-full md:w-1/2 px-3 py-2 border rounded-lg">
                                <option value="">Seleziona...</option>
                                <option value="si" ${project.caratteristicheMuro?.falsoEsistente === 'si' ? 'selected' : ''}>Sì</option>
                                <option value="no" ${project.caratteristicheMuro?.falsoEsistente === 'no' ? 'selected' : ''}>No</option>
                            </select>
                        </div>
                        
                        <div id="falso-si-fields-${project.id}" style="display: ${project.caratteristicheMuro?.falsoEsistente === 'si' ? 'block' : 'none'}">
                            <div class="bg-orange-50 p-3 rounded space-y-3">
                                <div>
                                    <label class="block text-xs font-medium text-orange-700 mb-1">Spessore Falso</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.spessoreFalso || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'spessoreFalso', this.value)"
                                           class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-orange-700 mb-1">+ Distanza Falso/Infisso</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.distanzaFalsoInfisso || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'distanzaFalsoInfisso', this.value)"
                                           class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                </div>
                            </div>
                        </div>
                        
                        <div id="falso-no-fields-${project.id}" style="display: ${project.caratteristicheMuro?.falsoEsistente === 'no' ? 'block' : 'none'}">
                            <div class="bg-purple-50 p-3 rounded">
                                <label class="block text-xs font-medium text-purple-700 mb-1">Distanza Muro/Infisso</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.distanzaMuroInfisso || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'distanzaMuroInfisso', this.value)"
                                       class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStep9Positions(project) {
            // Mostra riepilogo se richiesto
            if (state.showRiepilogoRilievi) {
                return renderRiepilogoRilievi(project);
            }
            
            return `
                <div>
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <span class="text-2xl">📍</span> Posizioni (${project.positions.length})
                        </h2>
                        <div class="flex gap-2">
                            <button onclick="state.showRiepilogoRilievi = true; render()"
                                    class="px-4 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 flex items-center gap-2">
                                📋 Riepilogo Rilievi
                            </button>
                            <button onclick="addPosition('${project.id}')"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                                + Aggiungi Posizione
                            </button>
                        </div>
                    </div>

                    ${project.positions.length === 0 ? `
                        <div class="text-center py-12 bg-gray-50 rounded-lg">
                            <p class="text-gray-600 mb-4">Nessuna posizione ancora</p>
                            <button onclick="addPosition('${project.id}')"
                                    class="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium">
                                Aggiungi Prima Posizione
                            </button>
                        </div>
                    ` : `
                        <div class="space-y-3">
                            ${project.positions.map((pos, idx) => {
                                const validation = validateMisure(project, pos);
                                const statusIcon = validation.errors.length > 0 ? '🔴' : validation.warnings.length > 0 ? '🟡' : '✅';
                                const statusText = validation.errors.length > 0 ? 'ERRORI' : validation.warnings.length > 0 ? 'WARNING' : 'OK';
                                
                                // Stato rilievo
                                const rilievoStatus = getRilievoStatus(pos);
                                const rilievoCompleteness = calculateRilievoCompleteness(pos);
                                
                                return `
                                <div class="section-card cursor-pointer hover:shadow-lg ${validation.errors.length > 0 ? 'pulse-error' : ''}" onclick="openPosition('${pos.id}')">
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">📍</span>
                                            <div>
                                                <h3 class="font-semibold">${pos.name}</h3>
                                                <p class="text-sm text-gray-600">
                                                    ${pos.piano || 'Piano'} • ${pos.ambiente || 'Ambiente'}
                                                    ${pos.infisso ? ` • 🪟` : ''}
                                                    ${pos.persiana ? ` • 🚪` : ''}
                                                    ${pos.tapparella ? ` • 🎚️` : ''}
                                                    ${pos.zanzariera ? ` • 🦟` : ''}
                                                    ${pos.cassonetto ? ` • 📦` : ''}
                                                </p>
                                                <div class="flex items-center gap-3 mt-1">
                                                    <p class="text-xs font-semibold ${validation.errors.length > 0 ? 'text-red-600' : validation.warnings.length > 0 ? 'text-amber-600' : 'text-green-600'}">
                                                        ${statusIcon} Misure: ${statusText}
                                                    </p>
                                                    <p class="text-xs font-semibold text-${rilievoStatus.color}-600 flex items-center gap-1">
                                                        ${rilievoStatus.icon} Rilievo: ${rilievoCompleteness.percentage}%
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        <span class="text-purple-600">→</span>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function renderRiepilogoRilievi(project) {
            // Calcola statistiche generali
            const totalPos = project.positions.length;
            const completedPos = project.positions.filter(p => {
                const comp = calculateRilievoCompleteness(p);
                return comp.percentage === 100;
            }).length;
            const incompletePos = totalPos - completedPos;
            const avgCompleteness = totalPos > 0 
                ? Math.round(project.positions.reduce((sum, p) => sum + calculateRilievoCompleteness(p).percentage, 0) / totalPos)
                : 0;
            
            return `
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <span class="text-2xl">📋</span> Riepilogo Rilievi
                        </h2>
                        <div class="flex gap-2">
                            <button onclick="printChecklistRilievi('${project.id}')"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 flex items-center gap-2">
                                📄 Stampa Checklist
                            </button>
                            <button onclick="state.showRiepilogoRilievi = false; render()"
                                    class="px-4 py-2 bg-gray-600 text-white rounded-lg font-medium hover:bg-gray-700">
                                ← Torna alle Posizioni
                            </button>
                        </div>
                    </div>
                    
                    <!-- Statistiche generali -->
                    <div class="grid md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
                            <div class="text-3xl font-bold text-blue-700">${totalPos}</div>
                            <div class="text-sm text-blue-600">Posizioni Totali</div>
                        </div>
                        <div class="bg-green-50 border-2 border-green-300 rounded-lg p-4">
                            <div class="text-3xl font-bold text-green-700">${completedPos}</div>
                            <div class="text-sm text-green-600">Rilievi Completi</div>
                        </div>
                        <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4">
                            <div class="text-3xl font-bold text-red-700">${incompletePos}</div>
                            <div class="text-sm text-red-600">Da Completare</div>
                        </div>
                        <div class="bg-purple-50 border-2 border-purple-300 rounded-lg p-4">
                            <div class="text-3xl font-bold text-purple-700">${avgCompleteness}%</div>
                            <div class="text-sm text-purple-600">Completezza Media</div>
                        </div>
                    </div>
                    
                    ${totalPos === 0 ? `
                        <div class="text-center py-12 bg-gray-50 rounded-lg">
                            <p class="text-gray-600 mb-4">Nessuna posizione ancora</p>
                            <button onclick="state.showRiepilogoRilievi = false; addPosition('${project.id}')"
                                    class="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium">
                                Aggiungi Prima Posizione
                            </button>
                        </div>
                    ` : `
                        <!-- Tabella riepilogo -->
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gradient-to-r from-purple-600 to-blue-600 text-white">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold">Posizione</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold">Piano/Ambiente</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold">Preesistente</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold">Materiale</th>
                                            <th class="px-4 py-3 text-center text-sm font-semibold">Togliere</th>
                                            <th class="px-4 py-3 text-center text-sm font-semibold">Smaltire</th>
                                            <th class="px-4 py-3 text-center text-sm font-semibold">Cop.INT</th>
                                            <th class="px-4 py-3 text-center text-sm font-semibold">Cop.EST</th>
                                            <th class="px-4 py-3 text-center text-sm font-semibold">Completezza</th>
                                            <th class="px-4 py-3 text-center text-sm font-semibold">Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${project.positions.map((pos, idx) => {
                                            const r = pos.rilievo || {};
                                            const status = getRilievoStatus(pos);
                                            const completeness = calculateRilievoCompleteness(pos);
                                            const bgColor = idx % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                                            
                                            return `
                                                <tr class="${bgColor} hover:bg-blue-50 transition-colors">
                                                    <td class="px-4 py-3">
                                                        <div class="font-semibold text-gray-800">${pos.name}</div>
                                                    </td>
                                                    <td class="px-4 py-3 text-sm text-gray-600">
                                                        ${pos.piano || '-'} • ${pos.ambiente || '-'}
                                                    </td>
                                                    <td class="px-4 py-3">
                                                        <div class="text-sm ${!r.preesistente || r.preesistente.trim() === '' ? 'text-red-600 font-semibold' : 'text-gray-700'}">
                                                            ${r.preesistente || '❌ Mancante'}
                                                        </div>
                                                    </td>
                                                    <td class="px-4 py-3">
                                                        <div class="text-sm ${!r.materiale || r.materiale.trim() === '' ? 'text-red-600 font-semibold' : 'text-gray-700'}">
                                                            ${r.materiale || '❌ Mancante'}
                                                        </div>
                                                    </td>
                                                    <td class="px-4 py-3 text-center">
                                                        <span class="text-lg">${r.togliere ? '✅' : '❌'}</span>
                                                    </td>
                                                    <td class="px-4 py-3 text-center">
                                                        <span class="text-lg">${r.smaltimento ? '✅' : '❌'}</span>
                                                    </td>
                                                    <td class="px-4 py-3 text-center">
                                                        <span class="text-lg">${r.coprifiliInt ? '✅' : '❌'}</span>
                                                    </td>
                                                    <td class="px-4 py-3 text-center">
                                                        <span class="text-lg">${r.coprifiliEst ? '✅' : '❌'}</span>
                                                    </td>
                                                    <td class="px-4 py-3 text-center">
                                                        <div class="flex flex-col items-center gap-1">
                                                            <span class="text-xl">${status.icon}</span>
                                                            <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                                                <div class="${status.badge} h-full transition-all" style="width: ${completeness.percentage}%"></div>
                                                            </div>
                                                            <span class="text-xs font-bold text-${status.color}-700">${completeness.percentage}%</span>
                                                        </div>
                                                    </td>
                                                    <td class="px-4 py-3 text-center">
                                                        <button onclick="state.showRiepilogoRilievi = false; openPosition('${pos.id}')"
                                                                class="px-3 py-1 bg-purple-600 text-white rounded text-sm hover:bg-purple-700">
                                                            Apri
                                                        </button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        ${incompletePos > 0 ? `
                            <div class="mt-4 p-4 bg-amber-50 border-2 border-amber-300 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <span class="text-3xl">⚠️</span>
                                    <div>
                                        <h3 class="font-bold text-amber-800">Attenzione!</h3>
                                        <p class="text-sm text-amber-700">
                                            Hai ${incompletePos} posizion${incompletePos > 1 ? 'i' : 'e'} con informazioni di rilievo incomplete. 
                                            Completa tutti i campi prima del sopralluogo per evitare dimenticanze!
                                        </p>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div class="mt-4 p-4 bg-green-50 border-2 border-green-300 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <span class="text-3xl">✅</span>
                                    <div>
                                        <h3 class="font-bold text-green-800">Perfetto!</h3>
                                        <p class="text-sm text-green-700">
                                            Tutti i rilievi sono completi. Sei pronto per il sopralluogo!
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `}
                    `}
                </div>
            `;
        }

        function PositionDetail() {
            const project = state.projects.find(p => p.id === state.currentProject);
            const pos = project?.positions.find(p => p.id === state.currentPosition);
            if (!pos) return '';

            return `
                <div class="max-w-7xl mx-auto p-4">
                    <div class="bg-white rounded-lg shadow p-4 mb-4">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3 flex-1">
                                <input type="text" value="${pos.name}"
                                       onchange="updatePosition('${project.id}', '${pos.id}', 'name', this.value)"
                                       class="text-xl font-bold border-b-2 border-transparent focus:border-purple-500 outline-none">
                                <select onchange="switchPosition(this.value)"
                                        class="px-3 py-1 border rounded-lg">
                                    ${project.positions.map(p => `
                                        <option value="${p.id}" ${p.id === pos.id ? 'selected' : ''}>${p.name}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="flex gap-2">
                                ${project.positions.length > 1 ? `
                                <button onclick="deletePosition('${project.id}', '${pos.id}')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm">
                                    🗑️ Elimina
                                </button>
                                ` : ''}
                                <button onclick="addPosition('${project.id}')"
                                        class="px-4 py-1.5 bg-green-600 text-white rounded-lg font-medium text-sm">
                                    + Nuova Posizione
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div class="section-card">
                            <label class="text-xs font-medium">Piano</label>
                            <input type="text" value="${pos.piano || ''}"
                                   onchange="updatePosition('${project.id}', '${pos.id}', 'piano', this.value)"
                                   placeholder="${project.clientData?.piano || 'Piano'}"
                                   class="w-full compact-input border rounded mt-1">
                        </div>
                        <div class="section-card">
                            <label class="text-xs font-medium">Ambiente</label>
                            <select onchange="updatePosition('${project.id}', '${pos.id}', 'ambiente', this.value)"
                                    class="w-full compact-input border rounded mt-1">
                                <option value="">Seleziona...</option>
                                ${['soggiorno', 'cucina', 'camera', 'bagno', 'corridoio'].map(amb => `
                                    <option value="${amb}" ${pos.ambiente === amb ? 'selected' : ''}>${amb}</option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="section-card">
                            <label class="text-xs font-medium">Quantità</label>
                            <input type="number" min="1" value="${pos.quantita || '1'}"
                                   onchange="updatePosition('${project.id}', '${pos.id}', 'quantita', this.value)"
                                   placeholder="1"
                                   class="w-full compact-input border rounded mt-1 font-semibold text-purple-700">
                        </div>
                        <div class="section-card">
                            <label class="text-xs font-medium">Foto</label>
                            <div class="flex items-center gap-2 mt-1">
                                <input type="file" id="foto-${pos.id}" accept="image/*" class="hidden"
                                       onchange="addFoto('${project.id}', '${pos.id}', this)">
                                <button onclick="document.getElementById('foto-${pos.id}').click()"
                                        class="px-3 py-1 bg-blue-600 text-white rounded text-sm">
                                    📷 Carica
                                </button>
                                <span class="text-sm text-gray-600">${pos.foto?.length || 0} foto</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow">
                        <div class="flex border-b overflow-x-auto">
                            <button onclick="setPositionTab('${pos.id}', 'misure')"
                                    class="tab-btn ${(pos.activeTab || 'misure') === 'misure' ? 'active' : ''}">
                                📏 Misure
                            </button>
                            ${project.prodotti?.infissi ? `
                                <button onclick="setPositionTab('${pos.id}', 'infissi')"
                                        class="tab-btn ${pos.activeTab === 'infissi' ? 'active' : ''}">
                                    🪟 Infissi
                                </button>
                            ` : ''}
                            ${project.prodotti?.persiane ? `
                                <button onclick="setPositionTab('${pos.id}', 'persiane')"
                                        class="tab-btn ${pos.activeTab === 'persiane' ? 'active' : ''}">
                                    🚪 Persiane
                                </button>
                            ` : ''}
                            ${project.prodotti?.tapparelle ? `
                                <button onclick="setPositionTab('${pos.id}', 'tapparelle')"
                                        class="tab-btn ${pos.activeTab === 'tapparelle' ? 'active' : ''}">
                                    🎚️ Tapparelle
                                </button>
                            ` : ''}
                            ${project.prodotti?.zanzariere ? `
                                <button onclick="setPositionTab('${pos.id}', 'zanzariere')"
                                        class="tab-btn ${pos.activeTab === 'zanzariere' ? 'active' : ''}">
                                    🦟 Zanzariere
                                </button>
                            ` : ''}
                            ${project.prodotti?.cassonetti ? `
                                <button onclick="setPositionTab('${pos.id}', 'cassonetti')"
                                        class="tab-btn ${pos.activeTab === 'cassonetti' ? 'active' : ''}">
                                    📦 Cassonetti
                                </button>
                            ` : ''}
                            <button onclick="setPositionTab('${pos.id}', 'foto')"
                                    class="tab-btn ${pos.activeTab === 'foto' ? 'active' : ''}">
                                📸 Foto (${pos.foto?.length || 0})
                            </button>
                        </div>

                        <div class="p-4">
                            ${renderPositionTabContent(project, pos)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPositionTabContent(project, pos) {
            const tab = pos.activeTab || 'misure';

            if (tab === 'misure') return renderMisureTab(project, pos);
            if (tab === 'infissi') return renderInfissiTab(project, pos);
            if (tab === 'persiane') return renderPersianeTab(project, pos);
            if (tab === 'tapparelle') return renderTapparelleTab(project, pos);
            if (tab === 'zanzariere') return renderZanzariereTab(project, pos);
            if (tab === 'cassonetti') return renderCassonettiTab(project, pos);
            if (tab === 'foto') return renderFotoTab(project, pos);

            return '';
        }

        function renderRilievoPerProdotto(project, pos, productType, productLabel, hasCoprifili) {
            const rilievoKey = `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
            const r = pos[rilievoKey] || {};
            
            // Calcola completezza specifica per questo prodotto
            let completed = 0;
            let total = 3; // materiale, togliere, smaltimento
            if (hasCoprifili) total = 5; // + coprifiliInt, coprifiliEst
            
            if (r.materiale && r.materiale.trim() !== '') completed++;
            if (r.togliere !== undefined && r.togliere !== null) completed++;
            if (r.smaltimento !== undefined && r.smaltimento !== null) completed++;
            if (hasCoprifili) {
                if (r.coprifiliInt !== undefined && r.coprifiliInt !== null) completed++;
                if (r.coprifiliEst !== undefined && r.coprifiliEst !== null) completed++;
            }
            
            const percentage = Math.round((completed / total) * 100);
            
            // Determina status
            let icon, color, statusText, badge;
            if (percentage === 0) {
                icon = '⚪'; color = 'gray'; statusText = 'NON INIZIATO'; badge = 'bg-gray-500';
            } else if (percentage < 50) {
                icon = '🔴'; color = 'red'; statusText = 'INCOMPLETO'; badge = 'bg-red-500';
            } else if (percentage < 100) {
                icon = '🟡'; color = 'amber'; statusText = 'PARZIALE'; badge = 'bg-amber-500';
            } else {
                icon = '🟢'; color = 'green'; statusText = 'COMPLETO'; badge = 'bg-green-500';
            }
            
            const uniqueId = `${pos.id}-${productType}`;
            
            return `
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-2 ${color === 'green' ? 'border-green-400' : color === 'amber' ? 'border-amber-400' : color === 'red' ? 'border-red-400' : 'border-gray-300'} rounded-lg p-4 shadow-md mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                📋 RILIEVO PREESISTENTE - ${productLabel}
                            </h3>
                            <p class="text-xs text-gray-600 mt-1">Compila tutte le informazioni per evitare dimenticanze</p>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <button onclick="copiaRilievoDaGlobaleProdotto('${project.id}', '${pos.id}', '${productType}')"
                                    class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg font-semibold transition">
                                📥 Copia da Globale
                            </button>
                            <div class="text-right">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-2xl">${icon}</span>
                                    <span class="text-sm font-bold text-${color}-700">${statusText}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div class="${badge} h-full transition-all duration-500" 
                                             style="width: ${percentage}%"></div>
                                    </div>
                                    <span class="text-sm font-bold">${percentage}%</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">${completed}/${total} campi</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4">
                        <!-- 1. MATERIALE -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-semibold flex items-center gap-2">
                                    🔧 Materiale
                                    ${!r.materiale || r.materiale.trim() === '' ? '<span class="text-red-600">●</span>' : '<span class="text-green-600">✓</span>'}
                                </label>
                                <button onclick="toggleMaterialeProdottoMode('${uniqueId}')" 
                                        id="materiale-toggle-${uniqueId}"
                                        class="text-xs bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full font-medium transition">
                                    ✏️ Scrivi
                                </button>
                            </div>
                            
                            <!-- SELECT MODE (default) -->
                            <select id="materiale-select-${uniqueId}"
                                    onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'materiale', this.value)"
                                    class="w-full px-3 py-2 border-2 ${!r.materiale || r.materiale.trim() === '' ? 'border-red-300 bg-red-50' : 'border-green-300 bg-white'} rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">Seleziona...</option>
                                <option value="Legno" ${r.materiale === 'Legno' ? 'selected' : ''}>Legno</option>
                                <option value="PVC" ${r.materiale === 'PVC' ? 'selected' : ''}>PVC</option>
                                <option value="Alluminio" ${r.materiale === 'Alluminio' ? 'selected' : ''}>Alluminio</option>
                                <option value="Ferro" ${r.materiale === 'Ferro' ? 'selected' : ''}>Ferro</option>
                            </select>
                            
                            <!-- INPUT MODE (hidden by default) -->
                            <input type="text" 
                                   id="materiale-input-${uniqueId}"
                                   value="${r.materiale || ''}"
                                   onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'materiale', this.value)"
                                   placeholder="Inserisci materiale..."
                                   style="display: none;"
                                   class="w-full px-3 py-2 border-2 ${!r.materiale || r.materiale.trim() === '' ? 'border-red-300 bg-red-50' : 'border-green-300 bg-white'} rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        
                        <!-- 2. NOTE AGGIUNTIVE -->
                        <div>
                            <label class="block text-sm font-semibold mb-2 flex items-center gap-2">
                                📝 Note
                            </label>
                            <input type="text" 
                                   value="${r.note || ''}"
                                   onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'note', this.value)"
                                   placeholder="Note aggiuntive..."
                                   class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                    
                    <div class="grid ${hasCoprifili ? 'md:grid-cols-4' : 'md:grid-cols-2'} gap-4 mt-4 pt-4 border-t-2 border-gray-200">
                        <!-- CHECKBOX: TOGLIERE -->
                        <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${r.togliere ? 'border-orange-300' : 'border-gray-200'}">
                            <input type="checkbox" 
                                   id="togliere-${uniqueId}"
                                   ${r.togliere ? 'checked' : ''}
                                   onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'togliere', this.checked)"
                                   class="w-5 h-5 text-orange-600 rounded focus:ring-2 focus:ring-orange-500">
                            <label for="togliere-${uniqueId}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                🔨 Da togliere?
                                ${r.togliere ? '<span class="text-green-600">✓</span>' : '<span class="text-gray-400">○</span>'}
                            </label>
                        </div>
                        
                        <!-- CHECKBOX: SMALTIMENTO -->
                        <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${r.smaltimento ? 'border-red-300' : 'border-gray-200'}">
                            <input type="checkbox" 
                                   id="smaltimento-${uniqueId}"
                                   ${r.smaltimento ? 'checked' : ''}
                                   onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'smaltimento', this.checked)"
                                   class="w-5 h-5 text-red-600 rounded focus:ring-2 focus:ring-red-500">
                            <label for="smaltimento-${uniqueId}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                🗑️ Da smaltire?
                                ${r.smaltimento ? '<span class="text-green-600">✓</span>' : '<span class="text-gray-400">○</span>'}
                            </label>
                        </div>
                        
                        ${hasCoprifili ? `
                            <!-- CHECKBOX: COPRIFILI INT (solo per Infissi) -->
                            <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${r.coprifiliInt ? 'border-blue-300' : 'border-gray-200'}">
                                <input type="checkbox" 
                                       id="coprifiliInt-${uniqueId}"
                                       ${r.coprifiliInt ? 'checked' : ''}
                                       onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'coprifiliInt', this.checked)"
                                       class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                                <label for="coprifiliInt-${uniqueId}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                    📏 Coprifili INT?
                                    ${r.coprifiliInt ? '<span class="text-green-600">✓</span>' : '<span class="text-gray-400">○</span>'}
                                </label>
                            </div>
                            
                            <!-- CHECKBOX: COPRIFILI EST (solo per Infissi) -->
                            <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${r.coprifiliEst ? 'border-purple-300' : 'border-gray-200'}">
                                <input type="checkbox" 
                                       id="coprifiliEst-${uniqueId}"
                                       ${r.coprifiliEst ? 'checked' : ''}
                                       onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'coprifiliEst', this.checked)"
                                       class="w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500">
                                <label for="coprifiliEst-${uniqueId}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                    📐 Coprifili EST?
                                    ${r.coprifiliEst ? '<span class="text-green-600">✓</span>' : '<span class="text-gray-400">○</span>'}
                                </label>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${percentage < 100 ? `
                        <div class="mt-3 p-2 bg-amber-100 border border-amber-300 rounded text-sm text-amber-800">
                            ⚠️ <strong>Attenzione:</strong> Compila tutti i campi per evitare dimenticanze!
                        </div>
                    ` : `
                        <div class="mt-3 p-2 bg-green-100 border border-green-300 rounded text-sm text-green-800">
                            ✅ <strong>Perfetto!</strong> Tutte le informazioni del rilievo sono complete.
                        </div>
                    `}
                </div>
            `;
        }

        function renderMisureTab(project, pos) {
            const validation = validateMisure(project, pos);
            
            return `
                <div class="space-y-4">
                    ${validation.errors.length > 0 || validation.warnings.length > 0 ? `
                        <div class="validation-summary">
                            ${validation.errors.length > 0 ? `
                                <div class="bg-red-50 border-2 border-red-500 rounded-lg p-4 mb-3">
                                    <h3 class="font-bold text-red-800 mb-2 flex items-center gap-2">
                                        🔴 ERRORI DI VALIDAZIONE (${validation.errors.length})
                                    </h3>
                                    <ul class="space-y-1">
                                        ${validation.errors.map(e => `
                                            <li class="text-sm text-red-700">• ${e.message}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${validation.warnings.length > 0 ? `
                                <div class="bg-amber-50 border-2 border-amber-500 rounded-lg p-4 mb-3">
                                    <h3 class="font-bold text-amber-800 mb-2 flex items-center gap-2">
                                        🟡 ATTENZIONE (${validation.warnings.length})
                                    </h3>
                                    <ul class="space-y-1">
                                        ${validation.warnings.map(w => `
                                            <li class="text-sm text-amber-700">• ${w.message}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    ` : `
                        <div class="bg-green-50 border-2 border-green-500 rounded-lg p-3 mb-3">
                            <p class="font-bold text-green-800 flex items-center gap-2">
                                ✅ Tutte le misure sono corrette!
                            </p>
                        </div>
                    `}
                    
                    <!-- 📋 SEZIONI RILIEVO PREESISTENTE PER OGNI PRODOTTO -->
                    ${project.prodotti?.infissi ? renderRilievoPerProdotto(project, pos, 'infissi', '🪟 Infissi', true) : ''}
                    ${project.prodotti?.persiane ? renderRilievoPerProdotto(project, pos, 'persiane', '🚪 Persiane', false) : ''}
                    ${project.prodotti?.tapparelle ? renderRilievoPerProdotto(project, pos, 'tapparelle', '🎚️ Tapparelle', false) : ''}
                    ${project.prodotti?.cassonetti ? renderRilievoPerProdotto(project, pos, 'cassonetti', '📦 Cassonetti', false) : ''}
                    
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-sm font-bold text-gray-700 mb-3">Misure Principali (mm)</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            ${['LVT', 'HVT', 'LF', 'HF', 'TMV', 'HMT', 'LVAR', 'HVAR'].map(field => `
                                <div>
                                    <label class="text-xs font-semibold">${field}</label>
                                    <input type="number" placeholder="0"
                                           value="${pos.misure?.[field] || ''}"
                                           onchange="updateMisuraWithValidation('${project.id}', '${pos.id}', '${field}', this.value)"
                                           class="w-full compact-input border rounded mt-1 font-semibold ${getFieldValidationClass(project, pos, field)}">
                                    ${getFieldValidationMessage(project, pos, field)}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-blue-50 rounded-lg p-4 border-2 border-blue-300">
                        <p class="text-sm font-bold text-blue-800 mb-3">📐 Delta (mm)</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-semibold mb-1">Delta INT</label>
                                <input type="number" placeholder="0" value="${pos.misure?.DeltaINT || ''}"
                                       onchange="updateMisura('${project.id}', '${pos.id}', 'DeltaINT', this.value)"
                                       class="w-full px-3 py-2 border rounded font-semibold">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold mb-1">Delta EST</label>
                                <input type="number" placeholder="0" value="${pos.misure?.DeltaEST || ''}"
                                       onchange="updateMisura('${project.id}', '${pos.id}', 'DeltaEST', this.value)"
                                       class="w-full px-3 py-2 border rounded font-semibold">
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-sm font-bold text-gray-700 mb-3">Altezze (mm)</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs font-semibold mb-1">H Soffitto</label>
                                <input type="number" placeholder="0" value="${pos.misure?.HSoffitto || ''}"
                                       onchange="updateMisura('${project.id}', '${pos.id}', 'HSoffitto', this.value)"
                                       class="w-full px-3 py-2 border rounded font-semibold">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold mb-1">H Parapetto/Soffitto</label>
                                <input type="number" placeholder="0" value="${pos.misure?.HParapettoSoffitto || ''}"
                                       onchange="updateMisura('${project.id}', '${pos.id}', 'HParapettoSoffitto', this.value)"
                                       class="w-full px-3 py-2 border rounded font-semibold">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold mb-1">H Pavimento/Parapetto</label>
                                <input type="number" placeholder="0" value="${pos.misure?.HPavimentoParapetto || ''}"
                                       onchange="updateMisura('${project.id}', '${pos.id}', 'HPavimentoParapetto', this.value)"
                                       class="w-full px-3 py-2 border rounded font-semibold">
                            </div>
                        </div>
                    </div>
                    
                    ${pos.overrideCaratteristiche ? `
                        <div class="bg-yellow-100 p-3 rounded border-2 border-yellow-500">
                            <p class="text-sm font-bold text-yellow-800">⚠️ Caratteristiche muro personalizzate per questa posizione</p>
                            <button onclick="disableOverride('${project.id}', '${pos.id}')"
                                    class="mt-2 text-xs bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-700">
                                ↩️ Ripristina globali
                            </button>
                        </div>
                    ` : `
                        <button onclick="enableOverride('${project.id}', '${pos.id}')"
                                class="text-sm bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
                            ✏️ Personalizza caratteristiche muro per questa posizione
                        </button>
                    `}
                </div>
            `;
        }

        function renderInfissiTab(project, pos) {
            const inf = pos.infisso;
            
            return `
                <div class="space-y-4">
                    ${!inf ? `
                        <div class="text-center py-8 bg-gray-50 rounded-lg">
                            <p class="text-gray-600 mb-4">Nessun infisso configurato</p>
                            <button onclick="addInfisso('${project.id}', '${pos.id}')"
                                    class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                                + Aggiungi Infisso
                            </button>
                        </div>
                    ` : `
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-blue-700 text-lg">🪟 Infisso</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'infisso')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    🗑️ Elimina
                                </button>
                            </div>
                            
                            <!-- 📋 DATI SPECIFICI -->
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-blue-800 mb-3 flex items-center gap-2">
                                    📋 Dati Specifici
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Quantità</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'qta', this.value)"
                                                class="w-full compact-input border rounded mt-1 font-semibold">
                                            ${[1,2,3,4,5,6,7,8,9,10].map(n => `
                                                <option value="${n}" ${(inf.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Tipo</label>
                                        ${(() => {
                                            const options = ['F1', 'PF1', 'F2', 'PF2', 'F3', 'PF3', 'HST', 'FISSO'];
                                            const current = inf.tipo || '';
                                            const isCustom = current && !options.includes(current);
                                            const selectId = `inf-tipo-${pos.id}`;
                                            const inputId = `inf-tipo-input-${pos.id}`;
                                            
                                            return `
                                                <select id="${selectId}" 
                                                        onchange="handleProductSelectWithCustom('${project.id}', '${pos.id}', 'infisso', 'tipo', '${selectId}', '${inputId}', this.value)"
                                                        class="w-full compact-input border rounded mt-1">
                                                    <option value="">--</option>
                                                    ${options.map(opt => `
                                                        <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                                    `).join('')}
                                                    <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>✏️ ALTRO - SCRIVO</option>
                                                </select>
                                                <input type="text" 
                                                       id="${inputId}"
                                                       value="${isCustom ? current : ''}"
                                                       onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'tipo', this.value)"
                                                       placeholder="Inserisci tipo personalizzato..."
                                                       style="display: ${isCustom ? 'block' : 'none'};"
                                                       class="w-full compact-input border rounded mt-2">
                                            `;
                                        })()}
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Apertura</label>
                                        ${(() => {
                                            const options = ['SX', 'DX', 'Fisso', 'Ribalta', 'Sp. SX', 'Sp. DX', 'SCORR.PARALL'];
                                            const current = inf.apertura || '';
                                            const isCustom = current && !options.includes(current);
                                            const selectId = `inf-apertura-${pos.id}`;
                                            const inputId = `inf-apertura-input-${pos.id}`;
                                            
                                            return `
                                                <select id="${selectId}" 
                                                        onchange="handleProductSelectWithCustom('${project.id}', '${pos.id}', 'infisso', 'apertura', '${selectId}', '${inputId}', this.value)"
                                                        class="w-full compact-input border rounded mt-1">
                                                    <option value="">--</option>
                                                    ${options.map(opt => `
                                                        <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                                    `).join('')}
                                                    <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>✏️ ALTRO - SCRIVO</option>
                                                </select>
                                                <input type="text" 
                                                       id="${inputId}"
                                                       value="${isCustom ? current : ''}"
                                                       onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'apertura', this.value)"
                                                       placeholder="Inserisci apertura personalizzata..."
                                                       style="display: ${isCustom ? 'block' : 'none'};"
                                                       class="w-full compact-input border rounded mt-2">
                                            `;
                                        })()}
                                    </div>
                                </div>
                            </div>

                            <!-- ⚙️ CONFIGURAZIONE -->
                            <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-green-800 mb-3 flex items-center gap-2">
                                    ⚙️ Configurazione
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Finitura Int</label>
                                        <input type="text" value="${inf.finituraInt || ''}"
                                               placeholder="pvc"
                                               list="finituraInt-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'finituraInt', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="finituraInt-list-${pos.id}">
                                            <option value="pvc">
                                            <option value="legno">
                                            <option value="alluminio">
                                            <option value="ceramica">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Finitura Est</label>
                                        <input type="text" value="${inf.finituraEst || ''}"
                                               placeholder="alluminio"
                                               list="finituraEst-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'finituraEst', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="finituraEst-list-${pos.id}">
                                            <option value="pvc">
                                            <option value="alluminio">
                                            <option value="ceramica">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Colore Int</label>
                                        <input type="text" value="${inf.coloreInt || ''}"
                                               placeholder="42"
                                               list="coloreInt-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'coloreInt', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="coloreInt-list-${pos.id}">
                                            <option value="42">
                                            <option value="L55">
                                            <option value="RAL 9010">
                                            <option value="Bianco">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Colore Est</label>
                                        <input type="text" value="${inf.coloreEst || ''}"
                                               placeholder="L55"
                                               list="coloreEst-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'coloreEst', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="coloreEst-list-${pos.id}">
                                            <option value="L55">
                                            <option value="42">
                                            <option value="RAL 8014">
                                            <option value="Marrone">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Tipo Anta</label>
                                        <input type="text" value="${inf.tipoAnta || ''}"
                                               placeholder="slim-line"
                                               list="tipoAnta-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'tipoAnta', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="tipoAnta-list-${pos.id}">
                                            <option value="step-line">
                                            <option value="nova-line">
                                            <option value="slim-line">
                                            <option value="classic-line">
                                            <option value="step-line-door">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Telaio</label>
                                        <input type="text" value="${inf.telaio || ''}"
                                               placeholder="965"
                                               list="telaio-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'telaio', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="telaio-list-${pos.id}">
                                            <option value="961">
                                            <option value="962">
                                            <option value="965">
                                            <option value="966">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Allarme</label>
                                        <input type="text" value="${inf.allarme || ''}"
                                               placeholder="no"
                                               list="allarme-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'allarme', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="allarme-list-${pos.id}">
                                            <option value="no">
                                            <option value="si">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Vetro</label>
                                        <input type="text" value="${inf.vetro || ''}"
                                               placeholder="DOPPIO"
                                               list="vetro-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'vetro', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="vetro-list-${pos.id}">
                                            <option value="DOPPIO">
                                            <option value="DOPPIO SAT">
                                            <option value="TRIPLO">
                                            <option value="TRIPLO SAT">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Tagli Telaio</label>
                                        <input type="text" value="${inf.tagliTelaio || ''}"
                                               placeholder="sopra-sotto"
                                               list="tagliTelaio-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'tagliTelaio', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="tagliTelaio-list-${pos.id}">
                                            <option value="sopra">
                                            <option value="sotto">
                                            <option value="sopra-sotto">
                                            <option value="dx">
                                            <option value="sx">
                                            <option value="dx-sx">
                                            <option value="4-lati">
                                            <option value="sopra-laterali">
                                            <option value="sotto-laterali">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Tipo Tagli</label>
                                        <input type="text" value="${inf.tipoTagli || ''}"
                                               placeholder="--"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'tipoTagli', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                </div>
                            </div>

                            <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-bold text-amber-800 flex items-center gap-2">
                                        📏 BRM - Misura per Ordine
                                    </h5>
                                    <button onclick="toggleUsaGlobale('${project.id}', '${pos.id}', 'infisso')"
                                            class="px-3 py-1.5 ${inf.usaGlobale ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'} text-white rounded-lg font-medium text-sm transition-all">
                                        ${inf.usaGlobale ? '✅ Usa Globale' : '🔽 Usa Globale'}
                                    </button>
                                </div>
                                
                                ${inf.usaGlobale ? `
                                    <div class="bg-white p-3 rounded border-2 border-amber-400">
                                        <p class="text-sm text-amber-800 mb-2">
                                            <strong>Formula Globale Attiva:</strong>
                                        </p>
                                        <div class="grid grid-cols-2 gap-3 text-sm">
                                            <div>
                                                <span class="font-semibold">BRM L =</span>
                                                ${project.brmConfigInfissi?.misuraBaseL || '?'} 
                                                ${project.brmConfigInfissi?.operazioneL || '-'} 
                                                ${project.brmConfigInfissi?.valoreL || '0'}mm
                                            </div>
                                            <div>
                                                <span class="font-semibold">BRM H =</span>
                                                ${project.brmConfigInfissi?.misuraBaseH || '?'} 
                                                ${project.brmConfigInfissi?.operazioneH || '-'} 
                                                ${project.brmConfigInfissi?.valoreH || '0'}mm
                                            </div>
                                        </div>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-3 mt-3">
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">📏 BRM Larghezza</label>
                                            <input type="number" value="${inf.BRM_L || ''}" readonly
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">📏 BRM Altezza</label>
                                            <input type="number" value="${inf.BRM_H || ''}" readonly
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                ` : `
                                    <div class="bg-white p-3 rounded border-2 border-purple-400 mb-3">
                                        <p class="text-sm font-semibold text-purple-800 mb-2">⚙️ Formula Personalizzata:</p>
                                        
                                        <!-- BRM Larghezza -->
                                        <div class="mb-3">
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">📏 BRM Larghezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'misuraBaseL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['LF', 'LVT', 'LVAR', 'TMV', 'LS'].map(m => `
                                                            <option value="${m}" ${inf.brmPersonalizzato?.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'operazioneL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${inf.brmPersonalizzato?.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${inf.brmPersonalizzato?.operazioneL === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" value="${inf.brmPersonalizzato?.valoreL || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'valoreL', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold">
                                                = ${inf.brmPersonalizzato?.misuraBaseL || '?'} ${inf.brmPersonalizzato?.operazioneL || '+'} ${inf.brmPersonalizzato?.valoreL || '0'}mm
                                            </div>
                                        </div>
                                        
                                        <!-- BRM Altezza -->
                                        <div>
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">📏 BRM Altezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'misuraBaseH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['HF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'].map(m => `
                                                            <option value="${m}" ${inf.brmPersonalizzato?.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'operazioneH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${inf.brmPersonalizzato?.operazioneH === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${inf.brmPersonalizzato?.operazioneH === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" value="${inf.brmPersonalizzato?.valoreH || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'valoreH', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold">
                                                = ${inf.brmPersonalizzato?.misuraBaseH || '?'} ${inf.brmPersonalizzato?.operazioneH || '+'} ${inf.brmPersonalizzato?.valoreH || '0'}mm
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Risultati BRM Calcolati -->
                                    <div class="grid md:grid-cols-2 gap-3">
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">✅ BRM Larghezza</label>
                                            <input type="number" value="${inf.BRM_L || ''}" readonly
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">✅ BRM Altezza</label>
                                            <input type="number" value="${inf.BRM_H || ''}" readonly
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                `}
                            </div>

                            <div class="mt-3">
                                <label class="text-xs font-medium">📝 Note</label>
                                <textarea value="${inf.note || ''}"
                                          onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'note', this.value)"
                                          class="w-full compact-input border rounded mt-1"
                                          rows="2">${inf.note || ''}</textarea>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

        function renderPersianeTab(project, pos) {
            const per = pos.persiana;
            
            return `
                <div class="space-y-4">
                    ${!per ? `
                        <div class="text-center py-8 bg-gray-50 rounded-lg">
                            <p class="text-gray-600 mb-4">Nessuna persiana configurata</p>
                            <button onclick="addPersiana('${project.id}', '${pos.id}')"
                                    class="px-6 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700">
                                + Aggiungi Persiana
                            </button>
                        </div>
                    ` : `
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-purple-700 text-lg">🚪 Persiana</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'persiana')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    🗑️ Elimina
                                </button>
                            </div>
                            
                            <!-- 📋 DATI SPECIFICI -->
                            <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-purple-800 mb-3 flex items-center gap-2">
                                    📋 Dati Specifici
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Quantità</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'qta', this.value)"
                                                class="w-full compact-input border rounded mt-1 font-semibold">
                                            ${[1,2,3,4,5,6,7,8,9,10].map(n => `
                                                <option value="${n}" ${(per.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Tipo</label>
                                        ${(() => {
                                            const options = ['FA', 'PFA', 'F2', 'PF2', 'F3', 'PF3', 'SCORREVOLE'];
                                            const current = per.tipo || '';
                                            const isCustom = current && !options.includes(current);
                                            const selectId = `per-tipo-${pos.id}`;
                                            const inputId = `per-tipo-input-${pos.id}`;
                                            
                                            return `
                                                <select id="${selectId}" 
                                                        onchange="handleProductSelectWithCustom('${project.id}', '${pos.id}', 'persiana', 'tipo', '${selectId}', '${inputId}', this.value)"
                                                        class="w-full compact-input border rounded mt-1">
                                                    <option value="">--</option>
                                                    ${options.map(opt => `
                                                        <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                                    `).join('')}
                                                    <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>✏️ ALTRO - SCRIVO</option>
                                                </select>
                                                <input type="text" 
                                                       id="${inputId}"
                                                       value="${isCustom ? current : ''}"
                                                       onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'tipo', this.value)"
                                                       placeholder="Inserisci tipo personalizzato..."
                                                       style="display: ${isCustom ? 'block' : 'none'};"
                                                       class="w-full compact-input border rounded mt-2">
                                            `;
                                        })()}
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Apertura</label>
                                        ${(() => {
                                            const options = ['SP SX', 'SP DX', 'LIB SX', 'LIB DX', 'SCORR SX', 'SCORR DX'];
                                            const current = per.apertura || '';
                                            const isCustom = current && !options.includes(current);
                                            const selectId = `per-apertura-${pos.id}`;
                                            const inputId = `per-apertura-input-${pos.id}`;
                                            
                                            return `
                                                <select id="${selectId}" 
                                                        onchange="handleProductSelectWithCustom('${project.id}', '${pos.id}', 'persiana', 'apertura', '${selectId}', '${inputId}', this.value)"
                                                        class="w-full compact-input border rounded mt-1">
                                                    <option value="">--</option>
                                                    ${options.map(opt => `
                                                        <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                                    `).join('')}
                                                    <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>✏️ Altro SCRIVO</option>
                                                </select>
                                                <input type="text" 
                                                       id="${inputId}"
                                                       value="${isCustom ? current : ''}"
                                                       onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'apertura', this.value)"
                                                       placeholder="Inserisci apertura personalizzata..."
                                                       style="display: ${isCustom ? 'block' : 'none'};"
                                                       class="w-full compact-input border rounded mt-2">
                                            `;
                                        })()}
                                    </div>
                                </div>
                            </div>

                            <!-- ⚙️ CONFIGURAZIONE -->
                            <div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-amber-800 mb-3 flex items-center gap-2">
                                    ⚙️ Configurazione
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Modello</label>
                                        <input type="text" value="${per.modello || ''}"
                                               placeholder="--"
                                               list="modello-per-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'modello', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="modello-per-list-${pos.id}">
                                            <option value="Aurora">
                                            <option value="Vanitosa">
                                            <option value="Oscura">
                                            <option value="Alto Adige">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Fissaggio</label>
                                        <input type="text" value="${per.fissaggio || ''}"
                                               placeholder="--"
                                               list="fissaggio-per-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'fissaggio', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="fissaggio-per-list-${pos.id}">
                                            <option value="A MURO">
                                            <option value="TELAIO">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Tipo Telaio</label>
                                        <input type="text" value="${per.tipoTelaio || ''}"
                                               placeholder="--"
                                               list="tipoTelaio-per-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'tipoTelaio', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="tipoTelaio-per-list-${pos.id}">
                                            <option value="TH 62">
                                            <option value="TH 40">
                                            <option value="TH 82">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Colore Persiana</label>
                                        <input type="text" value="${per.colorePersiana || ''}"
                                               placeholder="--"
                                               list="colorePers-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'colorePersiana', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="colorePers-list-${pos.id}">
                                            <option value="Bianco">
                                            <option value="Verde">
                                            <option value="Marrone">
                                            <option value="Grigio">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Colore Telaio</label>
                                        <input type="text" value="${per.coloreTelaio || ''}"
                                               placeholder="--"
                                               list="coloreTel-per-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'coloreTelaio', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="coloreTel-per-list-${pos.id}">
                                            <option value="Bianco">
                                            <option value="Marrone">
                                            <option value="Grigio">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Battuta</label>
                                        <input type="text" value="${per.battuta || ''}"
                                               placeholder="--"
                                               list="battuta-per-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'battuta', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="battuta-per-list-${pos.id}">
                                            <option value="3 LATI">
                                            <option value="4 LATI">
                                        </datalist>
                                    </div>
                                </div>
                            </div>

                            <!-- 📷 FOTO PERSIANA -->
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-semibold text-blue-800 flex items-center gap-2">
                                        📷 Foto Persiana
                                    </h5>
                                    <button onclick="document.getElementById('foto-persiana-input-${project.id}-${pos.id}').click()"
                                            class="px-3 py-1.5 bg-blue-600 text-white rounded-lg font-medium text-sm hover:bg-blue-700">
                                        📷 Carica Foto
                                    </button>
                                    <input type="file" 
                                           id="foto-persiana-input-${project.id}-${pos.id}"
                                           accept="image/*"
                                           style="display: none;"
                                           onchange="addFotoPersiana('${project.id}', '${pos.id}', event)">
                                </div>
                                ${per.foto && per.foto.length > 0 ? `
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                        ${per.foto.map((foto, idx) => `
                                            <div class="relative">
                                                <img src="${foto}" class="w-full h-32 object-cover rounded border-2 border-blue-300">
                                                <button onclick="removeFotoPersiana('${project.id}', '${pos.id}', ${idx})"
                                                        class="absolute top-1 right-1 bg-red-600 text-white rounded-full p-1 text-xs hover:bg-red-700">
                                                    ✕
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <p class="text-sm text-gray-500 italic text-center py-3">1 foto per persiana<br>Nessuna foto caricata</p>
                                `}
                            </div>

                            <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-bold text-amber-800 flex items-center gap-2">
                                        📏 BRM - Misura per Ordine
                                    </h5>
                                    <button onclick="toggleUsaGlobale('${project.id}', '${pos.id}', 'persiana')"
                                            class="px-3 py-1.5 ${per.usaGlobale ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'} text-white rounded-lg font-medium text-sm transition-all">
                                        ${per.usaGlobale ? '✅ Usa Globale' : '🔽 Usa Globale'}
                                    </button>
                                </div>
                                
                                ${per.usaGlobale ? `
                                    <div class="bg-white p-3 rounded border-2 border-amber-400">
                                        <p class="text-sm text-amber-800 mb-2"><strong>Formula Globale Attiva:</strong></p>
                                        <div class="grid grid-cols-2 gap-3 text-sm">
                                            <div><span class="font-semibold">BRM L =</span> ${project.brmConfigPersiane?.misuraBaseL || '?'} ${project.brmConfigPersiane?.operazioneL || '-'} ${project.brmConfigPersiane?.valoreL || '0'}mm</div>
                                            <div><span class="font-semibold">BRM H =</span> ${project.brmConfigPersiane?.misuraBaseH || '?'} ${project.brmConfigPersiane?.operazioneH || '-'} ${project.brmConfigPersiane?.valoreH || '0'}mm</div>
                                        </div>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-3 mt-3">
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">📏 BRM Larghezza</label>
                                            <input type="number" value="${per.BRM_L || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">📏 BRM Altezza</label>
                                            <input type="number" value="${per.BRM_H || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                ` : `
                                    <div class="bg-white p-3 rounded border-2 border-purple-400 mb-3">
                                        <p class="text-sm font-semibold text-purple-800 mb-2">⚙️ Formula Personalizzata:</p>
                                        
                                        <!-- BRM Larghezza -->
                                        <div class="mb-3">
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">📏 BRM Larghezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'misuraBaseL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['LF', 'LVT', 'LVAR', 'TMV', 'LS'].map(m => `
                                                            <option value="${m}" ${per.brmPersonalizzato?.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'operazioneL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${per.brmPersonalizzato?.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${per.brmPersonalizzato?.operazioneL === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" value="${per.brmPersonalizzato?.valoreL || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'valoreL', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold">
                                                = ${per.brmPersonalizzato?.misuraBaseL || '?'} ${per.brmPersonalizzato?.operazioneL || '+'} ${per.brmPersonalizzato?.valoreL || '0'}mm
                                            </div>
                                        </div>
                                        
                                        <!-- BRM Altezza -->
                                        <div>
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">📏 BRM Altezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'misuraBaseH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['HF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'].map(m => `
                                                            <option value="${m}" ${per.brmPersonalizzato?.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'operazioneH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${per.brmPersonalizzato?.operazioneH === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${per.brmPersonalizzato?.operazioneH === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" value="${per.brmPersonalizzato?.valoreH || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'valoreH', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold">
                                                = ${per.brmPersonalizzato?.misuraBaseH || '?'} ${per.brmPersonalizzato?.operazioneH || '+'} ${per.brmPersonalizzato?.valoreH || '0'}mm
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Risultati BRM Calcolati -->
                                    <div class="grid md:grid-cols-2 gap-3">
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">✅ BRM Larghezza</label>
                                            <input type="number" value="${per.BRM_L || ''}" readonly
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">✅ BRM Altezza</label>
                                            <input type="number" value="${per.BRM_H || ''}" readonly
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                `}
                            </div>

                            <div class="mt-3">
                                <label class="text-xs font-medium">📝 Note</label>
                                <textarea value="${per.note || ''}"
                                          onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'note', this.value)"
                                          class="w-full compact-input border rounded mt-1"
                                          rows="2">${per.note || ''}</textarea>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

                function renderTapparelleTab(project, pos) {
            const tap = pos.tapparella;
            
            return `
                <div class="space-y-4">
                    ${!tap ? `
                        <div class="text-center py-8 bg-gray-50 rounded-lg">
                            <p class="text-gray-600 mb-4">Nessuna tapparella configurata</p>
                            <button onclick="addTapparella('${project.id}', '${pos.id}')"
                                    class="px-6 py-2 bg-amber-600 text-white rounded-lg font-medium hover:bg-amber-700">
                                + Aggiungi Tapparella
                            </button>
                        </div>
                    ` : `
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-amber-700 text-lg">🎚️ Tapparella</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'tapparella')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    🗑️ Elimina
                                </button>
                            </div>
                            
                            <!-- 📋 DATI SPECIFICI -->
                            <div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-amber-800 mb-3 flex items-center gap-2">
                                    📋 Dati Specifici
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Quantità</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'qta', this.value)"
                                                class="w-full compact-input border rounded mt-1 font-semibold">
                                            ${[1,2,3,4,5,6,7,8,9,10].map(n => `
                                                <option value="${n}" ${(tap.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- ⚙️ CONFIGURAZIONE -->
                            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-yellow-800 mb-3 flex items-center gap-2">
                                    ⚙️ Configurazione
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Azienda</label>
                                        <input type="text" value="${tap.azienda || ''}"
                                               placeholder="plasticino"
                                               list="azienda-tap-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'azienda', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="azienda-tap-list-${pos.id}">
                                            <option value="plasticino">
                                            <option value="cherubini">
                                            <option value="nice">
                                            <option value="somfy">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Modello</label>
                                        <input type="text" value="${tap.modello || ''}"
                                               placeholder="Mini"
                                               list="modello-tap-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'modello', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="modello-tap-list-${pos.id}">
                                            <option value="Mini">
                                            <option value="Maxi">
                                            <option value="Standard">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Colore</label>
                                        <input type="text" value="${tap.colore || ''}"
                                               placeholder="marrone 79"
                                               list="colore-tap-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'colore', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="colore-tap-list-${pos.id}">
                                            <option value="marrone 79">
                                            <option value="bianco">
                                            <option value="grigio">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Manuale/Motorizzato</label>
                                        <input type="text" value="${tap.manualeMot || ''}"
                                               placeholder="Motorizzata"
                                               list="manualeMot-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'manualeMot', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="manualeMot-list-${pos.id}">
                                            <option value="Manuale">
                                            <option value="Motorizzata">
                                        </datalist>
                                    </div>
                                </div>

                                <!-- FASE 11a: TIPO SOSTITUZIONE -->
                                <div class="mt-4 bg-orange-100 border-2 border-orange-300 rounded-lg p-3">
                                    <label class="text-sm font-semibold text-orange-800 block mb-2">🔄 Cosa si sostituisce?</label>
                                    <div class="flex gap-4 flex-wrap">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" 
                                                   name="tipoSost-${pos.id}" 
                                                   value="Entrambi"
                                                   ${!tap.tipoSostituzione || tap.tipoSostituzione === 'Entrambi' ? 'checked' : ''}
                                                   onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'tipoSostituzione', this.value)"
                                                   class="w-4 h-4">
                                            <span class="text-sm font-medium">🔧 Entrambi (Motore + Tapparella)</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" 
                                                   name="tipoSost-${pos.id}" 
                                                   value="Solo Motore"
                                                   ${tap.tipoSostituzione === 'Solo Motore' ? 'checked' : ''}
                                                   onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'tipoSostituzione', this.value)"
                                                   class="w-4 h-4">
                                            <span class="text-sm font-medium">⚡ Solo Motore</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" 
                                                   name="tipoSost-${pos.id}" 
                                                   value="Solo Tapparella"
                                                   ${tap.tipoSostituzione === 'Solo Tapparella' ? 'checked' : ''}
                                                   onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'tipoSostituzione', this.value)"
                                                   class="w-4 h-4">
                                            <span class="text-sm font-medium">🎚️ Solo Tapparella</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- CAMPI CONDIZIONALI -->
                                ${tap.tipoSostituzione !== 'Solo Motore' ? `
                                <div class="grid md:grid-cols-2 gap-3 mt-3">
                                    <div>
                                        <label class="text-xs font-medium">Guida</label>
                                        <input type="text" value="${tap.guida || ''}"
                                               placeholder="--"
                                               list="guida-tap-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'guida', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="guida-tap-list-${pos.id}">
                                            <option value="Standard">
                                            <option value="Rinforzata">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Colore Guida</label>
                                        <input type="text" value="${tap.coloreGuida || ''}"
                                               placeholder="--"
                                               list="coloreGuida-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'coloreGuida', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="coloreGuida-list-${pos.id}">
                                            <option value="bianco">
                                            <option value="marrone">
                                            <option value="grigio">
                                        </datalist>
                                    </div>
                                </div>
                                ` : ''}
                            </div>

                            <!-- 🔌 MOTORI (SISTEMA COMPLETO FASE 11a) - Solo se Motorizzata e non Solo Tapparella -->
                            ${tap.manualeMot === 'Motorizzata' && tap.tipoSostituzione !== 'Solo Tapparella' ? `
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-semibold text-blue-800 flex items-center gap-2">
                                        🔌 Motori
                                    </h5>
                                    <button onclick="addMotoreTapparella('${project.id}', '${pos.id}')"
                                            class="px-3 py-1.5 bg-blue-600 text-white rounded-lg font-medium text-sm hover:bg-blue-700">
                                        + Aggiungi Motore
                                    </button>
                                </div>
                                ${tap.motori && tap.motori.length > 0 ? `
                                    ${tap.motori.map((motore, idx) => `
                                        <div class="bg-white p-4 rounded border-2 border-blue-300 mb-3">
                                            <div class="flex justify-between items-center mb-3">
                                                <h6 class="text-sm font-semibold text-blue-700">🔌 Motore ${idx + 1}</h6>
                                                <button onclick="removeMotoreTapparella('${project.id}', '${pos.id}', ${idx})"
                                                        class="text-red-600 hover:text-red-800 text-sm font-semibold px-2 py-1 hover:bg-red-50 rounded">
                                                    ✕ Rimuovi
                                                </button>
                                            </div>
                                            
                                            <!-- Marca Motore -->
                                            <div class="mb-3">
                                                <label class="text-xs font-medium text-gray-700">🏭 Marca</label>
                                                <input type="text" 
                                                       value="${motore.marca || ''}"
                                                       placeholder="Es: Somfy, Nice..."
                                                       list="marca-motore-list-${idx}"
                                                       onchange="updateMotoreTapparellaField('${project.id}', '${pos.id}', ${idx}, 'marca', this.value)"
                                                       class="w-full px-3 py-2 border rounded text-sm mt-1">
                                                <datalist id="marca-motore-list-${idx}">
                                                    <option value="Somfy">
                                                    <option value="Nice">
                                                    <option value="Cherubini">
                                                    <option value="BTicino">
                                                    <option value="Came">
                                                    <option value="Faac">
                                                </datalist>
                                            </div>

                                            <!-- Modello/Trasmettitore -->
                                            <div class="mb-3">
                                                <label class="text-xs font-medium text-gray-700">📡 Modello / Trasmettitore</label>
                                                <input type="text" 
                                                       value="${motore.modello || ''}"
                                                       placeholder="Es: LT, Oximo, Hybrid..."
                                                       list="modello-motore-list-${idx}"
                                                       onchange="updateMotoreTapparellaField('${project.id}', '${pos.id}', ${idx}, 'modello', this.value)"
                                                       class="w-full px-3 py-2 border rounded text-sm mt-1">
                                                <datalist id="modello-motore-list-${idx}">
                                                    <option value="LT">
                                                    <option value="Oximo">
                                                    <option value="Hybrid">
                                                    <option value="Era">
                                                    <option value="Neo">
                                                    <option value="Spider">
                                                </datalist>
                                            </div>

                                            <!-- Tipo Alimentazione -->
                                            <div class="mb-3">
                                                <label class="text-xs font-medium text-gray-700 block mb-2">⚡ Tipo Alimentazione</label>
                                                <div class="flex gap-4">
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="radio" 
                                                               name="alimentazione-${idx}" 
                                                               value="Filare"
                                                               ${!motore.alimentazione || motore.alimentazione === 'Filare' ? 'checked' : ''}
                                                               onchange="updateMotoreTapparellaField('${project.id}', '${pos.id}', ${idx}, 'alimentazione', this.value)"
                                                               class="w-4 h-4">
                                                        <span class="text-sm">🔌 Filare</span>
                                                    </label>
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="radio" 
                                                               name="alimentazione-${idx}" 
                                                               value="Telecomando"
                                                               ${motore.alimentazione === 'Telecomando' ? 'checked' : ''}
                                                               onchange="updateMotoreTapparellaField('${project.id}', '${pos.id}', ${idx}, 'alimentazione', this.value)"
                                                               class="w-4 h-4">
                                                        <span class="text-sm">📻 Telecomando</span>
                                                    </label>
                                                </div>
                                            </div>

                                            <!-- Trasmettitore (solo se Telecomando) -->
                                            ${motore.alimentazione === 'Telecomando' ? `
                                                <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-3">
                                                    <label class="text-xs font-medium text-purple-800 block mb-2">📻 Trasmettitore</label>
                                                    <input type="text" 
                                                           value="${motore.trasmettitore || ''}"
                                                           placeholder="Es: RTS, IO, Telis..."
                                                           onchange="updateMotoreTapparellaField('${project.id}', '${pos.id}', ${idx}, 'trasmettitore', this.value)"
                                                           class="w-full px-3 py-2 border border-purple-300 rounded text-sm">
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                ` : `
                                    <p class="text-sm text-gray-500 italic text-center py-3">Nessun motore aggiunto</p>
                                `}
                            </div>
                            ` : ''}

                            <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-bold text-amber-800 flex items-center gap-2">
                                        📏 BRM - Misura per Ordine
                                    </h5>
                                    <button onclick="toggleUsaGlobale('${project.id}', '${pos.id}', 'tapparella')"
                                            class="px-3 py-1.5 ${tap.usaGlobale ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'} text-white rounded-lg font-medium text-sm transition-all">
                                        ${tap.usaGlobale ? '✅ Usa Globale' : '🔽 Usa Globale'}
                                    </button>
                                </div>
                                
                                ${tap.usaGlobale ? `
                                    <div class="bg-white p-3 rounded border-2 border-amber-400">
                                        <p class="text-sm text-amber-800 mb-2"><strong>Formula Globale Attiva:</strong></p>
                                        <div class="grid grid-cols-2 gap-3 text-sm">
                                            <div><span class="font-semibold">BRM L =</span> ${project.brmConfigTapparelle?.misuraBaseL || '?'} ${project.brmConfigTapparelle?.operazioneL || '-'} ${project.brmConfigTapparelle?.valoreL || '0'}mm</div>
                                            <div><span class="font-semibold">BRM H =</span> ${project.brmConfigTapparelle?.misuraBaseH || '?'} ${project.brmConfigTapparelle?.operazioneH || '-'} ${project.brmConfigTapparelle?.valoreH || '0'}mm</div>
                                        </div>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-3 mt-3">
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">📏 BRM Larghezza</label>
                                            <input type="number" value="${tap.BRM_L || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">📏 BRM Altezza</label>
                                            <input type="number" value="${tap.BRM_H || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                ` : `
                                    <div class="bg-white p-3 rounded border-2 border-purple-400 mb-3">
                                        <p class="text-sm font-semibold text-purple-800 mb-2">⚙️ Formula Personalizzata:</p>
                                        
                                        <!-- BRM Larghezza -->
                                        <div class="mb-3">
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">📏 BRM Larghezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'tapparella', 'misuraBaseL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['LF', 'LVT', 'LVAR', 'TMV', 'LS'].map(m => `
                                                            <option value="${m}" ${tap.brmPersonalizzato?.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'tapparella', 'operazioneL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${tap.brmPersonalizzato?.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${tap.brmPersonalizzato?.operazioneL === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" value="${tap.brmPersonalizzato?.valoreL || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'tapparella', 'valoreL', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold">
                                                = ${tap.brmPersonalizzato?.misuraBaseL || '?'} ${tap.brmPersonalizzato?.operazioneL || '+'} ${tap.brmPersonalizzato?.valoreL || '0'}mm
                                            </div>
                                        </div>
                                        
                                        <!-- BRM Altezza -->
                                        <div>
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">📏 BRM Altezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'tapparella', 'misuraBaseH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['HF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'].map(m => `
                                                            <option value="${m}" ${tap.brmPersonalizzato?.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'tapparella', 'operazioneH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${tap.brmPersonalizzato?.operazioneH === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${tap.brmPersonalizzato?.operazioneH === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" value="${tap.brmPersonalizzato?.valoreH || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'tapparella', 'valoreH', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold">
                                                = ${tap.brmPersonalizzato?.misuraBaseH || '?'} ${tap.brmPersonalizzato?.operazioneH || '+'} ${tap.brmPersonalizzato?.valoreH || '0'}mm
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Risultati BRM Calcolati -->
                                    <div class="grid md:grid-cols-2 gap-3">
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">✅ BRM Larghezza</label>
                                            <input type="number" value="${tap.BRM_L || ''}" readonly
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">✅ BRM Altezza</label>
                                            <input type="number" value="${tap.BRM_H || ''}" readonly
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                `}
                            </div>

                            <div class="mt-3">
                                <label class="text-xs font-medium">📝 Note</label>
                                <textarea value="${tap.note || ''}"
                                          onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'note', this.value)"
                                          class="w-full compact-input border rounded mt-1"
                                          rows="2">${tap.note || ''}</textarea>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

                function renderZanzariereTab(project, pos) {
            const zan = pos.zanzariera;
            
            return `
                <div class="space-y-4">
                    ${!zan ? `
                        <div class="text-center py-8 bg-gray-50 rounded-lg">
                            <p class="text-gray-600 mb-4">Nessuna zanzariera configurata</p>
                            <button onclick="addZanzariera('${project.id}', '${pos.id}')"
                                    class="px-6 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                                + Aggiungi Zanzariera
                            </button>
                        </div>
                    ` : `
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-green-700 text-lg">🦟 Zanzariera</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'zanzariera')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    🗑️ Elimina
                                </button>
                            </div>
                            
                            <!-- ⚙️ TIPO INFISSO ASSOCIATO -->
                            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-yellow-800 mb-3 flex items-center gap-2">
                                    🔧 Tipo Infisso Associato
                                </h5>
                                <p class="text-sm text-gray-600 mb-3">Seleziona tipo:</p>
                                <div class="flex gap-6">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" 
                                               name="tipoInfisso-${project.id}-${pos.id}"
                                               value="F"
                                               ${zan.tipoInfissoAssociato === 'F' ? 'checked' : ''}
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'tipoInfissoAssociato', 'F')"
                                               class="w-4 h-4">
                                        <span class="font-medium">F (Finestra)</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" 
                                               name="tipoInfisso-${project.id}-${pos.id}"
                                               value="PF"
                                               ${zan.tipoInfissoAssociato === 'PF' ? 'checked' : ''}
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'tipoInfissoAssociato', 'PF')"
                                               class="w-4 h-4">
                                        <span class="font-medium">PF (Porta Finestra)</span>
                                    </label>
                                </div>
                                ${!zan.tipoInfissoAssociato ? `
                                    <div class="mt-3 bg-amber-100 border-l-4 border-amber-500 p-3">
                                        <p class="text-sm text-amber-800">⚠️ Seleziona prima se F o PF</p>
                                    </div>
                                ` : ''}
                            </div>

                            <!-- 📋 DATI SPECIFICI -->
                            <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-green-800 mb-3 flex items-center gap-2">
                                    📋 Dati Specifici
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Quantità</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'qta', this.value)"
                                                class="w-full compact-input border rounded mt-1 font-semibold">
                                            ${[1,2,3,4,5,6,7,8,9,10].map(n => `
                                                <option value="${n}" ${(zan.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Tipo</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'tipo', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">--</option>
                                            <option value="Avvolgibile" ${zan.tipo === 'Avvolgibile' ? 'selected' : ''}>Avvolgibile</option>
                                            <option value="Plissé" ${zan.tipo === 'Plissé' ? 'selected' : ''}>Plissé</option>
                                            <option value="Battente" ${zan.tipo === 'Battente' ? 'selected' : ''}>Battente</option>
                                            <option value="Scorrevole" ${zan.tipo === 'Scorrevole' ? 'selected' : ''}>Scorrevole</option>
                                            <option value="Fissa" ${zan.tipo === 'Fissa' ? 'selected' : ''}>Fissa</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Apertura</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'apertura', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">--</option>
                                            <option value="SP SX" ${zan.apertura === 'SP SX' ? 'selected' : ''}>SP SX</option>
                                            <option value="SP DX" ${zan.apertura === 'SP DX' ? 'selected' : ''}>SP DX</option>
                                            <option value="SCORR SX" ${zan.apertura === 'SCORR SX' ? 'selected' : ''}>SCORR SX</option>
                                            <option value="SCORR DX" ${zan.apertura === 'SCORR DX' ? 'selected' : ''}>SCORR DX</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- ⚙️ CONFIGURAZIONE -->
                            <div class="bg-teal-50 border-2 border-teal-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-teal-800 mb-3 flex items-center gap-2">
                                    ⚙️ Configurazione
                                </h5>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Colore Telaio</label>
                                        <input type="text" value="${zan.coloreTelaio || ''}"
                                               placeholder="Es: Bianco, Marrone"
                                               list="coloreTel-zan-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'coloreTelaio', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="coloreTel-zan-list-${pos.id}">
                                            <option value="Bianco">
                                            <option value="Marrone">
                                            <option value="Grigio">
                                            <option value="Nero">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Tipo Rete</label>
                                        <input type="text" value="${zan.tipoRete || ''}"
                                               placeholder="Es: Standard, Anti-polline"
                                               list="tipoRete-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'tipoRete', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="tipoRete-list-${pos.id}">
                                            <option value="Standard">
                                            <option value="Anti-polline">
                                            <option value="Pet-resistant">
                                            <option value="Micro-forata">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Colore Rete</label>
                                        <input type="text" value="${zan.coloreRete || ''}"
                                               placeholder="Es: Nero, Grigio"
                                               list="coloreRete-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'coloreRete', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="coloreRete-list-${pos.id}">
                                            <option value="Nero">
                                            <option value="Grigio">
                                            <option value="Bianco">
                                        </datalist>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-bold text-amber-800 flex items-center gap-2">
                                        📏 BRM - Misura per Ordine
                                    </h5>
                                    <button onclick="toggleUsaGlobale('${project.id}', '${pos.id}', 'zanzariera')"
                                            class="px-3 py-1.5 ${zan.usaGlobale ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'} text-white rounded-lg font-medium text-sm transition-all">
                                        ${zan.usaGlobale ? '✅ Usa Globale' : '🔽 Usa Globale'}
                                    </button>
                                </div>
                                
                                ${zan.usaGlobale ? `
                                    <div class="bg-white p-3 rounded border-2 border-amber-400">
                                        <p class="text-sm text-amber-800 mb-2"><strong>Formula Globale Attiva:</strong></p>
                                        <div class="grid grid-cols-2 gap-3 text-sm">
                                            <div><span class="font-semibold">BRM L =</span> ${project.brmConfigZanzariere?.misuraBaseL || '?'} ${project.brmConfigZanzariere?.operazioneL || '-'} ${project.brmConfigZanzariere?.valoreL || '0'}mm</div>
                                            <div><span class="font-semibold">BRM H =</span> ${project.brmConfigZanzariere?.misuraBaseH || '?'} ${project.brmConfigZanzariere?.operazioneH || '-'} ${project.brmConfigZanzariere?.valoreH || '0'}mm</div>
                                        </div>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-3 mt-3">
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">📏 BRM Larghezza</label>
                                            <input type="number" value="${zan.BRM_L || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">📏 BRM Altezza</label>
                                            <input type="number" value="${zan.BRM_H || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                ` : `
                                    <div class="bg-white p-3 rounded border-2 border-purple-400 mb-3">
                                        <p class="text-sm font-semibold text-purple-800 mb-2">⚙️ Formula Personalizzata:</p>
                                        
                                        <!-- BRM Larghezza -->
                                        <div class="mb-3">
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">📏 BRM Larghezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'zanzariera', 'misuraBaseL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['LF', 'LVT', 'LVAR', 'TMV', 'LS'].map(m => `
                                                            <option value="${m}" ${zan.brmPersonalizzato?.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'zanzariera', 'operazioneL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${zan.brmPersonalizzato?.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${zan.brmPersonalizzato?.operazioneL === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" value="${zan.brmPersonalizzato?.valoreL || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'zanzariera', 'valoreL', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold">
                                                = ${zan.brmPersonalizzato?.misuraBaseL || '?'} ${zan.brmPersonalizzato?.operazioneL || '+'} ${zan.brmPersonalizzato?.valoreL || '0'}mm
                                            </div>
                                        </div>
                                        
                                        <!-- BRM Altezza -->
                                        <div>
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">📏 BRM Altezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'zanzariera', 'misuraBaseH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['HF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'].map(m => `
                                                            <option value="${m}" ${zan.brmPersonalizzato?.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'zanzariera', 'operazioneH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${zan.brmPersonalizzato?.operazioneH === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${zan.brmPersonalizzato?.operazioneH === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" value="${zan.brmPersonalizzato?.valoreH || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'zanzariera', 'valoreH', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold">
                                                = ${zan.brmPersonalizzato?.misuraBaseH || '?'} ${zan.brmPersonalizzato?.operazioneH || '+'} ${zan.brmPersonalizzato?.valoreH || '0'}mm
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Risultati BRM Calcolati -->
                                    <div class="grid md:grid-cols-2 gap-3">
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">✅ BRM Larghezza</label>
                                            <input type="number" value="${zan.BRM_L || ''}" readonly
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">✅ BRM Altezza</label>
                                            <input type="number" value="${zan.BRM_H || ''}" readonly
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                `}
                            </div>

                            <div class="mt-3">
                                <label class="text-xs font-medium">📝 Note</label>
                                <textarea value="${zan.note || ''}"
                                          onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'note', this.value)"
                                          class="w-full compact-input border rounded mt-1"
                                          rows="2">${zan.note || ''}</textarea>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

                function renderCassonettiTab(project, pos) {
            const cas = pos.cassonetto;
            
            return `
                <div class="space-y-4">
                    ${!cas ? `
                        <div class="text-center py-8 bg-gray-50 rounded-lg">
                            <p class="text-gray-600 mb-4">Nessun cassonetto configurato</p>
                            <button onclick="addCassonetto('${project.id}', '${pos.id}')"
                                    class="px-6 py-2 bg-orange-600 text-white rounded-lg font-medium hover:bg-orange-700">
                                + Aggiungi Cassonetto
                            </button>
                        </div>
                    ` : `
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-orange-700 text-lg">📦 Cassonetto</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'cassonetto')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    🗑️ Elimina
                                </button>
                            </div>
                            
                            <!-- 📋 DATI GENERALI -->
                            <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-orange-800 mb-3 flex items-center gap-2">
                                    📋 Dati Generali
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Quantità</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'qta', this.value)"
                                                class="w-full compact-input border rounded mt-1 font-semibold">
                                            ${[1,2,3,4,5,6,7,8,9,10].map(n => `
                                                <option value="${n}" ${(cas.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                            `).join('')}
                                        </select>
                                    </div>

                                    <!-- FASE 11a: NUOVO CAMPO TIPO CASSONETTO -->
                                    <div>
                                        <label class="text-xs font-medium">📏 Tipo Cassonetto</label>
                                        <input type="text" value="${cas.tipoCassonetto || ''}"
                                               placeholder="LARGH_CASS"
                                               list="tipoCass-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'tipoCassonetto', this.value)"
                                               class="w-full compact-input border-2 border-yellow-400 rounded mt-1 font-semibold bg-yellow-50">
                                        <datalist id="tipoCass-list-${pos.id}">
                                            <option value="LARGH_CASS">
                                            <option value="LS">
                                            <option value="LVT">
                                            <option value="TMV">
                                            <option value="LP">
                                            <option value="MIS_FIN_INF_L">
                                            <option value="LS+SRDX+SRSX">
                                        </datalist>
                                    </div>

                                    <div>
                                        <label class="text-xs font-medium">Tipo</label>
                                        <input type="text" value="${cas.tipo || ''}"
                                               placeholder="Cassonetto"
                                               list="tipo-cas-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'tipo', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="tipo-cas-list-${pos.id}">
                                            <option value="Cassonetto">
                                            <option value="Cassonetto termico">
                                            <option value="Cassonetto ispezionabile">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Azienda</label>
                                        <input type="text" value="${cas.azienda || ''}"
                                               placeholder="finstral"
                                               list="azienda-cas-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'azienda', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="azienda-cas-list-${pos.id}">
                                            <option value="finstral">
                                            <option value="essepi">
                                            <option value="schuco">
                                            <option value="internorm">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Colore</label>
                                        <input type="text" value="${cas.colore || ''}"
                                               placeholder="42"
                                               list="colore-cas-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'colore', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="colore-cas-list-${pos.id}">
                                            <option value="42">
                                            <option value="Bianco">
                                            <option value="L55">
                                            <option value="RAL 9010">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Sovrappi/Sostit</label>
                                        <input type="text" value="${cas.sovrappiSostit || ''}"
                                               placeholder="--"
                                               list="sovrappi-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'sovrappiSostit', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="sovrappi-list-${pos.id}">
                                            <option value="Sovrapposizione">
                                            <option value="Sostituzione">
                                            <option value="Nuova installazione">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">A Soffitto</label>
                                        <input type="text" value="${cas.aSoffitto || ''}"
                                               placeholder="--"
                                               list="aSoffitto-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'aSoffitto', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="aSoffitto-list-${pos.id}">
                                            <option value="Sì">
                                            <option value="No">
                                        </datalist>
                                    </div>
                                </div>
                            </div>

                            <!-- 📏 MISURE CASSONETTO (mm) -->
                            <div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-amber-800 mb-3 flex items-center gap-2">
                                    📏 Misure Cassonetto (mm)
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">LS</label>
                                        <input type="number" value="${cas.LS || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'LS', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">SRSX</label>
                                        <input type="number" value="${cas.SRSX || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'SRSX', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">ZSX</label>
                                        <input type="number" value="${cas.ZSX || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'ZSX', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">SRDX</label>
                                        <input type="number" value="${cas.SRDX || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'SRDX', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">ZDX</label>
                                        <input type="number" value="${cas.ZDX || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'ZDX', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">HCASS</label>
                                        <input type="number" value="${cas.HCASS || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'HCASS', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">B</label>
                                        <input type="number" value="${cas.B || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'B', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">C</label>
                                        <input type="number" value="${cas.C || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'C', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">BSuperiore</label>
                                        <input type="number" value="${cas.BSuperiore || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'BSuperiore', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                </div>
                                <div class="mt-3 bg-blue-100 border-l-4 border-blue-500 p-3">
                                    <p class="text-sm text-blue-800">
                                        📝 <strong>Note:</strong> Se SRSX = ZSX → Muro a SX | Se SRDX = ZDX → Muro a DX
                                    </p>
                                </div>
                            </div>

                            <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-bold text-amber-800 flex items-center gap-2">
                                        📏 BRM - Misura per Ordine
                                    </h5>
                                    <div class="flex gap-2">
                                        ${cas.usaGlobale ? `
                                            <button onclick="ricalcolaBRMCassonetto('${project.id}', '${pos.id}')"
                                                    class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm transition-all">
                                                🔄 Ricalcola BRM
                                            </button>
                                        ` : ''}
                                        <button onclick="toggleUsaGlobale('${project.id}', '${pos.id}', 'cassonetto')"
                                                class="px-3 py-1.5 ${cas.usaGlobale ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'} text-white rounded-lg font-medium text-sm transition-all">
                                            ${cas.usaGlobale ? '✅ Usa Globale' : '🔽 Usa Globale'}
                                        </button>
                                    </div>
                                </div>
                                
                                ${cas.usaGlobale ? `
                                    <div class="bg-white p-3 rounded border-2 border-amber-400">
                                        <p class="text-sm text-amber-800 mb-2"><strong>Formula Globale Attiva:</strong></p>
                                        <div class="grid grid-cols-2 gap-3 text-sm">
                                            <div><span class="font-semibold">BRM L =</span> ${project.brmConfigCassonetti?.misuraBaseL || '?'} ${project.brmConfigCassonetti?.operazioneL || '-'} ${project.brmConfigCassonetti?.valoreL || '0'}mm</div>
                                            <div><span class="font-semibold">BRM H =</span> ${project.brmConfigCassonetti?.misuraBaseH || '?'} ${project.brmConfigCassonetti?.operazioneH || '-'} ${project.brmConfigCassonetti?.valoreH || '0'}mm</div>
                                        </div>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-3 mt-3">
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">📏 BRM Larghezza</label>
                                            <input type="number" value="${cas.BRM_L || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">📏 BRM Altezza</label>
                                            <input type="number" value="${cas.BRM_H || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                ` : `
                                    <div class="bg-white p-3 rounded border-2 border-purple-400 mb-3">
                                        <p class="text-sm font-semibold text-purple-800 mb-2">⚙️ Formula Personalizzata:</p>
                                        
                                        <!-- BRM Larghezza -->
                                        <div class="mb-3">
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">📏 BRM Larghezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'misuraBaseL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['LARGH_CASS', 'LS', 'LVT', 'TMV', 'LF', 'MIS_FIN_INF_L', 'LS+SRDX+SRSX'].map(m => `
                                                            <option value="${m}" ${cas.brmPersonalizzato?.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'operazioneL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${cas.brmPersonalizzato?.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${cas.brmPersonalizzato?.operazioneL === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" value="${cas.brmPersonalizzato?.valoreL || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'valoreL', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold">
                                                = ${cas.brmPersonalizzato?.misuraBaseL || '?'} ${cas.brmPersonalizzato?.operazioneL || '+'} ${cas.brmPersonalizzato?.valoreL || '0'}mm
                                            </div>
                                        </div>
                                        
                                        <!-- BRM Altezza -->
                                        <div>
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">📏 BRM Altezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'misuraBaseH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['HF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'].map(m => `
                                                            <option value="${m}" ${cas.brmPersonalizzato?.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'operazioneH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${cas.brmPersonalizzato?.operazioneH === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${cas.brmPersonalizzato?.operazioneH === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" value="${cas.brmPersonalizzato?.valoreH || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'valoreH', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold">
                                                = ${cas.brmPersonalizzato?.misuraBaseH || '?'} ${cas.brmPersonalizzato?.operazioneH || '+'} ${cas.brmPersonalizzato?.valoreH || '0'}mm
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Risultati BRM Calcolati -->
                                    <div class="grid md:grid-cols-2 gap-3">
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">✅ BRM Larghezza</label>
                                            <input type="number" value="${cas.BRM_L || ''}" readonly
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">✅ BRM Altezza</label>
                                            <input type="number" value="${cas.BRM_H || ''}" readonly
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                `}
                            </div>

                            <div class="mt-3">
                                <label class="text-xs font-medium">📝 Note</label>
                                <textarea value="${cas.note || ''}"
                                          onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'note', this.value)"
                                          class="w-full compact-input border rounded mt-1"
                                          rows="2">${cas.note || ''}</textarea>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

        function renderFotoTab(project, pos) {
            return `
                <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-700 mb-3">📸 Foto Posizione</h4>
                    
                    <div class="mb-3">
                        <input type="file" 
                               id="foto-input-${pos.id}" 
                               accept="image/*" 
                               onchange="addFoto('${project.id}', '${pos.id}', this)"
                               class="hidden">
                        <button onclick="document.getElementById('foto-input-${pos.id}').click()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold">
                            📷 Carica Foto
                        </button>
                        <p class="text-xs text-gray-600 mt-2">Click per selezionare un'immagine dal dispositivo</p>
                    </div>
                    
                    ${pos.foto && pos.foto.length > 0 ? `
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            ${pos.foto.map((foto, idx) => `
                                <div class="relative group">
                                    <img src="${foto.data}" 
                                         onclick="showFotoModal('${foto.data}')"
                                         class="w-full h-32 object-cover rounded-lg border-2 border-gray-300 cursor-pointer hover:border-blue-500 transition-all">
                                    <button onclick="removeFoto('${project.id}', '${pos.id}', ${idx})"
                                            class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                        ✕
                                    </button>
                                    <p class="text-xs text-center mt-1 text-gray-600">Foto ${idx + 1}</p>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p class="text-sm text-gray-500 italic">Nessuna foto caricata</p>'}
                </div>
            `;
        }

        function NewProjectModal() {
            return `
                <div id="modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
                        <h3 class="text-xl font-bold mb-4">Nuovo Progetto</h3>
                        <input type="text" id="projectName" placeholder="Nome progetto" 
                               class="w-full px-3 py-2 border rounded-lg mb-3">
                        <input type="text" id="projectClient" placeholder="Cliente" 
                               class="w-full px-3 py-2 border rounded-lg mb-4">
                        <div class="flex gap-3">
                            <button onclick="hideModal()" 
                                    class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">
                                Annulla
                            </button>
                            <button onclick="createNewProject()" 
                                    class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium">
                                Crea
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function FotoModal() {
            return `
                <div id="foto-modal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50" onclick="hideFotoModal()">
                    <div class="relative max-w-4xl max-h-screen p-4">
                        <button onclick="hideFotoModal()" class="absolute top-2 right-2 bg-white text-black rounded-full w-10 h-10 flex items-center justify-center font-bold hover:bg-gray-200">
                            ✕
                        </button>
                        <img id="foto-modal-img" src="" class="max-w-full max-h-screen object-contain rounded-lg">
                    </div>
                </div>
            `;
        }

        // Window Functions
        window.showNewProjectModal = () => document.getElementById('modal').classList.remove('hidden');
        window.hideModal = () => document.getElementById('modal').classList.add('hidden');

        window.createNewProject = () => {
            const name = document.getElementById('projectName').value.trim();
            const client = document.getElementById('projectClient').value.trim();
            if (name && client) {
                createProject(name, client);
                hideModal();
                state.screen = 'project';
                render();
            }
        };

        window.goBack = () => {
            if (state.screen === 'position') {
                state.screen = 'project';
            } else {
                state.screen = 'list';
            }
            render();
        };

        window.openProject = (id) => {
            state.currentProject = id;
            state.screen = 'project';
            render();
        };

        window.openPosition = (id) => {
            state.currentPosition = id;
            state.screen = 'position';
            state.showRiepilogoRilievi = false;  // Reset flag riepilogo
            render();
        };

        window.switchPosition = (id) => {
            state.currentPosition = id;
            render();
        };

        window.printChecklistRilievi = (projectId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            // Genera HTML per stampa
            const printHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Checklist Rilievi - ${project.nome || 'Progetto'}</title>
                    <style>
                        @media print {
                            @page { margin: 1cm; }
                            body { margin: 0; }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            max-width: 1200px;
                            margin: 0 auto;
                        }
                        h1 {
                            color: #6B46C1;
                            border-bottom: 3px solid #6B46C1;
                            padding-bottom: 10px;
                        }
                        h2 {
                            color: #4A5568;
                            margin-top: 30px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 20px 0;
                            page-break-inside: avoid;
                        }
                        th {
                            background: #6B46C1;
                            color: white;
                            padding: 12px;
                            text-align: left;
                            font-size: 14px;
                        }
                        td {
                            padding: 10px;
                            border: 1px solid #E2E8F0;
                        }
                        tr:nth-child(even) {
                            background: #F7FAFC;
                        }
                        .header-info {
                            background: #EDF2F7;
                            padding: 15px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                        }
                        .check-box {
                            display: inline-block;
                            width: 18px;
                            height: 18px;
                            border: 2px solid #4A5568;
                            margin: 0 5px;
                            vertical-align: middle;
                        }
                        .check-filled {
                            background: #48BB78;
                            border-color: #48BB78;
                        }
                        .missing {
                            color: #E53E3E;
                            font-weight: bold;
                        }
                        .status {
                            display: inline-block;
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 12px;
                            font-weight: bold;
                        }
                        .status-complete { background: #C6F6D5; color: #22543D; }
                        .status-partial { background: #FEEBC8; color: #744210; }
                        .status-empty { background: #FED7D7; color: #742A2A; }
                        .print-btn {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            padding: 10px 20px;
                            background: #6B46C1;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 16px;
                        }
                        @media print {
                            .print-btn { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <button class="print-btn" onclick="window.print()">🖨️ Stampa</button>
                    
                    <h1>📋 CHECKLIST RILIEVI - SOPRALLUOGO</h1>
                    
                    <div class="header-info">
                        <h3>Informazioni Progetto</h3>
                        <p><strong>Progetto:</strong> ${project.nome || 'N/A'}</p>
                        <p><strong>Cliente:</strong> ${project.clientData?.nome || 'N/A'}</p>
                        <p><strong>Indirizzo:</strong> ${project.clientData?.indirizzo || 'N/A'}</p>
                        <p><strong>Piano:</strong> ${project.clientData?.piano || 'N/A'}</p>
                        <p><strong>Data stampa:</strong> ${new Date().toLocaleDateString('it-IT')}</p>
                    </div>
                    
                    <h2>📍 Posizioni da Rilevare (${project.positions.length})</h2>
                    
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 15%">Posizione</th>
                                <th style="width: 12%">Piano/Amb.</th>
                                <th style="width: 15%">Preesistente</th>
                                <th style="width: 12%">Materiale</th>
                                <th style="width: 8%">Togliere</th>
                                <th style="width: 8%">Smaltire</th>
                                <th style="width: 8%">Cop.INT</th>
                                <th style="width: 8%">Cop.EST</th>
                                <th style="width: 14%">Note</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${project.positions.map(pos => {
                                const r = pos.rilievo || {};
                                const completeness = calculateRilievoCompleteness(pos);
                                const statusClass = completeness.percentage === 100 ? 'status-complete' : 
                                                   completeness.percentage > 0 ? 'status-partial' : 'status-empty';
                                const statusText = completeness.percentage === 100 ? 'COMPLETO' : 
                                                  completeness.percentage > 0 ? 'PARZIALE' : 'DA FARE';
                                
                                return `
                                    <tr>
                                        <td>
                                            <strong>${pos.name}</strong><br>
                                            <span class="status ${statusClass}">${statusText}</span>
                                        </td>
                                        <td>${pos.piano || '-'}<br>${pos.ambiente || '-'}</td>
                                        <td class="${!r.preesistente || r.preesistente.trim() === '' ? 'missing' : ''}">
                                            ${r.preesistente || '❌ DA COMPILARE'}
                                        </td>
                                        <td class="${!r.materiale || r.materiale.trim() === '' ? 'missing' : ''}">
                                            ${r.materiale || '❌ DA COMPILARE'}
                                        </td>
                                        <td style="text-align: center;">
                                            <span class="check-box ${r.togliere ? 'check-filled' : ''}"></span>
                                            ${r.togliere ? 'SI' : 'NO'}
                                        </td>
                                        <td style="text-align: center;">
                                            <span class="check-box ${r.smaltimento ? 'check-filled' : ''}"></span>
                                            ${r.smaltimento ? 'SI' : 'NO'}
                                        </td>
                                        <td style="text-align: center;">
                                            <span class="check-box ${r.coprifiliInt ? 'check-filled' : ''}"></span>
                                            ${r.coprifiliInt ? 'SI' : 'NO'}
                                        </td>
                                        <td style="text-align: center;">
                                            <span class="check-box ${r.coprifiliEst ? 'check-filled' : ''}"></span>
                                            ${r.coprifiliEst ? 'SI' : 'NO'}
                                        </td>
                                        <td style="font-size: 12px;">${r.note || '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 40px; border-top: 2px solid #E2E8F0; padding-top: 20px;">
                        <h3>✅ Istruzioni per il Sopralluogo</h3>
                        <ol style="line-height: 1.8;">
                            <li>Verifica per ogni posizione cosa è presente (infisso, persiana, tapparella, etc.)</li>
                            <li>Annota il materiale del prodotto esistente</li>
                            <li>Indica se il prodotto va tolto e/o smaltito</li>
                            <li>Verifica se servono coprifili interni ed esterni per il nuovo montaggio</li>
                            <li>Aggiungi note aggiuntive se necessario</li>
                        </ol>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center; color: #A0AEC0; font-size: 12px;">
                        <p>Generato da Open Porte - Sistema di Rilievo Misure</p>
                    </div>
                </body>
                </html>
            `;
            
            // Apri in nuova finestra e stampa
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printHTML);
            printWindow.document.close();
        };

        window.setPositionTab = (posId, tab) => {
            const project = state.projects.find(p => p.id === state.currentProject);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos.activeTab = tab;
                    render();
                }
            }
        };

        // Update Functions
        window.updateProject = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                project[field] = value;
                saveState();
            }
        };

        window.updateClientData = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.clientData) project.clientData = {};
                project.clientData[field] = value;
                
                if (field === 'piano') {
                    project.positions.forEach(pos => {
                        if (!pos.piano) pos.piano = value;
                    });
                }
                saveState();
            }
        };

        window.updateProdotti = (projectId, product, checked) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.prodotti) project.prodotti = {};
                project.prodotti[product] = checked;
                saveState();
                render();
            }
        };

        window.updateConfigInfissi = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configInfissi) project.configInfissi = {};
                project.configInfissi[field] = value;
                saveState();
            }
        };

        window.updateConfigPersiane = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configPersiane) project.configPersiane = {};
                project.configPersiane[field] = value;
                saveState();
            }
        };

        // Nuova funzione per gestire i campi condizionali delle persiane
        window.updateConfigPersianeConditional = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configPersiane) project.configPersiane = {};
                project.configPersiane[field] = value;
                saveState();
                
                // Gestione visibilità campi condizionali
                if (field === 'modello') {
                    const modelloAltro = document.getElementById(`modello-altro-${projectId}`);
                    if (modelloAltro) {
                        modelloAltro.style.display = value === 'altro' ? 'block' : 'none';
                    }
                } else if (field === 'tipoTelaio') {
                    const tipoTelaioAltro = document.getElementById(`tipo-telaio-altro-${projectId}`);
                    if (tipoTelaioAltro) {
                        tipoTelaioAltro.style.display = value === 'altro' ? 'block' : 'none';
                    }
                }
            }
        };

        // Nuova funzione per gestire il fissaggio e i campi telaio
        window.updateFissaggioPersiane = (projectId, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configPersiane) project.configPersiane = {};
                project.configPersiane.fissaggio = value;
                saveState();
                
                const tipoTelaioContainer = document.getElementById(`tipo-telaio-persiane-container-${projectId}`);
                const coloreTelaioContainer = document.getElementById(`colore-telaio-persiane-container-${projectId}`);
                
                if (tipoTelaioContainer) {
                    tipoTelaioContainer.style.display = value === 'TELAIO' ? 'block' : 'none';
                }
                if (coloreTelaioContainer) {
                    coloreTelaioContainer.style.display = value === 'TELAIO' ? 'block' : 'none';
                }
            }
        };

        window.updateConfigTapparelle = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configTapparelle) project.configTapparelle = {};
                project.configTapparelle[field] = value;
                saveState();
            }
        };

        window.updateConfigZanzariere = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configZanzariere) project.configZanzariere = {};
                project.configZanzariere[field] = value;
                saveState();
            }
        };

        window.updateConfigCassonetti = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configCassonetti) project.configCassonetti = {};
                project.configCassonetti[field] = value;
                saveState();
            }
        };

        window.updateBRMConfig = (projectId, configKey, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project[configKey]) project[configKey] = {};
                project[configKey][field] = value;
                saveState();
                render();
            }
        };

        window.updateBRMPersonalizzato = (projectId, posId, productType, field, value) => {
            updateBRMPersonalizzato(projectId, posId, productType, field, value);
        };

        window.updateCaratteristicheMuro = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
                project.caratteristicheMuro[field] = value;
                saveState();
            }
        };

        window.updateGuidaEsistente = (projectId, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
                project.caratteristicheMuro.guidaEsistente = value;
                saveState();
                
                const guidaFields = document.getElementById(`guida-fields-${projectId}`);
                if (guidaFields) {
                    guidaFields.style.display = value === 'si' ? 'block' : 'none';
                }
            }
        };

        window.updateFalsoEsistente = (projectId, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
                project.caratteristicheMuro.falsoEsistente = value;
                saveState();
                
                const falsoSiFields = document.getElementById(`falso-si-fields-${projectId}`);
                const falsoNoFields = document.getElementById(`falso-no-fields-${projectId}`);
                if (falsoSiFields && falsoNoFields) {
                    falsoSiFields.style.display = value === 'si' ? 'block' : 'none';
                    falsoNoFields.style.display = value === 'no' ? 'block' : 'none';
                }
            }
        };

        // 🆕 FASE 15: Update Misure Globali Infissi
        window.updateMisureGlobaliInfissi = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.misureGlobaliInfissi) {
                    project.misureGlobaliInfissi = {
                        LVT: '', HVT: '', LF: '', HF: '', 
                        TMV: '', HMT: '', LVAR: '', HVAR: '',
                        DeltaINT: '', DeltaEST: '',
                        HSoffitto: '', HParapettoSoffitto: '', HPavimentoParapetto: ''
                    };
                }
                project.misureGlobaliInfissi[field] = value;
                saveState();
            }
        };

        window.updatePosition = (projectId, posId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos[field] = value;
                    saveState();
                }
            }
        };

        window.updateMisura = (projectId, posId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    if (!pos.misure) pos.misure = {};
                    pos.misure[field] = value;
                    saveState();
                }
            }
        };

        window.updateMisuraWithValidation = (projectId, posId, field, value) => {
            updateMisura(projectId, posId, field, value);
            render();
        };

        window.enableOverride = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos.overrideCaratteristiche = true;
                    pos.caratteristicheMuroOverride = {...project.caratteristicheMuro};
                    saveState();
                    render();
                }
            }
        };

        window.disableOverride = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos.overrideCaratteristiche = false;
                    pos.caratteristicheMuroOverride = null;
                    saveState();
                    render();
                }
            }
        };

        window.deletePosition = (projectId, posId) => {
            if (confirm('Sei sicuro di voler eliminare questa posizione? Tutti i dati verranno persi.')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    project.positions = project.positions.filter(p => p.id !== posId);
                    saveState();
                    
                    if (project.positions.length > 0) {
                        state.currentPosition = project.positions[0].id;
                        state.screen = 'position';
                    } else {
                        state.screen = 'project';
                    }
                    render();
                }
            }
        };

        // Motor Functions for Tapparelle
        window.addMotoreTapparella = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.tapparella) {
                    if (!pos.tapparella.motori) {
                        pos.tapparella.motori = [];
                    }
                    // FASE 11a: Inizializza motore con tutti i campi
                    pos.tapparella.motori.push({ 
                        marca: '',
                        modello: '',
                        alimentazione: 'Filare',
                        trasmettitore: ''
                    });
                    saveState();
                    render();
                }
            }
        };

        window.updateMotoreTapparella = (projectId, posId, tappIdx, motoreIdx, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.tapparelle && pos.tapparelle[tappIdx] && pos.tapparelle[tappIdx].motori) {
                    pos.tapparelle[tappIdx].motori[motoreIdx].modello = value;
                    saveState();
                }
            }
        };

        // FASE 11a: Nuova funzione per aggiornare singoli campi del motore
        window.updateMotoreTapparellaField = (projectId, posId, motoreIdx, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.tapparella && pos.tapparella.motori && pos.tapparella.motori[motoreIdx]) {
                    pos.tapparella.motori[motoreIdx][field] = value;
                    saveState();
                    // Se cambia alimentazione, ri-renderizza per mostrare/nascondere trasmettitore
                    if (field === 'alimentazione') {
                        render();
                    }
                }
            }
        };

        window.removeMotoreTapparella = (projectId, posId, motoreIdx) => {
            if (confirm('Eliminare questo motore?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos.tapparella && pos.tapparella.motori) {
                        pos.tapparella.motori.splice(motoreIdx, 1);
                        saveState();
                        render();
                    }
                }
            }
        };

        // Foto Functions
        window.addFoto = (projectId, posId, input) => {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const project = state.projects.find(p => p.id === projectId);
                    if (project) {
                        const pos = project.positions.find(p => p.id === posId);
                        if (pos) {
                            if (!pos.foto) pos.foto = [];
                            pos.foto.push({
                                data: e.target.result,
                                timestamp: new Date().toISOString()
                            });
                            saveState();
                            showNotification('Foto aggiunta', 'success');
                            render();
                        }
                    }
                };
                reader.readAsDataURL(file);
            }
        };

        window.removeFoto = (projectId, posId, fotoIdx) => {
            if (confirm('Sei sicuro di voler eliminare questa foto?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos.foto) {
                        pos.foto.splice(fotoIdx, 1);
                        saveState();
                        render();
                    }
                }
            }
        };

        window.addFotoPersiana = (projectId, posId, persianaIdx, input) => {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const project = state.projects.find(p => p.id === projectId);
                    if (project) {
                        const pos = project.positions.find(p => p.id === posId);
                        if (pos && pos.persiane && pos.persiane[persianaIdx]) {
                            pos.persiane[persianaIdx].foto = {
                                data: e.target.result,
                                timestamp: new Date().toISOString()
                            };
                            saveState();
                            render();
                        }
                    }
                };
                reader.readAsDataURL(file);
            }
            input.value = '';
        };

        window.removeFotoPersiana = (projectId, posId, persianaIdx) => {
            if (confirm('Sei sicuro di voler eliminare questa foto?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos.persiane && pos.persiane[persianaIdx]) {
                        pos.persiane[persianaIdx].foto = null;
                        saveState();
                        render();
                    }
                }
            }
        };

        window.showFotoModal = (fotoData) => {
            const modal = document.getElementById('foto-modal');
            const img = document.getElementById('foto-modal-img');
            if (modal && img) {
                img.src = fotoData;
                modal.classList.remove('hidden');
            }
        };

        window.hideFotoModal = () => {
            const modal = document.getElementById('foto-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        };

        // Export/Import Functions
        window.exportAllProjects = () => {
            try {
                const data = {
                    projects: state.projects,
                    exportDate: new Date().toISOString(),
                    version: '3.0-18A',
                    totalProjects: state.projects.length
                };
                
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `open-porte-progetti-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`Export completato! ${data.totalProjects} progetti`, 'success');
                
            } catch (error) {
                console.error('Errore export:', error);
                showNotification(`Errore durante export: ${error.message}`, 'error');
            }
        };

        window.importProjects = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (!data.projects || !Array.isArray(data.projects)) {
                            throw new Error('File non valido');
                        }
                        
                        const conferma = confirm(
                            `Importare ${data.projects.length} progetti?\n\n` +
                            `OK = SOSTITUISCI progetti attuali\n` +
                            `Annulla = annulla`
                        );
                        
                        if (!conferma) {
                            showNotification('Importazione annullata', 'info');
                            return;
                        }
                        
                        const aggiungi = confirm(
                            `AGGIUNGERE ai progetti esistenti?\n\n` +
                            `OK = AGGIUNGI\n` +
                            `Annulla = SOSTITUISCI`
                        );
                        
                        if (aggiungi) {
                            const nuoviProgetti = data.projects.map(p => ({
                                ...p,
                                id: generateId()
                            }));
                            state.projects = [...state.projects, ...nuoviProgetti];
                        } else {
                            state.projects = data.projects;
                        }
                        
                        state.currentProject = null;
                        state.screen = 'list';
                        
                        saveState();
                        render();
                        
                        showNotification(
                            `Importazione completata! ${data.projects.length} progetti ${aggiungi ? 'aggiunti' : 'importati'}`,
                            'success'
                        );
                        
                    } catch (error) {
                        console.error('Errore import:', error);
                        showNotification(`Errore durante importazione: ${error.message}`, 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        };

        // Main Render Function
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = `
                ${Header()}
                <main class="min-h-screen">
                    ${state.screen === 'list' ? ProjectsList() :
                      state.screen === 'position' ? PositionDetail() :
                      ProjectSetup()}
                </main>
                ${NewProjectModal()}
                ${FotoModal()}
            `;
        }

        // Initialize App
        loadState();
        render();
    </script>
</body>
</html>
