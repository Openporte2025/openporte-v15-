<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Progetti Ristrutturazione</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .main-content {
            padding: 30px;
        }

        .project-header {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .project-header h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
        }

        .accordion {
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
        }

        .accordion-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            transition: background 0.3s;
        }

        .accordion-header:hover {
            opacity: 0.9;
        }

        .accordion-content {
            padding: 20px;
            display: none;
        }

        .accordion-content.active {
            display: block;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .product-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .product-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .positions-list {
            margin-top: 30px;
        }

        .position-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .item-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .item-header h4 {
            color: #667eea;
        }

        .btn-add {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-add:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-remove {
            padding: 8px 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-remove:hover {
            background: #c82333;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .toggle-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .toggle-group label {
            margin: 0;
            font-weight: 600;
        }

        .config-section {
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            margin-top: 15px;
        }

        .config-section h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .precompiled-label {
            color: #666;
            font-size: 0.85em;
            font-style: italic;
            margin-left: 5px;
        }

        .infisso-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .infisso-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            padding: 10px;
            background: #667eea;
            color: white;
            border-radius: 5px;
        }

        .infisso-content {
            padding: 15px;
            display: none;
        }

        .infisso-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèóÔ∏è Gestione Progetti Ristrutturazione</h1>
            <p>Sistema completo di gestione progetti con configurazioni avanzate</p>
        </div>

        <div class="main-content">
            <!-- PROJECT HEADER -->
            <div class="project-header">
                <h2>üìã Nuovo Progetto</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Nome Progetto *</label>
                        <input type="text" id="projectName" placeholder="Es: Ristrutturazione Via Roma 123">
                    </div>
                    <div class="form-group">
                        <label>Cliente</label>
                        <input type="text" id="clientName" placeholder="Nome del cliente">
                    </div>
                    <div class="form-group">
                        <label>Data Inizio</label>
                        <input type="date" id="startDate">
                    </div>
                </div>

                <div class="form-group">
                    <label>Descrizione</label>
                    <textarea id="projectDescription" rows="3" placeholder="Descrizione del progetto..."></textarea>
                </div>
            </div>

            <!-- ACCORDION CARATTERISTICHE MURO -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion('muroAccordion')">
                    <span>üß± Caratteristiche Muro</span>
                    <span id="muroAccordionIcon">‚ñº</span>
                </div>
                <div id="muroAccordion" class="accordion-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Spessore Muro Interno (cm)</label>
                            <input type="number" id="spessoreInterno" placeholder="Es: 12">
                        </div>
                        <div class="form-group">
                            <label>Spessore Muro Esterno (cm)</label>
                            <input type="number" id="spessoreEsterno" placeholder="Es: 30">
                        </div>
                        <div class="form-group">
                            <label>Materiale Muro</label>
                            <select id="materialeMuro">
                                <option value="">Seleziona...</option>
                                <option value="mattoni">Mattoni</option>
                                <option value="cemento">Cemento Armato</option>
                                <option value="cartongesso">Cartongesso</option>
                                <option value="pietra">Pietra</option>
                                <option value="altro">Altro</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ACCORDION CONFIGURAZIONE INFISSI GLOBALE -->
            <div class="accordion" id="infissiGlobaleAccordion" style="display: none;">
                <div class="accordion-header" onclick="toggleAccordion('infissiConfig')">
                    <span>ü™ü Configurazione Infissi Globale</span>
                    <span id="infissiConfigIcon">‚ñº</span>
                </div>
                <div id="infissiConfig" class="accordion-content">
                    <div class="alert alert-info">
                        ‚ö†Ô∏è Questa configurazione verr√† applicata di default a tutte le posizioni (modificabile per singola posizione)
                    </div>

                    <div class="toggle-group">
                        <label>Verranno sostituiti infissi?</label>
                        <select id="sostituzioneInfissi" onchange="toggleSostituzioneInfissi()">
                            <option value="no">No</option>
                            <option value="si">S√¨</option>
                        </select>
                    </div>

                    <div id="configInfissiFields" style="display: none;">
                        <div class="config-section">
                            <h4>Configurazione Base</h4>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>1. Azienda</label>
                                    <select id="configAzienda">
                                        <option value="finstral">FINSTRAL</option>
                                        <option value="essepi" disabled>ESSEPI (prossimamente)</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>2. Finitura Interna</label>
                                    <select id="configFinituraInt">
                                        <option value="">Seleziona...</option>
                                        <option value="pvc">PVC</option>
                                        <option value="legno">LEGNO</option>
                                        <option value="alluminio">ALLUMINIO</option>
                                        <option value="ceramica">CERAMICA</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>3. Finitura Esterna</label>
                                    <select id="configFinituraEst">
                                        <option value="">Seleziona...</option>
                                        <option value="pvc">PVC</option>
                                        <option value="alluminio">ALLUMINIO</option>
                                        <option value="ceramica">CERAMICA</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>4. Colore Interno</label>
                                    <input type="text" id="configColoreInt" placeholder="Es: Bianco RAL 9016">
                                </div>

                                <div class="form-group">
                                    <label>5. Colore Esterno</label>
                                    <input type="text" id="configColoreEst" placeholder="Es: Marrone">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>6. Tipo Anta</label>
                                    <select id="configTipoAnta">
                                        <option value="">Seleziona...</option>
                                        <option value="step-line">STEP-LINE</option>
                                        <option value="nova-line">NOVA-LINE</option>
                                        <option value="slim-line">SLIM-LINE</option>
                                        <option value="classic-line">CLASSIC-LINE</option>
                                        <option value="step-line-door">STEP-LINE DOOR</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>7. Telaio</label>
                                    <select id="configTelaio">
                                        <option value="">Seleziona...</option>
                                        <option value="961">961</option>
                                        <option value="962">962</option>
                                        <option value="966">966</option>
                                        <option value="965">965</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>8. Allarme</label>
                                    <select id="configAllarme">
                                        <option value="no">No</option>
                                        <option value="si">S√¨</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>9. Vetro</label>
                                    <select id="configVetro">
                                        <option value="">Seleziona...</option>
                                        <option value="doppio">Doppio</option>
                                        <option value="doppio-sat">Doppio Sat</option>
                                        <option value="triplo">Triplo</option>
                                        <option value="triplo-sat">Triplo Sat</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>10. Tagli Telaio</label>
                                    <select id="configTagliTelaio">
                                        <option value="">Seleziona...</option>
                                        <option value="sopra">Sopra</option>
                                        <option value="sotto">Sotto</option>
                                        <option value="sopra-sotto">Sopra/Sotto</option>
                                        <option value="dx">Dx</option>
                                        <option value="sx">Sx</option>
                                        <option value="dx-sx">Dx/Sx</option>
                                        <option value="4-lati">4 Lati</option>
                                        <option value="sopra-laterali">Sopra/Laterali</option>
                                        <option value="sotto-laterali">Sotto/Laterali</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>11. Tipo Tagli</label>
                                    <input type="text" id="configTipoTagli" placeholder="Descrivi il tipo di tagli">
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="updateConfigInfissi()">
                            üíæ Salva Configurazione Globale
                        </button>
                    </div>
                </div>
            </div>

            <!-- SELEZIONE PRODOTTI -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion('productsAccordion')">
                    <span>üõ†Ô∏è Selezione Prodotti da Includere</span>
                    <span id="productsAccordionIcon">‚ñº</span>
                </div>
                <div id="productsAccordion" class="accordion-content active">
                    <div class="products-grid">
                        <div class="product-card" onclick="toggleProduct('demolizioni')">
                            <h3>üî® Demolizioni</h3>
                            <input type="checkbox" id="prod-demolizioni">
                        </div>
                        <div class="product-card" onclick="toggleProduct('infissi')">
                            <h3>ü™ü Infissi</h3>
                            <input type="checkbox" id="prod-infissi" onchange="toggleInfissiAccordion()">
                        </div>
                        <div class="product-card" onclick="toggleProduct('persiane')">
                            <h3>üö™ Persiane</h3>
                            <input type="checkbox" id="prod-persiane">
                        </div>
                        <div class="product-card" onclick="toggleProduct('cassonetti')">
                            <h3>üì¶ Cassonetti</h3>
                            <input type="checkbox" id="prod-cassonetti">
                        </div>
                        <div class="product-card" onclick="toggleProduct('zanzariere')">
                            <h3>ü¶ü Zanzariere</h3>
                            <input type="checkbox" id="prod-zanzariere">
                        </div>
                        <div class="product-card" onclick="toggleProduct('controtelai')">
                            <h3>üî≤ Controtelai</h3>
                            <input type="checkbox" id="prod-controtelai">
                        </div>
                    </div>
                </div>
            </div>

            <!-- LISTA POSIZIONI -->
            <div class="positions-list">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üìç Posizioni</h2>
                    <button class="btn-add" onclick="addPosition()">
                        ‚ûï Aggiungi Posizione
                    </button>
                </div>

                <div id="positionsList"></div>
            </div>
        </div>
    </div>

    <script>
        // VARIABILI GLOBALI
        let positions = [];
        let positionCounter = 0;
        let configInfissiGlobale = null;

        // TOGGLE ACCORDION
        function toggleAccordion(id) {
            const content = document.getElementById(id);
            const icon = document.getElementById(id + 'Icon');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                icon.textContent = '‚ñº';
            } else {
                content.classList.add('active');
                icon.textContent = '‚ñ≤';
            }
        }

        // TOGGLE PRODUCT SELECTION
        function toggleProduct(productId) {
            const checkbox = document.getElementById('prod-' + productId);
            checkbox.checked = !checkbox.checked;
            
            const card = checkbox.closest('.product-card');
            if (checkbox.checked) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        }

        // TOGGLE INFISSI ACCORDION
        function toggleInfissiAccordion() {
            const checkbox = document.getElementById('prod-infissi');
            const accordion = document.getElementById('infissiGlobaleAccordion');
            
            if (checkbox.checked) {
                accordion.style.display = 'block';
            } else {
                accordion.style.display = 'none';
            }
        }

        // TOGGLE SOSTITUZIONE INFISSI
        function toggleSostituzioneInfissi() {
            const select = document.getElementById('sostituzioneInfissi');
            const fields = document.getElementById('configInfissiFields');
            
            if (select.value === 'si') {
                fields.style.display = 'block';
            } else {
                fields.style.display = 'none';
            }
        }

        // SALVA CONFIGURAZIONE INFISSI GLOBALE
        function updateConfigInfissi() {
            configInfissiGlobale = {
                azienda: document.getElementById('configAzienda').value,
                finituraInt: document.getElementById('configFinituraInt').value,
                finituraEst: document.getElementById('configFinituraEst').value,
                coloreInt: document.getElementById('configColoreInt').value,
                coloreEst: document.getElementById('configColoreEst').value,
                tipoAnta: document.getElementById('configTipoAnta').value,
                telaio: document.getElementById('configTelaio').value,
                allarme: document.getElementById('configAllarme').value,
                vetro: document.getElementById('configVetro').value,
                tagliTelaio: document.getElementById('configTagliTelaio').value,
                tipoTagli: document.getElementById('configTipoTagli').value
            };
            
            alert('‚úÖ Configurazione Infissi Globale salvata! Verr√† applicata di default a tutte le posizioni.');
        }

        // AGGIUNGI POSIZIONE
        function addPosition() {
            positionCounter++;
            const position = {
                id: positionCounter,
                name: `Posizione ${positionCounter}`,
                demolizioni: [],
                infissi: [],
                persiane: [],
                cassonetti: [],
                zanzariere: [],
                controtelai: []
            };
            
            positions.push(position);
            renderPositions();
        }

        // RENDER POSIZIONI
        function renderPositions() {
            const container = document.getElementById('positionsList');
            container.innerHTML = '';
            
            positions.forEach(position => {
                const positionCard = document.createElement('div');
                positionCard.className = 'position-card';
                positionCard.innerHTML = `
                    <div class="position-header">
                        <h3>üìç ${position.name}</h3>
                        <button class="btn-remove" onclick="removePosition(${position.id})">
                            üóëÔ∏è Elimina Posizione
                        </button>
                    </div>
                    
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab(${position.id}, 'info')">‚ÑπÔ∏è Info</button>
                        ${document.getElementById('prod-demolizioni').checked ? `<button class="tab" onclick="switchTab(${position.id}, 'demolizioni')">üî® Demolizioni</button>` : ''}
                        ${document.getElementById('prod-infissi').checked ? `<button class="tab" onclick="switchTab(${position.id}, 'infissi')">ü™ü Infissi</button>` : ''}
                        ${document.getElementById('prod-persiane').checked ? `<button class="tab" onclick="switchTab(${position.id}, 'persiane')">üö™ Persiane</button>` : ''}
                        ${document.getElementById('prod-cassonetti').checked ? `<button class="tab" onclick="switchTab(${position.id}, 'cassonetti')">üì¶ Cassonetti</button>` : ''}
                        ${document.getElementById('prod-zanzariere').checked ? `<button class="tab" onclick="switchTab(${position.id}, 'zanzariere')">ü¶ü Zanzariere</button>` : ''}
                        ${document.getElementById('prod-controtelai').checked ? `<button class="tab" onclick="switchTab(${position.id}, 'controtelai')">üî≤ Controtelai</button>` : ''}
                    </div>
                    
                    <div id="tab-info-${position.id}" class="tab-content active">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nome Posizione</label>
                                <input type="text" value="${position.name}" onchange="updatePositionName(${position.id}, this.value)">
                            </div>
                            <div class="form-group">
                                <label>Tipo Ambiente</label>
                                <select>
                                    <option>Soggiorno</option>
                                    <option>Camera</option>
                                    <option>Cucina</option>
                                    <option>Bagno</option>
                                    <option>Altro</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    ${document.getElementById('prod-demolizioni').checked ? `
                    <div id="tab-demolizioni-${position.id}" class="tab-content">
                        <button class="btn-add" onclick="addDemolizione(${position.id})">‚ûï Aggiungi Demolizione</button>
                        <div id="demolizioni-list-${position.id}"></div>
                    </div>
                    ` : ''}
                    
                    ${document.getElementById('prod-infissi').checked ? `
                    <div id="tab-infissi-${position.id}" class="tab-content">
                        <button class="btn-add" onclick="addInfisso(${position.id})">‚ûï Aggiungi Infisso</button>
                        <div id="infissi-list-${position.id}"></div>
                    </div>
                    ` : ''}
                    
                    ${document.getElementById('prod-persiane').checked ? `
                    <div id="tab-persiane-${position.id}" class="tab-content">
                        <p>Contenuto Persiane</p>
                    </div>
                    ` : ''}
                    
                    ${document.getElementById('prod-cassonetti').checked ? `
                    <div id="tab-cassonetti-${position.id}" class="tab-content">
                        <p>Contenuto Cassonetti</p>
                    </div>
                    ` : ''}
                    
                    ${document.getElementById('prod-zanzariere').checked ? `
                    <div id="tab-zanzariere-${position.id}" class="tab-content">
                        <p>Contenuto Zanzariere</p>
                    </div>
                    ` : ''}
                    
                    ${document.getElementById('prod-controtelai').checked ? `
                    <div id="tab-controtelai-${position.id}" class="tab-content">
                        <p>Contenuto Controtelai</p>
                    </div>
                    ` : ''}
                `;
                
                container.appendChild(positionCard);
            });
        }

        // SWITCH TAB
        function switchTab(positionId, tabName) {
            const position = document.querySelector(`#tab-info-${positionId}`).closest('.position-card');
            
            // Rimuovi active da tutti i tab e contenuti
            position.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            position.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Aggiungi active al tab e contenuto selezionato
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}-${positionId}`).classList.add('active');
        }

        // AGGIUNGI INFISSO
        function addInfisso(positionId) {
            const position = positions.find(p => p.id === positionId);
            const infissoId = position.infissi.length + 1;
            
            const infisso = {
                id: infissoId,
                qta: 1,
                tipo: '',
                tipoAltro: '',
                apertura: '',
                aperturaAltro: '',
                // Campi precompilati da config globale
                finituraInt: configInfissiGlobale?.finituraInt || '',
                finituraEst: configInfissiGlobale?.finituraEst || '',
                coloreInt: configInfissiGlobale?.coloreInt || '',
                coloreEst: configInfissiGlobale?.coloreEst || '',
                tipoAnta: configInfissiGlobale?.tipoAnta || '',
                telaio: configInfissiGlobale?.telaio || '',
                allarme: configInfissiGlobale?.allarme || 'no',
                vetro: configInfissiGlobale?.vetro || '',
                tagliTelaio: configInfissiGlobale?.tagliTelaio || '',
                tipoTagli: configInfissiGlobale?.tipoTagli || ''
            };
            
            position.infissi.push(infisso);
            renderInfissi(positionId);
        }

        // RENDER INFISSI
        function renderInfissi(positionId) {
            const position = positions.find(p => p.id === positionId);
            const container = document.getElementById(`infissi-list-${positionId}`);
            
            container.innerHTML = '';
            
            position.infissi.forEach((infisso, index) => {
                const infissoCard = document.createElement('div');
                infissoCard.className = 'infisso-card';
                infissoCard.innerHTML = `
                    <div class="infisso-header" onclick="toggleInfissoContent(${positionId}, ${infisso.id})">
                        <h4>ü™ü INFISSO #${infisso.id}</h4>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span id="infisso-icon-${positionId}-${infisso.id}">‚ñº</span>
                            <button class="btn-remove" onclick="event.stopPropagation(); removeInfisso(${positionId}, ${infisso.id})">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                    
                    <div id="infisso-content-${positionId}-${infisso.id}" class="infisso-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Quantit√†</label>
                                <select onchange="updateInfisso(${positionId}, ${infisso.id}, 'qta', this.value)">
                                    ${[1,2,3,4,5,6,7,8].map(n => `<option value="${n}" ${infisso.qta === n ? 'selected' : ''}>${n}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Tipo</label>
                                <select onchange="updateInfisso(${positionId}, ${infisso.id}, 'tipo', this.value)">
                                    <option value="">Seleziona...</option>
                                    <option value="F1" ${infisso.tipo === 'F1' ? 'selected' : ''}>F1</option>
                                    <option value="PF1" ${infisso.tipo === 'PF1' ? 'selected' : ''}>PF1</option>
                                    <option value="F2" ${infisso.tipo === 'F2' ? 'selected' : ''}>F2</option>
                                    <option value="PF2" ${infisso.tipo === 'PF2' ? 'selected' : ''}>PF2</option>
                                    <option value="F3" ${infisso.tipo === 'F3' ? 'selected' : ''}>F3</option>
                                    <option value="PF3" ${infisso.tipo === 'PF3' ? 'selected' : ''}>PF3</option>
                                    <option value="HST" ${infisso.tipo === 'HST' ? 'selected' : ''}>HST</option>
                                    <option value="SCORR.PARALL" ${infisso.tipo === 'SCORR.PARALL' ? 'selected' : ''}>SCORR.PARALL</option>
                                    <option value="FISSO" ${infisso.tipo === 'FISSO' ? 'selected' : ''}>FISSO</option>
                                    <option value="altro" ${infisso.tipo === 'altro' ? 'selected' : ''}>Altro</option>
                                </select>
                            </div>
                            
                            ${infisso.tipo === 'altro' ? `
                            <div class="form-group">
                                <label>Specifica Tipo</label>
                                <input type="text" value="${infisso.tipoAltro}" 
                                    onchange="updateInfisso(${positionId}, ${infisso.id}, 'tipoAltro', this.value)"
                                    placeholder="Inserisci tipo personalizzato">
                            </div>
                            ` : ''}
                            
                            <div class="form-group">
                                <label>Apertura</label>
                                <select onchange="updateInfisso(${positionId}, ${infisso.id}, 'apertura', this.value)">
                                    <option value="">Seleziona...</option>
                                    <option value="SX" ${infisso.apertura === 'SX' ? 'selected' : ''}>SX</option>
                                    <option value="DX" ${infisso.apertura === 'DX' ? 'selected' : ''}>DX</option>
                                    <option value="Fisso" ${infisso.apertura === 'Fisso' ? 'selected' : ''}>Fisso</option>
                                    <option value="Ribalta" ${infisso.apertura === 'Ribalta' ? 'selected' : ''}>Ribalta</option>
                                    <option value="Sp. SX" ${infisso.apertura === 'Sp. SX' ? 'selected' : ''}>Sp. SX</option>
                                    <option value="Sp. DX" ${infisso.apertura === 'Sp. DX' ? 'selected' : ''}>Sp. DX</option>
                                    <option value="altro" ${infisso.apertura === 'altro' ? 'selected' : ''}>Altro</option>
                                </select>
                            </div>
                            
                            ${infisso.apertura === 'altro' ? `
                            <div class="form-group">
                                <label>Specifica Apertura</label>
                                <input type="text" value="${infisso.aperturaAltro}" 
                                    onchange="updateInfisso(${positionId}, ${infisso.id}, 'aperturaAltro', this.value)"
                                    placeholder="Inserisci apertura personalizzata">
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="config-section">
                            <h4>‚öôÔ∏è Configurazione <span class="precompiled-label">(da configurazione globale - modificabile)</span></h4>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Finitura Interna</label>
                                    <select onchange="updateInfisso(${positionId}, ${infisso.id}, 'finituraInt', this.value)">
                                        <option value="">Seleziona...</option>
                                        <option value="pvc" ${infisso.finituraInt === 'pvc' ? 'selected' : ''}>PVC</option>
                                        <option value="legno" ${infisso.finituraInt === 'legno' ? 'selected' : ''}>LEGNO</option>
                                        <option value="alluminio" ${infisso.finituraInt === 'alluminio' ? 'selected' : ''}>ALLUMINIO</option>
                                        <option value="ceramica" ${infisso.finituraInt === 'ceramica' ? 'selected' : ''}>CERAMICA</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Finitura Esterna</label>
                                    <select onchange="updateInfisso(${positionId}, ${infisso.id}, 'finituraEst', this.value)">
                                        <option value="">Seleziona...</option>
                                        <option value="pvc" ${infisso.finituraEst === 'pvc' ? 'selected' : ''}>PVC</option>
                                        <option value="alluminio" ${infisso.finituraEst === 'alluminio' ? 'selected' : ''}>ALLUMINIO</option>
                                        <option value="ceramica" ${infisso.finituraEst === 'ceramica' ? 'selected' : ''}>CERAMICA</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Colore Interno</label>
                                    <input type="text" value="${infisso.coloreInt}" 
                                        onchange="updateInfisso(${positionId}, ${infisso.id}, 'coloreInt', this.value)">
                                </div>
                                
                                <div class="form-group">
                                    <label>Colore Esterno</label>
                                    <input type="text" value="${infisso.coloreEst}" 
                                        onchange="updateInfisso(${positionId}, ${infisso.id}, 'coloreEst', this.value)">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Tipo Anta</label>
                                    <select onchange="updateInfisso(${positionId}, ${infisso.id}, 'tipoAnta', this.value)">
                                        <option value="">Seleziona...</option>
                                        <option value="step-line" ${infisso.tipoAnta === 'step-line' ? 'selected' : ''}>STEP-LINE</option>
                                        <option value="nova-line" ${infisso.tipoAnta === 'nova-line' ? 'selected' : ''}>NOVA-LINE</option>
                                        <option value="slim-line" ${infisso.tipoAnta === 'slim-line' ? 'selected' : ''}>SLIM-LINE</option>
                                        <option value="classic-line" ${infisso.tipoAnta === 'classic-line' ? 'selected' : ''}>CLASSIC-LINE</option>
                                        <option value="step-line-door" ${infisso.tipoAnta === 'step-line-door' ? 'selected' : ''}>STEP-LINE DOOR</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Telaio</label>
                                    <select onchange="updateInfisso(${positionId}, ${infisso.id}, 'telaio', this.value)">
                                        <option value="">Seleziona...</option>
                                        <option value="961" ${infisso.telaio === '961' ? 'selected' : ''}>961</option>
                                        <option value="962" ${infisso.telaio === '962' ? 'selected' : ''}>962</option>
                                        <option value="966" ${infisso.telaio === '966' ? 'selected' : ''}>966</option>
                                        <option value="965" ${infisso.telaio === '965' ? 'selected' : ''}>965</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Allarme</label>
                                    <select onchange="updateInfisso(${positionId}, ${infisso.id}, 'allarme', this.value)">
                                        <option value="no" ${infisso.allarme === 'no' ? 'selected' : ''}>No</option>
                                        <option value="si" ${infisso.allarme === 'si' ? 'selected' : ''}>S√¨</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Vetro</label>
                                    <select onchange="updateInfisso(${positionId}, ${infisso.id}, 'vetro', this.value)">
                                        <option value="">Seleziona...</option>
                                        <option value="doppio" ${infisso.vetro === 'doppio' ? 'selected' : ''}>Doppio</option>
                                        <option value="doppio-sat" ${infisso.vetro === 'doppio-sat' ? 'selected' : ''}>Doppio Sat</option>
                                        <option value="triplo" ${infisso.vetro === 'triplo' ? 'selected' : ''}>Triplo</option>
                                        <option value="triplo-sat" ${infisso.vetro === 'triplo-sat' ? 'selected' : ''}>Triplo Sat</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Tagli Telaio</label>
                                    <select onchange="updateInfisso(${positionId}, ${infisso.id}, 'tagliTelaio', this.value)">
                                        <option value="">Seleziona...</option>
                                        <option value="sopra" ${infisso.tagliTelaio === 'sopra' ? 'selected' : ''}>Sopra</option>
                                        <option value="sotto" ${infisso.tagliTelaio === 'sotto' ? 'selected' : ''}>Sotto</option>
                                        <option value="sopra-sotto" ${infisso.tagliTelaio === 'sopra-sotto' ? 'selected' : ''}>Sopra/Sotto</option>
                                        <option value="dx" ${infisso.tagliTelaio === 'dx' ? 'selected' : ''}>Dx</option>
                                        <option value="sx" ${infisso.tagliTelaio === 'sx' ? 'selected' : ''}>Sx</option>
                                        <option value="dx-sx" ${infisso.tagliTelaio === 'dx-sx' ? 'selected' : ''}>Dx/Sx</option>
                                        <option value="4-lati" ${infisso.tagliTelaio === '4-lati' ? 'selected' : ''}>4 Lati</option>
                                        <option value="sopra-laterali" ${infisso.tagliTelaio === 'sopra-laterali' ? 'selected' : ''}>Sopra/Laterali</option>
                                        <option value="sotto-laterali" ${infisso.tagliTelaio === 'sotto-laterali' ? 'selected' : ''}>Sotto/Laterali</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Tipo Tagli</label>
                                    <input type="text" value="${infisso.tipoTagli}" 
                                        onchange="updateInfisso(${positionId}, ${infisso.id}, 'tipoTagli', this.value)">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(infissoCard);
            });
        }

        // TOGGLE INFISSO CONTENT
        function toggleInfissoContent(positionId, infissoId) {
            const content = document.getElementById(`infisso-content-${positionId}-${infissoId}`);
            const icon = document.getElementById(`infisso-icon-${positionId}-${infissoId}`);
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                icon.textContent = '‚ñº';
            } else {
                content.classList.add('active');
                icon.textContent = '‚ñ≤';
            }
        }

        // UPDATE INFISSO
        function updateInfisso(positionId, infissoId, field, value) {
            const position = positions.find(p => p.id === positionId);
            const infisso = position.infissi.find(i => i.id === infissoId);
            
            infisso[field] = value;
            
            // Se cambia tipo o apertura, re-render per mostrare/nascondere campo "Altro"
            if (field === 'tipo' || field === 'apertura') {
                renderInfissi(positionId);
            }
        }

        // REMOVE INFISSO
        function removeInfisso(positionId, infissoId) {
            const position = positions.find(p => p.id === positionId);
            position.infissi = position.infissi.filter(i => i.id !== infissoId);
            renderInfissi(positionId);
        }

        // REMOVE POSITION
        function removePosition(positionId) {
            if (confirm('Sei sicuro di voler eliminare questa posizione?')) {
                positions = positions.filter(p => p.id !== positionId);
                renderPositions();
            }
        }

        // UPDATE POSITION NAME
        function updatePositionName(positionId, newName) {
            const position = positions.find(p => p.id === positionId);
            position.name = newName;
        }

        // AGGIUNGI DEMOLIZIONE
        function addDemolizione(positionId) {
            const position = positions.find(p => p.id === positionId);
            position.demolizioni.push({
                id: position.demolizioni.length + 1,
                descrizione: ''
            });
            // Qui aggiungeresti il render delle demolizioni
        }
    </script>
</body>
</html>
